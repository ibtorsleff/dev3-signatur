@inherits LayoutComponentBase
@inject INavigationConfigService NavConfigService
@inject IThemeService ThemeService
@inject NavigationManager Navigation
@inject ThemeStateService ThemeState
@inject IJSRuntime JS
@implements IDisposable

<MudThemeProvider Theme="_currentTheme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<SessionPersistence />

<div class="page @_themeCssClass @(_isDarkMode ? "portal-dark" : "")">
    <NavMenu />
    <main class="main-content">
        @Body
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    private MudTheme _currentTheme = new();
    private string _themeCssClass = "theme-recruitingportal";
    private bool _isDarkMode;

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        ThemeState.OnChange += OnThemeStateChanged;
        UpdateTheme();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var stored = await JS.InvokeAsync<string?>("themePreference.get");
            var isDark = stored == "dark";
            ThemeState.Initialize(isDark);
            _isDarkMode = isDark;
            StateHasChanged();
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateTheme();
        InvokeAsync(StateHasChanged);
    }

    private void OnThemeStateChanged()
    {
        _isDarkMode = ThemeState.IsDarkMode;
        InvokeAsync(async () =>
        {
            await JS.InvokeVoidAsync("themePreference.set", _isDarkMode ? "dark" : "light");
            StateHasChanged();
        });
    }

    private void UpdateTheme()
    {
        var path = new Uri(Navigation.Uri).AbsolutePath;
        var navConfig = NavConfigService.GetConfigForRoute(path);
        var themeConfig = ThemeService.GetTheme(navConfig.PortalType);
        _currentTheme = themeConfig.MudTheme;
        _themeCssClass = themeConfig.CssClass;
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        ThemeState.OnChange -= OnThemeStateChanged;
    }
}
