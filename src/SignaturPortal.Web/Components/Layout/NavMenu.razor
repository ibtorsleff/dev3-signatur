<nav class="top-menu">
    @* Row 1: Primary navigation with icons *@
    <div class="row-1">
        <div class="top-logo">
            <a href="@_config.PortalUrl">
                <div>@ResolvePortalName()</div>
            </a>
        </div>
        <ul class="menu-items menu-items-left" id="nav-row1-left">
            @for (var i = 0; i < _config.Row1Items.Count; i++)
            {
                var item = _config.Row1Items[i];
                <li class="@(item.IsSelected ? "selected" : "") @(i >= _overflowStartIndex ? "nav-item-overflow" : "")"
                    data-nav-index="@i">
                    <a href="@item.Url">
                        <div class="icon @item.IconClass">@ResolveLabel(item)</div>
                    </a>
                </li>
            }
            @if (HasOverflow)
            {
                <li class="nav-more-item">
                    <MudMenu ActivationEvent="@MouseEvent.LeftClick"
                             AnchorOrigin="Origin.BottomLeft"
                             TransformOrigin="Origin.TopLeft"
                             Dense="true">
                        <ActivatorContent>
                            <div class="nav-more-activator">
                                <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" />
                                <span>Mere</span>
                            </div>
                        </ActivatorContent>
                        <ChildContent>
                            @foreach (var item in _config.Row1Items.Skip(_overflowStartIndex))
                            {
                                <MudMenuItem Href="@item.Url">@ResolveLabel(item)</MudMenuItem>
                            }
                        </ChildContent>
                    </MudMenu>
                </li>
            }
        </ul>
        <ul class="menu-items menu-items-right">
            @if (_portalsCollapsed)
            {
                @* All portal items have dropped off — show a single "Portals" dropdown *@
                <li class="nav-portals-item">
                    <MudMenu ActivationEvent="@MouseEvent.LeftClick"
                             AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight"
                             Dense="true">
                        <ActivatorContent>
                            <div class="icon icon-portals">@Localization.GetText("Portals")</div>
                        </ActivatorContent>
                        <ChildContent>
                            @foreach (var item in _config.Row1RightItems)
                            {
                                <MudMenuItem Href="@item.Url">@ResolveLabel(item)</MudMenuItem>
                            }
                        </ChildContent>
                    </MudMenu>
                </li>
            }
            else
            {
                @* Portals shown individually — each gets a data-portal-index for measurement *@
                @for (var i = 0; i < _config.Row1RightItems.Count; i++)
                {
                    var item = _config.Row1RightItems[i];
                    <li data-portal-index="@i">
                        <a href="@item.Url">
                            <div class="icon @item.IconClass">@ResolveLabel(item)</div>
                        </a>
                    </li>
                }
            }
        </ul>
    </div>

    @* Row 2: Secondary tabs *@
    <div class="row-2">
        <ul class="menu-items menu-items-left">
            @foreach (var item in _config.Row2Items)
            {
                <li class="@(item.IsSelected ? "selected" : "")">
                    <a href="@item.Url">
                        <div>@ResolveLabel(item)</div>
                    </a>
                </li>
            }
        </ul>
        <ul class="menu-items menu-items-right">
            <li class="user-menu">
                <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
                         Dense="true" PopoverClass="user-menu-popover"
                         ActivationEvent="@MouseEvent.MouseOver">
                    <ActivatorContent>
                        <div class="user-menu-activator">
                            @if (Session.IsImpersonating)
                            {
                                @(Session.ImpersonatedByFullName ?? Session.UserName)
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Filled" Class="impersonate-chip">
                                    Optræder som @(Session.FullName ?? Session.UserName)
                                </MudChip>
                                <span @onclick:stopPropagation="true">
                                    <MudSwitch T="bool" Value="@true" ValueChanged="OnImpersonateToggled"
                                               Color="Color.Warning" Size="Size.Small" Class="impersonate-toggle" />
                                </span>
                            }
                            else
                            {
                                @(Session.IsInitialized ? (Session.FullName ?? Session.UserName) : "User")
                            }
                            <img class="user-icon" src="/Responsive/images/responsive/top-menu/user_44x44.png" alt="User" />
                        </div>
                    </ActivatorContent>
                    <ChildContent>
                        @if (!Session.IsImpersonating)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Person"
                                         OnClick="OpenProfileDialogAsync">
                                @Localization.GetText("Profile")
                            </MudMenuItem>
                            @* Change Password — will be a Blazor dialog in a future phase *@
                            <MudMenuItem Icon="@Icons.Material.Filled.Key">
                                @Localization.GetText("ChangePassword")
                            </MudMenuItem>
                            @if (_isInternal)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.ManageAccounts"
                                             OnClick="OpenImpersonateDialogAsync">
                                    @Localization.GetText("Impersonate")
                                </MudMenuItem>
                            }
                            <MudDivider />
                        }
                        <MudMenuItem Icon="@(_themeState.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                     OnClick="ToggleDarkMode">
                            @(_themeState.IsDarkMode ? "Light mode" : "Dark mode")
                        </MudMenuItem>
                        @if (!Session.IsImpersonating)
                        {
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout"
                                         OnClick="NavigateToLogout">
                                @Localization.GetText("Logout")
                            </MudMenuItem>
                        }
                    </ChildContent>
                </MudMenu>
            </li>
        </ul>
    </div>

    @* Row 3: Tertiary sub-navigation (hidden if empty) *@
    @if (_config.Row3Items.Count > 0)
    {
        <div class="row-3">
            <ul class="menu-items menu-items-left">
                @foreach (var item in _config.Row3Items)
                {
                    <li class="@(item.IsSelected ? "selected" : "")">
                        <a href="@item.Url">
                            <div>@ResolveLabel(item)</div>
                        </a>
                    </li>
                }
            </ul>
        </div>
    }
</nav>
