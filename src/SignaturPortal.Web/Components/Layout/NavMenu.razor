<nav class="top-menu">
    @* Row 1: Primary navigation with icons *@
    <div class="row-1">
        <div class="top-logo">
            <a href="@_config.PortalUrl">
                <div>@ResolvePortalName()</div>
            </a>
        </div>
        <ul class="menu-items menu-items-left" id="nav-row1-left">
            @for (var i = 0; i < _config.Row1Items.Count; i++)
            {
                var item = _config.Row1Items[i];
                <li class="@(item.IsSelected ? "selected" : "") @(_overflowedIndices.Contains(i) ? "nav-item-overflow" : "")"
                    data-nav-index="@i">
                    <a href="@item.Url">
                        <div class="icon @item.IconClass">@ResolveLabel(item)</div>
                    </a>
                </li>
            }
            @if (HasOverflow)
            {
                <li class="nav-more-item">
                    <MudMenu ActivationEvent="@MouseEvent.LeftClick"
                             AnchorOrigin="Origin.BottomLeft"
                             TransformOrigin="Origin.TopLeft"
                             Dense="true">
                        <ActivatorContent>
                            <div class="nav-more-activator">
                                <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" />
                                <span>Mere</span>
                            </div>
                        </ActivatorContent>
                        <ChildContent>
                            @* Items rendered in their original visual order, regardless of drop priority. *@
                            @foreach (var (item, index) in _config.Row1Items.Select((item, i) => (item, i)).Where(x => _overflowedIndices.Contains(x.i)))
                            {
                                <MudMenuItem Href="@item.Url">@ResolveLabel(item)</MudMenuItem>
                            }
                        </ChildContent>
                    </MudMenu>
                </li>
            }
        </ul>
        <ul class="menu-items menu-items-right">
            @if (_portalsCollapsed)
            {
                @* All portal items have dropped off — show a single "Portals" dropdown *@
                <li class="nav-portals-item">
                    <MudMenu ActivationEvent="@MouseEvent.LeftClick"
                             AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight"
                             Dense="true">
                        <ActivatorContent>
                            <div class="icon icon-portals">@Localization.GetText("Portals")</div>
                        </ActivatorContent>
                        <ChildContent>
                            @foreach (var item in _config.Row1RightItems)
                            {
                                <MudMenuItem Href="@item.Url">@ResolveLabel(item)</MudMenuItem>
                            }
                        </ChildContent>
                    </MudMenu>
                </li>
            }
            else
            {
                @* Portals shown individually — each gets a data-portal-index for measurement *@
                @for (var i = 0; i < _config.Row1RightItems.Count; i++)
                {
                    var item = _config.Row1RightItems[i];
                    <li data-portal-index="@i">
                        <a href="@item.Url">
                            <div class="icon @item.IconClass">@ResolveLabel(item)</div>
                        </a>
                    </li>
                }
            }
        </ul>
    </div>

    @* Row 2: Secondary tabs *@
    <div class="row-2">
        <ul class="menu-items menu-items-left">
            @foreach (var item in Row2MainItems)
            {
                <li class="@(item.IsSelected ? "selected" : "")">
                    <a href="@item.Url">
                        <div>@ResolveLabel(item)</div>
                    </a>
                </li>
            }
            @if (HasRow2Others)
            {
                <li class="nav-row2-others-item @(Row2OthersItems.Any(i => i.IsSelected) ? "selected" : "")">
                    <MudMenu ActivationEvent="@MouseEvent.LeftClick"
                             AnchorOrigin="Origin.BottomLeft"
                             TransformOrigin="Origin.TopLeft"
                             Dense="true">
                        <ActivatorContent>
                            <div class="nav-row2-others-activator">
                                @Localization.GetText("Others")
                                <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" />
                            </div>
                        </ActivatorContent>
                        <ChildContent>
                            @foreach (var item in Row2OthersItems)
                            {
                                <MudMenuItem Href="@item.Url">@ResolveLabel(item)</MudMenuItem>
                            }
                        </ChildContent>
                    </MudMenu>
                </li>
            }
        </ul>
        <ul class="menu-items menu-items-right">
            <li class="user-menu">
                <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
                         Dense="true" PopoverClass="user-menu-popover"
                         ActivationEvent="@MouseEvent.MouseOver">
                    <ActivatorContent>
                        <div class="user-menu-activator">
                            @if (Session.IsImpersonating)
                            {
                                @(Session.ImpersonatedByFullName ?? Session.UserName)
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Filled" Class="impersonate-chip">
                                    Optræder som @(Session.FullName ?? Session.UserName)
                                </MudChip>
                                <span @onclick:stopPropagation="true">
                                    <MudSwitch T="bool" Value="@true" ValueChanged="OnImpersonateToggled"
                                               Color="Color.Warning" Size="Size.Small" Class="impersonate-toggle" />
                                </span>
                            }
                            else
                            {
                                @(Session.IsInitialized ? (Session.FullName ?? Session.UserName) : "User")
                            }
                            <img class="user-icon" src="/Responsive/images/responsive/top-menu/user_44x44.png" alt="User" />
                        </div>
                    </ActivatorContent>
                    <ChildContent>
                        @if (!Session.IsImpersonating)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Person"
                                         OnClick="OpenProfileDialogAsync">
                                @Localization.GetText("Profile")
                            </MudMenuItem>
                            @* Change Password — will be a Blazor dialog in a future phase *@
                            <MudMenuItem Icon="@Icons.Material.Filled.Key">
                                @Localization.GetText("ChangePassword")
                            </MudMenuItem>
                            @if (_isInternal)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.ManageAccounts"
                                             OnClick="OpenImpersonateDialogAsync">
                                    @Localization.GetText("Impersonate")
                                </MudMenuItem>
                            }
                            <MudDivider />
                        }
                        <MudMenuItem Icon="@(_themeState.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                     OnClick="ToggleDarkMode">
                            @(_themeState.IsDarkMode ? "Light mode" : "Dark mode")
                        </MudMenuItem>
                        @if (!Session.IsImpersonating)
                        {
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout"
                                         OnClick="NavigateToLogout">
                                @Localization.GetText("Logout")
                            </MudMenuItem>
                        }
                    </ChildContent>
                </MudMenu>
            </li>
        </ul>
    </div>

    @* Row 3: Tertiary sub-navigation (hidden if empty) *@
    @if (_config.Row3Items.Count > 0)
    {
        <div class="row-3">
            <ul class="menu-items menu-items-left">
                @foreach (var item in _config.Row3Items)
                {
                    <li class="@(item.IsSelected ? "selected" : "")">
                        <a href="@item.Url">
                            <div>@ResolveLabel(item)</div>
                        </a>
                    </li>
                }
            </ul>
        </div>
    }
</nav>

@* ============================================================
   Mobile Navigation — shown at ≤767px, hidden on desktop
   ============================================================ *@
<nav class="top-menu-mobile @(_mobileMenuOpen ? "expanded" : "")">
    @* Row 1: fixed header bar — always visible *@
    <div class="row-1">
        @* Left panel: portal name — animates open when menu expands *@
        <div class="menu-items-left" @onclick="ToggleMobileMenu">
            <div class="top-logo">
                <div>@ResolvePortalName()</div>
            </div>
        </div>
        @* Right panel: burger + page title + user icon *@
        <div class="menu-items-right">
            <div class="burger-menu-icon" @onclick="ToggleMobileMenu">
                <div></div>
            </div>
            <div class="current-page">
                <div>@ResolveMobilePageTitle()</div>
            </div>
            <div class="mobile-user-icon">
                <MudMenu ActivationEvent="@MouseEvent.LeftClick"
                         AnchorOrigin="Origin.BottomRight"
                         TransformOrigin="Origin.TopRight"
                         Dense="true">
                    <ActivatorContent>
                        <img src="/Responsive/images/responsive/burger-menu/user_34x34.png" alt="User" />
                    </ActivatorContent>
                    <ChildContent>
                        @if (Session.IsImpersonating)
                        {
                            <MudMenuItem Disabled="true">
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Filled">
                                    Optræder som @(Session.FullName ?? Session.UserName)
                                </MudChip>
                            </MudMenuItem>
                            <MudDivider />
                        }
                        @* Portal links — cross-portal navigation (mobile only) *@
                        @foreach (var item in _config.Row1RightItems)
                        {
                            <MudMenuItem Href="@item.Url"
                                         Icon="@Icons.Material.Filled.OpenInNew">
                                @ResolveLabel(item)
                            </MudMenuItem>
                        }
                        <MudDivider />
                        @if (!Session.IsImpersonating)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Person"
                                         OnClick="OpenProfileDialogAsync">
                                @Localization.GetText("Profile")
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Key">
                                @Localization.GetText("ChangePassword")
                            </MudMenuItem>
                            @if (_isInternal)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.ManageAccounts"
                                             OnClick="OpenImpersonateDialogAsync">
                                    @Localization.GetText("Impersonate")
                                </MudMenuItem>
                            }
                            <MudDivider />
                        }
                        else
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.SwitchAccount"
                                         OnClick="() => OnImpersonateToggled(false)">
                                Stop med at optræde som
                            </MudMenuItem>
                            <MudDivider />
                        }
                        <MudMenuItem Icon="@(_themeState.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                     OnClick="ToggleDarkMode">
                            @(_themeState.IsDarkMode ? "Light mode" : "Dark mode")
                        </MudMenuItem>
                        @if (!Session.IsImpersonating)
                        {
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout"
                                         OnClick="NavigateToLogout">
                                @Localization.GetText("Logout")
                            </MudMenuItem>
                        }
                    </ChildContent>
                </MudMenu>
            </div>
        </div>
    </div>

    @* Row 2: expandable item list *@
    <div class="row-2">
        @* Primary nav items (Row 1) — with icons *@
        @foreach (var item in _config.Row1Items)
        {
            <div class="mobile-menu-item @item.IconClass @(item.IsSelected ? "selected" : "")">
                <a href="@item.Url"><div>@ResolveLabel(item)</div></a>
            </div>
        }
        @if (_config.Row2Items.Count > 0)
        {
            <div class="mobile-menu-separator"></div>
            @* Sub-tab items (Row 2) — no icons, indented *@
            @foreach (var item in _config.Row2Items)
            {
                <div class="mobile-menu-item mobile-menu-item-sub @(item.IsSelected ? "selected" : "")">
                    <a href="@item.Url"><div>@ResolveLabel(item)</div></a>
                </div>
            }
        }
        @if (_config.Row1RightItems.Count > 0)
        {
            <div class="mobile-menu-separator"></div>
            @* Portal switchers *@
            @foreach (var item in _config.Row1RightItems)
            {
                <div class="mobile-menu-item @item.IconClass">
                    <a href="@item.Url"><div>@ResolveLabel(item)</div></a>
                </div>
            }
        }
    </div>
</nav>
