@page "/recruiting/activities"
@page "/recruiting/activities/{Mode}"
@using SignaturPortal.Application.DTOs
@using SignaturPortal.Domain.Enums
@attribute [Authorize(Policy = "RecruitmentAccess")]

<PageTitle>@_headlineText</PageTitle>

@if (!_isClientUser || _canCreateActivityInCurrentMode)
{
    <div class="toolbar-row" style="display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: @(_showMoreFilters ? "8px" : "20px");">
        @if (!_isClientUser)
        {
            <MudAutocomplete T="ClientDropdownDto"
                             @ref="_clientAutocomplete"
                             Value="_selectedClient"
                             ValueChanged="OnClientChanged"
                             OpenChanged="OnClientDropdownOpenChanged"
                             SearchFunc="SearchClients"
                             ToStringFunc="@(c => c == null ? string.Empty : (c.IsEnabled ? c.ClientName : $"[{c.ClientName}]"))"
                             Label="@Localization.GetText("Client")"
                             Required="true"
                             Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                             Class="activity-client-autocomplete main-client-filter"
                             PopoverClass="activity-filter-popover"
                             MinCharacters="0"
                             MaxItems="null"
                             Strict="false"
                             Clearable="false" />
        }
        @if (_currentStatus == ERActivityStatus.Closed && !_isClientUser)
        {
            <MudDatePicker Date="_closedDateFrom"
                           DateChanged="OnClosedDateFromChanged"
                           Label="@Localization.GetText("From")"
                           DateFormat="dd-MM-yyyy"
                           Margin="Margin.Dense" Variant="Variant.Outlined"
                           Class="activity-date-picker"
                           Clearable="true" />
            <MudDatePicker Date="_closedDateTo"
                           DateChanged="OnClosedDateToChanged"
                           Label="@Localization.GetText("To")"
                           DateFormat="dd-MM-yyyy"
                           Margin="Margin.Dense" Variant="Variant.Outlined"
                           Class="activity-date-picker"
                           Clearable="true" />
        }
        @if (_canCreateActivityInCurrentMode)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.AddCircle"
                       OnClick="OnCreateActivityClick"
                       Class="btn-create-activity"
                       Style="margin-top: 4px; text-transform: none; background-color: var(--mud-palette-primary-darken);">
                @_createButtonText
            </MudButton>
        }
        @if (!_isClientUser)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="ToggleMoreFilters"
                       Class="btn-more-filters"
                       Style="margin-top: 4px; text-transform: none; min-width: 90px;">
                @_moreButtonText
            </MudButton>
        }
    </div>
}

@if (!_isClientUser)
{
    <MudCollapse Expanded="_showMoreFilters">
        <div class="toolbar-row" style="display: inline-flex; gap: 12px; flex-wrap: wrap; margin-bottom:8px; padding: 4px 0 12px 0; align-items: flex-end;">
            <MudAutocomplete T="UserDropdownDto" 
                             @ref="_createdByAutocomplete"
                             Value="_createdByFilterUser"
                             ValueChanged="OnCreatedByFilterChanged"
                             OpenChanged="OnCreatedByDropdownOpenChanged"
                             SearchFunc="SearchCreatedByUsers"
                             ToStringFunc="@(u => u?.DisplayName ?? string.Empty)"
                             Label="@Localization.GetText("CreatedBy")"
                             Placeholder="@Localization.GetText("All")"
                             Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                             ShrinkLabel="true"
                             Class="activity-client-autocomplete" Style="min-width: 175px; max-width: 280px;"
                             PopoverClass="activity-filter-popover"
                             MinCharacters="0"
                             MaxItems="null"
                             Strict="false"
                             Clearable="true" />
            <MudAutocomplete T="UserDropdownDto"
                             @ref="_recruitmentResponsibleAutocomplete"
                             Value="_recruitmentResponsibleFilterUser"
                             ValueChanged="OnRecruitmentResponsibleFilterChanged"
                             OpenChanged="OnRecruitmentResponsibleDropdownOpenChanged"
                             SearchFunc="SearchRecruitmentResponsibleUsers"
                             ToStringFunc="@(u => u?.DisplayName ?? string.Empty)"
                             Label="@Localization.GetText(_recruitingResponsableKey)"
                             Placeholder="@Localization.GetText("All")"
                             Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                             ShrinkLabel="true"
                             Class="activity-client-autocomplete" Style="min-width: 175px; max-width: 280px;"
                             PopoverClass="activity-filter-popover"
                             MinCharacters="0"
                             MaxItems="null"
                             Strict="false"
                             Clearable="true" />
            <MudAutocomplete T="ClientSectionDropdownDto"
                             @ref="_clientSectionAutocomplete"
                             Value="_clientSectionFilterSection"
                             ValueChanged="OnClientSectionFilterChanged"
                             OpenChanged="OnClientSectionDropdownOpenChanged"
                             SearchFunc="SearchClientSections"
                             ToStringFunc="@(s => s?.Name ?? string.Empty)"
                             Label="@Localization.GetText("ClientSection")"
                             Placeholder="@Localization.GetText("All")"
                             Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                             ShrinkLabel="true"
                             Class="activity-client-autocomplete" Style="min-width: 175px; max-width: 280px;"
                             PopoverClass="activity-filter-popover"
                             MinCharacters="0"
                             MaxItems="null"
                             Strict="false"
                             Clearable="true" />
            @if (_clientUsesTemplateGroups && _currentStatus != ERActivityStatus.Draft)
            {
                <MudAutocomplete T="TemplateGroupDropdownDto"
                                 @ref="_templateGroupAutocomplete"
                                 Value="_templateGroupFilterItem"
                                 ValueChanged="OnTemplateGroupFilterChanged"
                                 OpenChanged="OnTemplateGroupDropdownOpenChanged"
                                 SearchFunc="SearchTemplateGroups"
                                 ToStringFunc="@(g => g?.Name ?? string.Empty)"
                                 Label="@Localization.GetText("TemplateGroup")"
                                 Placeholder="@Localization.GetText("All")"
                                 Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                                 ShrinkLabel="true"
                                 Class="activity-client-autocomplete" Style="min-width: 175px; max-width: 280px;"
                                 PopoverClass="activity-filter-popover"
                                 MinCharacters="0"
                                 MaxItems="null"
                                 Strict="false"
                                 Clearable="true" />
            }
            @if (!_clientUsesTemplateGroups && _filterClientSectionGroups.Count > 0)
            {
                <MudAutocomplete T="ClientSectionGroupDropdownDto"
                                 @ref="_clientSectionGroupAutocomplete"
                                 Value="_clientSectionGroupFilterItem"
                                 ValueChanged="OnClientSectionGroupFilterChanged"
                                 OpenChanged="OnClientSectionGroupDropdownOpenChanged"
                                 SearchFunc="SearchClientSectionGroups"
                                 ToStringFunc="@(g => g?.Name ?? string.Empty)"
                                 Label="@Localization.GetText("ClientSectionGroup")"
                                 Placeholder="@Localization.GetText("All")"
                                 Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                                 ShrinkLabel="true"
                                 Class="activity-client-autocomplete" Style="min-width: 175px; max-width: 280px;"
                                 PopoverClass="activity-filter-popover"
                                 MinCharacters="0"
                                 MaxItems="null"
                                 Strict="false"
                                 Clearable="true" />
            }
        </div>
        @if (_canExportActivityMembers)
        {
            <div style="margin-bottom: 20px;">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.FileDownload"
                           OnClick="OnExportActivityMembersClick"
                           Class="btn-export-activity-members"
                           Style="text-transform: none;">
                    @Localization.GetText("ExportActivityMembers")
                </MudButton>
            </div>
        }
    </MudCollapse>
}

<div class="list-desktop">
<MudDataGrid T="ActivityListDto"
             @ref="_dataGrid"
             ServerData="LoadServerData"
             Filterable="@_showFilters"
             FilterMode="DataGridFilterMode.ColumnFilterRow"
             SortMode="SortMode.Multiple"
             Hover="true"
             RowClick="OnRowClick"
             RowClassFunc="@((item, _) => GetActivityRowCombinedClass(item))"
             RowStyle="cursor: pointer;"
             Class="portal-data-grid">
    <ToolBarContent>
        <MudText Typo="Typo.body1" Style="font-weight:bold; font-size:var(--portal-grid-headline-font-size);">@_headlineText</MudText>
        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Default"
                 Style="background:var(--mud-palette-surface); font-weight:bold; font-size:12px; margin-left:8px;">@_totalCount.ToString()</MudChip>
        @if (_hasActiveMoreFilters)
        {
            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Default"
                     Style="background:var(--mud-palette-surface); font-weight:bold; font-size:12px; margin-left:4px; color: darkorange;">
                @Localization.GetText("Filter")
            </MudChip>
        }
        <MudSpacer />
        <MudTooltip Text="@(_showFilters ? Localization.GetText("HideFilter") : Localization.GetText("ShowFilter"))">
            <MudIconButton Icon="@Icons.Material.Filled.FilterList"
                           Color="@(_showFilters ? Color.Primary : Color.Default)"
                           OnClick="ToggleFilters" />
        </MudTooltip>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x.EractivityId" Title="@Localization.GetText("Id")" HeaderStyle="width:80px;" CellStyle="text-align:right;">
            <CellTemplate>
                @{ var idTooltip = GetIdCellTooltip(context.Item); }
                @if (!string.IsNullOrEmpty(idTooltip))
                {
                    <MudTooltip Text="@idTooltip" Placement="Placement.Right">
                        <span>@context.Item.EractivityId</span>
                    </MudTooltip>
                }
                else
                {
                    @context.Item.EractivityId
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Headline" Title="@Localization.GetText("Headline")">
            <CellTemplate>
                @* Icon 1: Email warning — non-client users with EditActivitiesNotMemberOf permission *@
                @if (!_hideEmailWarningIconColumn
                     && context.Item.EractivityStatusId == (int)ERActivityStatus.OnGoing
                     && context.Item.MembersMissingNotificationEmail > 0)
                {
                    <MudTooltip Text="@GetEmailWarningTooltip(context.Item)" Placement="Placement.Bottom">
                        <img src="/Responsive/images/responsive/list/email-warning-gray_36x32.png"
                             alt="Email warning"
                             style="width:18px; height:16px; cursor:default; opacity:0.85; margin-right:4px; vertical-align:middle;"
                             @onclick:stopPropagation="true" />
                    </MudTooltip>
                }
                @* Icon 2: Web ad status — client users with ShowWebAdStatusInActivityList config *@
                @if (!_hideWebAdStatusIconColumn
                     && context.Item.EractivityStatusId == (int)ERActivityStatus.OnGoing)
                {
                    var webAdIconSrc = GetWebAdStatusIconSrc(context.Item);
                    if (!string.IsNullOrEmpty(webAdIconSrc))
                    {
                        var tooltipKey = GetWebAdStatusTooltipKey(context.Item);
                        <MudTooltip Text="@Localization.GetText(tooltipKey)" Placement="Placement.Bottom">
                            <img src="@webAdIconSrc"
                                 alt="Web ad status"
                                 style="width:18px; height:18px; cursor:pointer; opacity:0.85; margin-right:4px; vertical-align:middle;"
                                 @onclick="() => NavigateToActivityAdTab(context.Item.EractivityId)"
                                 @onclick:stopPropagation="true" />
                        </MudTooltip>
                    }
                }
                @* Icon 3: Web ad changes — client users with WebAdSendMailOnAdChanges + PublishWebAd *@
                @if (!_hideWebAdChangesIconColumn
                     && context.Item.HasWebAdChanges
                     && !string.IsNullOrEmpty(context.Item.WebAdChangeSummary))
                {
                    <MudTooltip Text="@GetWebAdChangesTooltip(context.Item)" Placement="Placement.Bottom">
                        <img src="/Responsive/images/responsive/list/insertion-is-new_28x36.png"
                             alt="Web ad changes"
                             style="width:14px; height:18px; cursor:default; opacity:0.85; margin-right:4px; vertical-align:middle;"
                             @onclick:stopPropagation="true" />
                    </MudTooltip>
                }
                @* Headline text *@
                @if (_showCandidateCount && context.Item.CandidateCount > 0)
                {
                    @($"{context.Item.Headline} ({context.Item.CandidateCount})")
                }
                else
                {
                    @context.Item.Headline
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.WebAdVisitors" Title="@Localization.GetText("MSFNumberOfClicks")" Sortable="false" Hidden="@_hideVisitorsColumn" HeaderStyle="width:108px;" CellStyle="text-align:right;" />
        <PropertyColumn Property="x => x.ApplicationDeadline" Title="@Localization.GetText("ApplicationDeadline")" HeaderStyle="width:120px;">
            <CellTemplate>
                @if (context.Item.ContinuousPosting)
                {
                    <MudTooltip Text="@Localization.GetText("ContinuousPosting")">
                        <span>-</span>
                    </MudTooltip>
                }
                else
                {
                    @context.Item.ApplicationDeadline.ToString("dd-MM-yyyy")
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.DraftAreaName" Title="@Localization.GetText(_draftAreaHeaderKey)" Sortable="false" Hidden="@_hideDraftAreaColumn" HeaderStyle="width:170px;" />
        <PropertyColumn Property="x => x.ClientSectionName" Title="@Localization.GetText("ClientSection")" Hidden="@_hideClientSectionColumn" HeaderStyle="width:240px;" />
        <PropertyColumn Property="x => x.RecruitingResponsibleName" Title="@Localization.GetText(_recruitingResponsableKey)" Sortable="false" HeaderStyle="width:150px;" />
        <PropertyColumn Property="x => x.CreateDate" Title="@Localization.GetText("CreateDate")" Format="dd-MM-yyyy" InitialDirection="SortDirection.Descending" HeaderStyle="width:110px;" />
        <PropertyColumn Property="x => x.CreatedByName" Title="@Localization.GetText("CreatedBy")" Sortable="false" Hidden="@_hideCreatedByColumn" HeaderStyle="width:130px;" />
        <PropertyColumn Property="x => x.DraftResponsibleName" Title="@Localization.GetText(_draftResponsibleHeaderKey)" Sortable="false" Hidden="@_hideDraftResponsibleColumn" HeaderStyle="width:170px;" />
        <PropertyColumn Property="x => x.TemplateGroupName" Title="@Localization.GetText("TemplateGroup")" Hidden="@_hideTemplateGroupColumn" HeaderStyle="width:140px;" />
        <TemplateColumn T="ActivityListDto" Hidden="@_hideActionsColumn" Sortable="false" Filterable="false"
                        HeaderStyle="@($"width:{_actionsColumnWidth}; padding:0;")" CellStyle="padding:2px 4px; text-align:center;">
            <CellTemplate>
                <img src="/Responsive/images/responsive/list/copy-gray_32x32.png"
                     alt="Copy"
                     style="width:20px; height:20px; cursor:pointer; opacity:0.7;"
                     title="@Localization.GetText("CopyActivity")"
                     @onclick="() => CopyActivity(context.Item.EractivityId)"
                     @onclick:stopPropagation="true" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="ActivityListDto" PageSizeOptions="new int[] { 10, 25, 50, 100 }" InfoFormat="@_pagerInfoFormat" RowsPerPageString="@Localization.GetText("RowsPerPage")" />
    </PagerContent>
    <NoRecordsContent>
        <MudText>@Localization.GetText("NoActivities")</MudText>
    </NoRecordsContent>
</MudDataGrid>
</div>

@* ── MOBILE CARD LIST ──────────────────────────────────────────────────── *@
<div class="list-mobile-header">
    <span class="list-mobile-title">@_headlineText</span>
    <span class="list-mobile-badge">@_totalCount</span>
    @if (_hasActiveMoreFilters)
    {
        <span class="list-mobile-badge list-mobile-badge-filter">@Localization.GetText("Filter")</span>
    }
</div>
<div class="list-mobile">
    @if (_mobileDataLoaded && _mobileItems.Count == 0)
    {
        <MudText Class="list-mobile-empty">@Localization.GetText("NoActivities")</MudText>
    }
    @foreach (var item in _mobileItems)
    {
        var isExpanded = _expandedActivityIds.Contains(item.EractivityId);
        <div class="list-item-mobile">
            <div class="@GetMobileCardHeadlineClass(item)"
                 @onclick="() => OnMobileCardClick(item)">
                @if (!_hideEmailWarningIconColumn
                     && item.EractivityStatusId == (int)ERActivityStatus.OnGoing
                     && item.MembersMissingNotificationEmail > 0)
                {
                    <img src="/Responsive/images/responsive/list/email-warning-gray_36x32.png"
                         style="width:18px; height:16px; opacity:0.85; margin-right:4px; vertical-align:middle;" />
                }
                @if (!_hideWebAdStatusIconColumn
                     && item.EractivityStatusId == (int)ERActivityStatus.OnGoing)
                {
                    var webAdIconSrc = GetWebAdStatusIconSrc(item);
                    if (!string.IsNullOrEmpty(webAdIconSrc))
                    {
                        <img src="@webAdIconSrc"
                             style="width:18px; height:18px; opacity:0.85; margin-right:4px; vertical-align:middle;" />
                    }
                }
                @if (!_hideWebAdChangesIconColumn
                     && item.HasWebAdChanges
                     && !string.IsNullOrEmpty(item.WebAdChangeSummary))
                {
                    <img src="/Responsive/images/responsive/list/insertion-is-new_28x36.png"
                         style="width:14px; height:18px; opacity:0.85; margin-right:4px; vertical-align:middle;" />
                }
                <span class="list-item-headline-text">@GetMobileHeadlineText(item)</span>
                @{ var mobileTooltip = GetMobileCardTooltip(item); }
                @if (!string.IsNullOrEmpty(mobileTooltip))
                {
                    <MudTooltip Text="@mobileTooltip" Placement="Placement.Left">
                        <span class="list-item-tooltip-trigger"
                              @onclick:stopPropagation="true"
                              @onclick="() => Snackbar.Add(mobileTooltip, Severity.Info)">
                        </span>
                    </MudTooltip>
                }
                <button class="list-item-expand-btn @(isExpanded ? "expanded" : "")"
                        @onclick:stopPropagation="true"
                        @onclick="() => ToggleMobileCard(item.EractivityId)">
                </button>
            </div>
            <div class="list-item-content @(isExpanded ? "expanded" : "")">
                <div class="list-item-field">
                    <span class="list-item-label">@Localization.GetText("Status")</span>
                    <span class="list-item-value">@GetStatusDisplayText(item)</span>
                </div>
                <div class="list-item-field">
                    <span class="list-item-label">@Localization.GetText("ApplicationDeadline")</span>
                    <span class="list-item-value">@GetDeadlineDisplay(item)</span>
                </div>
                @if (!_hideClientSectionColumn && !string.IsNullOrEmpty(item.ClientSectionName))
                {
                    <div class="list-item-field">
                        <span class="list-item-label">@Localization.GetText("ClientSection")</span>
                        <span class="list-item-value">@item.ClientSectionName</span>
                    </div>
                }
                <div class="list-item-field">
                    <span class="list-item-label">@Localization.GetText(_recruitingResponsableKey)</span>
                    <span class="list-item-value">@item.RecruitingResponsibleName</span>
                </div>
                <div class="list-item-field">
                    <span class="list-item-label">@Localization.GetText("CreateDate")</span>
                    <span class="list-item-value">@item.CreateDate.ToString("dd-MM-yyyy")</span>
                </div>
                @if (!_hideCreatedByColumn && !string.IsNullOrEmpty(item.CreatedByName))
                {
                    <div class="list-item-field">
                        <span class="list-item-label">@Localization.GetText("CreatedBy")</span>
                        <span class="list-item-value">@item.CreatedByName</span>
                    </div>
                }
            </div>
        </div>
    }
</div>

@* ── MOBILE PAGER ──────────────────────────────────────────────────────── *@
<div class="list-mobile-pager">
    <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                   Disabled="@(_mobileCurrentPage == 0)"
                   OnClick="MobilePrevPage" />
    <span class="mobile-pager-info">@(_mobileCurrentPage + 1) / @TotalMobilePages</span>
    <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                   Disabled="@(_mobileCurrentPage >= TotalMobilePages - 1)"
                   OnClick="MobileNextPage" />
</div>

<MudMessageBox @ref="_noActivitiesDialog"
               Title="@Localization.GetText("ActivityList")">
    <MessageContent>
        @Localization.GetText(_noActivitiesDisclaimerKey)
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="text-transform:none;">
            @Localization.GetText("Ok")
        </MudButton>
    </YesButton>
</MudMessageBox>
