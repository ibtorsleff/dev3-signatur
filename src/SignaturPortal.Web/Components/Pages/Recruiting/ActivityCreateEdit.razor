@page "/recruiting/activities/new"
@page "/recruiting/activities/{ActivityId:int}/edit"
@attribute [Authorize(Policy = "RecruitmentAccess")]
@using Microsoft.AspNetCore.Authorization
@using SignaturPortal.Application.DTOs
@using SignaturPortal.Application.Interfaces
@using SignaturPortal.Web.Components.Shared.Recruiting

@* Fix: MudSelect flex container blocks margin collapsing vs MudAutocomplete block display.
   Zeroing mud-input-control top margin normalises gap across all input types. *@
<HeadContent>
    <style>
        .activity-form .mud-input-control {
            margin-top: 0 !important;
        }
    </style>
</HeadContent>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}
else if (_loadError != null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">@_loadError</MudAlert>
}
else
{
    <EditForm Model="_form" OnValidSubmit="OnSaveAsync" class="activity-form">
        <DataAnnotationsValidator />

        @if (_saveError != null)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="() => _saveError = null">@_saveError</MudAlert>
        }

        @* ── Action buttons ── *@
        <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap" Class="mb-4">
            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="_saving"
                       StartIcon="@Icons.Material.Filled.Save">
                @Localization.GetText("Save")
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       OnClick="OnCancelAsync"
                       Disabled="_saving"
                       StartIcon="@Icons.Material.Filled.Cancel">
                @Localization.GetText("Cancel")
            </MudButton>
            @if (IsEditMode)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           OnClick="OnDeleteAsync"
                           Disabled="_saving"
                           StartIcon="@Icons.Material.Filled.Delete">
                    @Localization.GetText("Delete")
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="OnCloseActivityAsync"
                           Disabled="_saving"
                           StartIcon="@Icons.Material.Filled.Done">
                    @Localization.GetText("CloseActivity")
                </MudButton>
            }
        </MudStack>

        <MudGrid>
            @* ── LEFT COLUMN ── *@
            <MudItem xs="12" md="8">

                @* ── Stamdata card ── *@
                <MudPaper Class="pa-4 mb-4" Elevation="1">
                    <MudText Typo="Typo.h6" Class="mb-3">@Localization.GetText("MasterData")</MudText>

                    @* Oprettet af *@
                    <div class="form-row">
                        <span class="form-label">@Localization.GetText("CreatedBy")</span>
                        <div class="form-input">
                            <MudText Typo="Typo.body2" Style="padding-top:6px">
                                @(IsEditMode ? _editData?.CreatedByName : _currentUserDisplayName)
                            </MudText>
                        </div>
                    </div>

                    @* Status *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("Status") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            @if (IsDraftActivity)
                            {
                                <MudText Typo="Typo.body2" Style="padding-top:6px">@Localization.GetText("Draft")</MudText>
                            }
                            else
                            {
                                <MudSelect T="int?"
                                           @bind-Value="_form.StatusId"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense">
                                    @foreach (var status in _options.Statuses.Where(s => s.Id != 3 || IsDeletedActivity)
                                                                              .Where(s => s.Id != 4))
                                    {
                                        <MudSelectItem Value="@((int?)status.Id)">@status.Name</MudSelectItem>
                                    }
                                </MudSelect>
                                <ValidationMessage For="@(() => _form.StatusId)" />
                            }
                        </div>
                    </div>

                    @* Kunde (non-client users only) *@
                    @if (!_isClientUser)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("Client") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudAutocomplete T="ClientDropdownDto"
                                                 @ref="_clientAutocomplete"
                                                 Value="_selectedClient"
                                                 ValueChanged="OnClientChangedAsync"
                                                 SearchFunc="SearchClientsAsync"
                                                 ToStringFunc="@(c => c == null ? string.Empty : (c.IsEnabled ? c.ClientName : $"[{c.ClientName}]"))"
                                                 Variant="Variant.Outlined"
                                                 Margin="Margin.Dense"
                                                 MinCharacters="0"
                                                 MaxItems="null"
                                                 Strict="false"
                                                 CoerceValue="true" />
                            </div>
                        </div>
                    }

                    @* Overskrift *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("Headline") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudTextField T="string"
                                          @bind-Value="_form.Headline"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          MaxLength="70"
                                          Counter="70" />
                            <ValidationMessage For="@(() => _form.Headline)" />
                        </div>
                    </div>

                    @* Jobtitel *@
                    <div class="form-row">
                        <label class="form-label">@(_clientConfig.IsFundClient ? Localization.GetText("ERecruitmentJobtitleOnlyForCandidateEmailsFund") : Localization.GetText("ERecruitmentJobtitleOnlyForCandidateEmails"))</label>
                        <div class="form-input">
                            <MudTextField T="string"
                                          @bind-Value="_form.JobTitle"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          MaxLength="70" />
                        </div>
                    </div>

                    @* Stillingsbetegnelse (Jobnet Occupation) *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("ERActivityJobnetOccupation") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudAutocomplete T="SimpleOptionDto"
                                             Value="_selectedOccupation"
                                             ValueChanged="OnOccupationChangedAsync"
                                             SearchFunc="SearchOccupationsAsync"
                                             ToStringFunc="@(o => o?.Name ?? string.Empty)"
                                             Variant="Variant.Outlined"
                                             Margin="Margin.Dense"
                                             MinCharacters="0"
                                             MaxItems="50"
                                             CoerceValue="true">
                                <NoItemsTemplate>
                                    <MudText Typo="Typo.body2" Class="px-4 py-2 mud-text-secondary">Skriv for at søge...</MudText>
                                </NoItemsTemplate>
                            </MudAutocomplete>
                        </div>
                    </div>

                    @* Afdelingsgruppe (conditional) *@
                    @if (_clientConfig.UseClientSectionGroups)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("ClientSectionGroup")</label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           Value="_form.ClientSectionGroupId"
                                           ValueChanged="OnSectionGroupChangedAsync"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Disabled="@TemplateInputsDisabled">
                                    <MudSelectItem Value="@((int?)null)">—</MudSelectItem>
                                    @foreach (var group in _options.ClientSectionGroups)
                                    {
                                        <MudSelectItem Value="@((int?)group.ClientSectionGroupId)">@group.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </div>
                        </div>
                    }

                    @* Afdeling *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("ClientSection") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudAutocomplete T="ClientSectionDropdownDto"
                                             @ref="_clientSectionAutocomplete"
                                             Value="_selectedClientSection"
                                             ValueChanged="OnClientSectionChangedAsync"
                                             SearchFunc="SearchClientSectionsAsync"
                                             ToStringFunc="@(cs => cs?.Name ?? string.Empty)"
                                             Variant="Variant.Outlined"
                                             Margin="Margin.Dense"
                                             MinCharacters="0"
                                             CoerceValue="true"
                                             Disabled="@TemplateInputsDisabled" />
                            <ValidationMessage For="@(() => _form.ClientSectionId)" />
                        </div>
                    </div>

                    @* Genopslag *@
                    <div class="form-row form-row-checkbox">
                        <span class="form-label">@Localization.GetText("Reposting")</span>
                        <div class="form-input">
                            <MudCheckBox T="bool" @bind-Value="_form.Reposting" Dense="true" />
                        </div>
                    </div>

                    @* Rekrutteringstype — conditional on client config flags *@
                    @if (ShowCombinedRecruitmentTypeDropdown)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("RecruitmentType") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           @bind-Value="_form.RecruitmentTypeId"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense">
                                    <MudSelectItem Value="@((int?)null)">—</MudSelectItem>
                                    @foreach (var opt in _options.RecruitmentTypes)
                                    {
                                        <MudSelectItem Value="@((int?)opt.Id)">@opt.Name</MudSelectItem>
                                    }
                                </MudSelect>
                                <ValidationMessage For="@(() => _form.RecruitmentTypeId)" />
                            </div>
                        </div>
                    }
                    @if (ShowLeadershipPositionDropdown)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("LeadershipPosition") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           @bind-Value="_form.LeadershipPositionId"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense">
                                    <MudSelectItem Value="@((int?)null)">—</MudSelectItem>
                                    <MudSelectItem Value="@((int?)1)">@Localization.GetText("Yes")</MudSelectItem>
                                    <MudSelectItem Value="@((int?)2)">@Localization.GetText("No")</MudSelectItem>
                                </MudSelect>
                            </div>
                        </div>
                    }
                    @if (ShowBlindRecruitmentDropdown)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("BlindRecruitment") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           @bind-Value="_form.BlindRecruitmentId"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense">
                                    <MudSelectItem Value="@((int?)null)">—</MudSelectItem>
                                    <MudSelectItem Value="@((int?)1)">@Localization.GetText("Yes")</MudSelectItem>
                                    <MudSelectItem Value="@((int?)2)">@Localization.GetText("No")</MudSelectItem>
                                </MudSelect>
                            </div>
                        </div>
                    }

                    @* Lock/View Evaluation (conditional) *@
                    @if (_clientConfig.LockEvaluationFeatureEnabled)
                    {
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("HideCandidateEvalutionAndNotesWhenUserHasNotEvaluated")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.LockCandidateEvaluation" Dense="true" />
                            </div>
                        </div>
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("ViewRecruitmentCommitteeEvaluations")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.ViewCommitteeEvaluations" Dense="true" />
                            </div>
                        </div>
                    }

                    @* Send mail ved ny ansøger *@
                    <div class="form-row form-row-checkbox">
                        <span class="form-label">@Localization.GetText("SendEmailOnNewCandidate")</span>
                        <div class="form-input">
                            <MudCheckBox T="bool" @bind-Value="_form.SendEmailOnNewCandidate" Dense="true" />
                        </div>
                    </div>

                    @* Send daglig statusmail (conditional) *@
                    @if (_clientConfig.SendDailyStatusMailEnabled)
                    {
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("SendDailyStatusMail")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.SendDailyStatusMail" Dense="true" />
                            </div>
                        </div>
                    }

                    @* Løbende opslag (conditional) *@
                    @if (_clientConfig.ContinuousPostingEnabled)
                    {
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("ContinuousPosting")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.ContinuousPosting" Dense="true" />
                            </div>
                        </div>
                    }

                    @* Ansøgningsfrist (hidden when continuous posting) *@
                    @if (!_form.ContinuousPosting)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("ApplicationDeadline") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudStack Row="true" Spacing="1">
                                    <MudDatePicker @bind-Date="_form.ApplicationDeadline"
                                                   Variant="Variant.Outlined"
                                                   Margin="Margin.Dense"
                                                   DateFormat="dd-MM-yyyy"
                                                   Style="flex:1" />
                                    <MudTimePicker Time="_applicationDeadlineTime"
                                                   TimeChanged="OnApplicationDeadlineTimeChanged"
                                                   Variant="Variant.Outlined"
                                                   Margin="Margin.Dense"
                                                   Style="width:110px" />
                                </MudStack>
                                <ValidationMessage For="@(() => _form.ApplicationDeadline)" />
                            </div>
                        </div>
                    }

                    @* Ansættelsesdato *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("HireDate")</label>
                        <div class="form-input">
                            <MudRadioGroup T="int" @bind-Value="_form.HireDateType" Class="mt-1">
                                <MudRadio Value="1" Dense="true">@Localization.GetText("Date")</MudRadio>
                                <MudRadio Value="2" Dense="true">@Localization.GetText("Freetext")</MudRadio>
                            </MudRadioGroup>
                            @if (_form.HireDateType == 1)
                            {
                                <MudDatePicker @bind-Date="_form.HireDate"
                                               Variant="Variant.Outlined"
                                               Margin="Margin.Dense"
                                               DateFormat="dd-MM-yyyy"
                                               Class="mt-2" />
                                <ValidationMessage For="@(() => _form.HireDate)" />
                            }
                            @if (_form.HireDateType == 2)
                            {
                                <MudTextField T="string"
                                              @bind-Value="_form.HireDateFreeText"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              MaxLength="100"
                                              Class="mt-2" />
                                <ValidationMessage For="@(() => _form.HireDateFreeText)" />
                            }
                        </div>
                    </div>

                    @* Samtalerunder (conditional) *@
                    @if (ShowInterviewRoundsDropdown)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("InterviewRounds") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           @bind-Value="_form.InterviewRounds"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense">
                                    <MudSelectItem Value="@((int?)null)">—</MudSelectItem>
                                    @foreach (var opt in _options.InterviewRoundsOptions)
                                    {
                                        <MudSelectItem Value="@((int?)opt.Id)">@opt.Name</MudSelectItem>
                                    }
                                </MudSelect>
                                <ValidationMessage For="@(() => _form.InterviewRounds)" />
                            </div>
                        </div>
                    }

                    @* Kalender (conditional) *@
                    @if (_clientConfig.CalendarEnabled)
                    {
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("ClosedCalendarEnabled")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.ClosedCalendarEnabled" Dense="true" />
                            </div>
                        </div>
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("OpenCalendarEnabled")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.OpenCalendarEnabled" Dense="true" />
                            </div>
                        </div>

                        @if (_form.ClosedCalendarEnabled && _form.OpenCalendarEnabled)
                        {
                            <div class="form-row">
                                <label class="form-label">@Localization.GetText("CalendarType") <span class="required-mark">*</span></label>
                                <div class="form-input">
                                    <MudSelect T="int?"
                                               @bind-Value="_form.CalendarTypeId"
                                               Variant="Variant.Outlined"
                                               Margin="Margin.Dense">
                                        <MudSelectItem Value="@((int?)null)">—</MudSelectItem>
                                        @foreach (var opt in _options.CalendarTypes)
                                        {
                                            <MudSelectItem Value="@((int?)opt.Id)">@opt.Name</MudSelectItem>
                                        }
                                    </MudSelect>
                                    <ValidationMessage For="@(() => _form.CalendarTypeId)" />
                                </div>
                            </div>
                        }

                        @if (_form.OpenCalendarEnabled)
                        {
                            <div class="form-row">
                                <label class="form-label">@Localization.GetText("InterviewDuration") <span class="required-mark">*</span></label>
                                <div class="form-input">
                                    <MudSelect T="int?"
                                               @bind-Value="_form.InterviewDurationId"
                                               Variant="Variant.Outlined"
                                               Margin="Margin.Dense">
                                        <MudSelectItem Value="@((int?)null)">—</MudSelectItem>
                                        @foreach (var opt in _options.InterviewDurations)
                                        {
                                            <MudSelectItem Value="@((int?)opt.Id)">@opt.Name</MudSelectItem>
                                        }
                                    </MudSelect>
                                    <ValidationMessage For="@(() => _form.InterviewDurationId)" />
                                </div>
                            </div>
                        }

                        @if (IsEditMode && ActivityId.HasValue)
                        {
                            <div class="form-row">
                                <span class="form-label">@Localization.GetText("InterviewSchedule")</span>
                                <div class="form-input">
                                    <MudLink Href="@($"/Responsive/Recruiting/OpenCalendarAdministration.aspx?ErId={ActivityId}")" Class="d-inline-block" Style="padding-top:6px">
                                        @Localization.GetText("InterviewSchedule") →
                                    </MudLink>
                                </div>
                            </div>
                        }
                    }

                    @* SMS Reminders (conditional) *@
                    @if (_clientConfig.AllowSendingSms && _clientConfig.CalendarEnabled)
                    {
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("SendSmsInterviewRemembrances")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.SendSmsInterviewReminders" Dense="true" />
                            </div>
                        </div>
                    }

                    @* Extended Evaluation (conditional) *@
                    @if (ShowExtendedEvaluation)
                    {
                        <div class="form-row form-row-checkbox">
                            <span class="form-label">@Localization.GetText("ExtendedEvaluationEnabled")</span>
                            <div class="form-input">
                                <MudCheckBox T="bool" @bind-Value="_form.ExtendedEvaluationEnabled" Dense="true" />
                            </div>
                        </div>
                        @if (_form.ExtendedEvaluationEnabled && IsEditMode && ActivityId.HasValue)
                        {
                            <div class="form-row">
                                <span class="form-label"></span>
                                <div class="form-input">
                                    <MudLink Href="@($"/Responsive/Recruiting/EvaluationCriteriaAdministration.aspx?ErId={ActivityId}")" Class="d-inline-block">
                                        @Localization.GetText("EvaluationCriteria") →
                                    </MudLink>
                                </div>
                            </div>
                        }
                    }

                    @* Language (conditional) *@
                    @if (_clientConfig.MultipleLanguagesEnabled && _options.Languages.Count > 0)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("Language") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudSelect T="int"
                                           MultiSelection="true"
                                           SelectedValues="_form.SelectedLanguageIds"
                                           SelectedValuesChanged="OnLanguagesChangedAsync"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense">
                                    @foreach (var lang in _options.Languages)
                                    {
                                        <MudSelectItem Value="@lang.Id">@lang.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </div>
                        </div>
                    }
                </MudPaper>

                @* ── Skabeloner card ── *@
                <MudPaper Class="pa-4 mb-4" Elevation="1">
                    <MudText Typo="Typo.h6" Class="mb-3">@Localization.GetText("Templates")</MudText>

                    @* Skabelongruppe (conditional) *@
                    @if (_clientConfig.UseTemplateGroups)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("WorkArea") / @Localization.GetText("TemplateGroup")</label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           Value="_form.TemplateGroupId"
                                           ValueChanged="OnTemplateGroupChangedAsync"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Disabled="@(_cascadeLoading || !_form.ClientId.HasValue)">
                                    <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                    @foreach (var tg in _options.TemplateGroups)
                                    {
                                        <MudSelectItem Value="@((int?)tg.TemplateGroupId)">@tg.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </div>
                        </div>
                    }

                    @* Ansøgningsskabelon *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("ApplicationTemplate") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudSelect T="int?"
                                       @bind-Value="_form.ApplicationTemplateId"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Disabled="@TemplateInputsDisabled">
                                <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                @foreach (var tmpl in _options.ApplicationTemplates)
                                {
                                    <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                }
                            </MudSelect>
                            <ValidationMessage For="@(() => _form.ApplicationTemplateId)" />
                        </div>
                    </div>

                    @* Modtagelsesmail *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("ReceivedEmail") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudSelect T="int?"
                                       @bind-Value="_form.EmailTemplateReceivedId"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Disabled="@TemplateInputsDisabled">
                                <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                @foreach (var tmpl in _options.EmailTemplatesReceived)
                                {
                                    <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                }
                            </MudSelect>
                            <ValidationMessage For="@(() => _form.EmailTemplateReceivedId)" />
                        </div>
                    </div>

                    @* Samtalemail, første runde *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText(_clientConfig.MultipleInterviewRoundsEnabled ? "InterviewEmailFirstRoundForSelected" : "InterviewEmailForSelected") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudSelect T="int?"
                                       @bind-Value="_form.EmailTemplateInterviewId"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Disabled="@TemplateInputsDisabled">
                                <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                @foreach (var tmpl in _options.EmailTemplatesInterview)
                                {
                                    <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                }
                            </MudSelect>
                            <ValidationMessage For="@(() => _form.EmailTemplateInterviewId)" />
                        </div>
                    </div>

                    @* Samtalemail, 2+ runder (conditional) *@
                    @if (_clientConfig.MultipleInterviewRoundsEnabled && (_form.InterviewRounds ?? 0) >= 2)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("InterviewEmailTwoPlusRoundsForSelected")</label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           @bind-Value="_form.EmailTemplateInterview2PlusId"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Disabled="@TemplateInputsDisabled">
                                    <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                    @foreach (var tmpl in _options.EmailTemplatesInterview2Plus)
                                    {
                                        <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </div>
                        </div>
                    }

                    @* Afslagsmail, ikke udvalgte *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("RejectedEmailForNotSelected") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudSelect T="int?"
                                       @bind-Value="_form.EmailTemplateRejectedId"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Disabled="@TemplateInputsDisabled">
                                <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                @foreach (var tmpl in _options.EmailTemplatesRejected)
                                {
                                    <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                }
                            </MudSelect>
                            <ValidationMessage For="@(() => _form.EmailTemplateRejectedId)" />
                        </div>
                    </div>

                    @* Afslagsmail, efter samtale *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText("RejectedEmailAfterInterview") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudSelect T="int?"
                                       @bind-Value="_form.EmailTemplateRejectedAfterInterviewId"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Disabled="@TemplateInputsDisabled">
                                <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                @foreach (var tmpl in _options.EmailTemplatesRejectedAfterInterview)
                                {
                                    <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                }
                            </MudSelect>
                            <ValidationMessage For="@(() => _form.EmailTemplateRejectedAfterInterviewId)" />
                        </div>
                    </div>

                    @* Notifikationsmail til ansættelsesudvalg *@
                    <div class="form-row">
                        <label class="form-label">@Localization.GetText(_clientConfig.IsFundClient ? "NotifyRecruitmentCommitteeEmailFund" : "NotifyRecruitmentCommitteeEmail") <span class="required-mark">*</span></label>
                        <div class="form-input">
                            <MudSelect T="int?"
                                       @bind-Value="_form.EmailTemplateNotifyCommitteeId"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Disabled="@TemplateInputsDisabled">
                                <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                @foreach (var tmpl in _options.EmailTemplatesNotifyCommittee)
                                {
                                    <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                }
                            </MudSelect>
                            <ValidationMessage For="@(() => _form.EmailTemplateNotifyCommitteeId)" />
                        </div>
                    </div>

                    @* SMS Template (conditional) *@
                    @if (_clientConfig.AllowSendingSms)
                    {
                        <div class="form-row">
                            <label class="form-label">@Localization.GetText("InterviewSmsForSelected") <span class="required-mark">*</span></label>
                            <div class="form-input">
                                <MudSelect T="int?"
                                           @bind-Value="_form.SmsTemplateInterviewId"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Disabled="@TemplateInputsDisabled">
                                    <MudSelectItem Value="@((int?)null)">(@Localization.GetText("PleaseSelect"))</MudSelectItem>
                                    @foreach (var tmpl in _options.SmsTemplates)
                                    {
                                        <MudSelectItem Value="@((int?)tmpl.Id)">@tmpl.Name</MudSelectItem>
                                    }
                                </MudSelect>
                                <ValidationMessage For="@(() => _form.SmsTemplateInterviewId)" />
                            </div>
                        </div>
                    }
                </MudPaper>
            </MudItem>

            @* ── RIGHT COLUMN (sidebar) ── *@
            <MudItem xs="12" md="4">

                @* Rekrutteringsansvarlig *@
                <MudPaper Class="pa-4 mb-4" Elevation="1">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        @(_clientConfig.IsFundClient
                            ? Localization.GetText("RecruitingResponsableFund")
                            : Localization.GetText("RecruitingResponsable"))
                    </MudText>

                    @if (_responsibleUser != null)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                @(_responsibleUser.DisplayName.Length > 0 ? _responsibleUser.DisplayName[0] : '?')
                            </MudAvatar>
                            <MudText Typo="Typo.body2">@_responsibleUser.DisplayName</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">—</MudText>
                    }

                    <MudButton Variant="Variant.Outlined"
                               Size="Size.Small"
                               OnClick="OnChangeResponsibleAsync"
                               Disabled="!_form.ClientId.HasValue"
                               StartIcon="@Icons.Material.Filled.PersonSearch">
                        @Localization.GetText("Change")
                    </MudButton>
                    <ValidationMessage For="@(() => _form.RecruitmentResponsibleUserId)" />
                </MudPaper>

                @* Vikar for opretter (Alternative Responsibles) *@
                <MudPaper Class="pa-4 mb-4" Elevation="1">
                    <MudText Typo="Typo.h6" Class="mb-3">@Localization.GetText("RecruitingResponsableAlternative")</MudText>

                    @if (_alternativeUsers.Count == 0)
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-2">—</MudText>
                    }
                    @foreach (var altUser in _alternativeUsers)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                            <MudAvatar Color="Color.Secondary" Size="Size.Small">
                                @(altUser.DisplayName.Length > 0 ? altUser.DisplayName[0] : '?')
                            </MudAvatar>
                            <MudText Typo="Typo.body2" Style="flex:1">@altUser.DisplayName</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.RemoveCircleOutline"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="() => RemoveAlternativeResponsible(altUser.UserId)" />
                        </MudStack>
                    }

                    <MudButton Variant="Variant.Outlined"
                               Size="Size.Small"
                               OnClick="OnAddAlternativeResponsibleAsync"
                               Disabled="!_form.ClientId.HasValue"
                               StartIcon="@Icons.Material.Filled.PersonAdd">
                        @Localization.GetText("Add")
                    </MudButton>
                </MudPaper>

                @* Ansættelsesudvalg (read-only, edit mode only) *@
                @if (IsEditMode)
                {
                    <MudPaper Class="pa-4 mb-4" Elevation="1">
                        <MudText Typo="Typo.h6" Class="mb-3">@Localization.GetText("RecruitmentCommittee")</MudText>

                        @if (_committeeMembers.Count == 0)
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">—</MudText>
                        }
                        else
                        {
                            <MudSimpleTable Dense="true" Class="mb-3" Style="font-size:0.8rem">
                                <thead>
                                    <tr>
                                        <th>@Localization.GetText("Name")</th>
                                        <th>@Localization.GetText("Type")</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var member in _committeeMembers)
                                    {
                                        <tr>
                                            <td>@member.FullName</td>
                                            <td>@member.MemberTypeName</td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }

                        @if (ActivityId.HasValue)
                        {
                            <MudButton Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       Href="@($"/Responsive/Recruiting/RecruitmentCommitteeAddRemoveInternal.aspx?ErId={ActivityId}")"
                                       StartIcon="@Icons.Material.Filled.Group">
                                @Localization.GetText("ManageCommittee")
                            </MudButton>
                        }
                    </MudPaper>
                }
            </MudItem>
        </MudGrid>
    </EditForm>
}
