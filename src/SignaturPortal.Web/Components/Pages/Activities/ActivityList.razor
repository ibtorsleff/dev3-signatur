@page "/activities"
@page "/activities/{Mode}"
@using SignaturPortal.Application.DTOs
@using SignaturPortal.Domain.Enums
@attribute [Authorize(Policy = "RecruitmentAccess")]

<PageTitle>@_headlineText</PageTitle>

@if (!_isClientUser || _canCreateActivity)
{
    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: @(_showMoreFilters ? "4px" : "8px");">
        @if (!_isClientUser)
        {
            <MudAutocomplete T="ClientDropdownDto"
                             @ref="_clientAutocomplete"
                             Value="_selectedClient"
                             ValueChanged="OnClientChanged"
                             OpenChanged="OnClientDropdownOpenChanged"
                             SearchFunc="SearchClients"
                             ToStringFunc="@(c => c?.ClientName ?? string.Empty)"
                             Label="@Localization.GetText("Client")"
                             Required="true"
                             Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                             Style="width: 300px;"
                             MinCharacters="0"
                             MaxItems="null"
                             Strict="false"
                             Clearable="false" />
        }
        @if (_canCreateActivity)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.AddCircle"
                       OnClick="OnCreateActivityClick"
                       Class="btn-create-activity"
                       Style="margin-top: 4px; background-color: #054541; text-transform: none;">
                @_createButtonText
            </MudButton>
        }
        @if (!_isClientUser)
        {
            <MudButton Variant="Variant.Outlined"
                       Color="@(_hasActiveMoreFilters ? Color.Primary : Color.Default)"
                       OnClick="ToggleMoreFilters"
                       Style="margin-top: 4px; text-transform: none; min-width: 90px;">
                @_moreButtonText
            </MudButton>
        }
    </div>
}

@if (!_isClientUser)
{
    <MudCollapse Expanded="_showMoreFilters">
        <div style="display: flex; gap: 12px; flex-wrap: wrap; padding: 4px 0 12px 0; align-items: flex-end;">
            <MudSelect T="Guid?"
                       Value="_createdByFilter"
                       ValueChanged="OnCreatedByFilterChanged"
                       Label="@Localization.GetText("CreatedBy")"
                       Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                       Style="min-width: 175px; max-width: 280px;"
                       Clearable="true"
                       AnchorOrigin="Origin.BottomLeft">
                @foreach (var user in _filterCreatedByUsers)
                {
                    <MudSelectItem T="Guid?" Value="@((Guid?)user.UserId)">@user.DisplayName</MudSelectItem>
                }
            </MudSelect>
            <MudSelect T="Guid?"
                       Value="_recruitmentResponsibleFilter"
                       ValueChanged="OnRecruitmentResponsibleFilterChanged"
                       Label="@Localization.GetText("RecruitingResponsable")"
                       Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                       Style="min-width: 175px; max-width: 280px;"
                       Clearable="true"
                       AnchorOrigin="Origin.BottomLeft">
                @foreach (var user in _filterRecruitmentResponsibleUsers)
                {
                    <MudSelectItem T="Guid?" Value="@((Guid?)user.UserId)">@user.DisplayName</MudSelectItem>
                }
            </MudSelect>
            <MudSelect T="int?"
                       Value="_clientSectionFilter"
                       ValueChanged="OnClientSectionFilterChanged"
                       Label="@Localization.GetText("ClientSection")"
                       Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                       Style="min-width: 175px; max-width: 280px;"
                       Clearable="true"
                       AnchorOrigin="Origin.BottomLeft">
                @foreach (var clientSection in _filterClientSections)
                {
                    <MudSelectItem T="int?" Value="@((int?)clientSection.ClientSectionId)">@clientSection.Name</MudSelectItem>
                }
            </MudSelect>
        </div>
    </MudCollapse>
}

<MudDataGrid T="ActivityListDto"
             @ref="_dataGrid"
             ServerData="LoadServerData"
             Filterable="@_showFilters"
             FilterMode="DataGridFilterMode.ColumnFilterRow"
             SortMode="SortMode.Multiple"
             Hover="true"
             RowClick="OnRowClick"
             RowStyle="cursor: pointer;"
             Class="portal-data-grid">
    <ToolBarContent>
        <MudText Typo="Typo.body1" Style="font-weight:bold; font-size:var(--portal-grid-headline-font-size);">@_headlineText</MudText>
        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Default"
                 Style="background:#fff; font-weight:bold; font-size:12px; margin-left:8px;">@_totalCount.ToString()</MudChip>
        <MudSpacer />
        <MudTooltip Text="@(_showFilters ? Localization.GetText("HideFilter") : Localization.GetText("ShowFilter"))">
            <MudIconButton Icon="@Icons.Material.Filled.FilterList"
                           Color="@(_showFilters ? Color.Primary : Color.Default)"
                           OnClick="ToggleFilters" />
        </MudTooltip>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x.EractivityId" Title="@Localization.GetText("Id")" HeaderStyle="width:80px;" CellStyle="text-align:right;" />
        <PropertyColumn Property="x => x.Headline" Title="@Localization.GetText("Headline")">
            <CellTemplate>
                @if (_showCandidateCount && context.Item.CandidateCount > 0)
                {
                    @($"{context.Item.Headline} ({context.Item.CandidateCount})")
                }
                else
                {
                    @context.Item.Headline
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.WebAdVisitors" Title="@Localization.GetText("MSFNumberOfClicks")" Sortable="false" Hidden="@_hideVisitorsColumn" HeaderStyle="width:108px;" CellStyle="text-align:right;" />
        <PropertyColumn Property="x => x.ApplicationDeadline" Title="@Localization.GetText("ApplicationDeadline")" HeaderStyle="width:120px;">
            <CellTemplate>
                @if (context.Item.ContinuousPosting)
                {
                    <MudTooltip Text="@Localization.GetText("ContinuousPosting")">
                        <span>-</span>
                    </MudTooltip>
                }
                else
                {
                    @context.Item.ApplicationDeadline.ToString("dd-MM-yyyy")
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.ClientSectionName" Title="@Localization.GetText("ClientSection")" Hidden="@_hideClientSectionColumn" HeaderStyle="width:240px;" />
        <PropertyColumn Property="x => x.RecruitingResponsibleName" Title="@Localization.GetText("RecruitingResponsable")" Sortable="false" HeaderStyle="width:150px;" />
        <PropertyColumn Property="x => x.CreateDate" Title="@Localization.GetText("CreateDate")" Format="dd-MM-yyyy" InitialDirection="SortDirection.Descending" HeaderStyle="width:110px;" />
        <PropertyColumn Property="x => x.CreatedByName" Title="@Localization.GetText("CreatedBy")" Sortable="false" Hidden="@_hideCreatedByColumn" HeaderStyle="width:130px;" />
        <PropertyColumn Property="x => x.DraftResponsibleName" Title="@Localization.GetText("ERDraftResponsibleHeader")" Sortable="false" Hidden="@_hideDraftResponsibleColumn" HeaderStyle="width:170px;" />
        <PropertyColumn Property="x => x.TemplateGroupName" Title="@Localization.GetText("TemplateGroup")" Hidden="@_hideTemplateGroupColumn" HeaderStyle="width:140px;" />
        <TemplateColumn T="ActivityListDto" Hidden="@_hideActionsColumn" Sortable="false" Filterable="false"
                        HeaderStyle="width:36px; padding:0;" CellStyle="padding:2px 4px; text-align:center;">
            <CellTemplate>
                <img src="/Responsive/images/responsive/list/copy-gray_32x32.png"
                     alt="Copy"
                     style="width:20px; height:20px; cursor:pointer; opacity:0.7;"
                     title="@Localization.GetText("CopyActivity")"
                     @onclick:stopPropagation="true" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="ActivityListDto" PageSizeOptions="new int[] { 10, 25, 50, 100 }" InfoFormat="@_pagerInfoFormat" RowsPerPageString="@Localization.GetText("RowsPerPage")" />
    </PagerContent>
    <NoRecordsContent>
        <MudText>@Localization.GetText("NoActivities")</MudText>
    </NoRecordsContent>
</MudDataGrid>
