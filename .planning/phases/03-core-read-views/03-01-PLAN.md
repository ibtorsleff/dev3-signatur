---
phase: 03-core-read-views
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Web/SignaturPortal.Web.csproj
  - src/SignaturPortal.Application/SignaturPortal.Application.csproj
  - src/SignaturPortal.Infrastructure/SignaturPortal.Infrastructure.csproj
  - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
  - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/Eractivitymember.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/BinaryFile.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/Ercandidatefile.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
  - src/SignaturPortal.Domain/Enums/ERActivityStatus.cs
  - src/SignaturPortal.Application/DTOs/ActivityListDto.cs
  - src/SignaturPortal.Application/DTOs/GridRequest.cs
  - src/SignaturPortal.Application/DTOs/GridResponse.cs
  - src/SignaturPortal.Application/Interfaces/IActivityService.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  - src/SignaturPortal.Infrastructure/Extensions/QueryableExtensions.cs
  - src/SignaturPortal.Infrastructure/DependencyInjection.cs
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
  - src/SignaturPortal.Web/Components/App.razor
  - src/SignaturPortal.Web/Components/_Imports.razor
  - src/SignaturPortal.Web/Program.cs
  - src/SignaturPortal.Web/wwwroot/css/app.css
  - src/SignaturPortal.Web/Components/Layout/NavMenu.razor
autonomous: true

must_haves:
  truths:
    - "User sees their recruitment activities in a paginated, sortable, filterable MudDataGrid"
    - "Activity list shows headline, journal no, deadline, status name, candidate count"
    - "Activity list is scoped to user's tenant (ClientId) via global query filters"
    - "Activity list loads in under 2 seconds for a typical query (server-side data operations)"
    - "User can page through activities with configurable page size (10, 25, 50, 100)"
    - "User can sort by any column and filter by status"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor"
      provides: "MudDataGrid-based activity list page"
      contains: "MudDataGrid"
    - path: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      provides: "Server-side paginated activity query"
      exports: ["ActivityService"]
    - path: "src/SignaturPortal.Application/DTOs/ActivityListDto.cs"
      provides: "Flat DTO for grid display"
      contains: "ActivityListDto"
    - path: "src/SignaturPortal.Application/DTOs/GridRequest.cs"
      provides: "Generic grid query parameters"
      contains: "GridRequest"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs"
      to: "IActivityService"
      via: "DI injection + ServerData callback"
      pattern: "IActivityService"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "SignaturDbContext"
      via: "IDbContextFactory"
      pattern: "IDbContextFactory.*SignaturDbContext"
    - from: "src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs"
      to: "Eractivity"
      via: "Global query filter on ClientId"
      pattern: "HasQueryFilter"
---

<objective>
Install MudBlazor, scaffold additional database tables needed for Phase 3, create the Application-layer service and DTOs for server-side data grid operations, and build the Activity List page with MudDataGrid that supports pagination, sorting, and filtering.

Purpose: This is the core deliverable of Phase 3 -- the activity list is the primary screen users see when they open the E-recruitment portal. It must load fast, show the right data, and respect tenant isolation.

Output: Working activity list page at /activities with server-side MudDataGrid, backed by EF Core queries with proper tenant filtering.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-read-views/03-RESEARCH.md
@src/SignaturPortal.Web/Program.cs
@src/SignaturPortal.Infrastructure/DependencyInjection.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Ercandidate.cs
@src/SignaturPortal.Infrastructure/Repositories/UnitOfWork.cs
@src/SignaturPortal.Domain/Interfaces/IRepository.cs
@src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs
@src/SignaturPortal.Application/Interfaces/IPermissionService.cs
@src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
@src/SignaturPortal.Web/Components/Layout/NavMenu.razor
@src/SignaturPortal.Web/Components/App.razor
@src/SignaturPortal.Web/Components/_Imports.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MudBlazor, scaffold additional tables, create shared DTOs and service layer</name>
  <files>
    src/SignaturPortal.Web/SignaturPortal.Web.csproj
    src/SignaturPortal.Application/SignaturPortal.Application.csproj
    src/SignaturPortal.Infrastructure/SignaturPortal.Infrastructure.csproj
    src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
    src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
    src/SignaturPortal.Infrastructure/Data/Entities/Eractivitymember.cs
    src/SignaturPortal.Infrastructure/Data/Entities/BinaryFile.cs
    src/SignaturPortal.Infrastructure/Data/Entities/Ercandidatefile.cs
    src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
    src/SignaturPortal.Domain/Enums/ERActivityStatus.cs
    src/SignaturPortal.Application/DTOs/ActivityListDto.cs
    src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
    src/SignaturPortal.Application/DTOs/CandidateListDto.cs
    src/SignaturPortal.Application/DTOs/GridRequest.cs
    src/SignaturPortal.Application/DTOs/GridResponse.cs
    src/SignaturPortal.Application/Interfaces/IActivityService.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
    src/SignaturPortal.Infrastructure/Extensions/QueryableExtensions.cs
    src/SignaturPortal.Infrastructure/DependencyInjection.cs
    src/SignaturPortal.Web/Program.cs
    src/SignaturPortal.Web/Components/App.razor
    src/SignaturPortal.Web/Components/_Imports.razor
  </files>
  <action>
    **Step 1: Install NuGet packages**
    - Add MudBlazor (latest stable, 7.x) to SignaturPortal.Web.csproj
    - Add System.Linq.Dynamic.Core to SignaturPortal.Application.csproj (for dynamic filter/sort)

    **Step 2: Configure MudBlazor in Program.cs**
    - Add `builder.Services.AddMudServices();` after AddRazorComponents
    - In App.razor: add `<MudThemeProvider />`, `<MudPopoverProvider />`, `<MudDialogProvider />`, `<MudSnackbarProvider />` inside the body
    - In App.razor HeadContent: add MudBlazor CSS link (`_content/MudBlazor/MudBlazor.min.css`)
    - In App.razor: add MudBlazor JS reference (`_content/MudBlazor/MudBlazor.min.js`)
    - In _Imports.razor: add `@using MudBlazor`

    **Step 3: Scaffold additional EF Core entities**
    These tables are needed for Phase 3 but were not scaffolded in Phase 1. Run `dotnet ef dbcontext scaffold` for each additional table, OR manually create entity classes matching the DB schema. The tables needed are:

    a) **ERActivityMember** table -> `Eractivitymember.cs` entity:
       - ERActivityMemberId (int, PK)
       - ERActivityId (int, FK -> ERActivity)
       - UserId (Guid, FK -> aspnet_Users)
       - ERActivityMemberTypeId (int) -- 1=Internal, 2=External, 3=ExternalDraft
       - ExtUserAllowCandidateManagement (bool?)
       - ExtUserAllowCandidateReview (bool?)
       - ExtUserAllowViewEditNotes (bool?)
       - NotificationMailSendToUser (bool?)
       - Navigation: Eractivity, AspnetUser

    b) **BinaryFile** table -> `BinaryFile.cs` entity:
       - BinaryFileId (int, PK, identity)
       - FileName (string, nvarchar)
       - FileSize (int)
       - FileData (byte[]) -- the actual binary content
       Note: FileData is a varbinary(max) column. Include it in the entity but NEVER eagerly load it in list queries.

    c) **ERCandidateFile** table -> `Ercandidatefile.cs` entity:
       - BinaryFileId (int, PK+FK -> BinaryFile)
       - ERCandidateId (int, FK -> ERCandidate)
       - ERCandidateFileConversionStatusId (int?)
       - ConvertedFileName (string?)
       - ConvertedFileSize (int?)
       - ConversionErrorMessage (string?)
       - ConversionErrorMessageDetails (string?)
       - FileException (string?)
       - Navigation: BinaryFile, Ercandidate

    IMPORTANT: Use `dotnet ef dbcontext scaffold` to get exact column types from the database rather than guessing. Run:
    ```
    dotnet ef dbcontext scaffold "Name=ConnectionStrings:SignaturAnnoncePortal" Microsoft.EntityFrameworkCore.SqlServer --project src/SignaturPortal.Infrastructure --startup-project src/SignaturPortal.Web --output-dir Data/Entities --table ERActivityMember --table BinaryFile --table ERCandidateFile --no-onconfiguring --force --no-build
    ```
    Then merge the new entities into the existing DbContext (add DbSet properties and OnModelCreating config). Do NOT overwrite the existing entity files or DbContext -- merge carefully.

    d) Update `Eractivity.cs` to add navigation collection: `public virtual ICollection<Eractivitymember> Eractivitymembers { get; set; } = new List<Eractivitymember>();`
    Also add: `public virtual ICollection<Ercandidate> Ercandidates { get; set; } = new List<Ercandidate>();` (if not already present, check the scaffold output)

    e) Update `SignaturDbContext.Custom.cs`:
       - Add global query filter for Eractivitymember through activity: `entity.HasQueryFilter(m => CurrentClientId == null || m.Eractivity.ClientId == CurrentClientId);`

    **Step 4: Create Domain enums**
    Create `src/SignaturPortal.Domain/Enums/ERActivityStatus.cs`:
    ```csharp
    namespace SignaturPortal.Domain.Enums;
    public enum ERActivityStatus
    {
        All = 0,
        OnGoing = 1,
        Closed = 2,
        Deleted = 3,
        Draft = 4
    }
    ```

    **Step 5: Create Application layer DTOs**

    a) `GridRequest.cs` -- generic paginated grid request:
    ```csharp
    public class GridRequest
    {
        public int Page { get; set; }
        public int PageSize { get; set; } = 25;
        public List<SortDefinition> Sorts { get; set; } = new();
        public List<FilterDefinition> Filters { get; set; } = new();
    }
    public record SortDefinition(string PropertyName, bool Descending);
    public record FilterDefinition(string PropertyName, string Operator, object? Value);
    ```

    b) `GridResponse<T>` -- generic paginated response:
    ```csharp
    public class GridResponse<T>
    {
        public List<T> Items { get; set; } = new();
        public int TotalCount { get; set; }
    }
    ```

    c) `ActivityListDto.cs` -- flat DTO for the grid:
    ```csharp
    public record ActivityListDto
    {
        public int EractivityId { get; init; }
        public string Headline { get; init; } = "";
        public string Jobtitle { get; init; } = "";
        public string JournalNo { get; init; } = "";
        public DateTime ApplicationDeadline { get; init; }
        public int EractivityStatusId { get; init; }
        public string StatusName { get; init; } = "";
        public DateTime CreateDate { get; init; }
        public int CandidateCount { get; init; }
        public Guid Responsible { get; init; }
        public Guid CreatedBy { get; init; }
    }
    ```

    d) Also create `ActivityDetailDto.cs` and `CandidateListDto.cs` stubs (will be filled in Plans 02/03) so they compile:
    - `ActivityDetailDto` extends ActivityListDto with: HireDate, HireDateFreeText, ContinuousPosting, IsCleaned, ClientId, plus lists for HiringTeamMembers and Candidates
    - `CandidateListDto`: ErcandidateId, FirstName, LastName, Email, Telephone, City, ZipCode, RegistrationDate, ErcandidateStatusId, StatusName, IsDeleted, FileCount

    **Step 6: Create IActivityService interface**
    In `src/SignaturPortal.Application/Interfaces/IActivityService.cs`:
    ```csharp
    public interface IActivityService
    {
        Task<GridResponse<ActivityListDto>> GetActivitiesAsync(GridRequest request, CancellationToken ct = default);
    }
    ```

    **Step 7: Create ActivityService implementation**
    In `src/SignaturPortal.Infrastructure/Services/ActivityService.cs`:
    - Inject IDbContextFactory<SignaturDbContext> and IUserSessionContext
    - In GetActivitiesAsync:
      1. Create DbContext via factory, stamp CurrentSiteId/CurrentClientId from session
      2. Build base query: `context.Eractivities.Where(a => !a.IsCleaned)` -- global filter already handles ClientId
      3. Apply permission-based filtering: if user doesn't have AdminAccess, filter to activities where user is Responsible or CreatedBy (matching legacy behavior where non-admin users see only their activities). Inject IPermissionService to check this.
      4. Get TotalCount AFTER filters but BEFORE pagination
      5. Apply sorts from GridRequest using QueryableExtensions (default sort: ApplicationDeadline descending)
      6. Apply pagination (Skip/Take)
      7. Project to ActivityListDto using .Select() (NOT .Include()) to avoid N+1:
         - Map EractivityStatusId to StatusName using a static dictionary matching the legacy enum (1="Ongoing", 2="Closed", 3="Deleted", 4="Draft")
         - CandidateCount = a.Ercandidates.Count(c => !c.IsDeleted) -- subquery, not loaded
      8. Dispose context via using statement

    **Step 8: Create QueryableExtensions**
    In `src/SignaturPortal.Infrastructure/Extensions/QueryableExtensions.cs`:
    - `ApplySorts<T>(this IQueryable<T>, List<SortDefinition>)` -- uses System.Linq.Dynamic.Core `OrderBy()` for dynamic property sorting
    - `ApplyPage<T>(this IQueryable<T>, int page, int pageSize)` -- Skip/Take
    Use System.Linq.Dynamic.Core for safe dynamic property resolution.

    **Step 9: Register services in DI**
    In `DependencyInjection.cs`:
    - Add `services.AddScoped<IActivityService, ActivityService>();`

    **Step 10: Verify build**
    Run `dotnet build` and fix any compilation errors.
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - New DbSet properties exist in SignaturDbContext for ERActivityMember, BinaryFile, ERCandidateFile
    - IActivityService is registered in DI
    - ActivityService can be resolved (check DI wiring compiles)
  </verify>
  <done>
    MudBlazor installed and configured, additional EF Core entities scaffolded, IActivityService and ActivityService created with server-side pagination/sorting/filtering, all DTOs defined, build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the Activity List page with MudDataGrid</name>
  <files>
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
    src/SignaturPortal.Web/Components/Layout/NavMenu.razor
    src/SignaturPortal.Web/wwwroot/css/app.css
  </files>
  <action>
    **Step 1: Create ActivityList page with code-behind**

    Create `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor`:
    - Route: `@page "/activities"`
    - Authorize attribute: `@attribute [Authorize(Policy = "RecruitmentAccess")]`
    - Use `@attribute [StreamRendering]` for better loading UX
    - Contains a MudDataGrid with ServerData callback
    - Page title: "Recruitment Activities"

    MudDataGrid configuration:
    ```razor
    <MudDataGrid T="ActivityListDto"
                 @ref="_dataGrid"
                 ServerData="LoadServerData"
                 Filterable="true"
                 FilterMode="DataGridFilterMode.ColumnFilterRow"
                 SortMode="SortMode.Multiple"
                 Sortable="true"
                 Hover="true"
                 Dense="true"
                 RowClick="OnRowClick"
                 RowStyle="cursor: pointer;">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Recruitment Activities</MudText>
            <MudSpacer />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Headline" Title="Activity" />
            <PropertyColumn Property="x => x.JournalNo" Title="Journal No" />
            <PropertyColumn Property="x => x.ApplicationDeadline" Title="Deadline" Format="yyyy-MM-dd" />
            <PropertyColumn Property="x => x.StatusName" Title="Status" />
            <PropertyColumn Property="x => x.CandidateCount" Title="Candidates" Filterable="false" />
            <PropertyColumn Property="x => x.CreateDate" Title="Created" Format="yyyy-MM-dd" />
            <TemplateColumn Title="" Sortable="false" Filterable="false">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   Size="Size.Small"
                                   OnClick="@(() => NavigateToDetail(context.Item.EractivityId))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="ActivityListDto" PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
        <NoRecordsContent>
            <MudText>No recruitment activities found.</MudText>
        </NoRecordsContent>
    </MudDataGrid>
    ```

    Create `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs` (code-behind):
    ```csharp
    public partial class ActivityList
    {
        [Inject] private IActivityService ActivityService { get; set; } = default!;
        [Inject] private NavigationManager Navigation { get; set; } = default!;

        private MudDataGrid<ActivityListDto> _dataGrid = default!;

        private async Task<GridData<ActivityListDto>> LoadServerData(GridState<ActivityListDto> state)
        {
            var request = new GridRequest
            {
                Page = state.Page,
                PageSize = state.PageSize,
                Sorts = state.SortDefinitions
                    .Select(s => new SortDefinition(s.SortBy, s.Descending))
                    .ToList()
            };

            // Map MudDataGrid filter definitions to our GridRequest filters
            // (handle null values, type conversions)

            var response = await ActivityService.GetActivitiesAsync(request);

            return new GridData<ActivityListDto>
            {
                Items = response.Items,
                TotalItems = response.TotalCount
            };
        }

        private void NavigateToDetail(int activityId)
        {
            Navigation.NavigateTo($"/activities/{activityId}");
        }

        private void OnRowClick(DataGridRowClickEventArgs<ActivityListDto> args)
        {
            NavigateToDetail(args.Item.EractivityId);
        }
    }
    ```

    IMPORTANT: The MudDataGrid SortDefinitions API in MudBlazor 7.x uses `SortBy` as a string property name. Map from `state.SortDefinitions` to our `SortDefinition` records. Check the actual MudBlazor 7.x API -- the property name may be `SortBy` or `PropertyName` depending on version. Use the installed version's actual API.

    **Step 2: Update NavMenu**
    In `NavMenu.razor`, update the "E-Recruitment" link to point to `/activities` instead of `/e-recruitment` (or add it alongside):
    - Change the E-Recruitment nav link href to "/activities"

    **Step 3: Add minimal activity-list styling**
    If needed, add basic styles to `app.css` or as scoped CSS to make the grid look clean. MudBlazor handles most styling, so this should be minimal. Ensure the primary teal color (#1a9b89) is used for the MudTheme primary color by configuring a custom MudTheme in App.razor or MainLayout:
    ```csharp
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#1a9b89",
            PrimaryDarken = "#178a79",
        }
    };
    ```
    Pass this to `<MudThemeProvider Theme="_theme" />`.

    **Step 4: Verify end-to-end**
    - Build the solution
    - Start the app and navigate to /activities
    - Verify the MudDataGrid renders (even without data, the grid structure should appear)
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - The file `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor` exists and contains `MudDataGrid`
    - The file `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs` exists and contains `IActivityService`
    - NavMenu links to /activities
    - MudBlazor theme uses primary color #1a9b89
  </verify>
  <done>
    Activity list page renders a MudDataGrid at /activities with server-side data loading, pagination (10/25/50/100), sorting on all columns, column filter row, and row click navigation to detail page. NavMenu links to the activity list. MudBlazor theme uses the project's teal primary color.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build SignaturPortal.slnx` -- zero errors
2. MudBlazor packages installed and configured (CSS, JS, providers, theme)
3. ERActivityMember, BinaryFile, ERCandidateFile entities scaffolded with correct relationships
4. ActivityService implements server-side pagination, sorting, and tenant-scoped queries
5. /activities route renders MudDataGrid with correct columns
6. Permission-based filtering applied (non-admin users see own activities only)
</verification>

<success_criteria>
- User navigates to /activities and sees a MudDataGrid with recruitment activities
- Grid supports pagination with configurable page sizes (10, 25, 50, 100)
- Grid supports sorting on Headline, Journal No, Deadline, Status, Created columns
- Grid shows column filter row for filtering
- Data is loaded server-side (no client-side loading of full dataset)
- Activities are scoped to user's tenant via EF Core global query filters
- Clicking a row or the view icon navigates to /activities/{id} (page doesn't exist yet - that's Plan 02)
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-read-views/03-01-SUMMARY.md`
</output>
