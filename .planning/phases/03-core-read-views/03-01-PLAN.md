---
phase: 03-core-read-views
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Web/SignaturPortal.Web.csproj
  - src/SignaturPortal.Application/SignaturPortal.Application.csproj
  - src/SignaturPortal.Infrastructure/SignaturPortal.Infrastructure.csproj
  - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
  - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/Eractivitymember.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/BinaryFile.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/Ercandidatefile.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
  - src/SignaturPortal.Domain/Enums/ERActivityStatus.cs
  - src/SignaturPortal.Domain/Helpers/StatusMappings.cs
autonomous: true

must_haves:
  truths:
    - "MudBlazor NuGet package is installed and configured in the Blazor app (CSS, JS, providers)"
    - "ERActivityMember, BinaryFile, ERCandidateFile entities are scaffolded from the database with correct relationships"
    - "ERActivityStatus enum exists with values matching the legacy system (All=0, OnGoing=1, Closed=2, Deleted=3, Draft=4)"
    - "StatusMappings helper provides reliable status name lookup from status ID"
    - "Global query filter for Eractivitymember scopes through activity.ClientId"
    - "Eractivity entity has navigation collections for Eractivitymembers and Ercandidates"
  artifacts:
    - path: "src/SignaturPortal.Infrastructure/Data/Entities/Eractivitymember.cs"
      provides: "ERActivityMember entity"
      contains: "Eractivitymember"
    - path: "src/SignaturPortal.Infrastructure/Data/Entities/BinaryFile.cs"
      provides: "BinaryFile entity with FileData column"
      contains: "BinaryFile"
    - path: "src/SignaturPortal.Infrastructure/Data/Entities/Ercandidatefile.cs"
      provides: "ERCandidateFile entity linking candidates to files"
      contains: "Ercandidatefile"
    - path: "src/SignaturPortal.Domain/Enums/ERActivityStatus.cs"
      provides: "Activity status enum matching legacy values"
      contains: "ERActivityStatus"
    - path: "src/SignaturPortal.Domain/Helpers/StatusMappings.cs"
      provides: "Static status name lookup dictionaries"
      contains: "GetActivityStatusName"
  key_links:
    - from: "src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs"
      to: "Eractivitymember"
      via: "Global query filter on ClientId through navigation"
      pattern: "HasQueryFilter"
    - from: "src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs"
      to: "Eractivitymember"
      via: "Navigation collection"
      pattern: "ICollection.*Eractivitymember"
---

<objective>
Install MudBlazor, scaffold additional EF Core entities needed for Phase 3 (ERActivityMember, BinaryFile, ERCandidateFile), create domain enums and status mapping helpers, and configure tenant query filters for new entities.

Purpose: This is the infrastructure foundation for all Phase 3 read views. The entities, enums, and MudBlazor setup must exist before any service layer or UI can be built.

Output: MudBlazor configured, 3 new EF Core entities scaffolded with relationships, domain enums and status mapping helpers ready for use.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-read-views/03-RESEARCH.md
@src/SignaturPortal.Web/Program.cs
@src/SignaturPortal.Infrastructure/DependencyInjection.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Ercandidate.cs
@src/SignaturPortal.Web/Components/App.razor
@src/SignaturPortal.Web/Components/_Imports.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MudBlazor and configure in the Blazor app</name>
  <files>
    src/SignaturPortal.Web/SignaturPortal.Web.csproj
    src/SignaturPortal.Web/Components/App.razor
    src/SignaturPortal.Web/Components/_Imports.razor
    src/SignaturPortal.Web/Program.cs
  </files>
  <action>
    **Step 1: Install NuGet packages**
    - Add MudBlazor (latest stable, 7.x) to SignaturPortal.Web.csproj
    - Add System.Linq.Dynamic.Core to SignaturPortal.Application.csproj (for dynamic filter/sort in later plans)

    **Step 2: Configure MudBlazor in Program.cs**
    - Add `builder.Services.AddMudServices();` after AddRazorComponents

    **Step 3: Configure MudBlazor in App.razor**
    - In HeadContent: add MudBlazor CSS link (`_content/MudBlazor/MudBlazor.min.css`)
    - In body: add `<MudThemeProvider />`, `<MudPopoverProvider />`, `<MudDialogProvider />`, `<MudSnackbarProvider />`
    - Before closing body: add MudBlazor JS reference (`_content/MudBlazor/MudBlazor.min.js`)
    - Configure custom MudTheme with primary color #1a9b89:
      ```csharp
      private MudTheme _theme = new()
      {
          PaletteLight = new PaletteLight
          {
              Primary = "#1a9b89",
              PrimaryDarken = "#178a79",
          }
      };
      ```
    - Pass to `<MudThemeProvider Theme="_theme" />`

    **Step 4: Add MudBlazor using to _Imports.razor**
    - Add `@using MudBlazor`

    **Step 5: Verify build**
    Run `dotnet build SignaturPortal.slnx` and fix any compilation errors.
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - MudBlazor package reference exists in Web.csproj
    - System.Linq.Dynamic.Core package reference exists in Application.csproj
    - App.razor contains MudThemeProvider, MudPopoverProvider, MudDialogProvider, MudSnackbarProvider
    - _Imports.razor contains `@using MudBlazor`
  </verify>
  <done>
    MudBlazor 7.x installed and fully configured: CSS/JS references in App.razor, service providers registered, custom teal theme (#1a9b89) applied, MudBlazor namespace imported. System.Linq.Dynamic.Core available for dynamic queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scaffold EF Core entities, create domain enums and status mappings, configure query filters</name>
  <files>
    src/SignaturPortal.Infrastructure/SignaturPortal.Infrastructure.csproj
    src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
    src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
    src/SignaturPortal.Infrastructure/Data/Entities/Eractivitymember.cs
    src/SignaturPortal.Infrastructure/Data/Entities/BinaryFile.cs
    src/SignaturPortal.Infrastructure/Data/Entities/Ercandidatefile.cs
    src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
    src/SignaturPortal.Domain/Enums/ERActivityStatus.cs
    src/SignaturPortal.Domain/Helpers/StatusMappings.cs
  </files>
  <action>
    **Step 1: Scaffold additional EF Core entities**
    Run `dotnet ef dbcontext scaffold` to get exact column types from the database:
    ```
    dotnet ef dbcontext scaffold "Name=ConnectionStrings:SignaturAnnoncePortal" Microsoft.EntityFrameworkCore.SqlServer --project src/SignaturPortal.Infrastructure --startup-project src/SignaturPortal.Web --output-dir Data/Entities --table ERActivityMember --table BinaryFile --table ERCandidateFile --no-onconfiguring --force --no-build
    ```
    Then merge the new entities into the existing DbContext:
    - Add DbSet properties for ERActivityMember, BinaryFile, ERCandidateFile
    - Merge OnModelCreating configuration (relationships, FK constraints)
    - Do NOT overwrite existing entity files or DbContext -- merge carefully

    The expected entities are:

    a) **ERActivityMember** -> `Eractivitymember.cs`:
       - ERActivityMemberId (int, PK), ERActivityId (int, FK), UserId (Guid, FK), ERActivityMemberTypeId (int)
       - ExtUserAllowCandidateManagement (bool?), ExtUserAllowCandidateReview (bool?), ExtUserAllowViewEditNotes (bool?), NotificationMailSendToUser (bool?)
       - Navigation: Eractivity, AspnetUser

    b) **BinaryFile** -> `BinaryFile.cs`:
       - BinaryFileId (int, PK, identity), FileName (string), FileSize (int), FileData (byte[], varbinary(max))
       - IMPORTANT: FileData must NEVER be eagerly loaded in list queries

    c) **ERCandidateFile** -> `Ercandidatefile.cs`:
       - BinaryFileId (int, PK+FK -> BinaryFile), ERCandidateId (int, FK -> ERCandidate)
       - ERCandidateFileConversionStatusId (int?), ConvertedFileName (string?), ConvertedFileSize (int?), ConversionErrorMessage (string?), ConversionErrorMessageDetails (string?), FileException (string?)
       - Navigation: BinaryFile, Ercandidate

    **Step 2: Update Eractivity entity with navigation collections**
    Add to `Eractivity.cs`:
    - `public virtual ICollection<Eractivitymember> Eractivitymembers { get; set; } = new List<Eractivitymember>();`
    - `public virtual ICollection<Ercandidate> Ercandidates { get; set; } = new List<Ercandidate>();` (if not already present)

    **Step 3: Add global query filter for Eractivitymember**
    In `SignaturDbContext.Custom.cs`, add inside OnModelCreatingPartial:
    ```csharp
    modelBuilder.Entity<Eractivitymember>()
        .HasQueryFilter(m => CurrentClientId == null || m.Eractivity.ClientId == CurrentClientId);
    ```

    **Step 4: Create Domain enum**
    Create `src/SignaturPortal.Domain/Enums/ERActivityStatus.cs`:
    ```csharp
    namespace SignaturPortal.Domain.Enums;

    public enum ERActivityStatus
    {
        All = 0,
        OnGoing = 1,
        Closed = 2,
        Deleted = 3,
        Draft = 4
    }
    ```

    **Step 5: Create StatusMappings helper**
    Create `src/SignaturPortal.Domain/Helpers/StatusMappings.cs` with explicit static dictionaries:
    ```csharp
    namespace SignaturPortal.Domain.Helpers;

    public static class StatusMappings
    {
        private static readonly Dictionary<int, string> ActivityStatusNames = new()
        {
            { 0, "All" },
            { 1, "Ongoing" },
            { 2, "Closed" },
            { 3, "Deleted" },
            { 4, "Draft" }
        };

        private static readonly Dictionary<int, string> ActivityMemberTypeNames = new()
        {
            { 1, "Internal" },
            { 2, "External" },
            { 3, "External (Draft)" }
        };

        /// <summary>
        /// Maps ERActivityStatusId to display name. Returns "Unknown" for unmapped values.
        /// Values match legacy ERActivityStatus table: 1=Ongoing, 2=Closed, 3=Deleted, 4=Draft.
        /// </summary>
        public static string GetActivityStatusName(int statusId)
            => ActivityStatusNames.TryGetValue(statusId, out var name) ? name : "Unknown";

        /// <summary>
        /// Maps ERActivityMemberTypeId to display name. Returns "Unknown" for unmapped values.
        /// Values match legacy ERActivityMemberType: 1=Internal, 2=External, 3=External (Draft).
        /// </summary>
        public static string GetActivityMemberTypeName(int memberTypeId)
            => ActivityMemberTypeNames.TryGetValue(memberTypeId, out var name) ? name : "Unknown";
    }
    ```

    **Step 6: Verify build**
    Run `dotnet build SignaturPortal.slnx` and fix any compilation errors.
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - New DbSet properties exist in SignaturDbContext for ERActivityMember, BinaryFile, ERCandidateFile
    - Eractivity has navigation collections for Eractivitymembers and Ercandidates
    - Global query filter for Eractivitymember configured in SignaturDbContext.Custom.cs
    - ERActivityStatus enum has values All=0, OnGoing=1, Closed=2, Deleted=3, Draft=4
    - StatusMappings.GetActivityStatusName(1) returns "Ongoing"
    - StatusMappings.GetActivityStatusName(99) returns "Unknown"
    - StatusMappings.GetActivityMemberTypeName(1) returns "Internal"
  </verify>
  <done>
    Three new EF Core entities scaffolded (ERActivityMember, BinaryFile, ERCandidateFile) with correct relationships and DbSet registrations. Eractivity has navigation collections. Global query filter for Eractivitymember scopes through activity.ClientId. ERActivityStatus enum created. StatusMappings helper provides explicit static dictionary lookups for activity status names and member type names, with "Unknown" fallback for unmapped values.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build SignaturPortal.slnx` -- zero errors
2. MudBlazor packages installed and configured (CSS, JS, providers, theme with #1a9b89)
3. ERActivityMember, BinaryFile, ERCandidateFile entities scaffolded with correct relationships
4. Global query filter for Eractivitymember configured
5. StatusMappings.GetActivityStatusName returns correct names for all legacy values
6. StatusMappings.GetActivityMemberTypeName returns correct names for all member types
</verification>

<success_criteria>
- MudBlazor 7.x is installed, configured, and the app builds successfully
- Three new EF Core entities exist with correct database-first schema
- Domain enums and status mapping helpers are ready for use by service layer (Plan 02)
- Tenant query filter for ERActivityMember is configured
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-read-views/03-01-SUMMARY.md`
</output>
