---
phase: 03-core-read-views
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/SignaturPortal.Infrastructure/Data/Entities/User.cs
  - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
  - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
  - src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
  - src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs
  - src/SignaturPortal.Application/Interfaces/IActivityService.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor.cs
autonomous: true

must_haves:
  truths:
    - "User can click an activity in the list and see its full read-only details"
    - "Activity detail page displays all key properties: headline, job title, journal number, deadline, hire date, status, creation date"
    - "Activity detail page shows the hiring team members with name, email, role type (internal/external), and permissions"
    - "Activity detail page shows the count and summary of linked candidates"
    - "Detail page respects tenant isolation -- user cannot view activity from another client"
    - "[User] table is scaffolded for member name resolution; tenant filtering is NOT needed because User access is always scoped through ERActivityMember which is already tenant-filtered"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor"
      provides: "Activity detail read-only view"
      contains: "MudCard"
    - path: "src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs"
      provides: "Full activity DTO with related data"
      contains: "ActivityDetailDto"
    - path: "src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs"
      provides: "Hiring team member DTO"
      contains: "HiringTeamMemberDto"
    - path: "src/SignaturPortal.Infrastructure/Data/Entities/User.cs"
      provides: "User entity for name/email resolution"
      contains: "class User"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor.cs"
      to: "IActivityService.GetActivityDetailAsync"
      via: "DI injection + OnInitializedAsync"
      pattern: "GetActivityDetailAsync"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "Eractivitymember"
      via: "EF Core Include/projection"
      pattern: "Eractivitymember"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "User entity"
      via: "Join for member name resolution"
      pattern: "User"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "StatusMappings"
      via: "GetActivityStatusName and GetActivityMemberTypeName"
      pattern: "StatusMappings\\."
---

<objective>
Build the Activity Detail page that shows all read-only properties of a recruitment activity, its assigned hiring team members, and a summary of linked candidates. Also scaffold the [User] table needed for member name resolution.

Purpose: Users need to drill into an activity to see its full details and the hiring team composition. This is ELIST-08, ELIST-09, ELIST-10 from the requirements.

Output: Working detail page at /activities/{id} with activity properties, hiring team table, and candidate count summary.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-read-views/03-RESEARCH.md
@.planning/phases/03-core-read-views/03-01-SUMMARY.md
@.planning/phases/03-core-read-views/03-02-SUMMARY.md
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivitymember.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
@src/SignaturPortal.Application/Interfaces/IActivityService.cs
@src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
@src/SignaturPortal.Infrastructure/Services/ActivityService.cs
@src/SignaturPortal.Domain/Helpers/StatusMappings.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold [User] table, create DTOs, and extend ActivityService with GetActivityDetailAsync</name>
  <files>
    src/SignaturPortal.Infrastructure/Data/Entities/User.cs
    src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
    src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
    src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
    src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs
    src/SignaturPortal.Application/Interfaces/IActivityService.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  </files>
  <action>
    **Step 1: Scaffold [User] table**
    The legacy app uses a `[User]` table (not `aspnet_Users`) for user details like FullName, Email, Phone. The `aspnet_Users` table only has UserName and UserId. For hiring team member names, scaffold the [User] table:
    ```
    dotnet ef dbcontext scaffold "Name=ConnectionStrings:SignaturAnnoncePortal" Microsoft.EntityFrameworkCore.SqlServer --project src/SignaturPortal.Infrastructure --startup-project src/SignaturPortal.Web --output-dir Data/Entities --table [User] --no-onconfiguring --force --no-build
    ```
    Add the DbSet and configure in DbContext. Add navigation from Eractivitymember to User.

    **TENANT FILTERING DECISION for [User] table:**
    The [User] table does NOT need a global query filter for tenant isolation. Reason: User data is never queried directly by end users -- it is only joined through ERActivityMember (which already has a tenant-scoped global query filter via Eractivity.ClientId). The User table is a lookup/reference table for name resolution, not a directly browsable entity. If [User] does have a ClientId/SiteId column, document it in the SUMMARY but do NOT add a global filter -- it would break cross-client user lookups needed for external hiring team members (MemberTypeId=2,3) who may belong to a different client.

    If the scaffolded [User] entity reveals a ClientId or SiteId column, add a code comment in SignaturDbContext.Custom.cs:
    ```csharp
    // [User] table: NO global query filter needed.
    // User data is accessed only through ERActivityMember joins (already tenant-filtered).
    // Adding a ClientId filter would break external hiring team member name resolution
    // (external members may belong to a different client).
    ```

    **Step 2: Complete ActivityDetailDto**
    Update `src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs` (stub created in Plan 02):
    ```csharp
    public record ActivityDetailDto
    {
        public int EractivityId { get; init; }
        public int ClientId { get; init; }
        public string Headline { get; init; } = "";
        public string Jobtitle { get; init; } = "";
        public string JournalNo { get; init; } = "";
        public int EractivityStatusId { get; init; }
        public string StatusName { get; init; } = "";
        public DateTime ApplicationDeadline { get; init; }
        public DateTime? HireDate { get; init; }
        public string? HireDateFreeText { get; init; }
        public DateTime CreateDate { get; init; }
        public DateTime StatusChangedTimeStamp { get; init; }
        public bool ContinuousPosting { get; init; }
        public bool CandidateEvaluationEnabled { get; init; }
        public bool IsCleaned { get; init; }
        public bool EmailOnNewCandidate { get; init; }
        public Guid Responsible { get; init; }
        public string ResponsibleName { get; init; } = "";
        public Guid CreatedBy { get; init; }
        public string CreatedByName { get; init; } = "";
        public int CandidateCount { get; init; }
        public int HiringTeamMemberCount { get; init; }
        public List<HiringTeamMemberDto> HiringTeamMembers { get; init; } = new();
    }
    ```

    **Step 3: Create HiringTeamMemberDto**
    Create `src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs`:
    ```csharp
    public record HiringTeamMemberDto
    {
        public int EractivityMemberId { get; init; }
        public Guid UserId { get; init; }
        public string UserName { get; init; } = "";
        public string FullName { get; init; } = "";
        public string Email { get; init; } = "";
        public int MemberTypeId { get; init; }
        public string MemberTypeName { get; init; } = "";
        public bool? AllowCandidateManagement { get; init; }
        public bool? AllowCandidateReview { get; init; }
        public bool? AllowViewEditNotes { get; init; }
        public bool? NotificationMailSendToUser { get; init; }
    }
    ```

    **Step 4: Extend IActivityService**
    Add to the interface:
    ```csharp
    Task<ActivityDetailDto?> GetActivityDetailAsync(int activityId, CancellationToken ct = default);
    ```

    **Step 5: Implement GetActivityDetailAsync in ActivityService**
    1. Create DbContext via factory, stamp tenant context
    2. Query the activity with:
       - Activity properties projected to DTO
       - Hiring team members via Eractivitymembers navigation, joined with User entity for user names
       - Use AsSplitQuery() to avoid cartesian explosion between members and candidates
       - CandidateCount as a subquery count (not loaded)
    3. For Responsible and CreatedBy names: join to [User] table to get FullName/UserName for those Guids
    4. For hiring team member names: join ERActivityMember -> [User] via UserId
    5. For MemberTypeName: use StatusMappings.GetActivityMemberTypeName (from Plan 01)
    6. For StatusName: use StatusMappings.GetActivityStatusName (from Plan 01)
       NOTE: Same as Plan 02 -- StatusMappings calls cannot be translated to SQL. Apply in-memory after materialization.
    7. Return null if activity not found (query filter will also hide cross-tenant activities)
    8. Dispose context

    **Step 6: Verify build**
    Run `dotnet build` and fix any compilation errors.
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - IActivityService has GetActivityDetailAsync method
    - ActivityService implements GetActivityDetailAsync with tenant-scoped query
    - HiringTeamMemberDto includes MemberTypeName via StatusMappings.GetActivityMemberTypeName
    - User entity scaffolded with DbSet in SignaturDbContext
    - SignaturDbContext.Custom.cs contains comment explaining why [User] has no global query filter
  </verify>
  <done>
    [User] table scaffolded for name resolution (no tenant filter needed -- documented with comment). ActivityDetailDto and HiringTeamMemberDto fully defined. ActivityService.GetActivityDetailAsync queries activity with hiring team members (names from [User] table) and candidate count, respecting tenant isolation via global query filters. Status and member type names resolved via StatusMappings helpers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the Activity Detail page with hiring team display</name>
  <files>
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor.cs
  </files>
  <action>
    **Step 1: Create ActivityDetail.razor page**

    Route: `@page "/activities/{ActivityId:int}"`
    Authorize: `@attribute [Authorize(Policy = "RecruitmentAccess")]`

    Layout structure using MudBlazor components:
    ```
    <PageTitle>Activity Detail - {Headline}</PageTitle>

    <!-- Breadcrumb / Back navigation -->
    <MudBreadcrumbs Items="_breadcrumbs" />

    <!-- Loading state -->
    @if (_activity == null && !_notFound)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (_notFound)
    {
        <MudAlert Severity="Severity.Warning">Activity not found.</MudAlert>
    }
    else
    {
        <!-- Activity Header Card -->
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">@_activity.Headline</MudText>
                    <MudChip T="string" Color="@GetStatusColor(_activity.EractivityStatusId)">
                        @_activity.StatusName
                    </MudChip>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <!-- Left column: Core details -->
                    <MudItem xs="12" md="6">
                        <MudSimpleTable Dense="true" Hover="true">
                            <!-- Job Title, Journal No, Deadline, Hire Date, Created, etc. -->
                        </MudSimpleTable>
                    </MudItem>
                    <!-- Right column: Flags and counts -->
                    <MudItem xs="12" md="6">
                        <MudSimpleTable Dense="true" Hover="true">
                            <!-- Continuous Posting, Candidate Evaluation, Candidates count, etc. -->
                        </MudSimpleTable>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Hiring Team Card -->
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">
                        Hiring Team
                        <MudChip T="string" Size="Size.Small">@_activity.HiringTeamMemberCount</MudChip>
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (_activity.HiringTeamMembers.Any())
                {
                    <MudSimpleTable Dense="true" Hover="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Review</th>
                                <th>Manage</th>
                                <th>Notes</th>
                                <th>Notifications</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var member in _activity.HiringTeamMembers)
                            {
                                <tr>
                                    <td>@member.FullName</td>
                                    <td>@member.Email</td>
                                    <td><MudChip T="string" Size="Size.Small">@member.MemberTypeName</MudChip></td>
                                    <td>@BoolDisplay(member.AllowCandidateReview)</td>
                                    <td>@BoolDisplay(member.AllowCandidateManagement)</td>
                                    <td>@BoolDisplay(member.AllowViewEditNotes)</td>
                                    <td>@BoolDisplay(member.NotificationMailSendToUser)</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No hiring team members assigned.</MudText>
                }
            </MudCardContent>
        </MudCard>

        <!-- Candidates Summary Card -->
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">
                        Candidates
                        <MudChip T="string" Size="Size.Small">@_activity.CandidateCount</MudChip>
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Href="@($"/activities/{ActivityId}/candidates")">
                    View Candidates
                </MudButton>
            </MudCardContent>
        </MudCard>
    }
    ```

    **Step 2: Create ActivityDetail.razor.cs code-behind**
    ```csharp
    public partial class ActivityDetail
    {
        [Parameter] public int ActivityId { get; set; }
        [Inject] private IActivityService ActivityService { get; set; } = default!;
        [Inject] private NavigationManager Navigation { get; set; } = default!;

        private ActivityDetailDto? _activity;
        private bool _notFound;
        private List<BreadcrumbItem> _breadcrumbs = new();

        protected override async Task OnInitializedAsync()
        {
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new("Activities", "/activities"),
                new("Detail", null, disabled: true)
            };

            _activity = await ActivityService.GetActivityDetailAsync(ActivityId);

            if (_activity == null)
            {
                _notFound = true;
            }
            else
            {
                _breadcrumbs[1] = new BreadcrumbItem(_activity.Headline, null, disabled: true);
            }
        }

        private Color GetStatusColor(int statusId) => statusId switch
        {
            1 => Color.Success,   // Ongoing
            2 => Color.Default,   // Closed
            3 => Color.Error,     // Deleted
            4 => Color.Warning,   // Draft
            _ => Color.Default
        };

        private string BoolDisplay(bool? value) => value switch
        {
            true => "\u2713",    // checkmark
            false => "\u2717",   // cross
            null => "-"
        };
    }
    ```

    **Step 3: Verify build and page structure**
    - `dotnet build` must pass
    - Page has correct route parameter binding
    - Breadcrumb navigation back to /activities works
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - ActivityDetail.razor has route `/activities/{ActivityId:int}`
    - ActivityDetail.razor.cs calls `GetActivityDetailAsync` in `OnInitializedAsync`
    - Hiring team members displayed in a table with columns: Name, Email, Type, Review, Manage, Notes, Notifications
    - Candidates summary shows count and link to candidate list
    - Loading state and not-found state handled
  </verify>
  <done>
    Activity detail page renders at /activities/{id} with: activity header card showing all key properties with status chip, hiring team table showing members with their names/emails/types/permissions (member type resolved via StatusMappings), candidates summary card with count and link to candidate view. Breadcrumb navigation back to activity list. Loading and not-found states handled gracefully.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build SignaturPortal.slnx` -- zero errors
2. [User] table scaffolded with documented tenant filtering decision (no filter, with explanation comment)
3. Navigate to /activities/{validId} -- shows activity detail with all fields
4. Hiring team section shows members from ERActivityMember table with user details from [User] table
5. Member type names shown via StatusMappings.GetActivityMemberTypeName
6. Candidates count matches ERCandidate count for the activity (non-deleted)
7. /activities/{invalidId} shows "Activity not found" message
8. Detail page respects tenant isolation (cross-tenant activity ID returns not found)
</verification>

<success_criteria>
- User clicks an activity in the list and sees the full detail page
- Activity header shows headline, status chip (color-coded), and core properties
- Hiring team table shows all members with their role type and permission flags
- Candidate count is displayed with a link to the candidate list page
- Breadcrumb navigation allows returning to activity list
- Invalid or cross-tenant activity IDs show a "not found" message
- [User] table tenant filtering documented with rationale
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-read-views/03-03-SUMMARY.md`
</output>
