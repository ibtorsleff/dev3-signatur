---
phase: 03-core-read-views
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
  - src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs
  - src/SignaturPortal.Application/Interfaces/IActivityService.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor.cs
autonomous: true

must_haves:
  truths:
    - "User can click an activity in the list and see its full read-only details"
    - "Activity detail page displays all key properties: headline, job title, journal number, deadline, hire date, status, creation date"
    - "Activity detail page shows the hiring team members with name, email, role type (internal/external), and permissions"
    - "Activity detail page shows the count and summary of linked candidates"
    - "Detail page respects tenant isolation -- user cannot view activity from another client"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor"
      provides: "Activity detail read-only view"
      contains: "MudCard"
    - path: "src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs"
      provides: "Full activity DTO with related data"
      contains: "ActivityDetailDto"
    - path: "src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs"
      provides: "Hiring team member DTO"
      contains: "HiringTeamMemberDto"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor.cs"
      to: "IActivityService.GetActivityDetailAsync"
      via: "DI injection + OnInitializedAsync"
      pattern: "GetActivityDetailAsync"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "Eractivitymember"
      via: "EF Core Include/projection"
      pattern: "Eractivitymember"
---

<objective>
Build the Activity Detail page that shows all read-only properties of a recruitment activity, its assigned hiring team members, and a summary of linked candidates.

Purpose: Users need to drill into an activity to see its full details and the hiring team composition. This is ELIST-08, ELIST-09, ELIST-10 from the requirements.

Output: Working detail page at /activities/{id} with activity properties, hiring team table, and candidate count summary.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-read-views/03-RESEARCH.md
@.planning/phases/03-core-read-views/03-01-SUMMARY.md
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivitymember.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
@src/SignaturPortal.Application/Interfaces/IActivityService.cs
@src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
@src/SignaturPortal.Infrastructure/Services/ActivityService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActivityDetailDto, HiringTeamMemberDto, and extend ActivityService</name>
  <files>
    src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
    src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs
    src/SignaturPortal.Application/Interfaces/IActivityService.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  </files>
  <action>
    **Step 1: Complete ActivityDetailDto**
    Update `src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs` (stub created in Plan 01) to include all relevant read-only fields from the ERActivity entity:

    ```csharp
    public record ActivityDetailDto
    {
        // Core identity
        public int EractivityId { get; init; }
        public int ClientId { get; init; }
        public string Headline { get; init; } = "";
        public string Jobtitle { get; init; } = "";
        public string JournalNo { get; init; } = "";

        // Status
        public int EractivityStatusId { get; init; }
        public string StatusName { get; init; } = "";

        // Dates
        public DateTime ApplicationDeadline { get; init; }
        public DateTime? HireDate { get; init; }
        public string? HireDateFreeText { get; init; }
        public DateTime CreateDate { get; init; }
        public DateTime StatusChangedTimeStamp { get; init; }

        // Flags
        public bool ContinuousPosting { get; init; }
        public bool CandidateEvaluationEnabled { get; init; }
        public bool IsCleaned { get; init; }
        public bool EmailOnNewCandidate { get; init; }

        // People
        public Guid Responsible { get; init; }
        public string ResponsibleName { get; init; } = "";
        public Guid CreatedBy { get; init; }
        public string CreatedByName { get; init; } = "";

        // Related data summaries
        public int CandidateCount { get; init; }
        public int HiringTeamMemberCount { get; init; }

        // Collections
        public List<HiringTeamMemberDto> HiringTeamMembers { get; init; } = new();
    }
    ```

    **Step 2: Create HiringTeamMemberDto**
    Create `src/SignaturPortal.Application/DTOs/HiringTeamMemberDto.cs`:
    ```csharp
    public record HiringTeamMemberDto
    {
        public int EractivityMemberId { get; init; }
        public Guid UserId { get; init; }
        public string UserName { get; init; } = "";
        public string FullName { get; init; } = "";
        public string Email { get; init; } = "";
        public int MemberTypeId { get; init; }
        public string MemberTypeName { get; init; } = ""; // "Internal", "External", "External Draft"
        public bool? AllowCandidateManagement { get; init; }
        public bool? AllowCandidateReview { get; init; }
        public bool? AllowViewEditNotes { get; init; }
        public bool? NotificationMailSendToUser { get; init; }
    }
    ```

    **Step 3: Extend IActivityService**
    Add to the interface:
    ```csharp
    Task<ActivityDetailDto?> GetActivityDetailAsync(int activityId, CancellationToken ct = default);
    ```

    **Step 4: Implement GetActivityDetailAsync in ActivityService**
    In ActivityService:
    1. Create DbContext via factory, stamp tenant context
    2. Query the activity with:
       - Activity properties projected to DTO
       - Hiring team members via Eractivitymembers navigation, joined with AspnetUsers for user names.
         Use AsSplitQuery() to avoid cartesian explosion between members and candidates.
       - CandidateCount as a subquery count (not loaded)
    3. For Responsible and CreatedBy names: join to aspnet_Users table to get UserName for those Guids
    4. For hiring team member names: the ERActivityMember table joins to a [User] table (not aspnet_Users). Check the actual schema -- the legacy SQL shows `INNER JOIN [User] USR ON ERAM.UserId = USR.UserId`. The `[User]` table is a separate table from `aspnet_Users`. You may need to scaffold the `[User]` table as well OR use a raw SQL query/subquery for the member names.

    IMPORTANT: The legacy app uses a `[User]` table (not `aspnet_Users`) for user details like FullName, Email, Phone. The `aspnet_Users` table only has UserName and UserId. For hiring team member names:
    - Option A: Scaffold the `[User]` table entity and join through it (preferred -- more tables but clean EF Core)
    - Option B: Use a raw SQL subquery to get FullName from [User] table

    Use Option A: scaffold the `[User]` table. Run:
    ```
    dotnet ef dbcontext scaffold "Name=ConnectionStrings:SignaturAnnoncePortal" Microsoft.EntityFrameworkCore.SqlServer --project src/SignaturPortal.Infrastructure --startup-project src/SignaturPortal.Web --output-dir Data/Entities --table [User] --no-onconfiguring --force --no-build
    ```
    Then add the DbSet and configure in DbContext. Add navigation from Eractivitymember to User.

    For the member type name, use a static mapping: 1 -> "Internal", 2 -> "External", 3 -> "External (Draft)"

    5. Return null if activity not found (query filter will also hide cross-tenant activities)
    6. Dispose context

    **Step 5: Verify build**
    Run `dotnet build` and fix any compilation errors.
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - IActivityService has GetActivityDetailAsync method
    - ActivityService implements GetActivityDetailAsync with tenant-scoped query
    - HiringTeamMemberDto includes member type name mapping
  </verify>
  <done>
    ActivityDetailDto and HiringTeamMemberDto fully defined. ActivityService.GetActivityDetailAsync queries activity with hiring team members and candidate count, respecting tenant isolation via global query filters. User table scaffolded for member name resolution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the Activity Detail page with hiring team display</name>
  <files>
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityDetail.razor.cs
  </files>
  <action>
    **Step 1: Create ActivityDetail.razor page**

    Route: `@page "/activities/{ActivityId:int}"`
    Authorize: `@attribute [Authorize(Policy = "RecruitmentAccess")]`

    Layout structure using MudBlazor components:
    ```
    <PageTitle>Activity Detail - {Headline}</PageTitle>

    <!-- Breadcrumb / Back navigation -->
    <MudBreadcrumbs Items="_breadcrumbs" />

    <!-- Loading state -->
    @if (_activity == null && !_notFound)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (_notFound)
    {
        <MudAlert Severity="Severity.Warning">Activity not found.</MudAlert>
    }
    else
    {
        <!-- Activity Header Card -->
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">@_activity.Headline</MudText>
                    <MudChip T="string" Color="@GetStatusColor(_activity.EractivityStatusId)">
                        @_activity.StatusName
                    </MudChip>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <!-- Left column: Core details -->
                    <MudItem xs="12" md="6">
                        <MudSimpleTable Dense="true" Hover="true">
                            <!-- Job Title, Journal No, Deadline, Hire Date, Created, etc. -->
                        </MudSimpleTable>
                    </MudItem>
                    <!-- Right column: Flags and counts -->
                    <MudItem xs="12" md="6">
                        <MudSimpleTable Dense="true" Hover="true">
                            <!-- Continuous Posting, Candidate Evaluation, Candidates count, etc. -->
                        </MudSimpleTable>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Hiring Team Card -->
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">
                        Hiring Team
                        <MudChip T="string" Size="Size.Small">@_activity.HiringTeamMemberCount</MudChip>
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (_activity.HiringTeamMembers.Any())
                {
                    <MudSimpleTable Dense="true" Hover="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Review</th>
                                <th>Manage</th>
                                <th>Notes</th>
                                <th>Notifications</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var member in _activity.HiringTeamMembers)
                            {
                                <tr>
                                    <td>@member.FullName</td>
                                    <td>@member.Email</td>
                                    <td><MudChip T="string" Size="Size.Small">@member.MemberTypeName</MudChip></td>
                                    <td>@BoolIcon(member.AllowCandidateReview)</td>
                                    <td>@BoolIcon(member.AllowCandidateManagement)</td>
                                    <td>@BoolIcon(member.AllowViewEditNotes)</td>
                                    <td>@BoolIcon(member.NotificationMailSendToUser)</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No hiring team members assigned.</MudText>
                }
            </MudCardContent>
        </MudCard>

        <!-- Candidates Summary Card (links to candidate list -- built in Plan 03) -->
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">
                        Candidates
                        <MudChip T="string" Size="Size.Small">@_activity.CandidateCount</MudChip>
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Href="@($"/activities/{ActivityId}/candidates")">
                    View Candidates
                </MudButton>
            </MudCardContent>
        </MudCard>
    }
    ```

    **Step 2: Create ActivityDetail.razor.cs code-behind**
    ```csharp
    public partial class ActivityDetail
    {
        [Parameter] public int ActivityId { get; set; }
        [Inject] private IActivityService ActivityService { get; set; } = default!;
        [Inject] private NavigationManager Navigation { get; set; } = default!;

        private ActivityDetailDto? _activity;
        private bool _notFound;
        private List<BreadcrumbItem> _breadcrumbs = new();

        protected override async Task OnInitializedAsync()
        {
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new("Activities", "/activities"),
                new("Detail", null, disabled: true)
            };

            _activity = await ActivityService.GetActivityDetailAsync(ActivityId);

            if (_activity == null)
            {
                _notFound = true;
            }
            else
            {
                _breadcrumbs[1] = new BreadcrumbItem(_activity.Headline, null, disabled: true);
            }
        }

        private Color GetStatusColor(int statusId) => statusId switch
        {
            1 => Color.Success,   // Ongoing
            2 => Color.Default,   // Closed
            3 => Color.Error,     // Deleted
            4 => Color.Warning,   // Draft
            _ => Color.Default
        };

        private RenderFragment BoolIcon(bool? value) => value switch
        {
            true => /* MudIcon check */,
            false => /* MudIcon close */,
            null => /* dash or empty */
        };
    }
    ```

    For the BoolIcon helper, render inline MudIcon components:
    - true: `<MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />`
    - false: `<MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Error" />`
    - null: `<MudText>-</MudText>`

    Since RenderFragment from code-behind is verbose, consider using a simpler approach:
    - Create a private method `string BoolDisplay(bool? value)` returning a Unicode checkmark/cross/dash
    - Or use `@if` blocks inline in the razor markup

    **Step 3: Verify build and page structure**
    - `dotnet build` must pass
    - Page has correct route parameter binding
    - Breadcrumb navigation back to /activities works
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - ActivityDetail.razor has route `/activities/{ActivityId:int}`
    - ActivityDetail.razor.cs calls `GetActivityDetailAsync` in `OnInitializedAsync`
    - Hiring team members displayed in a table with columns: Name, Email, Type, Review, Manage, Notes, Notifications
    - Candidates summary shows count and link to candidate list
    - Loading state and not-found state handled
  </verify>
  <done>
    Activity detail page renders at /activities/{id} with: activity header card showing all key properties with status chip, hiring team table showing members with their names/emails/types/permissions, candidates summary card with count and link to candidate view. Breadcrumb navigation back to activity list. Loading and not-found states handled gracefully.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build SignaturPortal.slnx` -- zero errors
2. Navigate to /activities/{validId} -- shows activity detail with all fields
3. Hiring team section shows members from ERActivityMember table with user details
4. Candidates count matches ERCandidate count for the activity (non-deleted)
5. /activities/{invalidId} shows "Activity not found" message
6. Detail page respects tenant isolation (cross-tenant activity ID returns not found)
</verification>

<success_criteria>
- User clicks an activity in the list and sees the full detail page
- Activity header shows headline, status chip (color-coded), and core properties
- Hiring team table shows all members with their role type and permission flags
- Candidate count is displayed with a link to the candidate list page
- Breadcrumb navigation allows returning to activity list
- Invalid or cross-tenant activity IDs show a "not found" message
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-read-views/03-02-SUMMARY.md`
</output>
