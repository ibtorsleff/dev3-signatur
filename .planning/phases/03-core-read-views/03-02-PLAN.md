---
phase: 03-core-read-views
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/SignaturPortal.Application/DTOs/ActivityListDto.cs
  - src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
  - src/SignaturPortal.Application/DTOs/CandidateListDto.cs
  - src/SignaturPortal.Application/DTOs/GridRequest.cs
  - src/SignaturPortal.Application/DTOs/GridResponse.cs
  - src/SignaturPortal.Application/Interfaces/IActivityService.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  - src/SignaturPortal.Infrastructure/Extensions/QueryableExtensions.cs
  - src/SignaturPortal.Infrastructure/DependencyInjection.cs
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
  - src/SignaturPortal.Web/Components/Layout/NavMenu.razor
  - src/SignaturPortal.Web/wwwroot/css/app.css
autonomous: true

must_haves:
  truths:
    - "User sees their recruitment activities in a paginated, sortable, filterable MudDataGrid"
    - "Activity list shows headline, journal no, deadline, status name, candidate count"
    - "Activity list is scoped to user's tenant (ClientId) via global query filters"
    - "Activity list loads with server-side data operations (no full dataset loaded client-side)"
    - "User can page through activities with configurable page size (10, 25, 50, 100)"
    - "User can sort by any column and filter by status"
    - "StatusName column uses StatusMappings.GetActivityStatusName for display"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor"
      provides: "MudDataGrid-based activity list page"
      contains: "MudDataGrid"
    - path: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      provides: "Server-side paginated activity query"
      exports: ["ActivityService"]
    - path: "src/SignaturPortal.Application/DTOs/ActivityListDto.cs"
      provides: "Flat DTO for grid display"
      contains: "ActivityListDto"
    - path: "src/SignaturPortal.Application/DTOs/GridRequest.cs"
      provides: "Generic grid query parameters"
      contains: "GridRequest"
    - path: "src/SignaturPortal.Infrastructure/Extensions/QueryableExtensions.cs"
      provides: "Reusable filter/sort/page LINQ extensions"
      contains: "ApplySorts"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs"
      to: "IActivityService"
      via: "DI injection + ServerData callback"
      pattern: "IActivityService"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "SignaturDbContext"
      via: "IDbContextFactory"
      pattern: "IDbContextFactory.*SignaturDbContext"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "StatusMappings"
      via: "Static method call for status name resolution"
      pattern: "StatusMappings\\.GetActivityStatusName"
---

<objective>
Create the Application-layer DTOs, service interface, service implementation, and QueryableExtensions for server-side data grid operations, then build the Activity List page with MudDataGrid.

Purpose: This is the core deliverable of Phase 3 -- the activity list is the primary screen users see when they open the E-recruitment portal. It must load fast, show the right data, and respect tenant isolation.

Output: Working activity list page at /activities with server-side MudDataGrid, backed by EF Core queries with proper tenant filtering.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-read-views/03-RESEARCH.md
@.planning/phases/03-core-read-views/03-01-SUMMARY.md
@src/SignaturPortal.Web/Program.cs
@src/SignaturPortal.Infrastructure/DependencyInjection.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Ercandidate.cs
@src/SignaturPortal.Infrastructure/Repositories/UnitOfWork.cs
@src/SignaturPortal.Domain/Interfaces/IRepository.cs
@src/SignaturPortal.Domain/Helpers/StatusMappings.cs
@src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs
@src/SignaturPortal.Application/Interfaces/IPermissionService.cs
@src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
@src/SignaturPortal.Web/Components/Layout/NavMenu.razor
@src/SignaturPortal.Web/Components/App.razor
@src/SignaturPortal.Web/Components/_Imports.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DTOs, service interface, service implementation, and QueryableExtensions</name>
  <files>
    src/SignaturPortal.Application/DTOs/ActivityListDto.cs
    src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
    src/SignaturPortal.Application/DTOs/CandidateListDto.cs
    src/SignaturPortal.Application/DTOs/GridRequest.cs
    src/SignaturPortal.Application/DTOs/GridResponse.cs
    src/SignaturPortal.Application/Interfaces/IActivityService.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
    src/SignaturPortal.Infrastructure/Extensions/QueryableExtensions.cs
    src/SignaturPortal.Infrastructure/DependencyInjection.cs
  </files>
  <action>
    **Step 1: Create Application layer DTOs**

    a) `GridRequest.cs` -- generic paginated grid request:
    ```csharp
    public class GridRequest
    {
        public int Page { get; set; }
        public int PageSize { get; set; } = 25;
        public List<SortDefinition> Sorts { get; set; } = new();
        public List<FilterDefinition> Filters { get; set; } = new();
    }
    public record SortDefinition(string PropertyName, bool Descending);
    public record FilterDefinition(string PropertyName, string Operator, object? Value);
    ```

    b) `GridResponse<T>` -- generic paginated response:
    ```csharp
    public class GridResponse<T>
    {
        public List<T> Items { get; set; } = new();
        public int TotalCount { get; set; }
    }
    ```

    c) `ActivityListDto.cs` -- flat DTO for the grid:
    ```csharp
    public record ActivityListDto
    {
        public int EractivityId { get; init; }
        public string Headline { get; init; } = "";
        public string Jobtitle { get; init; } = "";
        public string JournalNo { get; init; } = "";
        public DateTime ApplicationDeadline { get; init; }
        public int EractivityStatusId { get; init; }
        public string StatusName { get; init; } = "";
        public DateTime CreateDate { get; init; }
        public int CandidateCount { get; init; }
        public Guid Responsible { get; init; }
        public Guid CreatedBy { get; init; }
    }
    ```

    d) Create `ActivityDetailDto.cs` and `CandidateListDto.cs` stubs (will be completed in Plans 03/04) so they compile:
    - `ActivityDetailDto`: minimal stub with EractivityId, Headline, and a TODO comment
    - `CandidateListDto`: minimal stub with ErcandidateId, FirstName, LastName, and a TODO comment

    **Step 2: Create IActivityService interface**
    In `src/SignaturPortal.Application/Interfaces/IActivityService.cs`:
    ```csharp
    public interface IActivityService
    {
        Task<GridResponse<ActivityListDto>> GetActivitiesAsync(GridRequest request, CancellationToken ct = default);
    }
    ```

    **Step 3: Create ActivityService implementation**
    In `src/SignaturPortal.Infrastructure/Services/ActivityService.cs`:
    - Inject IDbContextFactory<SignaturDbContext>, IUserSessionContext, and IPermissionService
    - In GetActivitiesAsync:
      1. Create DbContext via factory, stamp CurrentSiteId/CurrentClientId from session
      2. Build base query: `context.Eractivities.Where(a => !a.IsCleaned)` -- global filter already handles ClientId
      3. Apply permission-based filtering: if user doesn't have AdminAccess, filter to activities where user is Responsible or CreatedBy (matching legacy behavior where non-admin users see only their activities). Inject IPermissionService to check this.
      4. Apply filters from GridRequest using QueryableExtensions
      5. Get TotalCount AFTER status/permission filters but BEFORE pagination
      6. Apply sorts from GridRequest using QueryableExtensions (default sort: ApplicationDeadline descending)
      7. Apply pagination (Skip/Take)
      8. Project to ActivityListDto using .Select() (NOT .Include()) to avoid N+1:
         - Use `StatusMappings.GetActivityStatusName(a.EractivityStatusId)` for StatusName. NOTE: This cannot be translated by EF Core to SQL. Instead, project EractivityStatusId into the DTO and compute StatusName in-memory AFTER materialization. Either: (a) materialize first, then map StatusName, or (b) leave StatusName empty in the projection and fill it in a loop after ToListAsync().
         - CandidateCount = a.Ercandidates.Count(c => !c.IsDeleted) -- subquery, not loaded
      9. After materializing items, set StatusName using StatusMappings.GetActivityStatusName for each item
      10. Dispose context via using statement

    **Step 4: Create QueryableExtensions**
    In `src/SignaturPortal.Infrastructure/Extensions/QueryableExtensions.cs`:
    - `ApplySorts<T>(this IQueryable<T>, List<SortDefinition>)` -- uses System.Linq.Dynamic.Core `OrderBy()` for dynamic property sorting
    - `ApplyFilters<T>(this IQueryable<T>, List<FilterDefinition>)` -- supports "contains", "equals", "startswith", "endswith" operators via System.Linq.Dynamic.Core
    - `ApplyPage<T>(this IQueryable<T>, int page, int pageSize)` -- Skip/Take

    **Step 5: Register services in DI**
    In `DependencyInjection.cs`:
    - Add `services.AddScoped<IActivityService, ActivityService>();`

    **Step 6: Verify build**
    Run `dotnet build` and fix any compilation errors.
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - IActivityService is registered in DI container
    - ActivityService uses StatusMappings.GetActivityStatusName (not inline string mapping)
    - QueryableExtensions provides ApplySorts, ApplyFilters, ApplyPage methods
    - ActivityService creates DbContext via IDbContextFactory and stamps tenant context
  </verify>
  <done>
    GridRequest/GridResponse DTOs defined. ActivityListDto with all grid columns. IActivityService interface with GetActivitiesAsync. ActivityService implements server-side pagination, sorting, filtering with tenant-scoped queries and StatusMappings-based status name resolution. QueryableExtensions provides reusable dynamic LINQ methods. Service registered in DI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the Activity List page with MudDataGrid</name>
  <files>
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
    src/SignaturPortal.Web/Components/Layout/NavMenu.razor
    src/SignaturPortal.Web/wwwroot/css/app.css
  </files>
  <action>
    **Step 1: Create ActivityList page with code-behind**

    Create `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor`:
    - Route: `@page "/activities"`
    - Authorize attribute: `@attribute [Authorize(Policy = "RecruitmentAccess")]`
    - Use `@attribute [StreamRendering]` for better loading UX
    - Contains a MudDataGrid with ServerData callback
    - Page title: "Recruitment Activities"

    MudDataGrid configuration:
    ```razor
    <MudDataGrid T="ActivityListDto"
                 @ref="_dataGrid"
                 ServerData="LoadServerData"
                 Filterable="true"
                 FilterMode="DataGridFilterMode.ColumnFilterRow"
                 SortMode="SortMode.Multiple"
                 Sortable="true"
                 Hover="true"
                 Dense="true"
                 RowClick="OnRowClick"
                 RowStyle="cursor: pointer;">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Recruitment Activities</MudText>
            <MudSpacer />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Headline" Title="Activity" />
            <PropertyColumn Property="x => x.JournalNo" Title="Journal No" />
            <PropertyColumn Property="x => x.ApplicationDeadline" Title="Deadline" Format="yyyy-MM-dd" />
            <PropertyColumn Property="x => x.StatusName" Title="Status" />
            <PropertyColumn Property="x => x.CandidateCount" Title="Candidates" Filterable="false" />
            <PropertyColumn Property="x => x.CreateDate" Title="Created" Format="yyyy-MM-dd" />
            <TemplateColumn Title="" Sortable="false" Filterable="false">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   Size="Size.Small"
                                   OnClick="@(() => NavigateToDetail(context.Item.EractivityId))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="ActivityListDto" PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
        <NoRecordsContent>
            <MudText>No recruitment activities found.</MudText>
        </NoRecordsContent>
    </MudDataGrid>
    ```

    Create `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs` (code-behind):
    ```csharp
    public partial class ActivityList
    {
        [Inject] private IActivityService ActivityService { get; set; } = default!;
        [Inject] private NavigationManager Navigation { get; set; } = default!;

        private MudDataGrid<ActivityListDto> _dataGrid = default!;

        private async Task<GridData<ActivityListDto>> LoadServerData(GridState<ActivityListDto> state)
        {
            var request = new GridRequest
            {
                Page = state.Page,
                PageSize = state.PageSize,
                Sorts = state.SortDefinitions
                    .Select(s => new SortDefinition(s.SortBy, s.Descending))
                    .ToList()
            };

            // Map MudDataGrid filter definitions to our GridRequest filters
            // (handle null values, type conversions)

            var response = await ActivityService.GetActivitiesAsync(request);

            return new GridData<ActivityListDto>
            {
                Items = response.Items,
                TotalItems = response.TotalCount
            };
        }

        private void NavigateToDetail(int activityId)
        {
            Navigation.NavigateTo($"/activities/{activityId}");
        }

        private void OnRowClick(DataGridRowClickEventArgs<ActivityListDto> args)
        {
            NavigateToDetail(args.Item.EractivityId);
        }
    }
    ```

    IMPORTANT: The MudDataGrid SortDefinitions API in MudBlazor 7.x uses `SortBy` as a string property name. Map from `state.SortDefinitions` to our `SortDefinition` records. Check the actual MudBlazor 7.x API -- the property name may be `SortBy` or `PropertyName` depending on version. Use the installed version's actual API.

    **Step 2: Update NavMenu**
    In `NavMenu.razor`, update the "E-Recruitment" link to point to `/activities` instead of `/e-recruitment` (or add it alongside):
    - Change the E-Recruitment nav link href to "/activities"

    **Step 3: Add minimal activity-list styling**
    If needed, add basic styles to `app.css` to make the grid look clean. MudBlazor handles most styling, so this should be minimal.

    **Step 4: Verify end-to-end**
    - Build the solution
    - Verify the MudDataGrid renders correctly
  </action>
  <verify>
    - `dotnet build SignaturPortal.slnx` compiles with 0 errors
    - The file `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor` exists and contains `MudDataGrid`
    - The file `src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs` exists and contains `IActivityService`
    - NavMenu links to /activities
    - MudBlazor theme uses primary color #1a9b89 (configured in Plan 01)
  </verify>
  <done>
    Activity list page renders a MudDataGrid at /activities with server-side data loading, pagination (10/25/50/100), sorting on all columns, column filter row, and row click navigation to detail page. NavMenu links to the activity list.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build SignaturPortal.slnx` -- zero errors
2. ActivityService implements server-side pagination, sorting, and tenant-scoped queries
3. ActivityService uses StatusMappings.GetActivityStatusName (explicit, verified mapping)
4. /activities route renders MudDataGrid with correct columns
5. Permission-based filtering applied (non-admin users see own activities only)
6. NavMenu updated with /activities link
</verification>

<success_criteria>
- User navigates to /activities and sees a MudDataGrid with recruitment activities
- Grid supports pagination with configurable page sizes (10, 25, 50, 100)
- Grid supports sorting on Headline, Journal No, Deadline, Status, Created columns
- Grid shows column filter row for filtering
- Data is loaded server-side (no client-side loading of full dataset)
- Activities are scoped to user's tenant via EF Core global query filters
- Status names displayed via StatusMappings helper (not inline strings)
- Clicking a row or the view icon navigates to /activities/{id} (page built in Plan 03)
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-read-views/03-02-SUMMARY.md`
</output>
