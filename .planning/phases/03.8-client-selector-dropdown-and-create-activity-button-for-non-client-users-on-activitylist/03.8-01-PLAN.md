---
phase: 03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Application/DTOs/ClientDropdownDto.cs
  - src/SignaturPortal.Application/Interfaces/IClientService.cs
  - src/SignaturPortal.Infrastructure/Services/ClientService.cs
  - src/SignaturPortal.Infrastructure/DependencyInjection.cs
  - src/SignaturPortal.Application/Interfaces/IActivityService.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
autonomous: true
must_haves:
  truths:
    - "IClientService.GetClientsForSiteAsync returns client list with names extracted from ObjectData XML"
    - "GetActivitiesAsync accepts optional clientIdFilter that overrides session-based ClientId filtering"
    - "ClientService is registered as Scoped in DI"
  artifacts:
    - path: "src/SignaturPortal.Application/DTOs/ClientDropdownDto.cs"
      provides: "DTO for client dropdown items"
      contains: "record ClientDropdownDto"
    - path: "src/SignaturPortal.Application/Interfaces/IClientService.cs"
      provides: "Client service interface"
      exports: ["IClientService"]
    - path: "src/SignaturPortal.Infrastructure/Services/ClientService.cs"
      provides: "Client service implementation with SQL XPath query"
      contains: "ObjectData.value"
    - path: "src/SignaturPortal.Application/Interfaces/IActivityService.cs"
      provides: "Updated interface with clientIdFilter parameter"
      contains: "clientIdFilter"
    - path: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      provides: "Updated implementation using clientIdFilter"
      contains: "clientIdFilter"
  key_links:
    - from: "src/SignaturPortal.Infrastructure/Services/ClientService.cs"
      to: "SignaturDbContext"
      via: "IDbContextFactory"
      pattern: "_contextFactory.CreateDbContextAsync"
    - from: "src/SignaturPortal.Infrastructure/DependencyInjection.cs"
      to: "ClientService"
      via: "AddScoped"
      pattern: "AddScoped<IClientService, ClientService>"
---

<objective>
Create the backend service layer for client dropdown data and add client filtering capability to the activity list query.

Purpose: Non-client (staff/admin) users need to filter the activity list by client. This requires a new service to load client names (extracted from ObjectData XML) and an updated ActivityService that accepts an explicit client filter override.

Output: IClientService with GetClientsForSiteAsync, ClientDropdownDto, and updated IActivityService/ActivityService with clientIdFilter parameter.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist/03.8-RESEARCH.md
@src/SignaturPortal.Application/Interfaces/IActivityService.cs
@src/SignaturPortal.Infrastructure/Services/ActivityService.cs
@src/SignaturPortal.Infrastructure/DependencyInjection.cs
@src/SignaturPortal.Application/DTOs/ClientDto.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IClientService, ClientDropdownDto, and ClientService with SQL XPath client name extraction</name>
  <files>
    src/SignaturPortal.Application/DTOs/ClientDropdownDto.cs
    src/SignaturPortal.Application/Interfaces/IClientService.cs
    src/SignaturPortal.Infrastructure/Services/ClientService.cs
    src/SignaturPortal.Infrastructure/DependencyInjection.cs
  </files>
  <action>
    1. Create `ClientDropdownDto` as a simple record in Application/DTOs:
       ```csharp
       public record ClientDropdownDto(int ClientId, string ClientName);
       ```

    2. Create `IClientService` interface in Application/Interfaces with one method:
       ```csharp
       Task<List<ClientDropdownDto>> GetClientsForSiteAsync(int siteId, CancellationToken ct = default);
       ```

    3. Create `ClientService` in Infrastructure/Services implementing `IClientService`:
       - Inject `IDbContextFactory<SignaturDbContext>`.
       - `GetClientsForSiteAsync` uses `context.Database.SqlQueryRaw<ClientDropdownDto>` with raw SQL that:
         - Selects `c.ClientId` and `c.ObjectData.value('(/Client/ClientName)[1]','NVARCHAR(128)') AS ClientName`
         - From `Client c`
         - WHERE `c.SiteId = {0}` (parameterized)
         - AND `c.ObjectData.value('(/Client/Enabled)[1]','NVARCHAR(5)') = 'true'` (only enabled clients)
         - ORDER BY extracted ClientName
       - Do NOT set CurrentSiteId/CurrentClientId on context (raw SQL bypasses EF global filters).
       - Do NOT use System.Xml.Linq or parse XML in C# -- let SQL Server handle XPath.

    4. Register in `DependencyInjection.cs`:
       - Add `services.AddScoped<IClientService, ClientService>();` after the IActivityService line.
       - Add `using` for IClientService if needed (it should be covered by existing Application.Interfaces using).
  </action>
  <verify>
    Run `dotnet build` on the solution. No compile errors. Verify ClientService.cs contains `SqlQueryRaw` with `ObjectData.value` XPath pattern.
  </verify>
  <done>
    IClientService interface exists, ClientService implementation uses raw SQL XPath to extract client names from ObjectData XML, ClientDropdownDto record created, service registered as Scoped in DI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add clientIdFilter parameter to IActivityService and ActivityService.GetActivitiesAsync</name>
  <files>
    src/SignaturPortal.Application/Interfaces/IActivityService.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  </files>
  <action>
    1. Update `IActivityService.GetActivitiesAsync` signature to add optional `int? clientIdFilter = null` parameter:
       ```csharp
       Task<GridResponse<ActivityListDto>> GetActivitiesAsync(
           GridRequest request,
           ERActivityStatus? statusFilter = null,
           int? clientIdFilter = null,
           CancellationToken ct = default);
       ```
       This is a non-breaking change -- existing callers pass null by default.

    2. Update `ActivityService.GetActivitiesAsync` implementation:
       - Add `int? clientIdFilter = null` parameter matching the interface.
       - Change the `context.CurrentClientId` stamping logic:
         ```csharp
         // Use explicit client filter if provided (non-client user selected a client),
         // otherwise fall back to session ClientId (null for non-client = show all)
         if (clientIdFilter.HasValue && clientIdFilter.Value > 0)
             context.CurrentClientId = clientIdFilter.Value;
         else
             context.CurrentClientId = _sessionContext.ClientId;
         ```
       - This replaces the current simple `context.CurrentClientId = _sessionContext.ClientId;` line.
       - When clientIdFilter is -1 or null, non-client users see all activities (existing behavior).
       - When clientIdFilter is a positive int, the global query filter scopes to that client.

    3. Do NOT change any other methods in ActivityService. Do NOT change the method signatures of GetActivityDetailAsync, GetCandidatesAsync, or GetCandidateFileDataAsync.
  </action>
  <verify>
    Run `dotnet build` on the solution. No compile errors. Verify that existing callers (ActivityList.razor.cs line 119) still compile since the new parameter has a default value.
  </verify>
  <done>
    IActivityService and ActivityService accept optional clientIdFilter parameter. Existing callers unaffected (default null). When a positive clientId is passed, CurrentClientId is stamped to filter by that client.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with zero errors and zero warnings related to the changed files.
2. `IClientService` interface has `GetClientsForSiteAsync(int siteId, CancellationToken ct)` method.
3. `ClientService` uses `SqlQueryRaw` with `ObjectData.value` XPath -- not C# XML parsing.
4. `IActivityService.GetActivitiesAsync` has `clientIdFilter` as third optional parameter with default null.
5. `ActivityService.GetActivitiesAsync` uses `clientIdFilter` to override `CurrentClientId` when positive.
6. No existing callers broken (compile check).
</verification>

<success_criteria>
- ClientDropdownDto, IClientService, ClientService exist and compile
- ClientService registered as Scoped in DependencyInjection.cs
- GetActivitiesAsync signature updated with backward-compatible clientIdFilter parameter
- ActivityService stamps CurrentClientId from clientIdFilter when provided and positive
- Full solution builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist/03.8-01-SUMMARY.md`
</output>
