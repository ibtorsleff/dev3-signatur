---
phase: 03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist
plan: 02
type: execute
wave: 2
depends_on: ["03.8-01"]
files_modified:
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
autonomous: true
must_haves:
  truths:
    - "Non-client users see a client dropdown in the activity list toolbar"
    - "Client users do NOT see the client dropdown"
    - "Selecting a client reloads the activity list filtered to that client"
    - "Non-client users see a Create Activity button when they have CreateActivity permission"
    - "Create Activity button navigates to legacy ASPX page via YARP with forceLoad"
    - "Create Activity button requires client selection for non-client users (snackbar if not selected)"
    - "Draft mode navigates to ActivityCreateDraft.aspx, other modes to ActivityCreateEdit.aspx"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor"
      provides: "MudSelect client dropdown and MudButton for Create Activity in ToolBarContent"
      contains: "MudSelect"
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs"
      provides: "Client loading, selection handler, create activity navigation logic"
      contains: "OnClientChanged"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs"
      to: "IClientService"
      via: "Inject"
      pattern: "IClientService"
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs"
      to: "ActivityService.GetActivitiesAsync"
      via: "clientIdFilter parameter"
      pattern: "GetActivitiesAsync.*_selectedClientId"
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs"
      to: "Legacy ASPX pages"
      via: "NavigateTo with forceLoad"
      pattern: "NavigateTo.*ActivityCreate.*forceLoad.*true"
---

<objective>
Add client selector dropdown and Create Activity button to the ActivityList toolbar for non-client users.

Purpose: Staff/admin users need to filter the activity list by client and navigate to legacy activity creation pages. Client users already have implicit client scoping and do not need these controls.

Output: Updated ActivityList.razor with MudSelect client dropdown and MudButton for Create Activity in the toolbar area, with full event handling.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist/03.8-RESEARCH.md
@.planning/phases/03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist/03.8-01-SUMMARY.md
@src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
@src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client dropdown, create button, and event handlers to ActivityList</name>
  <files>
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
  </files>
  <action>
    **Code-behind (ActivityList.razor.cs):**

    1. Add new injected services at the top:
       ```csharp
       [Inject] private IClientService ClientService { get; set; } = default!;
       ```
       Add the `using SignaturPortal.Application.DTOs;` if not already present (it should be).

    2. Add new state fields after the existing permission fields:
       ```csharp
       private List<ClientDropdownDto> _clients = new();
       private int _selectedClientId = -1; // -1 = all clients (no filter)
       ```

    3. In `OnInitializedAsync`, after the existing `_canCreateActivity` line, add:
       ```csharp
       if (!_isClientUser)
       {
           var siteId = Session.SiteId ?? 0;
           if (siteId > 0)
               _clients = await ClientService.GetClientsForSiteAsync(siteId);
       }
       ```

    4. Add `OnClientChanged` handler:
       ```csharp
       private async Task OnClientChanged(int clientId)
       {
           _selectedClientId = clientId;
           await _dataGrid.ReloadServerData();
       }
       ```

    5. Update `LoadServerData` to pass clientIdFilter to `GetActivitiesAsync`:
       Change line 119 from:
       ```csharp
       var response = await ActivityService.GetActivitiesAsync(request, _currentStatus);
       ```
       To:
       ```csharp
       var clientFilter = _isClientUser ? null : (_selectedClientId > 0 ? (int?)_selectedClientId : null);
       var response = await ActivityService.GetActivitiesAsync(request, _currentStatus, clientFilter);
       ```

    6. Add `OnCreateActivityClick` handler:
       ```csharp
       private void OnCreateActivityClick()
       {
           if (!_isClientUser && _selectedClientId <= 0)
           {
               Snackbar.Add(Localization.GetText("PleaseSelectClient"), Severity.Warning);
               return;
           }

           var clientId = _isClientUser ? (Session.ClientId ?? 0) : _selectedClientId;

           string url;
           if (_currentStatus == ERActivityStatus.Draft)
           {
               url = clientId > 0
                   ? $"/Responsive/Recruiting/ActivityCreateDraft.aspx?ClientId={clientId}"
                   : "/Responsive/Recruiting/ActivityCreateDraft.aspx";
           }
           else
           {
               url = clientId > 0
                   ? $"/Responsive/Recruiting/ActivityCreateEdit.aspx?ClientId={clientId}"
                   : "/Responsive/Recruiting/ActivityCreateEdit.aspx";
           }

           Navigation.NavigateTo(url, forceLoad: true);
       }
       ```

    7. Add a computed property for the create button text:
       ```csharp
       private string _createButtonText => _currentStatus == ERActivityStatus.Draft
           ? Localization.GetText("ERCreateNewDraftActivity")
           : Localization.GetText("CreateNewActivity");
       ```

    **Razor template (ActivityList.razor):**

    8. Modify the `<ToolBarContent>` section. After the MudChip count badge and BEFORE the existing `<MudSpacer />`, insert the client dropdown (conditionally visible for non-client users):
       ```razor
       @if (!_isClientUser)
       {
           <MudSelect T="int" Value="_selectedClientId" ValueChanged="OnClientChanged"
                      Label="@Localization.GetText("Client")"
                      Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                      Style="max-width: 300px; margin-left: 16px;">
               <MudSelectItem T="int" Value="-1">(@Localization.GetText("AllClients"))</MudSelectItem>
               @foreach (var client in _clients)
               {
                   <MudSelectItem T="int" Value="client.ClientId">@client.ClientName</MudSelectItem>
               }
           </MudSelect>
       }
       ```

    9. After the `<MudSpacer />` and BEFORE the existing filter toggle MudTooltip, add the Create Activity button (visible when user has permission):
       ```razor
       @if (_canCreateActivity)
       {
           <MudButton Variant="Variant.Filled" Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="OnCreateActivityClick"
                      Style="margin-right: 8px;">
               @_createButtonText
           </MudButton>
       }
       ```

    The final toolbar order should be: Headline text | Count chip | Client dropdown (non-client only) | Spacer | Create button (permission-gated) | Filter toggle.

    **Important:** Do NOT add `@using` for `System.Xml.Linq` or any XML parsing. The client names come pre-extracted from the service. Do NOT change any column definitions or other parts of the grid.
  </action>
  <verify>
    1. `dotnet build` succeeds with zero errors.
    2. Verify `ActivityList.razor` contains `MudSelect` with `OnClientChanged` handler.
    3. Verify `ActivityList.razor` contains `MudButton` with `OnCreateActivityClick` handler.
    4. Verify `ActivityList.razor.cs` calls `GetActivitiesAsync` with three arguments (request, status, clientFilter).
    5. Verify `OnCreateActivityClick` uses `forceLoad: true` for legacy navigation.
    6. Verify the dropdown is wrapped in `@if (!_isClientUser)` conditional.
    7. Verify the button is wrapped in `@if (_canCreateActivity)` conditional.
  </verify>
  <done>
    Non-client users see a client dropdown (MudSelect) in the ActivityList toolbar that filters the grid on selection. Create Activity button visible for permitted users, navigates to correct legacy ASPX page (Draft vs Ongoing) via YARP with ClientId query parameter. Client selection required for non-client Create (snackbar warning). Client users see neither control.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with zero errors.
2. Non-client user toolbar shows: headline, count, client dropdown, spacer, create button, filter toggle.
3. Client user toolbar shows: headline, count, spacer, filter toggle (no dropdown, no create button unless permitted).
4. Selecting a client from dropdown triggers grid reload with filtered data.
5. Selecting "All Clients" (-1) shows all activities (no client filter).
6. Create Activity in draft mode navigates to `ActivityCreateDraft.aspx?ClientId=X`.
7. Create Activity in ongoing/closed mode navigates to `ActivityCreateEdit.aspx?ClientId=X`.
8. Create Activity without client selection shows snackbar warning for non-client users.
</verification>

<success_criteria>
- Client dropdown visible only for non-client users
- Client dropdown populated from IClientService
- Grid reloads on client selection with correct filter
- Create Activity button visible only when user has CreateActivity permission
- Create Activity navigates to correct legacy page based on current mode
- Client selection enforced before Create for non-client users
- All navigation uses forceLoad: true for YARP proxy
- Full solution builds and compiles
</success_criteria>

<output>
After completion, create `.planning/phases/03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist/03.8-02-SUMMARY.md`
</output>
