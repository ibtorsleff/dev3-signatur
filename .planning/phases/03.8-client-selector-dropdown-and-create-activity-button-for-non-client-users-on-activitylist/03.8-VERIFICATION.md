---
phase: 03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist
verified: 2026-02-18T11:30:28Z
status: passed
score: 10/10 must-haves verified
re_verification: false
---

# Phase 03.8: Client Selector Dropdown and Create Activity Button Verification Report

**Phase Goal:** Non-client (staff/admin) users can filter the activity list by client via a dropdown and navigate to legacy activity creation pages via a Create Activity button -- matching the legacy toolbar behavior
**Verified:** 2026-02-18T11:30:28Z
**Status:** passed
**Re-verification:** No -- initial verification

---

## Goal Achievement

### Observable Truths

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | IClientService.GetClientsForSiteAsync returns client list with names extracted from ObjectData XML | VERIFIED | ClientService.cs uses SqlQueryRaw with ObjectData.value() XPath; returns List<ClientDropdownDto> |
| 2  | GetActivitiesAsync accepts optional clientIdFilter that overrides session-based ClientId filtering | VERIFIED | IActivityService.cs has int? clientIdFilter = null; ActivityService.cs stamps CurrentClientId from it when positive |
| 3  | ClientService is registered as Scoped in DI | VERIFIED | DependencyInjection.cs line 55: services.AddScoped<IClientService, ClientService>() |
| 4  | Non-client users see a client dropdown in the activity list toolbar | VERIFIED | ActivityList.razor ToolBarContent wraps MudSelect in @if (!_isClientUser) |
| 5  | Client users do NOT see the client dropdown | VERIFIED | Same @if (!_isClientUser) conditional excludes client users |
| 6  | Selecting a client reloads the activity list filtered to that client | VERIFIED | OnClientChanged sets _selectedClientId and calls _dataGrid.ReloadServerData(); LoadServerData passes clientFilter to GetActivitiesAsync |
| 7  | Non-client users see a Create Activity button when they have CreateActivity permission | VERIFIED | ActivityList.razor wraps MudButton in @if (_canCreateActivity) |
| 8  | Create Activity button navigates to legacy ASPX page via YARP with forceLoad | VERIFIED | OnCreateActivityClick calls Navigation.NavigateTo(url, forceLoad: true) |
| 9  | Create Activity button requires client selection for non-client users (snackbar if not selected) | VERIFIED | OnCreateActivityClick guard: if (!_isClientUser && _selectedClientId <= 0) shows Snackbar.Add warning |
| 10 | Draft mode navigates to ActivityCreateDraft.aspx, other modes to ActivityCreateEdit.aspx | VERIFIED | Branch logic on _currentStatus == ERActivityStatus.Draft in OnCreateActivityClick |

**Score:** 10/10 truths verified

---

### Required Artifacts

| Artifact | Provided | Status | Details |
|----------|----------|--------|---------|
| src/SignaturPortal.Application/DTOs/ClientDropdownDto.cs | DTO for client dropdown items | VERIFIED | record ClientDropdownDto(int ClientId, string ClientName) -- substantive, used by IClientService and ActivityList |
| src/SignaturPortal.Application/Interfaces/IClientService.cs | Client service interface | VERIFIED | Exports IClientService with GetClientsForSiteAsync(int siteId, CancellationToken ct = default) |
| src/SignaturPortal.Infrastructure/Services/ClientService.cs | Client service implementation with SQL XPath query | VERIFIED | Uses SqlQueryRaw with ObjectData.value() XPath; IDbContextFactory injected; no C# XML parsing |
| src/SignaturPortal.Application/Interfaces/IActivityService.cs | Updated interface with clientIdFilter parameter | VERIFIED | GetActivitiesAsync has int? clientIdFilter = null as third parameter (backward compatible) |
| src/SignaturPortal.Infrastructure/Services/ActivityService.cs | Updated implementation using clientIdFilter | VERIFIED | clientIdFilter > 0 stamps CurrentClientId; else falls back to _sessionContext.ClientId |
| src/SignaturPortal.Infrastructure/DependencyInjection.cs | DI registration for ClientService | VERIFIED | AddScoped<IClientService, ClientService>() at line 55 |
| src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor | MudSelect client dropdown and MudButton in ToolBarContent | VERIFIED | MudSelect (T=int, ValueChanged=OnClientChanged) and MudButton (OnClick=OnCreateActivityClick) both present in ToolBarContent |
| src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs | Client loading, selection handler, create activity navigation logic | VERIFIED | IClientService injected at line 19; _clients loaded in OnInitializedAsync; OnClientChanged, OnCreateActivityClick, _createButtonText all fully implemented |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| ClientService.cs | SignaturDbContext | IDbContextFactory | WIRED | _contextFactory.CreateDbContextAsync() called in GetClientsForSiteAsync |
| DependencyInjection.cs | ClientService | AddScoped | WIRED | services.AddScoped<IClientService, ClientService>() at line 55 |
| ActivityList.razor.cs | IClientService | [Inject] | WIRED | [Inject] private IClientService ClientService at line 19; used in OnInitializedAsync to load _clients |
| ActivityList.razor.cs | ActivityService.GetActivitiesAsync | clientIdFilter parameter | WIRED | var clientFilter computed from _selectedClientId; passed as third argument in LoadServerData at line 132 |
| ActivityList.razor.cs | Legacy ASPX pages | NavigateTo forceLoad | WIRED | Navigation.NavigateTo(url, forceLoad: true) in OnCreateActivityClick; both ActivityCreateDraft.aspx and ActivityCreateEdit.aspx with ClientId query param |

---

### Requirements Coverage

| Requirement | Status | Notes |
|-------------|--------|-------|
| Non-client users can filter activity list by client | SATISFIED | MudSelect dropdown triggers OnClientChanged which reloads grid with clientIdFilter |
| Client users are not shown the client dropdown | SATISFIED | @if (!_isClientUser) wraps the entire MudSelect block |
| Non-client users with CreateActivity permission see Create Activity button | SATISFIED | @if (_canCreateActivity) wraps MudButton; permission loaded via PermHelper.UserCanCreateActivityAsync() |
| Create Activity navigates to correct legacy ASPX based on mode | SATISFIED | Draft -> ActivityCreateDraft.aspx; Ongoing/Closed -> ActivityCreateEdit.aspx; ClientId appended as query param |
| Navigation uses forceLoad for YARP proxy | SATISFIED | forceLoad: true on all NavigateTo calls in OnCreateActivityClick |
| Client selection enforced before Create for non-client users | SATISFIED | Guard clause shows snackbar when _selectedClientId <= 0 for non-client users |

---

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| ActivityList.razor.cs | 44 | TODO: Replace _clientHasWebAdVisitorStatistics | Info | Pre-existing from phase 03.6 (commit a43591f); hardcoded true matches current client config; out of scope for 03.8 |
| ActivityList.razor.cs | 49 | TODO: Replace _clientUsesTemplateGroups | Info | Pre-existing from phase 03.6 (commit a43591f); hardcoded false matches current client config; out of scope for 03.8 |

Both TODOs were introduced before phase 03.8. Confirmed via git: phase 03.8 commit b270224 added zero new TODO lines. Neither TODO blocks the phase 03.8 goal.

---

### Human Verification Required

#### 1. Client Dropdown Population

**Test:** Log in as a non-client (staff/admin) user, navigate to /activities
**Expected:** Client dropdown appears in the toolbar, populated with enabled clients for the site with names correctly extracted from ObjectData XML
**Why human:** SQL XPath extraction from the real database cannot be verified by static analysis

#### 2. Client Filtering Behavior

**Test:** Select a client from the dropdown
**Expected:** Activity list immediately reloads showing only activities for the selected client; selecting All Clients shows all activities
**Why human:** Requires live Blazor circuit and database query execution

#### 3. Create Activity Button Visibility by Permission

**Test:** Log in as non-client user WITH CreateActivity permission, navigate to /activities
**Expected:** Create Activity button visible in toolbar to the right of the spacer
**Test 2:** Log in as non-client user WITHOUT CreateActivity permission
**Expected:** Create Activity button is absent
**Why human:** Permission state depends on live database permission records

#### 4. Client Selection Enforcement

**Test:** As a non-client user with no client selected (-1), click Create Activity
**Expected:** Snackbar warning appears, navigation does not occur
**Why human:** Requires live Blazor interaction

#### 5. Draft vs Ongoing Navigation

**Test:** In Ongoing mode with a client selected, click Create Activity
**Expected:** Browser navigates to /Responsive/Recruiting/ActivityCreateEdit.aspx?ClientId=X via YARP (legacy page loads)
**Test 2:** Switch to Draft mode, click Create Activity
**Expected:** Browser navigates to /Responsive/Recruiting/ActivityCreateDraft.aspx?ClientId=X via YARP
**Why human:** Requires live YARP proxy and legacy app running on localhost:1500

---

### Gaps Summary

No gaps. All 10 observable truths are verified. All 8 required artifacts exist, are substantive, and are properly wired. All 5 key links are confirmed. Git history confirms all phase commits are present (4daa30c, ff87831, b270224). The two pre-existing TODO items are informational and do not block the phase 03.8 goal.

---

_Verified: 2026-02-18T11:30:28Z_
_Verifier: Claude (gsd-verifier)_
