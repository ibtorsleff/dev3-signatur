# Phase 03.8: Client Selector Dropdown and Create Activity Button for Non-Client Users - Research

**Researched:** 2026-02-18
**Domain:** Blazor Server UI components, MudBlazor toolbar, multi-tenant client filtering
**Confidence:** HIGH

## Summary

This phase adds two toolbar elements to the ActivityList page for non-client (staff/admin) users: a client selector dropdown that filters the activity list by client, and a "Create Activity" button that navigates to activity creation (passing the selected client). These mirror the legacy WebForms `toolbarClientDdl` and `toolbarCreateNewActivityBtn` in `ActivityList.aspx`.

The legacy implementation shows that: (1) the client dropdown is **only visible** when `!_isClientLoggedOn` (non-client users), (2) it populates from `ClientsGet(siteId, enabled, eRecruitmentEnabled)` which queries the `Client` table extracting `ClientName` from the `ObjectData` XML column, (3) selecting a client re-filters the activity list, and (4) the Create button requires a client to be selected (shows "Please select client" message if not). The current Blazor `ActivityService.GetActivitiesAsync` uses `context.CurrentClientId` for the EF global query filter -- for non-client users this is null, so all activities are shown. The client dropdown needs to override this filtering.

**Primary recommendation:** Add a `MudSelect<int>` client dropdown in the ToolBarContent that is conditionally visible for non-client users, pass the selected clientId as a parameter to `GetActivitiesAsync`, and add a `MudButton` for "Create Activity" that navigates to the legacy `ActivityCreateEdit.aspx` (or `ActivityCreateDraft.aspx` for draft mode) via YARP with the selected ClientId as a query parameter.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| MudBlazor | 8.0.0 | UI components (MudSelect, MudButton, MudDataGrid) | Already used throughout project |
| EF Core | (project default) | Database access via IDbContextFactory | Already used, global query filters for tenancy |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| System.Xml.Linq | (built-in) | Parse Client.ObjectData XML to extract ClientName | Reading client names from XML column |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| MudSelect | MudAutocomplete | Autocomplete better for large lists (100+ clients), but MudSelect matches legacy dropdown behavior |
| XML parsing in C# | Raw SQL `ObjectData.value()` | Raw SQL is closer to legacy pattern but EF Core `FromSqlRaw` is harder to compose with LINQ |

## Architecture Patterns

### Data Flow for Client Dropdown
```
ActivityList.razor (UI)
  |-- OnInitializedAsync: if (!_isClientUser) load client list
  |-- MudSelect<int> bound to _selectedClientId
  |-- On change: reload MudDataGrid server data
  |
ActivityService.GetActivitiesAsync(request, status, clientIdFilter?)
  |-- If clientIdFilter provided, stamp context.CurrentClientId = clientIdFilter
  |-- If not provided (and user is non-client), CurrentClientId stays null (show all)
  |
New: IClientService.GetClientsForSiteAsync(siteId)
  |-- Queries Client table WHERE SiteId = siteId
  |-- Parses ObjectData XML for ClientName
  |-- Returns List<ClientDropdownDto> { ClientId, ClientName }
```

### Pattern 1: Toolbar Extension in MudDataGrid
**What:** Add client dropdown and create button inside existing `<ToolBarContent>` section
**When to use:** When adding controls to the grid toolbar
**Example:**
```razor
<ToolBarContent>
    <MudText Typo="Typo.body1" ...>@_headlineText</MudText>
    <MudChip ...>@_totalCount.ToString()</MudChip>
    @if (!_isClientUser)
    {
        <MudSelect T="int" Value="_selectedClientId" ValueChanged="OnClientChanged"
                   Label="@Localization.GetText("Client")"
                   Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                   Style="max-width: 300px; margin-left: 16px;">
            <MudSelectItem T="int" Value="-1">(@Localization.GetText("AllClients"))</MudSelectItem>
            @foreach (var client in _clients)
            {
                <MudSelectItem T="int" Value="client.ClientId">@client.ClientName</MudSelectItem>
            }
        </MudSelect>
    }
    <MudSpacer />
    @if (_canCreateActivity)
    {
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OnCreateActivityClick"
                   Style="margin-right: 8px;">
            @_createButtonText
        </MudButton>
    }
    <MudTooltip ...>
        <MudIconButton Icon="@Icons.Material.Filled.FilterList" ... />
    </MudTooltip>
</ToolBarContent>
```

### Pattern 2: Client Filtering Override in ActivityService
**What:** Add optional `clientIdFilter` parameter to `GetActivitiesAsync` that overrides the session-based `CurrentClientId`
**When to use:** When non-client user selects a specific client from dropdown
**Example:**
```csharp
public async Task<GridResponse<ActivityListDto>> GetActivitiesAsync(
    GridRequest request,
    ERActivityStatus? statusFilter = null,
    int? clientIdFilter = null, // NEW: explicit client filter for non-client users
    CancellationToken ct = default)
{
    await using var context = await _contextFactory.CreateDbContextAsync(ct);
    context.CurrentSiteId = _sessionContext.SiteId;

    // Use explicit filter if provided, otherwise fall back to session ClientId
    if (clientIdFilter.HasValue && clientIdFilter.Value > 0)
        context.CurrentClientId = clientIdFilter.Value;
    else
        context.CurrentClientId = _sessionContext.ClientId;
    // ...
}
```

### Pattern 3: Extracting ClientName from ObjectData XML
**What:** Parse the XML column to get client names
**When to use:** Loading client list for the dropdown
**Example:**
```csharp
// Using raw SQL for XML value extraction (most efficient, matches legacy pattern)
var clients = await context.Database
    .SqlQueryRaw<ClientDropdownDto>(
        @"SELECT c.ClientId,
                 c.ObjectData.value('(/Client/ClientName)[1]','NVARCHAR(128)') AS ClientName
          FROM Client c
          WHERE c.SiteId = {0}
          ORDER BY c.ObjectData.value('(/Client/ClientName)[1]','NVARCHAR(128)')",
        siteId)
    .ToListAsync(ct);

// OR: Load Client entities and parse XML in memory
var clients = await context.Clients
    .Select(c => new { c.ClientId, c.ObjectData })
    .ToListAsync(ct);
// Then parse each ObjectData with XDocument
```

### Pattern 4: Create Activity Navigation
**What:** Navigate to legacy create pages via YARP, passing selected ClientId
**When to use:** When user clicks Create Activity button
**Example:**
```csharp
private void OnCreateActivityClick()
{
    if (!_isClientUser && _selectedClientId <= 0)
    {
        Snackbar.Add(Localization.GetText("PleaseSelectClient"), Severity.Warning);
        return;
    }

    string url;
    if (_currentStatus == ERActivityStatus.Draft)
    {
        url = _selectedClientId > 0
            ? $"/Responsive/Recruiting/ActivityCreateDraft.aspx?ClientId={_selectedClientId}"
            : "/Responsive/Recruiting/ActivityCreateDraft.aspx";
    }
    else
    {
        url = _selectedClientId > 0
            ? $"/Responsive/Recruiting/ActivityCreateEdit.aspx?ClientId={_selectedClientId}"
            : "/Responsive/Recruiting/ActivityCreateEdit.aspx";
    }

    Navigation.NavigateTo(url, forceLoad: true); // forceLoad for YARP proxy to legacy
}
```

### Anti-Patterns to Avoid
- **Do NOT change global query filter logic:** The existing `CurrentClientId == null` -> show all behavior is correct for non-client users. The dropdown should override `CurrentClientId` when a specific client is selected, not change the filter semantics.
- **Do NOT load ObjectData XML in bulk without pagination:** The Client table may have hundreds of rows, but each ObjectData is a full XML document. Use SQL `ObjectData.value()` XPath extraction to get only the name, not the full XML content.
- **Do NOT make Create Activity navigate to a Blazor page:** Activity creation is still in the legacy app. Always use `forceLoad: true` to go through YARP.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Client name extraction from XML | Custom XML parser per row | SQL `ObjectData.value()` XPath | Much more efficient, runs server-side in SQL |
| Client dropdown component | Custom dropdown with search | `MudSelect<int>` or `MudAutocomplete<int>` | Already available in MudBlazor 8.0, handles keyboard nav, virtualization |
| Activity creation form | New Blazor create page | Legacy `ActivityCreateEdit.aspx` via YARP | Activity creation is complex, not yet ported |

**Key insight:** The client name is embedded in an XML column (`Client.ObjectData`), not a simple string column. The most efficient approach is SQL XPath extraction via `SqlQueryRaw`, matching the legacy pattern exactly.

## Common Pitfalls

### Pitfall 1: Forgetting to Reload Grid After Client Change
**What goes wrong:** User selects a different client but grid still shows old data
**Why it happens:** MudDataGrid only refreshes on explicit `ReloadServerData()` call
**How to avoid:** Call `_dataGrid.ReloadServerData()` in the `ValueChanged` handler of MudSelect
**Warning signs:** Data appears stale after dropdown change

### Pitfall 2: Global Query Filter Interaction
**What goes wrong:** Non-client user selects a client, but activities for other clients still appear (or vice versa)
**Why it happens:** `context.CurrentClientId` not correctly set before query execution
**How to avoid:** Set `context.CurrentClientId = selectedClientId` when a client is selected; leave it as `_sessionContext.ClientId` (null for non-client) when "All" is selected
**Warning signs:** Activity count doesn't change after selecting a client

### Pitfall 3: Create Button Without Client Selected
**What goes wrong:** Non-client user clicks Create without selecting a client, legacy page errors
**Why it happens:** Legacy `ActivityCreateEdit.aspx` may need ClientId context
**How to avoid:** Show a snackbar message "Please select a client" when no client is selected, matching legacy behavior. For non-draft mode, legacy allows creation without client selected -- replicate this exactly.
**Warning signs:** Error on legacy page after clicking Create

### Pitfall 4: Client Dropdown Showing Disabled/Inactive Clients
**What goes wrong:** Dropdown shows clients that have no recruitment enabled
**Why it happens:** Legacy filters by `ErecruitmentEnabled` from the `SigClient` table
**How to avoid:** For the initial implementation, query all clients for the site. If `SigClient` table needs to be included, scaffold it. Alternatively, filter by checking if the client has any ERActivities.
**Warning signs:** User selects a client and sees zero activities

### Pitfall 5: IActivityService Interface Breaking Change
**What goes wrong:** Adding `clientIdFilter` parameter to `GetActivitiesAsync` breaks existing callers
**Why it happens:** Interface change without updating all implementations/callers
**How to avoid:** Add as optional parameter with default `null` -- existing callers don't need changes
**Warning signs:** Compile errors in other files referencing IActivityService

## Code Examples

### Loading Client List via Raw SQL (Recommended)
```csharp
// In new IClientService / ClientService
public async Task<List<ClientDropdownDto>> GetClientsForSiteAsync(int siteId, CancellationToken ct = default)
{
    await using var context = await _contextFactory.CreateDbContextAsync(ct);
    context.CurrentSiteId = siteId;

    return await context.Database
        .SqlQueryRaw<ClientDropdownDto>(
            @"SELECT c.ClientId,
                     c.ObjectData.value('(/Client/ClientName)[1]','NVARCHAR(128)') AS ClientName
              FROM Client c
              WHERE c.SiteId = {0}
                AND c.ObjectData.value('(/Client/Enabled)[1]','NVARCHAR(5)') = 'true'
              ORDER BY c.ObjectData.value('(/Client/ClientName)[1]','NVARCHAR(128)')",
            siteId)
        .ToListAsync(ct);
}
```

### ClientDropdownDto
```csharp
public record ClientDropdownDto(int ClientId, string ClientName);
```

### ActivityList.razor.cs Additions
```csharp
// New injected service
[Inject] private IClientService ClientService { get; set; } = default!;

// New state fields
private List<ClientDropdownDto> _clients = new();
private int _selectedClientId = -1; // -1 = "all clients"

// In OnInitializedAsync, after existing code:
if (!_isClientUser)
{
    _clients = await ClientService.GetClientsForSiteAsync(Session.SiteId ?? 0);
}

// New handler:
private async Task OnClientChanged(int clientId)
{
    _selectedClientId = clientId;
    await _dataGrid.ReloadServerData();
}

// Modified LoadServerData to pass clientId:
var response = await ActivityService.GetActivitiesAsync(
    request,
    _currentStatus,
    _isClientUser ? null : (_selectedClientId > 0 ? _selectedClientId : null));
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| WebForms UpdatePanel with server postback | Blazor Server with MudBlazor components | Project migration | SPA-like experience, no full page reload for dropdown change |
| ViewState for FilterClientId persistence | Component state field | Project migration | Simpler, lives in circuit memory |
| Legacy `ClientHlp.ClientsGet` with LLBLGen | EF Core + raw SQL for XML extraction | Project migration | Need new service method |

## Open Questions

1. **Should the SigClient table be scaffolded to filter by ErecruitmentEnabled?**
   - What we know: Legacy filters clients by `SigClient.ErecruitmentEnabled`. The `SigClient` table exists in the DB but is not scaffolded in the Blazor app.
   - What's unclear: How many clients exist per site, and whether showing non-recruitment-enabled clients is a real problem
   - Recommendation: For phase 03.8, add `ErecruitmentEnabled` filtering via the raw SQL query (JOIN to SigClient table in the SQL). This avoids scaffolding a new entity while still filtering correctly. If not feasible, filter by checking if client has any ERActivities.

2. **Should non-client users see "All Clients" by default or be forced to select one?**
   - What we know: Legacy shows "(Please select client)" as default with value -1. Activity list shows nothing until a client is selected (`MustHaveClientId = true` on the control).
   - What's unclear: Whether this strict behavior is desired in the new Blazor UI
   - Recommendation: Match legacy behavior -- default to "(Please select client)" / -1, show all activities when no client selected (current behavior), but require client selection for Create Activity. The `MustHaveClientId` on the legacy control means the list does NOT load until a client is selected. Consider whether to replicate this strictness.

3. **Create button text varies by mode**
   - What we know: Legacy uses "Create New Draft Activity" for draft mode, "Create New Activity" for ongoing mode
   - Recommendation: Use same localization keys: `ERCreateNewDraftActivity` and `CreateNewActivity`

## Sources

### Primary (HIGH confidence)
- Legacy `ActivityList.aspx` and `ActivityList.aspx.cs` -- toolbar layout, client dropdown, create button behavior
- Legacy `Controls/ActivityList.ascx.cs` -- ClientId property, MustHaveClientId filtering
- Blazor `ActivityList.razor` + `ActivityList.razor.cs` -- current component structure
- `ActivityService.cs` -- current GetActivitiesAsync implementation with CurrentClientId filter
- `SignaturDbContext.Custom.cs` -- global query filter: `CurrentClientId == null || e.ClientId == CurrentClientId`
- `Client.cs` entity -- ObjectData XML column, no Name column
- `ICurrentUserService.cs`, `IPermissionHelper.cs`, `IUserSessionContext.cs` -- available user context
- Legacy SQL patterns: `ObjectData.value('(/Client/ClientName)[1]','NVARCHAR(128)')` for client name extraction

### Secondary (MEDIUM confidence)
- Legacy `ClientHelper.cs` -- `ClientsGet` method with `eRecruitmentEnabled` filter via `SigClient` table

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - MudBlazor 8.0 already in use, components verified in existing code
- Architecture: HIGH - Clear pattern from legacy code, straightforward adaptation to Blazor
- Pitfalls: HIGH - Well-understood from legacy behavior analysis
- Client name extraction: HIGH - SQL XPath pattern confirmed from multiple legacy source files
- SigClient filtering: MEDIUM - Table not scaffolded, exact filtering needs may vary

**Research date:** 2026-02-18
**Valid until:** 2026-03-18 (stable domain, no external dependencies changing)
