---
phase: 03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist
plan: 01
subsystem: api
tags: [ef-core, sql-xpath, xml, client-filtering, multi-tenancy]

# Dependency graph
requires:
  - phase: 03.7.1-icurrentuserservice-db-backed-user-context
    provides: ICurrentUserService, IUserSessionContext with ClientId/SiteId
provides:
  - IClientService with GetClientsForSiteAsync (SQL XPath client name extraction)
  - ClientDropdownDto record for client dropdown items
  - clientIdFilter parameter on GetActivitiesAsync for explicit client filtering
affects: [03.8-02, activity-list-ui, client-dropdown-ui]

# Tech tracking
tech-stack:
  added: []
  patterns: [SqlQueryRaw with XML XPath for ObjectData extraction, optional filter parameter override pattern]

key-files:
  created:
    - src/SignaturPortal.Application/DTOs/ClientDropdownDto.cs
    - src/SignaturPortal.Application/Interfaces/IClientService.cs
    - src/SignaturPortal.Infrastructure/Services/ClientService.cs
  modified:
    - src/SignaturPortal.Infrastructure/DependencyInjection.cs
    - src/SignaturPortal.Application/Interfaces/IActivityService.cs
    - src/SignaturPortal.Infrastructure/Services/ActivityService.cs

key-decisions:
  - "SqlQueryRaw with ObjectData.value() XPath for client name extraction -- no C# XML parsing, matches legacy SQL pattern"
  - "clientIdFilter as optional parameter with default null -- backward compatible, no breaking changes to existing callers"
  - "ClientService bypasses EF global filters via raw SQL -- does not set CurrentSiteId/CurrentClientId on context"

patterns-established:
  - "SQL XPath extraction: Use SqlQueryRaw with ObjectData.value() for XML column data rather than parsing XML in C#"
  - "Filter override pattern: Optional parameter on service method overrides session-based filtering when explicitly provided"

# Metrics
duration: 3min
completed: 2026-02-18
---

# Phase 03.8 Plan 01: Backend Service Layer Summary

**IClientService with SQL XPath client name extraction from ObjectData XML, and clientIdFilter override on GetActivitiesAsync for non-client user filtering**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-18T11:19:36Z
- **Completed:** 2026-02-18T11:22:25Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Created IClientService and ClientService using raw SQL with XPath to extract client names from ObjectData XML column
- Added backward-compatible clientIdFilter parameter to IActivityService.GetActivitiesAsync
- ActivityService stamps CurrentClientId from clientIdFilter when positive, falls back to session ClientId otherwise
- ClientService registered as Scoped in DependencyInjection.cs

## Task Commits

Each task was committed atomically:

1. **Task 1: Create IClientService, ClientDropdownDto, and ClientService** - `4daa30c` (feat)
2. **Task 2: Add clientIdFilter parameter to GetActivitiesAsync** - `ff87831` (feat)

## Files Created/Modified
- `src/SignaturPortal.Application/DTOs/ClientDropdownDto.cs` - Lightweight record for client dropdown items (ClientId, ClientName)
- `src/SignaturPortal.Application/Interfaces/IClientService.cs` - Interface with GetClientsForSiteAsync method
- `src/SignaturPortal.Infrastructure/Services/ClientService.cs` - Implementation using SqlQueryRaw with ObjectData.value() XPath
- `src/SignaturPortal.Infrastructure/DependencyInjection.cs` - Added Scoped registration for IClientService/ClientService
- `src/SignaturPortal.Application/Interfaces/IActivityService.cs` - Added optional clientIdFilter parameter
- `src/SignaturPortal.Infrastructure/Services/ActivityService.cs` - Uses clientIdFilter to override CurrentClientId when positive

## Decisions Made
- Used SqlQueryRaw with ObjectData.value() XPath for client name extraction -- matches legacy SQL pattern exactly, avoids loading full XML documents into C# memory
- Added clientIdFilter as optional parameter with default null -- backward compatible, existing callers (ActivityList.razor.cs) unaffected
- ClientService does not stamp CurrentSiteId/CurrentClientId on context because raw SQL bypasses EF global filters entirely
- Enabled-only filter via XPath: `ObjectData.value('(/Client/Enabled)[1]','NVARCHAR(5)') = 'true'`

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Web project build failed due to file locks from running SignaturPortal.Web.exe process -- verified compilation via Infrastructure and Tests project builds instead (both succeeded with zero errors)

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- IClientService ready for injection into ActivityList.razor.cs component (Plan 03.8-02)
- GetActivitiesAsync ready to receive clientIdFilter from UI dropdown selection
- All existing callers continue to work without changes

---
*Phase: 03.8-client-selector-dropdown-and-create-activity-button-for-non-client-users-on-activitylist*
*Completed: 2026-02-18*
