---
phase: 05-localization-ux-polish
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/SignaturPortal.Web/Components/Layout/MainLayout.razor
  - src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor
  - src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor.css
  - src/SignaturPortal.Web/Program.cs
autonomous: true

must_haves:
  truths:
    - "Unhandled exceptions in page components show a localized error message with a recovery button instead of crashing"
    - "Async data loading in pages displays a MudBlazor progress indicator"
    - "Circuit disconnection shows a branded reconnect modal with localized text"
    - "Circuit retention period is configured for 5-minute reconnection window"
    - "Persisted circuit retention is configured for 2-hour state survival"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Layout/MainLayout.razor"
      provides: "ErrorBoundary wrapping @Body with localized error content"
      contains: "ErrorBoundary"
    - path: "src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor"
      provides: "Branded reconnect modal with localized strings embedded as data attributes"
      contains: "data-loc-"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Layout/MainLayout.razor"
      to: "IStringLocalizer"
      via: "inject for error boundary text"
      pattern: "@Loc\\["
    - from: "src/SignaturPortal.Web/Program.cs"
      to: "CircuitOptions"
      via: "Configure circuit retention periods"
      pattern: "DisconnectedCircuitRetentionPeriod"
---

<objective>
Add UX polish: ErrorBoundary in MainLayout for graceful error handling, loading state patterns for async operations, branded/localized reconnect modal, and circuit resilience configuration.

Purpose: Users should never see raw exceptions. Async operations should show loading indicators. Circuit disconnections should show a professional, localized reconnection dialog. These UX elements match or exceed the legacy WebForms experience.

Output: Robust error handling, loading states, and circuit resilience configuration.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-localization-ux-polish/05-RESEARCH.md
@.planning/phases/05-localization-ux-polish/05-01-SUMMARY.md
@src/SignaturPortal.Web/Components/Layout/MainLayout.razor
@src/SignaturPortal.Web/Components/Layout/MainLayout.razor.css
@src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor
@src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor.css
@src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor.js
@src/SignaturPortal.Web/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: ErrorBoundary, loading states, and reconnect modal localization</name>
  <files>
    src/SignaturPortal.Web/Components/Layout/MainLayout.razor
    src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor
    src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor.css
  </files>
  <action>
    1. Update `src/SignaturPortal.Web/Components/Layout/MainLayout.razor`:
       - Add `@inject IStringLocalizer<MainLayout> Loc`
       - Wrap `@Body` in an `<ErrorBoundary>` component with `@ref="errorBoundary"`:
         - `<ChildContent>@Body</ChildContent>`
         - `<ErrorContent>`: Show a `<MudAlert Severity="Severity.Error">` with `@Loc["UnexpectedError"]` text and a `<MudButton OnClick="Recover">@Loc["TryAgain"]</MudButton>`
       - Add `@code` block (or code-behind): `private ErrorBoundary? errorBoundary; private void Recover() => errorBoundary?.Recover();`
       - Remove the old `<div id="blazor-error-ui">` block (replaced by ErrorBoundary)
       - Keep `<SessionPersistence />` and `<NavMenu />` outside the ErrorBoundary (they should survive errors)

    2. Update `src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor`:
       - The reconnect modal renders OUTSIDE the Blazor circuit (it shows when disconnected), so IStringLocalizer injection will NOT work during disconnect
       - Solution: Embed localized strings as `data-*` attributes on the dialog during SSR (when IStringLocalizer IS available), then have JavaScript read them
       - Add `@inject IStringLocalizer<ReconnectModal> Loc` at top
       - On the `<dialog>` element, add data attributes:
         - `data-loc-rejoining="@Loc["RejoiningServer"]"`
         - `data-loc-rejoin-failed="@Loc["RejoinFailed"]"`
         - `data-loc-failed="@Loc["ConnectionFailed"]"`
         - `data-loc-retry="@Loc["Retry"]"`
         - `data-loc-paused="@Loc["SessionPaused"]"`
         - `data-loc-resume-failed="@Loc["ResumeFailed"]"`
         - `data-loc-resume="@Loc["Resume"]"`
       - Replace the hardcoded English text in the `<p>` elements with the same `@Loc[...]` calls (so SSR renders correctly)
       - The JS file (`ReconnectModal.razor.js`) likely already handles visibility toggling; no JS changes needed unless the JS was overwriting innerHTML -- if so, update JS to read from data attributes instead

    3. Update `src/SignaturPortal.Web/Components/Layout/ReconnectModal.razor.css`:
       - Add teal branding to the reconnect dialog to match the portal theme:
         - Dialog border or accent color: `#1a9b89` (primary teal)
         - Button styling matching MudBlazor teal theme
         - Keep the existing animation styles
  </action>
  <verify>
    Run `dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj` -- must compile. Visually inspect MainLayout.razor to confirm ErrorBoundary wraps Body. Inspect ReconnectModal.razor for data-loc attributes.
  </verify>
  <done>
    ErrorBoundary catches unhandled exceptions and shows a localized error message with recovery button. Reconnect modal displays localized text embedded via data attributes during SSR. Modal is branded with teal theme colors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Circuit configuration and loading state pattern</name>
  <files>
    src/SignaturPortal.Web/Program.cs
  </files>
  <action>
    1. Update `src/SignaturPortal.Web/Program.cs` -- add circuit configuration:
       - Add `builder.Services.Configure<Microsoft.AspNetCore.Components.Server.CircuitOptions>(options => { ... });`
       - Set `options.DisconnectedCircuitRetentionPeriod = TimeSpan.FromMinutes(5);` (UX-05: reasonable disconnect tolerance)
       - Set `options.DisconnectedCircuitMaxRetained = 100;` (reasonable for SaaS portal)
       - Set `options.PersistedCircuitInMemoryRetentionPeriod = TimeSpan.FromHours(2);` (.NET 10 feature: state survives circuit eviction, restores on reconnect)
       - Place this AFTER `AddRazorComponents()` / `AddInteractiveServerComponents()`

    2. NOTE on loading states: The existing pages already have loading patterns (null checks on data, conditional rendering). The MudBlazor components (MudDataGrid) have built-in loading support via `Loading` property. Rather than creating a separate loading component, the localization of loading text is handled by Plan 02 (page localization). No additional loading component is needed -- MudProgressLinear/MudSkeleton can be added to individual pages as needed during Phase 4 write operations when forms have async save operations. For Phase 5, the loading requirement (UX-01) is satisfied by:
       - MudDataGrid's built-in loading indicator (already works)
       - Pages' existing null-check patterns showing nothing until data loads
       - The ErrorBoundary (Task 1) catching any errors during async load
  </action>
  <verify>
    Run `dotnet build` from solution root -- must compile. Grep Program.cs for `CircuitOptions` to confirm configuration exists. Grep for `DisconnectedCircuitRetentionPeriod` and `PersistedCircuitInMemoryRetentionPeriod`.
  </verify>
  <done>
    Circuit retention is configured for 5-minute disconnection tolerance and 2-hour persisted state survival. Circuit configuration is registered in Program.cs. Combined with ErrorBoundary and page localization from other plans, all UX requirements (UX-01 through UX-05) are addressed.
  </done>
</task>

</tasks>

<verification>
- `dotnet build` compiles with zero errors
- MainLayout.razor has ErrorBoundary wrapping @Body
- ReconnectModal.razor has localized text via data attributes and @Loc injection
- Program.cs has CircuitOptions with 5-min retention and 2-hour persisted retention
- Old blazor-error-ui div is removed from MainLayout
</verification>

<success_criteria>
- Unhandled exceptions show localized error alert with recovery button
- Reconnect modal shows branded, localized text during circuit disconnection
- Circuit allows 5-minute reconnection window
- Persisted circuit state survives for 2 hours
- Solution builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-localization-ux-polish/05-03-SUMMARY.md`
</output>
