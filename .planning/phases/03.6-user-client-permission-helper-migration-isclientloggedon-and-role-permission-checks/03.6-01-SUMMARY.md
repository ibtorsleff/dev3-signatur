---
phase: 03.6-user-client-permission-helper-migration
plan: 01
subsystem: auth
tags: [permissions, enum, session-context, authorization]

# Dependency graph
requires:
  - phase: 01-infrastructure-shell
    provides: IUserSessionContext interface and UserSessionContext implementation
provides:
  - IsClientUser property on IUserSessionContext for user type classification
  - PortalPermission enum with all 90+ legacy permission values
  - Migration from ERecruitmentPermission to PortalPermission across codebase
affects: [03.6-02, 03.6-03, phase-04, phase-05]

# Tech tracking
tech-stack:
  added: []
  patterns: [full-permission-enum-matching-legacy-db-values, computed-user-type-property]

key-files:
  created:
    - src/SignaturPortal.Application/Authorization/PortalPermission.cs
  modified:
    - src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs
    - src/SignaturPortal.Web/Services/UserSessionContext.cs
    - src/SignaturPortal.Web/Program.cs
    - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
    - tests/SignaturPortal.Tests/Authorization/PermissionServiceTests.cs
    - tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs

key-decisions:
  - "IsClientUser computed as ClientId.HasValue && ClientId.Value > 0 -- matches legacy PermissionHelper.UserIsClient"
  - "PortalPermission includes all 90+ values upfront to prevent rework in later phases"
  - "ERecruitmentPermission fully deleted rather than deprecated -- clean break"

patterns-established:
  - "PortalPermission enum values match PermissionId column in Permission DB table exactly"
  - "Cast to int for policy requirements: (int)PortalPermission.XxxAccess"

# Metrics
duration: 3min
completed: 2026-02-17
---

# Phase 03.6 Plan 01: IsClientUser and PortalPermission Enum Summary

**IsClientUser property on IUserSessionContext and full 90+ value PortalPermission enum replacing 6-value ERecruitmentPermission**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-17T10:15:19Z
- **Completed:** 2026-02-17T10:17:53Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments
- Added IsClientUser computed property to IUserSessionContext (true when ClientId > 0)
- Created PortalPermission enum with all 90+ legacy permission values matching DB PermissionId exactly
- Migrated all ERecruitmentPermission references to PortalPermission and deleted old enum
- Full solution compiles with zero references to old enum

## Task Commits

Each task was committed atomically:

1. **Task 1: Add IsClientUser to IUserSessionContext and create PortalPermission enum** - `b4ca964` (feat)
2. **Task 2: Migrate all ERecruitmentPermission references to PortalPermission** - `961aa3f` (refactor)

## Files Created/Modified
- `src/SignaturPortal.Application/Authorization/PortalPermission.cs` - Full permission enum (90+ values) matching legacy PermissionHelper.Permission
- `src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs` - Added IsClientUser property
- `src/SignaturPortal.Web/Services/UserSessionContext.cs` - Implemented IsClientUser as computed property
- `src/SignaturPortal.Web/Program.cs` - Updated policy registrations to use PortalPermission
- `src/SignaturPortal.Infrastructure/Services/ActivityService.cs` - Updated admin check to use PortalPermission
- `src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs` - Deleted (superseded)
- `tests/SignaturPortal.Tests/Authorization/PermissionServiceTests.cs` - Added IsClientUser to test stub
- `tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs` - Added IsClientUser to test stub

## Decisions Made
- IsClientUser computed as `ClientId.HasValue && ClientId.Value > 0` matching legacy PermissionHelper.UserIsClient
- All 90+ permission values included upfront to prevent rework in Phase 4+
- ERecruitmentPermission fully deleted rather than deprecated

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed test stubs missing IsClientUser interface member**
- **Found during:** Task 2 (full solution build verification)
- **Issue:** Two test stub classes implementing IUserSessionContext did not have the new IsClientUser property
- **Fix:** Added `public bool IsClientUser => ClientId.HasValue && ClientId.Value > 0;` to both test stubs
- **Files modified:** tests/SignaturPortal.Tests/Authorization/PermissionServiceTests.cs, tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs
- **Verification:** Full solution build passes with 0 errors
- **Committed in:** 961aa3f (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Necessary fix for interface contract compliance in test stubs. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- IsClientUser available for all permission helper methods in subsequent plans
- PortalPermission enum ready for HasPermission/HasAnyPermission checks in 03.6-02
- All authorization policies already using new enum

## Self-Check: PASSED

- All created files exist on disk
- ERecruitmentPermission.cs confirmed deleted
- Both task commits verified: b4ca964, 961aa3f
- Full solution builds with 0 errors

---
*Phase: 03.6-user-client-permission-helper-migration*
*Completed: 2026-02-17*
