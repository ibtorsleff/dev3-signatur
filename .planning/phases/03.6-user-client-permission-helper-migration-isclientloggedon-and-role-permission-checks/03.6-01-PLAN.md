---
phase: 03.6-user-client-permission-helper-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs
  - src/SignaturPortal.Web/Services/UserSessionContext.cs
  - src/SignaturPortal.Application/Authorization/PortalPermission.cs
  - src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  - src/SignaturPortal.Web/Program.cs
autonomous: true
must_haves:
  truths:
    - "IUserSessionContext exposes IsClientUser property that returns true when ClientId > 0"
    - "PortalPermission enum contains all 90+ permission values matching legacy PermissionHelper.Permission exactly"
    - "All references to ERecruitmentPermission are replaced with PortalPermission"
    - "Authorization policies in Program.cs use PortalPermission enum values"
    - "ActivityService admin check uses PortalPermission.RecruitmentPortalAdminAccess"
  artifacts:
    - path: "src/SignaturPortal.Application/Authorization/PortalPermission.cs"
      provides: "Full permission enum matching legacy DB PermissionId values"
      contains: "PortalPermission"
    - path: "src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs"
      provides: "IsClientUser property"
      contains: "IsClientUser"
    - path: "src/SignaturPortal.Web/Services/UserSessionContext.cs"
      provides: "IsClientUser computed implementation"
      contains: "IsClientUser"
  key_links:
    - from: "src/SignaturPortal.Web/Program.cs"
      to: "src/SignaturPortal.Application/Authorization/PortalPermission.cs"
      via: "policy registration using PortalPermission enum cast to int"
      pattern: "PortalPermission\\.Recruitment"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "src/SignaturPortal.Application/Authorization/PortalPermission.cs"
      via: "admin permission check"
      pattern: "PortalPermission\\.RecruitmentPortalAdminAccess"
---

<objective>
Add IsClientUser to IUserSessionContext and replace the 6-value ERecruitmentPermission enum with the full PortalPermission enum (all 90+ values from legacy PermissionHelper.Permission). Update all existing references.

Purpose: Provides the two foundational building blocks -- user type classification and complete permission enum -- needed by all subsequent permission helper methods and component-level permission checks.
Output: Updated IUserSessionContext with IsClientUser, new PortalPermission enum, all references migrated from ERecruitmentPermission.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.6-user-client-permission-helper-migration-isclientloggedon-and-role-permission-checks/03.6-RESEARCH.md
@src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs
@src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
@src/SignaturPortal.Web/Services/UserSessionContext.cs
@src/SignaturPortal.Web/Program.cs
@src/SignaturPortal.Infrastructure/Services/ActivityService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IsClientUser to IUserSessionContext and create PortalPermission enum</name>
  <files>
    src/SignaturPortal.Application/Interfaces/IUserSessionContext.cs
    src/SignaturPortal.Web/Services/UserSessionContext.cs
    src/SignaturPortal.Application/Authorization/PortalPermission.cs
  </files>
  <action>
1. In `IUserSessionContext.cs`, add `bool IsClientUser { get; }` property to the interface. Add XML doc: "True when the user belongs to a client organization (ClientId > 0). Matches legacy PermissionHelper.UserIsClient."

2. In `UserSessionContext.cs`, implement as a computed property:
   ```csharp
   public bool IsClientUser => ClientId.HasValue && ClientId.Value > 0;
   ```
   This matches the legacy `PermissionHelper.UserIsClient(aUser)` which returns `aUser.ClientId > 0`. Note: legacy also returns true for null user, but in Blazor that case is handled by `IsInitialized` being false (access denied entirely).

3. Create `src/SignaturPortal.Application/Authorization/PortalPermission.cs` with ALL values from the legacy `PermissionHelper.Permission` enum. Copy the exact names and integer values:

   ```csharp
   namespace SignaturPortal.Application.Authorization;

   /// <summary>
   /// Complete permission enum matching the legacy PermissionHelper.Permission enum.
   /// Values correspond to PermissionId in the Permission database table.
   /// Source of truth: C:\Dev\Dev3Org\AtlantaSignatur\Library\Security\PermissionHelper.cs
   /// </summary>
   public enum PortalPermission
   {
       // General
       GeneralCreateEditServiceMessage = 100,
       GeneralCreateEditHelpPageAlternative = 110,

       // Ad Portal
       AdPortalAdminAccess = 1000,
       AdPortalViewOtherUsersActivities = 1001,
       AdPortalViewOtherUsersDraftActivities = 1002,
       AdPortalEditOtherUsersDraftActivities = 1003,
       AdPortalViewActivitiesFromUserGroupsUserNotMemberOf = 1004,
       AdPortalEditOwnDraftActivities = 1005,
       AdPortalAllowChangeStatusDraftActivities = 1006,
       AdPortalAlwaysAllowCreateActivity = 1007,
       AdPortalAccess = 1050,
       AdPortalPublishWebAd = 1100,
       AdPortalPublishJobnet = 1101,
       AdPortalPublishNaturejobs = 1102,
       AdPortalPublishLinkedIn = 1103,
       AdPortalAllowInsertExtraMedia = 1150,
       AdPortalWebAdAiAssistance = 1160,
       AdPortalAllowDeleteActivity = 1200,
       AdPortalEditWebAdTemplates = 1500,
       AdPortalMediaStatisticsAccess = 1600,
       AdPortalAllowImpersonate = 1700,
       AllowUserActiveInactive = 1900,
       AllowUserDeletePermanent = 1901,

       // Recruitment Portal
       RecruitmentPortalRecruitmentAccess = 2000,
       RecruitmentPortalRecruitmentStatisticsAccess = 2010,
       RecruitmentPortalQuestionnaireStatisticsAccess = 2011,
       RecruitmentPortalMediaStatisticsAccess = 2012,
       RecruitmentPortalCreateActivity = 2020,
       RecruitmentPortalDeleteActivity = 2021,
       RecruitmentPortalViewDeletedActivities = 2022,
       RecruitmentPortalEditDeletedActivities = 2023,
       RecruitmentPortalAllowCloseActivityWithNotFinishedCandidates = 2024,
       RecruitmentPortalViewActivitiesUserNotMemberOf = 2025,
       RecruitmentPortalEditActivitiesUserNotMemberOf = 2026,
       RecruitmentPortalCreateDraftActivities = 2027,
       RecruitmentPortalViewDraftActivities = 2028,
       RecruitmentPortalEditDraftActivities = 2029,
       RecruitmentPortalAllowExportActivityMembersInActivityList = 2030,
       RecruitmentPortalAllowSelectWorkAreasThatUserIsNotMemberOf = 2034,
       RecruitmentPortalViewActivitiesFromWorkAreaUserNotMemberOf = 2035,
       RecruitmentPortalEditActivitiesFromWorkAreaUserNotMemberOf = 2036,
       RecruitmentPortalRepublishWebAdAndJobnetAdFromOwnRecruitmentActivity = 2040,
       RecruitmentPortalViewCandidateDetails = 2050,
       RecruitmentPortalCandidateEvaluation = 2051,
       RecruitmentPortalViewCandidateNotes = 2052,
       RecruitmentPortalCreateCandidateNote = 2053,
       RecruitmentPortalCandidateNoteCanDeleteOtherUsersNote = 2054,
       RecruitmentPortalAllowViewCandidateEvalutionAndNotesWhenUserHasNotEvaluated = 2055,
       RecruitmentPortalViewCandidateOtherApplicationsInCandidateList = 2056,
       RecruitmentPortalEditCandidate = 2060,
       RecruitmentPortalViewDeletedCandidates = 2061,
       RecruitmentPortalEditDeletedCandidates = 2062,
       RecruitmentPortalCandidateAllowSetPossibleCandidate = 2063,
       RecruitmentPortalDownloadCandidateHiredFile = 2065,
       RecruitmentPortalCandidatesAllowMoveAnotherActivityNotResponsible = 2066,
       RecruitmentPortalPermanentDeleteCandidates = 2068,
       RecruitmentPortalRecruitmentResponsible = 2070,
       RecruitmentPortalAllowSearchCandidates = 2080,
       RecruitmentPortalAllowDeleteCandidatesFromSearchCandidates = 2082,
       RecruitmentPortalAllowExternalCandidateExport = 2085,
       RecruitmentPortalAllowSearchJobProfiles = 2090,
       RecruitmentPortalDeleteJobProfiles = 2092,
       RecruitmentPortalEditJobProfiles = 2094,
       RecruitmentPortalAllowSearchJobAgents = 2096,
       RecruitmentPortalDeleteJobAgents = 2097,
       RecruitmentPortalEditJobAgents = 2098,
       RecruitmentPortalViewActivityNotes = 2100,
       RecruitmentPortalCreateActivityNote = 2101,
       RecruitmentPortalActivityNoteCanDeleteOtherUsersNote = 2102,
       RecruitmentPortalViewJobBanksWhereUserNotResponsible = 2200,
       RecruitmentPortalCreateEditJobBanks = 2202,
       RecruitmentPortalEditJobBanksWhereUserNotResponsible = 2204,
       RecruitmentPortalViewJobBankCandidatesFromJobBanksUserNotMemberOf = 2206,
       RecruitmentPortalEditJobBankCandidate = 2208,
       RecruitmentPortalPermanentDeleteJobBankCandidates = 2209,
       RecruitmentPortalAllowCreateQuickHireFromJobBanksUserNotMemberOf = 2250,
       RecruitmentPortalAdminAccess = 2500,
       RecruitmentPortalViewMailTemplates = 2510,
       RecruitmentPortalCreateMailTemplates = 2511,
       RecruitmentPortalViewSmsTemplates = 2515,
       RecruitmentPortalCreateSmsTemplates = 2516,
       RecruitmentPortalViewApplicationTemplates = 2520,
       RecruitmentPortalCreateApplicationTemplates = 2521,
       RecruitmentPortalViewGrossApplicationTemplate = 2522,
       RecruitmentPortalEditGrossApplicationTemplate = 2523,
       RecruitmentPortalEditGrossApplicationTemplateFieldNameAndElementName = 2524,
       RecruitmentPortalViewLists = 2530,
       RecruitmentPortalCreateLists = 2531,
       RecruitmentPortalViewQuestionnaires = 2540,
       RecruitmentPortalCreateEditQuestionnaires = 2541,
       RecruitmentPortalViewUsers = 2550,
       RecruitmentPortalCreateUsers = 2551,
       RecruitmentPortalViewExternalUsers = 2555,
       RecruitmentPortalEditExternalUsers = 2556,
       RecruitmentPortalViewUserLog = 2560,
       RecruitmentPortalEditSsoUsers = 2570,

       // Onboarding Portal
       OnboardingPortalOnboardingAccess = 3000,
       OnBoardingPortalEditProcessesUserNotMemberOf = 3010,
       OnBoardingPortalDeleteProcess = 3011,
       OnBoardingPortalCreateEditProcesses = 3013,
       OnBoardingPortalAllowCreateEmployeeWhenCreateProcess = 3014,
       OnboardingPortalViewProcessesUserNotMemberOf = 3015,
       OnboardingPortalBoardingResponsible = 3017,
       OnboardingPortalAllowSelectWorkAreasThatUserIsNotMemberOf = 3020,
       OnboardingPortalViewProcessesFromWorkAreaUserNotMemberOf = 3021,
       OnboardingPortalEditProcessesFromWorkAreaUserNotMemberOf = 3022,
       OnboardingPortalAdminAccess = 3500,
       OnboardingPortalViewTemplates = 3510,
       OnboardingPortalCreateEditTemplates = 3511,
       OnboardingPortalEditTemplateWhereUserNotResponsible = 3512,
       OnboardingPortalViewGrossTemplates = 3515,
       OnboardingPortalCreateEditGrossTemplates = 3516,
       OnboardingPortalViewLetterTemplates = 3530,
       OnboardingPortalCreateEditLetterTemplates = 3531,
       OnboardingPortalViewQuestionnaires = 3540,
       OnboardingPortalCreateEditQuestionnaires = 3541,
       OnboardingPortalViewUsers = 3550,
       OnboardingPortalCreateEditUsers = 3551,
       OnboardingPortalViewUserLog = 3560,
       OnboardingPortalQuestionnaireStatisticsAccess = 3600,

       // Special / Cross-Portal
       AdPortalRecruitmentSpecialAdministratorActions = 9000,
       AdPortalCreateEditSignaturUsers = 9020,
       AdPortalCreateEditRoles = 9022,
       AdPortalEditActivityMediaStatistics = 9040,
       AdPortalUsersMergeAllow = 9050,
       AdPortalWebAdAiAssistanceAlways = 9060,
   }
   ```

   Include ALL values -- the cost is trivial (one file) and prevents rework in Phase 4+.
  </action>
  <verify>
    Run `dotnet build src/SignaturPortal.Application/SignaturPortal.Application.csproj` -- must compile with no errors. Verify the new file exists and the interface has 7 properties (UserId, SiteId, ClientId, UserName, UserLanguageId, IsInitialized, IsClientUser).
  </verify>
  <done>
    IUserSessionContext has IsClientUser property. PortalPermission.cs exists with all 90+ legacy enum values. UserSessionContext computes IsClientUser as `ClientId.HasValue && ClientId.Value > 0`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all ERecruitmentPermission references to PortalPermission</name>
  <files>
    src/SignaturPortal.Web/Program.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
    src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
  </files>
  <action>
1. In `Program.cs`, change the two policy registrations from `ERecruitmentPermission` to `PortalPermission`:
   - `ERecruitmentPermission.RecruitmentAccess` -> `PortalPermission.RecruitmentPortalRecruitmentAccess`
   - `ERecruitmentPermission.AdminAccess` -> `PortalPermission.RecruitmentPortalAdminAccess`
   Update the `using` from `SignaturPortal.Application.Authorization` (already correct namespace).

2. In `ActivityService.cs`, change:
   - `using SignaturPortal.Application.Authorization;` (already present, no change needed)
   - `(int)ERecruitmentPermission.AdminAccess` -> `(int)PortalPermission.RecruitmentPortalAdminAccess`

3. Delete `ERecruitmentPermission.cs` -- it is fully superseded by `PortalPermission.cs`. All 6 original values exist in the new enum with their correct legacy names:
   - `RecruitmentAccess = 2000` -> `RecruitmentPortalRecruitmentAccess = 2000` (same DB value)
   - `ViewCandidateDetails = 2050` -> `RecruitmentPortalViewCandidateDetails = 2050`
   - `EditCandidate = 2060` -> `RecruitmentPortalEditCandidate = 2060`
   - `AdminAccess = 2500` -> `RecruitmentPortalAdminAccess = 2500`
   - `ViewUsers = 2550` -> `RecruitmentPortalViewUsers = 2550`
   - `CreateUsers = 2551` -> `RecruitmentPortalCreateUsers = 2551`
  </action>
  <verify>
    Run `dotnet build src/SignaturPortal.sln` -- full solution must compile with no errors. Grep for `ERecruitmentPermission` across entire src/ -- must return zero matches.
  </verify>
  <done>
    ERecruitmentPermission.cs is deleted. All references use PortalPermission. Full solution compiles. Zero references to old enum remain.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/SignaturPortal.sln` compiles with no errors
2. `grep -r "ERecruitmentPermission" src/` returns zero matches
3. IUserSessionContext.cs contains `bool IsClientUser { get; }`
4. UserSessionContext.cs contains `IsClientUser => ClientId.HasValue && ClientId.Value > 0`
5. PortalPermission.cs contains all permission values from legacy (spot check: 100, 1000, 1050, 2000, 2500, 3000, 9000)
6. Program.cs policies reference PortalPermission enum values
</verification>

<success_criteria>
- IsClientUser is accessible via IUserSessionContext throughout the application
- PortalPermission enum has all 90+ values matching legacy PermissionHelper.Permission exactly
- ERecruitmentPermission is completely removed from the codebase
- Solution compiles and all authorization policies work with the new enum
</success_criteria>

<output>
After completion, create `.planning/phases/03.6-user-client-permission-helper-migration-isclientloggedon-and-role-permission-checks/03.6-01-SUMMARY.md`
</output>
