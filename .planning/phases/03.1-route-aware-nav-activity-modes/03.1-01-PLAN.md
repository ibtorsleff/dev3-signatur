---
phase: 03.1-route-aware-nav-activity-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Web/Components/Layout/NavMenu.razor
  - src/SignaturPortal.Web/Components/Layout/NavMenu.razor.cs
  - src/SignaturPortal.Web/Components/Layout/NavMenuConfig.cs
  - src/SignaturPortal.Web/Components/Services/INavigationConfigService.cs
  - src/SignaturPortal.Web/Components/Services/NavigationConfigService.cs
  - src/SignaturPortal.Infrastructure/DependencyInjection.cs
autonomous: true

must_haves:
  truths:
    - "Row 2 tabs change when navigating between activity list and other sections"
    - "Row 1 'Sagsliste' icon is highlighted when on an activity page"
    - "Row 3 is hidden when there are no sub-navigation items (activity list area)"
    - "Clicking a Row 2 mode tab navigates to the correct URL"
    - "Navigation config updates without a full page reload (SPA navigation)"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Services/INavigationConfigService.cs"
      provides: "Interface for route-to-nav-config resolution"
      exports: ["INavigationConfigService"]
    - path: "src/SignaturPortal.Web/Components/Services/NavigationConfigService.cs"
      provides: "Route-aware navigation configuration logic"
      exports: ["NavigationConfigService"]
    - path: "src/SignaturPortal.Web/Components/Layout/NavMenu.razor.cs"
      provides: "Code-behind with LocationChanged subscription and IDisposable"
      exports: ["NavMenu"]
    - path: "src/SignaturPortal.Web/Components/Layout/NavMenuConfig.cs"
      provides: "NavMenuItem and NavMenuConfig data classes"
      contains: "class NavMenuConfig"
    - path: "src/SignaturPortal.Web/Components/Layout/NavMenu.razor"
      provides: "Dynamic nav rendering using injected config"
  key_links:
    - from: "NavMenu.razor.cs"
      to: "INavigationConfigService"
      via: "Inject + GetConfigForRoute call"
      pattern: "NavConfigService\\.GetConfigForRoute"
    - from: "NavMenu.razor.cs"
      to: "NavigationManager.LocationChanged"
      via: "Event subscription in OnInitialized, unsubscribe in Dispose"
      pattern: "LocationChanged \\+="
    - from: "NavigationConfigService"
      to: "NavMenuConfig"
      via: "Returns config based on current path"
      pattern: "return new NavMenuConfig"
    - from: "DependencyInjection.cs"
      to: "NavigationConfigService"
      via: "AddSingleton DI registration"
      pattern: "AddSingleton.*INavigationConfigService"
---

<objective>
Make the NavMenu component route-aware so that Row 1 active state, Row 2 tabs, and Row 3 sub-tabs change dynamically based on the current page URL.

Purpose: The legacy WebForms app has context-dependent navigation where Row 2 shows different tabs depending on whether the user is viewing the activity list, editing an activity, or viewing statistics. The current Blazor NavMenu has hardcoded static config that shows the same tabs regardless of route. This plan replaces the static config with a centralized route-to-config service.

Output: INavigationConfigService, NavigationConfigService, NavMenu code-behind with route change detection, updated NavMenu.razor using dynamic config.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-route-aware-nav-activity-modes/03.1-RESEARCH.md
@src/SignaturPortal.Web/Components/Layout/NavMenu.razor
@src/SignaturPortal.Web/Components/Layout/NavMenu.razor.css
@src/SignaturPortal.Web/Components/Layout/NavMenuConfig.cs
@src/SignaturPortal.Web/Components/Layout/MainLayout.razor
@src/SignaturPortal.Infrastructure/DependencyInjection.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create INavigationConfigService and NavigationConfigService</name>
  <files>
    src/SignaturPortal.Web/Components/Services/INavigationConfigService.cs
    src/SignaturPortal.Web/Components/Services/NavigationConfigService.cs
    src/SignaturPortal.Web/Components/Layout/NavMenuConfig.cs
    src/SignaturPortal.Infrastructure/DependencyInjection.cs
  </files>
  <action>
1. Create directory `src/SignaturPortal.Web/Components/Services/` if it does not exist.

2. Create `INavigationConfigService.cs` in namespace `SignaturPortal.Web.Components.Services`:
   - Single method: `NavMenuConfig GetConfigForRoute(string path)`
   - Takes the absolute path portion of the current URL (e.g., "/activities", "/activities/closed", "/activities/123")

3. Create `NavigationConfigService.cs` implementing `INavigationConfigService`:
   - `GetConfigForRoute(string path)` determines the "area" from the path and builds the appropriate NavMenuConfig.
   - Area resolution logic:
     - Path starts with "/activities" -> `NavigationArea.Activities`
     - All other paths -> `NavigationArea.Default` (legacy nav items still link to WebForms URLs via YARP)
   - Define a private enum `NavigationArea { Default, Activities }` inside the class (or as a nested type).

   - `GetRow1Items(string path)` returns the 6 left items (always the same list). Set `IsSelected = true` on the item whose area matches the current path:
     - "Sagsliste" selected when path starts with "/activities"
     - Other items: never selected (they link to legacy WebForms pages)
   - Items (matching legacy exactly):
     ```
     Sagsliste -> /activities, icon-activity-list
     Sog -> /Responsive/Recruiting/Search.aspx, icon-search
     Jobbank -> /Responsive/Recruiting/JobBank.aspx, icon-jobbank
     Hjaelp -> /Responsive/Recruiting/Help.aspx, icon-help
     Admin -> /Responsive/Recruiting/Admin.aspx, icon-admin
     Statistik -> /Responsive/Recruiting/StatisticsQuestionnaire.aspx, icon-statistics
     ```

   - `GetRow1RightItems()` returns 2 items (always the same, never selected):
     ```
     Medarbejderportal -> /Responsive/OnBoarding/Default.aspx, icon-employee-portal
     Annonceportal -> /Responsive/AdPortal/ActivityList.aspx, icon-ad-portal
     ```

   - `GetRow2Items(string path)` returns context-dependent tabs:
     - For Activities area: return the 3 mode tabs with correct selected state:
       - "Kladdesager" -> /activities/draft (selected when path == "/activities/draft")
       - "Igangvaerende sager" -> /activities (selected when path == "/activities" exactly, or path starts with "/activities/" but is NOT "/activities/draft" or "/activities/closed" -- this catches "/activities/123" detail pages too)
       - "Afsluttede sager" -> /activities/closed (selected when path == "/activities/closed")
       NOTE: For now, show all 3 tabs unconditionally. Permission-based visibility (Draft requires UserCanAccessRecruitmentDraftActivities, Closed requires IsInternal) is deferred to a later phase when the permission system is more complete.
     - For Default area: return empty list (no Row 2 tabs for unmigrated sections)

   - `GetRow3Items(string path)` returns empty list for all current areas. Row 3 is not used for the activity list area. Future phases will add Row 3 items for candidate detail pages.

   - `PortalName` always "Rekruttering", `PortalUrl` always "/activities".

4. Update `NavMenuConfig.cs` -- keep the existing `NavMenuItem` and `NavMenuConfig` classes as-is. No changes needed to the data model.

5. Register the service in `DependencyInjection.cs`: Add `services.AddSingleton<INavigationConfigService, NavigationConfigService>();` in the `AddInfrastructure` method. Use Singleton because the service is stateless (pure function of path input). NOTE: The NavigationConfigService class lives in the Web project but can be registered from Infrastructure's DI since the Web project calls `AddInfrastructure`. Actually -- register it in `Program.cs` instead since the service is in the Web project namespace. Add `builder.Services.AddSingleton<INavigationConfigService, NavigationConfigService>();` after the existing service registrations.

IMPORTANT: The "selected" logic for Row 2 activity mode tabs must correctly handle:
- `/activities` -> "Igangvaerende sager" selected
- `/activities/draft` -> "Kladdesager" selected
- `/activities/closed` -> "Afsluttede sager" selected
- `/activities/123` (detail page) -> "Igangvaerende sager" selected (detail is part of ongoing context)
  </action>
  <verify>
    - `dotnet build src/SignaturPortal.Web` compiles without errors
    - The NavigationConfigService class exists and implements INavigationConfigService
    - Calling `GetConfigForRoute("/activities")` returns config with 3 Row2 items and "Igangvaerende sager" selected
    - Calling `GetConfigForRoute("/activities/closed")` returns config with "Afsluttede sager" selected
    - Calling `GetConfigForRoute("/activities/draft")` returns config with "Kladdesager" selected
    - Calling `GetConfigForRoute("/activities/123")` returns config with "Igangvaerende sager" selected
    - Calling `GetConfigForRoute("/some-other-page")` returns config with empty Row2Items
  </verify>
  <done>
    INavigationConfigService and NavigationConfigService exist, are registered in DI, and correctly map routes to NavMenuConfig objects with proper Row1 selected state and Row2 activity mode tabs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert NavMenu to route-aware with code-behind</name>
  <files>
    src/SignaturPortal.Web/Components/Layout/NavMenu.razor
    src/SignaturPortal.Web/Components/Layout/NavMenu.razor.cs
  </files>
  <action>
1. Create `NavMenu.razor.cs` code-behind in namespace `SignaturPortal.Web.Components.Layout`:
   - Class: `public partial class NavMenu : IDisposable`
   - Inject `NavigationManager` via `[Inject]`
   - Inject `INavigationConfigService` via `[Inject]`
   - Inject `IUserSessionContext` via `[Inject]` (already used in razor for Session.UserName)
   - Private field: `private NavMenuConfig _config = new();`

   - `protected override void OnInitialized()`:
     - Subscribe: `Navigation.LocationChanged += OnLocationChanged;`
     - Call `UpdateNavConfig();` to set initial config

   - `private void OnLocationChanged(object? sender, LocationChangedEventArgs e)`:
     - Call `UpdateNavConfig();`
     - Call `InvokeAsync(StateHasChanged);` to re-render on UI thread

   - `private void UpdateNavConfig()`:
     - Get absolute path: `var uri = new Uri(Navigation.Uri); var path = uri.AbsolutePath;`
     - Set config: `_config = NavConfigService.GetConfigForRoute(path);`

   - `public void Dispose()`:
     - Unsubscribe: `Navigation.LocationChanged -= OnLocationChanged;`

2. Update `NavMenu.razor`:
   - Remove the entire `@code { }` block (the hardcoded static config). All logic is now in the code-behind.
   - Remove the `@inject IUserSessionContext Session` directive (moved to code-behind as [Inject]).
   - Remove the `@using SignaturPortal.Application.Interfaces` directive (moved to code-behind).
   - Keep the HTML template exactly as-is. The template already uses `_config.Row1Items`, `_config.Row2Items`, `_config.Row3Items`, `_config.PortalName`, `_config.PortalUrl` which will now come from the code-behind field.
   - Update the Session reference in Row 2 user info: change `Session.IsInitialized` and `Session.UserName` to use the code-behind's injected property name. In the code-behind, name the property `Session` to match: `[Inject] private IUserSessionContext Session { get; set; } = default!;`. This way the razor template references remain unchanged.

The razor file should be pure template with NO @code block, NO @inject directives (handled by code-behind), and NO @using directives for injected types.

CRITICAL: The existing razor template references `_config` (private field) and `Session` (inject). Both must be accessible from the code-behind partial class. `_config` is a private field in the code-behind. `Session` is a private [Inject] property in the code-behind. Blazor partial classes share access to private members, so the razor template can reference them.
  </action>
  <verify>
    - `dotnet build src/SignaturPortal.Web` compiles without errors
    - NavMenu.razor has NO `@code` block
    - NavMenu.razor.cs exists with IDisposable, LocationChanged subscription/unsubscription
    - NavMenu.razor.cs injects INavigationConfigService and NavigationManager
    - Run the app: navigate to /activities -- Row 2 shows "Kladdesager", "Igangvaerende sager" (selected), "Afsluttede sager"
    - Navigate to /activities/closed -- Row 2 shows "Afsluttede sager" as selected
    - Row 1 "Sagsliste" icon is highlighted when on activity pages
    - Row 3 is hidden (no items for activity list area)
  </verify>
  <done>
    NavMenu dynamically updates its tab configuration based on the current route. The hardcoded static config is replaced with route-aware config from INavigationConfigService. LocationChanged event ensures config updates on SPA navigation without full page reload.
  </done>
</task>

</tasks>

<verification>
1. Build: `dotnet build src/SignaturPortal.Web` succeeds with no errors
2. Navigate to /activities: Row 1 "Sagsliste" is highlighted, Row 2 shows 3 mode tabs with "Igangvaerende sager" selected, Row 3 is hidden
3. Navigate to /activities/closed: Row 2 "Afsluttede sager" becomes selected
4. Navigate to /activities/draft: Row 2 "Kladdesager" becomes selected
5. Navigate to /activities/123 (detail page): Row 2 "Igangvaerende sager" remains selected (detail is within ongoing context)
6. Click a Row 1 legacy link (e.g., Sog): YARP proxies to legacy app correctly
7. No console errors related to navigation or rendering
</verification>

<success_criteria>
- NavMenu renders dynamic tabs based on current route
- Row 1 active state correctly highlights "Sagsliste" on activity pages
- Row 2 shows Draft/Ongoing/Closed mode tabs on activity list pages
- Row 3 is hidden when no sub-navigation items exist
- Navigation between routes updates tabs without full page reload
- No memory leaks (LocationChanged properly unsubscribed in Dispose)
- Build compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-route-aware-nav-activity-modes/03.1-01-SUMMARY.md`
</output>
