# Phase 3.1: Route-Aware Navigation & Activity List Modes - Research

**Researched:** 2026-02-16
**Domain:** Blazor route-aware navigation, legacy WebForms navigation replication
**Confidence:** HIGH

## Summary

This phase transforms the currently static NavMenu component into a route-aware navigation system that dynamically changes Row 2 and Row 3 tab content based on the current page context. The activity list page must also support 3 distinct modes (Draft, Ongoing, Closed) accessible via sub-navigation tabs, replicating the legacy WebForms behavior exactly.

The legacy system uses a complex `RecruitingTabs.ascx` control (~4600 lines) with deeply nested switch statements to determine which tabs appear in Row 1, Row 2, and Row 3 based on the current `RecruitingAreaEn` and `RecruitingSubAreaEn`. For the activity list specifically, the 3 modes are implemented via query parameters (`?Mode=2` for Closed, `?Mode=3` for Draft, no param or `Hdm=1` for Ongoing). Each mode is a separate page load with its own set of Row 2 tabs showing Draft/Ongoing/Closed as sub-tabs.

The Blazor implementation should use `NavigationManager.LocationChanged` to detect route changes and a navigation configuration service to determine which tabs are visible and selected. The existing `NavMenuConfig` class provides a solid foundation but needs to become dynamic (computed per-route) rather than static (hardcoded).

**Primary recommendation:** Build a `INavigationConfigService` that takes the current URI and returns the appropriate `NavMenuConfig` for that route, replacing the static config in NavMenu.razor. For the activity list modes, use Blazor route parameters (e.g., `/activities/ongoing`, `/activities/closed`, `/activities/draft`) rather than query strings, which is the idiomatic Blazor approach.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| MudBlazor | 8.0.0 | UI components (already installed) | MudTabs, MudDataGrid already in use |
| NavigationManager | Built-in | Route detection, LocationChanged event | Standard Blazor navigation API |
| CascadingParameter | Built-in | Pass nav state from layout to components | Standard Blazor pattern for layout-to-content communication |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Microsoft.AspNetCore.Components.Routing | Built-in | @page directives, route parameters | For `/activities/{mode?}` route pattern |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom nav config service | MudBlazor MudNavMenu | MudNavMenu is for sidebar nav, not 3-row top nav; custom matches legacy |
| Route parameters `/activities/ongoing` | Query strings `?Mode=1` | Route params are more idiomatic Blazor and better for browser history/bookmarks |
| CascadingParameter for nav state | Scoped DI service | CascadingParameter is simpler and auto-updates on render; DI service needs manual notification |

## Architecture Patterns

### Recommended Project Structure
```
Components/
  Layout/
    NavMenu.razor             # MODIFY: Use INavigationConfigService instead of static config
    NavMenu.razor.cs          # NEW: Code-behind for route change handling
    NavMenu.razor.css         # EXISTING: Already has all 3-row styles
    NavMenuConfig.cs          # MODIFY: Add route-to-config mapping logic
  Services/
    NavigationConfigService.cs  # NEW: Determines nav config from current route
    INavigationConfigService.cs # NEW: Interface for nav config resolution
  Pages/
    Activities/
      ActivityList.razor       # MODIFY: Add mode parameter, filter by status
      ActivityList.razor.cs    # MODIFY: Pass mode to service, update nav context
```

### Pattern 1: Route-Aware Navigation via NavigationManager
**What:** NavMenu subscribes to NavigationManager.LocationChanged to rebuild its tab configuration on every navigation
**When to use:** Any time navigation content must change based on current route
**Example:**
```csharp
// NavMenu.razor.cs
public partial class NavMenu : IDisposable
{
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private INavigationConfigService NavConfigService { get; set; } = default!;

    private NavMenuConfig _config = new();

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        UpdateNavConfig();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateNavConfig();
        StateHasChanged();
    }

    private void UpdateNavConfig()
    {
        var uri = new Uri(Navigation.Uri);
        _config = NavConfigService.GetConfigForRoute(uri.AbsolutePath);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
```

### Pattern 2: Activity List Mode via Route Parameter
**What:** Use optional route parameter for activity list mode instead of query string
**When to use:** The activity list page with its 3 modes
**Example:**
```csharp
// ActivityList.razor
@page "/activities"
@page "/activities/{Mode}"

// ActivityList.razor.cs
[Parameter] public string? Mode { get; set; }

private ERActivityStatus GetCurrentMode()
{
    return Mode?.ToLowerInvariant() switch
    {
        "draft" => ERActivityStatus.Draft,
        "closed" => ERActivityStatus.Closed,
        _ => ERActivityStatus.OnGoing  // default mode
    };
}
```

### Pattern 3: Navigation Configuration Service
**What:** A service that maps routes to navigation configurations, mirroring legacy RecruitingTabs logic
**When to use:** For determining which tabs appear in Row 1/2/3 for any given page
**Example:**
```csharp
public class NavigationConfigService : INavigationConfigService
{
    public NavMenuConfig GetConfigForRoute(string path)
    {
        // Determine the "area" from the path
        var area = ResolveArea(path);

        return new NavMenuConfig
        {
            PortalName = "Rekruttering",
            PortalUrl = "/activities",
            Row1Items = BuildRow1Items(area),
            Row2Items = BuildRow2Items(area, path),
            Row3Items = BuildRow3Items(area, path),
        };
    }

    private NavigationArea ResolveArea(string path)
    {
        if (path.StartsWith("/activities")) return NavigationArea.ActivityList;
        // ... other areas as they get migrated
        return NavigationArea.Unknown;
    }
}
```

### Anti-Patterns to Avoid
- **Hardcoded nav config per page:** Don't put nav configuration in each page component. Use a centralized service -- the legacy app suffered from 4600 lines of switch statements precisely because each page set its own area.
- **Rebuilding the entire legacy menu system:** Don't replicate all ~40 sub-areas from RecruitingTabs.ascx. Only implement the areas that are actually migrated to Blazor (currently: ActivityList + ActivityDetail). Other nav items should link to legacy URLs via YARP.
- **Using MudTabs for navigation rows:** MudTabs are for content tabs, not navigation. The existing custom CSS nav is the correct approach since it matches the legacy pixel-perfectly.
- **Storing nav state in session/server:** Navigation state should be computed from the current URL, not stored server-side. This is stateless and works with browser back/forward.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Route change detection | Custom JS interop or polling | `NavigationManager.LocationChanged` event | Built-in, reliable, Blazor-native |
| URL path parsing | Manual string splitting | `Uri` class + route parameters | Handles edge cases (encoding, trailing slashes) |
| Active tab highlighting | CSS class toggle via JS | Blazor `@(isActive ? "selected" : "")` binding | Reactive, no manual DOM manipulation needed |
| Status-based data filtering | Client-side filtering of all data | Server-side `WHERE EractivityStatusId = @mode` | Performance -- don't load all statuses then filter |

**Key insight:** The Blazor approach should be simpler than the legacy WebForms approach. In WebForms, the page tells the master page its area, and the master page computes tabs. In Blazor, the navigation component simply reads the URL and computes tabs directly -- no bidirectional communication needed.

## Common Pitfalls

### Pitfall 1: LocationChanged fires AFTER render
**What goes wrong:** NavMenu renders with stale config, then LocationChanged fires and causes a second render with the correct config, causing a visual flash.
**Why it happens:** NavigationManager.LocationChanged is an event that fires after the navigation has occurred.
**How to avoid:** Also call `UpdateNavConfig()` in `OnParametersSet()` of NavMenu, not just in the event handler. This ensures the initial render for a new route already has the correct config.
**Warning signs:** Navigation tabs briefly show wrong content before correcting.

### Pitfall 2: Memory leak from LocationChanged subscription
**What goes wrong:** NavMenu subscribes to LocationChanged but never unsubscribes, causing memory leaks.
**Why it happens:** Forgetting to implement IDisposable.
**How to avoid:** Always implement `IDisposable` and unsubscribe in `Dispose()`.
**Warning signs:** Increasing memory usage over time, multiple event handlers firing.

### Pitfall 3: Activity list not reloading when mode changes via nav tab
**What goes wrong:** Clicking from "Ongoing" to "Closed" tab changes the URL but the data grid doesn't reload.
**Why it happens:** When only the route parameter changes (not the page component), Blazor reuses the existing component instance. `OnInitializedAsync` does NOT re-fire.
**How to avoid:** Use `OnParametersSet` or `OnParametersSetAsync` to detect when the `Mode` parameter changes and reload data. Or check in `SetParametersAsync`.
**Warning signs:** URL bar shows the new mode, but the grid still shows the old data.

### Pitfall 4: Mode parameter not flowing to IActivityService
**What goes wrong:** The activity list shows all activities regardless of mode.
**Why it happens:** The current `GetActivitiesAsync` method doesn't accept a status filter parameter.
**How to avoid:** Add a `statusFilter` parameter to `GetActivitiesAsync` (or use the existing `FilterDefinition` mechanism with a status filter). The legacy code explicitly builds `activityStatusList.Add(_mode)` to filter.
**Warning signs:** All 3 modes show identical data.

### Pitfall 5: Legacy nav items breaking when clicked
**What goes wrong:** Row 1 nav items that link to legacy pages (e.g., Search, Help, Admin) break because they point to legacy WebForms URLs.
**Why it happens:** The links use relative paths like `/Responsive/Recruiting/ActivitySearch.aspx` which should be served by YARP reverse proxy to the legacy app.
**How to avoid:** Ensure these links use the exact legacy URLs (they should work via YARP). Don't try to make them Blazor routes.
**Warning signs:** 404 errors when clicking un-migrated nav items.

## Legacy Navigation Structure -- Complete Reference

### How the 3-row navigation works in legacy

**Row 1 (white, icons+labels):** Top-level sections, always visible. Items:
- Sagsliste (Activity List) -- icon: `recruitment-activity-list_80x80.png`
- Sog (Search) -- icon: `recruitment-search_80x80.png`
- Jobbank -- icon: `recruitment-job-bank_80x80.png`
- Hjaelp (Help) -- icon: `recruitment-help_80x80.png`
- Admin -- icon: `recruitment-admin_80x80.png`
- Statistik (Statistics) -- icon: `recruitment-statistics_80x80.png`

Right side:
- Medarbejderportal (Employee Portal / Onboarding) -- icon: `recruitment-onboarding-portal_80x80.png`
- Annonceportal (Ad Portal) -- icon: `recruitment-ad-portal_80x80.png`

**Row 2 (teal tabs):** Context-dependent, changes by section. For Activity List:
- Kladdesager (Draft Activities) -- only if user has draft access
- Igangvaerende sager (Ongoing Activities) -- always shown
- Afsluttede sager (Closed Activities) -- only for internal users

For Activity Edit (when viewing/editing an activity):
- Sag (Activity) -- the edit form
- Kandidatliste (Candidate List)
- Annonce (Advertisement)
- Sagsnoter (Activity Notes)

For Statistics:
- Rekruttering (Recruitment)
- Sporgeskema (Questionnaire)
- Medie (Media)

**Row 3 (dark teal sub-nav):** Deepest context level. For activity list modes: Row 3 is NOT shown. For candidate detail pages: shows candidate sub-tabs (Info, Application Form, Files, Log). Row 3 is hidden when `menuItemList.Count == 0`.

### Activity List Mode URLs (Legacy)
| Mode | URL | Query Param |
|------|-----|-------------|
| Ongoing | `/Responsive/Recruiting/ActivityList.aspx` | none (or `?Mode=1`) |
| Closed | `/Responsive/Recruiting/ActivityList.aspx?Mode=2` | `?Mode=2` |
| Draft | `/Responsive/Recruiting/ActivityList.aspx?Mode=3` | `?Mode=3` |
| Default (auto) | `/Responsive/Recruiting/ActivityList.aspx?Hdm=1` | Reads last mode from session |

### Mode-specific behavior (from legacy code)
- **Ongoing:** Default mode. Auto-postback on filter changes. No date filter. Shows "Create New Activity" button.
- **Closed:** Shows date range filter (From/To) and Search button. Requires explicit search. Internal users only.
- **Draft:** Shows "Create New Draft Activity" button. Requires `UserCanAccessRecruitmentDraftActivities` permission. Shows different grid columns (DraftArea, DraftResponsible instead of CreatedBy, TemplateGroup).
- **All modes:** Show activity count badge in headline: `"Igangvaerende sager (42)"`. Show filter badge when filters active.

### Row 2 tabs for Activity List area
The following code from `PopulateDesktopRow2MenuItems()` (lines 1576-1609) shows exactly which tabs appear:

```
When ActivityListOngoing:
  [Draft]* -> Ongoing -> [Closed]**

When ActivityListClosed:
  [Draft]* -> Ongoing -> Closed

When ActivityListDraft:
  Draft -> Ongoing -> [Closed]**

* Draft tab only shown if _userCanAccessRecruitmentDraftActivities
** Closed tab only shown if _currentUser.IsInternal
```

The currently selected mode gets the `selected` CSS class.

### Session key for last active mode
The legacy app stores the last active activity list mode in `Session["ERActivityListAreaLast"]` as a `RecruitingSubAreaEn` enum value. When navigating to `/ActivityList.aspx?Hdm=1` (portal logo click), it reads this session key to determine which mode to redirect to.

## Code Examples

### Example 1: NavMenu with Route-Aware Config
```csharp
// INavigationConfigService.cs
public interface INavigationConfigService
{
    NavMenuConfig GetConfigForRoute(string path, string? queryString = null);
}

// NavigationConfigService.cs
public class NavigationConfigService : INavigationConfigService
{
    public NavMenuConfig GetConfigForRoute(string path, string? queryString = null)
    {
        var config = new NavMenuConfig
        {
            PortalName = "Rekruttering",
            PortalUrl = "/activities",
            Row1Items = GetRow1Items(path),
            Row1RightItems = GetRow1RightItems(),
            Row2Items = GetRow2Items(path),
            Row3Items = GetRow3Items(path),
        };
        return config;
    }

    private List<NavMenuItem> GetRow2Items(string path)
    {
        // Activity list area -- show Draft/Ongoing/Closed tabs
        if (path.StartsWith("/activities"))
        {
            var mode = ExtractActivityMode(path);
            var items = new List<NavMenuItem>();

            // TODO: Draft tab conditional on user permissions (Phase 5+)
            // items.Add(new NavMenuItem { Label = "Kladdesager", Url = "/activities/draft", IsSelected = mode == "draft" });

            items.Add(new NavMenuItem
            {
                Label = "Igangvaerende sager",
                Url = "/activities",
                IsSelected = mode == "ongoing"
            });
            items.Add(new NavMenuItem
            {
                Label = "Afsluttede sager",
                Url = "/activities/closed",
                IsSelected = mode == "closed"
            });

            return items;
        }

        return new List<NavMenuItem>();
    }
}
```

### Example 2: ActivityList with Mode Parameter
```csharp
// ActivityList.razor
@page "/activities"
@page "/activities/{Mode}"

// ActivityList.razor.cs
public partial class ActivityList
{
    [Parameter] public string? Mode { get; set; }

    private ERActivityStatus _currentStatus = ERActivityStatus.OnGoing;

    protected override void OnParametersSet()
    {
        _currentStatus = Mode?.ToLowerInvariant() switch
        {
            "draft" => ERActivityStatus.Draft,
            "closed" => ERActivityStatus.Closed,
            _ => ERActivityStatus.OnGoing
        };
    }

    private async Task<GridData<ActivityListDto>> LoadServerData(GridState<ActivityListDto> state)
    {
        var request = new GridRequest { /* ... */ };
        // Add status filter
        request.Filters.Add(new FilterDefinition(
            "EractivityStatusId", "equals", (int)_currentStatus));

        var response = await ActivityService.GetActivitiesAsync(request);
        return new GridData<ActivityListDto> { Items = response.Items, TotalItems = response.TotalCount };
    }
}
```

### Example 3: Content Headline with Count Badge (matching legacy)
```razor
<div class="content-headline">
    <div>
        @GetHeadlineText()
        <span class="badge">@_activityCount</span>
        @if (_hasActiveFilter)
        {
            <span class="badge exclamation-text">Filter</span>
        }
    </div>
</div>

@code {
    private string GetHeadlineText() => _currentStatus switch
    {
        ERActivityStatus.Draft => "Kladdesager",
        ERActivityStatus.Closed => "Afsluttede sager",
        _ => "Igangvaerende sager"
    };
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Static NavMenuConfig (hardcoded) | Dynamic route-aware NavMenuConfig | This phase | Enables context-dependent navigation |
| No status filtering in activity list | Status-based filtering via route param | This phase | Matches legacy 3-mode behavior |
| Query strings for mode (`?Mode=2`) | Route parameters (`/activities/closed`) | This phase | More idiomatic Blazor, better UX |

**Deprecated/outdated:**
- The current static `_config` in NavMenu.razor `@code {}` block must be replaced with dynamic config resolution

## Open Questions

1. **Draft mode user permissions**
   - What we know: Legacy checks `_userCanAccessRecruitmentDraftActivities` (Permission + Client config) before showing Draft tab
   - What's unclear: Whether to implement this permission check now or defer to a later permission phase
   - Recommendation: Add the Draft tab to nav config but hide it by default. Show it only for internal users initially. Full permission check can be wired up in a later phase when the permission system is implemented.

2. **Localization of tab labels**
   - What we know: Legacy uses `GetText()` for all labels (Danish: "Igangvaerende sager", "Afsluttede sager", "Kladdesager")
   - What's unclear: Whether to hardcode Danish labels now or set up localization infrastructure
   - Recommendation: Hardcode Danish labels for now (matching legacy). Localization is a separate concern for a future phase.

3. **Activity count in headline**
   - What we know: Legacy shows count badge like "Igangvaerende sager (42)". The count is the total number of activities matching the current filters.
   - What's unclear: Whether the count should come from the GridResponse or a separate count endpoint
   - Recommendation: Use `GridResponse.TotalCount` from the existing server-side pagination -- it already returns the filtered count.

4. **Default redirect behavior (Hdm=1 pattern)**
   - What we know: Legacy logo link uses `?Hdm=1` to redirect to last-used mode (stored in session)
   - What's unclear: Whether to replicate the session-based default mode in Blazor
   - Recommendation: For now, the logo link goes to `/activities` (Ongoing mode). Session-based last-mode tracking can be added later if needed.

## Sources

### Primary (HIGH confidence)
- Legacy codebase `RecruitingTabs.ascx.cs` -- Complete navigation logic, ~4600 lines analyzed
- Legacy codebase `ActivityList.aspx.cs` -- Mode handling via query params, filter setup, data loading
- Legacy codebase `RecruitingTabs.ascx` -- HTML structure for 3-row nav with repeaters
- Existing Blazor codebase `NavMenu.razor` + `NavMenuConfig.cs` -- Current static nav implementation
- Existing Blazor codebase `ActivityList.razor` + `ActivityList.razor.cs` -- Current data grid implementation

### Secondary (MEDIUM confidence)
- Blazor `NavigationManager.LocationChanged` -- Standard documented Blazor API for route change detection
- Blazor route parameter pattern `@page "/route/{param}"` -- Standard documented Blazor routing

### Tertiary (LOW confidence)
- None -- all findings verified against source code

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in use (MudBlazor, Blazor built-ins)
- Architecture: HIGH - Patterns derived directly from legacy code analysis + standard Blazor patterns
- Pitfalls: HIGH - Pitfalls identified from known Blazor lifecycle behavior and actual legacy code analysis
- Legacy navigation structure: HIGH - Extracted directly from source code analysis of RecruitingTabs.ascx.cs

**Research date:** 2026-02-16
**Valid until:** 2026-03-16 (stable -- legacy code is frozen, Blazor patterns are well-established)
