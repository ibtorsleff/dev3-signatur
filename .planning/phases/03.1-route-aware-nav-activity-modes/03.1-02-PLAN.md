---
phase: 03.1-route-aware-nav-activity-modes
plan: 02
type: execute
wave: 2
depends_on: ["03.1-01"]
files_modified:
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
  - src/SignaturPortal.Application/Interfaces/IActivityService.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
autonomous: true

must_haves:
  truths:
    - "Navigating to /activities shows only Ongoing activities"
    - "Navigating to /activities/closed shows only Closed activities"
    - "Navigating to /activities/draft shows only Draft activities"
    - "The headline text changes to match the current mode (Igangvaerende sager, Afsluttede sager, Kladdesager)"
    - "The activity count is displayed in the headline"
    - "Switching between mode tabs reloads the data grid with the correct status filter"
    - "The page title updates to reflect the current mode"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor"
      provides: "Activity list page with mode route parameter, headline with count"
      contains: '@page "/activities/{Mode}"'
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs"
      provides: "Mode parameter handling, status-filtered data loading"
      contains: "OnParametersSet"
    - path: "src/SignaturPortal.Application/Interfaces/IActivityService.cs"
      provides: "GetActivitiesAsync with optional status filter parameter"
      exports: ["IActivityService"]
    - path: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      provides: "Server-side status filtering in activity query"
      contains: "EractivityStatusId"
  key_links:
    - from: "ActivityList.razor.cs"
      to: "IActivityService.GetActivitiesAsync"
      via: "Passes ERActivityStatus filter derived from Mode route parameter"
      pattern: "GetActivitiesAsync.*statusFilter"
    - from: "ActivityList.razor.cs"
      to: "OnParametersSet"
      via: "Detects Mode parameter change and reloads grid"
      pattern: "OnParametersSet"
    - from: "ActivityService.cs"
      to: "EractivityStatusId"
      via: "WHERE clause filtering by status"
      pattern: "EractivityStatusId == \\(int\\)"
---

<objective>
Add activity list status mode filtering so that /activities, /activities/closed, and /activities/draft each show only activities with the matching status, with a mode-specific headline and count badge.

Purpose: The legacy WebForms app has 3 distinct activity list modes (Ongoing, Closed, Draft) accessible via sub-navigation tabs. Each mode shows a filtered view of activities. The current Blazor activity list shows all activities regardless of status. This plan adds route-parameter-based filtering to match the legacy behavior.

Output: ActivityList with Mode route parameter, status-filtered data loading via IActivityService, mode-specific headline with activity count badge.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-route-aware-nav-activity-modes/03.1-RESEARCH.md
@.planning/phases/03.1-route-aware-nav-activity-modes/03.1-01-SUMMARY.md
@src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
@src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
@src/SignaturPortal.Application/Interfaces/IActivityService.cs
@src/SignaturPortal.Infrastructure/Services/ActivityService.cs
@src/SignaturPortal.Application/DTOs/GridRequest.cs
@src/SignaturPortal.Domain/Enums/ERActivityStatus.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status filter parameter to IActivityService and ActivityService</name>
  <files>
    src/SignaturPortal.Application/Interfaces/IActivityService.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  </files>
  <action>
1. Update `IActivityService.GetActivitiesAsync` signature to accept an optional status filter:
   ```csharp
   Task<GridResponse<ActivityListDto>> GetActivitiesAsync(
       GridRequest request,
       ERActivityStatus? statusFilter = null,
       CancellationToken ct = default);
   ```
   Add `using SignaturPortal.Domain.Enums;` to the IActivityService file.

2. Update `ActivityService.GetActivitiesAsync` to use the new parameter:
   - Add the `ERActivityStatus? statusFilter = null` parameter to the method signature.
   - After the existing `Where(a => !a.IsCleaned)` filter and BEFORE the `ApplyFilters(request.Filters)` call, add a status filter:
     ```csharp
     // Filter by activity status mode (Ongoing, Closed, Draft)
     if (statusFilter.HasValue)
     {
         var statusId = (int)statusFilter.Value;
         query = query.Where(a => a.EractivityStatusId == statusId);
     }
     ```
   - This ensures the status filter is applied server-side in the SQL query, not client-side.
   - Do NOT remove the existing filter logic -- the dynamic filters from MudDataGrid column filters should still work on top of the status filter.

NOTE: The status filter is applied BEFORE the count query (`CountAsync`), so the TotalCount in the response reflects only activities matching the current status mode. This is important for the count badge in the headline.
  </action>
  <verify>
    - `dotnet build src/SignaturPortal.Web` compiles without errors
    - IActivityService.GetActivitiesAsync has the new `ERActivityStatus? statusFilter` parameter
    - ActivityService.GetActivitiesAsync filters by `EractivityStatusId` when statusFilter is provided
    - Existing callers (ActivityList.razor.cs) still compile because the parameter has a default value
  </verify>
  <done>
    IActivityService and ActivityService support optional status filtering. Passing `ERActivityStatus.OnGoing` returns only ongoing activities; passing `null` returns all (backward compatible).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Mode route parameter, headline with count, and filtered data loading to ActivityList</name>
  <files>
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor.cs
  </files>
  <action>
1. Update `ActivityList.razor`:
   - Add a second `@page` directive: `@page "/activities/{Mode}"` (keep the existing `@page "/activities"`)
   - Add `@using SignaturPortal.Domain.Enums` if not already present
   - Replace the existing `<MudText Typo="Typo.h6">Recruitment Activities</MudText>` in the ToolBarContent with a mode-aware headline that includes the activity count:
     ```razor
     <MudText Typo="Typo.h6">@_headlineText (@_totalCount)</MudText>
     ```
   - Update `<PageTitle>` to be mode-aware: `<PageTitle>@_headlineText</PageTitle>`

2. Update `ActivityList.razor.cs`:
   - Add route parameter: `[Parameter] public string? Mode { get; set; }`
   - Add private fields:
     ```csharp
     private ERActivityStatus _currentStatus = ERActivityStatus.OnGoing;
     private string _headlineText = "Igangvaerende sager";
     private int _totalCount;
     ```
   - Add `OnParametersSet` override to detect mode changes. This is CRITICAL because when navigating between /activities and /activities/closed, Blazor reuses the component instance. OnInitializedAsync does NOT re-fire. OnParametersSet fires every time a route parameter changes:
     ```csharp
     protected override void OnParametersSet()
     {
         var newStatus = Mode?.ToLowerInvariant() switch
         {
             "draft" => ERActivityStatus.Draft,
             "closed" => ERActivityStatus.Closed,
             _ => ERActivityStatus.OnGoing
         };

         if (newStatus != _currentStatus)
         {
             _currentStatus = newStatus;
             _headlineText = _currentStatus switch
             {
                 ERActivityStatus.Draft => "Kladdesager",
                 ERActivityStatus.Closed => "Afsluttede sager",
                 _ => "Igangvaerende sager"
             };
         }
     }
     ```
   - IMPORTANT: After `OnParametersSet` changes `_currentStatus`, the MudDataGrid needs to reload. The ServerData callback (`LoadServerData`) is called by MudDataGrid when it renders. Since `OnParametersSet` triggers a re-render, AND the grid uses ServerData, we need to explicitly tell the grid to reload when the mode changes. Add after the status change detection:
     ```csharp
     if (newStatus != _currentStatus)
     {
         _currentStatus = newStatus;
         _headlineText = ...;
         // Force grid reload on next render
         _dataGrid?.ReloadServerData();
     }
     ```
     BUT be careful: `_dataGrid` may be null on the first call to `OnParametersSet` (before the component renders). Guard with null check. On the initial render, the grid will call `LoadServerData` naturally, so no explicit reload is needed.

     Actually, a simpler approach: always set the status and headline, and always call `_dataGrid?.ReloadServerData()`. The null check on `_dataGrid` handles the initial render case. But this triggers an extra unnecessary reload on the first render. Better approach: track the previous status and only reload when it actually changes:
     ```csharp
     protected override void OnParametersSet()
     {
         var newStatus = Mode?.ToLowerInvariant() switch
         {
             "draft" => ERActivityStatus.Draft,
             "closed" => ERActivityStatus.Closed,
             _ => ERActivityStatus.OnGoing
         };

         _headlineText = newStatus switch
         {
             ERActivityStatus.Draft => "Kladdesager",
             ERActivityStatus.Closed => "Afsluttede sager",
             _ => "Igangvaerende sager"
         };

         if (newStatus != _currentStatus)
         {
             _currentStatus = newStatus;
             _dataGrid?.ReloadServerData();
         }
     }
     ```

   - Update `LoadServerData` to pass the current status filter to the service:
     ```csharp
     var response = await ActivityService.GetActivitiesAsync(request, _currentStatus);
     ```
     (Replace the existing `ActivityService.GetActivitiesAsync(request)` call)

   - After receiving the response, update `_totalCount`:
     ```csharp
     _totalCount = response.TotalCount;
     ```
     Add this line right after the service call and before the return statement.

   - Keep all existing error handling (try-catch with Snackbar) intact.
   - Keep all existing columns, pager, and NoRecordsContent intact.
   - Keep the existing `NavigateToDetail` and `OnRowClick` methods unchanged.
  </action>
  <verify>
    - `dotnet build src/SignaturPortal.Web` compiles without errors
    - ActivityList.razor has both `@page "/activities"` and `@page "/activities/{Mode}"` directives
    - Navigate to /activities: shows only Ongoing activities, headline says "Igangvaerende sager (N)"
    - Navigate to /activities/closed: shows only Closed activities, headline says "Afsluttede sager (N)"
    - Navigate to /activities/draft: shows only Draft activities, headline says "Kladdesager (N)"
    - Navigate from /activities to /activities/closed via tab click: data grid reloads with correct filter
    - Navigate to /activities/123 (detail page): still works (route constraint `:int` disambiguates)
    - Page title updates to match mode name
    - Existing column filters still work on top of the status filter
  </verify>
  <done>
    Activity list page supports 3 modes via route parameter. Each mode filters activities by status server-side, displays the correct Danish headline with activity count, and reloads the grid when switching between modes via navigation.
  </done>
</task>

</tasks>

<verification>
1. Build: `dotnet build src/SignaturPortal.Web` succeeds with no errors
2. Full navigation flow: click "Igangvaerende sager" tab -> /activities loads with Ongoing activities only
3. Click "Afsluttede sager" tab -> /activities/closed loads with Closed activities only
4. Click "Kladdesager" tab -> /activities/draft loads with Draft activities only
5. Activity count in headline matches the number of activities displayed (total, not just current page)
6. Click an activity row -> navigates to /activities/123 detail page (route `:int` constraint still works)
7. Browser back button returns to the correct mode tab with correct data
8. Column filters (e.g., filter by Headline text) work within the current mode
9. Page title in browser tab reflects the current mode name
</verification>

<success_criteria>
- Three activity list modes work: /activities (Ongoing), /activities/closed (Closed), /activities/draft (Draft)
- Each mode shows only activities with the matching status
- Headline displays mode-specific Danish text with activity count: "Igangvaerende sager (42)"
- Switching modes via Row 2 tab clicks reloads the data grid
- Status filter is applied server-side (SQL WHERE clause, not client-side filtering)
- Existing grid features (sorting, pagination, column filters) still work
- No route conflicts with /activities/{ActivityId:int} detail page
- Build compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-route-aware-nav-activity-modes/03.1-02-SUMMARY.md`
</output>
