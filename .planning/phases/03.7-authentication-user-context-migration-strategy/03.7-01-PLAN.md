---
phase: 03.7-authentication-user-context-migration-strategy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "C:\\Dev\\Dev3Org\\AtlantaSignatur\\Web\\MainSite\\Global.asax.cs"
  - src/SignaturPortal.Web/Program.cs
  - src/SignaturPortal.Web/Components/Routes.razor
  - src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor
autonomous: true
must_haves:
  truths:
    - "Unauthenticated users navigating to a Blazor page are redirected to the legacy login page"
    - "[Authorize] attributes on Blazor pages are enforced during both SSR and SPA navigation within the circuit"
    - "UserId session value deserializes correctly as Guid on the Blazor side"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Routes.razor"
      provides: "AuthorizeRouteView with NotAuthorized redirect"
      contains: "AuthorizeRouteView"
    - path: "src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor"
      provides: "Login redirect component for unauthenticated users"
      contains: "NavigateTo"
    - path: "src/SignaturPortal.Web/Program.cs"
      provides: "CascadingAuthenticationState registration"
      contains: "AddCascadingAuthenticationState"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Routes.razor"
      to: "src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor"
      via: "NotAuthorized template references RedirectToLogin component"
      pattern: "<RedirectToLogin"
    - from: "src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor"
      to: "/Login.aspx"
      via: "NavigationManager.NavigateTo with forceLoad:true"
      pattern: "NavigateTo.*Login\\.aspx.*forceLoad.*true"
---

<objective>
Fix authentication and authorization gaps in the Blazor app: correct the UserId session key type mismatch on the legacy side, wire up AuthorizeRouteView with CascadingAuthenticationState so [Authorize] attributes are enforced during SPA navigation, and redirect unauthenticated users to the legacy login page.

Purpose: Without these fixes, [Authorize] attributes are only enforced during SSR but not during SPA navigation within the circuit, and the UserId session key may fail to deserialize.
Output: Working auth enforcement in the Blazor component router with login redirect.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.7-authentication-user-context-migration-strategy/03.7-RESEARCH.md
@src/SignaturPortal.Web/Program.cs
@src/SignaturPortal.Web/Components/Routes.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix legacy UserId type and add CascadingAuthenticationState</name>
  <files>
    C:\Dev\Dev3Org\AtlantaSignatur\Web\MainSite\Global.asax.cs
    src/SignaturPortal.Web/Program.cs
  </files>
  <action>
1. In legacy `C:\Dev\Dev3Org\AtlantaSignatur\Web\MainSite\Global.asax.cs`, find the line `options.RegisterKey<int>("UserId")` and change it to `options.RegisterKey<Guid>("UserId")`. Add `using System;` if not already present (Guid requires it). The actual value stored is `aUser.UserId` which is a `Guid` (verified in GenericObjects.cs), so the registered type must match.

2. In `src/SignaturPortal.Web/Program.cs`, add `builder.Services.AddCascadingAuthenticationState();` immediately after the `AddRazorComponents()` block (after the closing semicolon of `.AddHubOptions(...)` chain, before the MudBlazor section). This makes `Task<AuthenticationState>` available as a cascading parameter throughout the Blazor component tree, which is required for AuthorizeRouteView to function.

Do NOT change any other registrations. Do NOT add any new NuGet packages (Microsoft.AspNetCore.Components.Authorization is already part of the Blazor framework).
  </action>
  <verify>
Build both projects:
- `dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj` succeeds
- Verify `Global.asax.cs` contains `RegisterKey<Guid>("UserId")` (not `int`)
- Verify `Program.cs` contains `AddCascadingAuthenticationState()`
  </verify>
  <done>
Legacy Global.asax.cs registers UserId as Guid matching the actual value type. Program.cs registers CascadingAuthenticationState for the Blazor component tree.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace RouteView with AuthorizeRouteView and create RedirectToLogin</name>
  <files>
    src/SignaturPortal.Web/Components/Routes.razor
    src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor
  </files>
  <action>
1. Create `src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor` with this content:

```razor
@inject NavigationManager Navigation

@code {
    protected override void OnInitialized()
    {
        var returnUrl = Uri.EscapeDataString(Navigation.Uri);
        Navigation.NavigateTo($"/Login.aspx?ReturnUrl={returnUrl}", forceLoad: true);
    }
}
```

This component redirects unauthenticated users to the legacy login page via YARP. `forceLoad: true` ensures a full HTTP round-trip so the legacy Forms Auth login page is served. The ReturnUrl parameter allows the legacy app to redirect back after successful login.

2. Replace the entire contents of `src/SignaturPortal.Web/Components/Routes.razor` with:

```razor
@using Microsoft.AspNetCore.Components.Authorization

<Router AppAssembly="typeof(Program).Assembly" NotFoundPage="typeof(Pages.NotFound)">
    <Found Context="routeData">
        <AuthorizeRouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)">
            <NotAuthorized>
                <RedirectToLogin />
            </NotAuthorized>
        </AuthorizeRouteView>
        <FocusOnNavigate RouteData="routeData" Selector="h1" />
    </Found>
</Router>
```

Key changes from current Routes.razor:
- Added `@using Microsoft.AspNetCore.Components.Authorization`
- Replaced `<RouteView>` (self-closing) with `<AuthorizeRouteView>` (with content)
- Added `<NotAuthorized>` template containing `<RedirectToLogin />`
- This ensures [Authorize] attributes are enforced during SPA navigations, not just SSR
  </action>
  <verify>
- `dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj` succeeds
- File `src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor` exists
- `Routes.razor` contains `AuthorizeRouteView` (not `RouteView`)
- `Routes.razor` contains `<RedirectToLogin />`
  </verify>
  <done>
AuthorizeRouteView enforces [Authorize] attributes during SPA navigation. Unauthenticated users are redirected to legacy /Login.aspx with a ReturnUrl parameter.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj` compiles without errors
2. `Routes.razor` uses `AuthorizeRouteView` instead of `RouteView`
3. `RedirectToLogin.razor` exists and navigates to `/Login.aspx?ReturnUrl=...`
4. `Program.cs` calls `AddCascadingAuthenticationState()`
5. Legacy `Global.asax.cs` registers `UserId` as `Guid`
</verification>

<success_criteria>
- The Blazor app enforces [Authorize] attributes on pages during both SSR and SPA navigation
- Unauthenticated users are redirected to the legacy login page
- UserId session key type matches between legacy and Blazor (both Guid)
- The app builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.7-authentication-user-context-migration-strategy/03.7-01-SUMMARY.md`
</output>
