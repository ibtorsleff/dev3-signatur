---
phase: 03.7-authentication-user-context-migration-strategy
plan: 01
subsystem: auth
tags: [blazor, authorize-route-view, cascading-auth-state, session, system-web-adapters]

# Dependency graph
requires:
  - phase: 01-infrastructure-shell
    provides: System.Web Adapters session sharing, YARP reverse proxy
provides:
  - AuthorizeRouteView enforcement for [Authorize] attributes during SPA navigation
  - RedirectToLogin component for unauthenticated user redirect to legacy login
  - CascadingAuthenticationState registration for Blazor component tree
  - UserId type alignment (Guid) between legacy and Blazor session serialization
affects: [02-multi-tenancy-security, future auth phases]

# Tech tracking
tech-stack:
  added: []
  patterns: [AuthorizeRouteView with NotAuthorized redirect, forceLoad navigation to legacy pages]

key-files:
  created:
    - src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor
  modified:
    - src/SignaturPortal.Web/Program.cs
    - src/SignaturPortal.Web/Components/Routes.razor
    - C:\Dev\Dev3Org\AtlantaSignatur\Web\MainSite\Global.asax.cs

key-decisions:
  - "UserId registered as Guid (not int) matching aUser.UserId actual type in legacy GenericObjects"
  - "forceLoad: true on login redirect ensures full HTTP round-trip through YARP to legacy Forms Auth"
  - "ReturnUrl parameter passed to Login.aspx for post-login redirect back to Blazor"

patterns-established:
  - "RedirectToLogin pattern: component-based login redirect via NavigationManager with forceLoad"
  - "Auth directory: src/SignaturPortal.Web/Components/Auth/ for auth-related Blazor components"

# Metrics
duration: 2min
completed: 2026-02-17
---

# Phase 03.7 Plan 01: Authentication & Authorization Enforcement Summary

**AuthorizeRouteView with CascadingAuthenticationState enforcing [Authorize] during SPA navigation, RedirectToLogin to legacy /Login.aspx, and UserId Guid type fix**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-17T18:28:31Z
- **Completed:** 2026-02-17T18:30:10Z
- **Tasks:** 2
- **Files modified:** 4 (3 in Blazor repo + 1 in legacy repo)

## Accomplishments
- Fixed UserId session key type mismatch from int to Guid in legacy Global.asax.cs
- Added CascadingAuthenticationState to make auth state available throughout Blazor component tree
- Replaced RouteView with AuthorizeRouteView so [Authorize] attributes are enforced during SPA navigation (not just SSR)
- Created RedirectToLogin component that sends unauthenticated users to legacy /Login.aspx with ReturnUrl

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix legacy UserId type and add CascadingAuthenticationState** - `d30140a` (feat)
2. **Task 2: Replace RouteView with AuthorizeRouteView and create RedirectToLogin** - `da99804` (feat)

## Files Created/Modified
- `src/SignaturPortal.Web/Program.cs` - Added AddCascadingAuthenticationState() after AddRazorComponents block
- `src/SignaturPortal.Web/Components/Routes.razor` - Replaced RouteView with AuthorizeRouteView + NotAuthorized template
- `src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor` - New component redirecting to /Login.aspx with ReturnUrl
- `C:\Dev\Dev3Org\AtlantaSignatur\Web\MainSite\Global.asax.cs` - Changed RegisterKey<int>("UserId") to RegisterKey<Guid>("UserId")

## Decisions Made
- UserId registered as Guid matching aUser.UserId actual type (verified in GenericObjects.cs)
- forceLoad: true on NavigateTo ensures full HTTP round-trip through YARP so legacy Forms Auth login page is served
- ReturnUrl parameter included for post-login redirect capability

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Legacy Global.asax.cs is in a separate git repository (C:\Dev\Dev3Org\) so could not be committed in the Blazor repo. The change was applied but must be committed separately in the legacy repo.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Auth enforcement is now active for all [Authorize]-decorated Blazor pages
- Unauthenticated users will be redirected to legacy login
- Ready for further auth/permission work in subsequent plans

---
*Phase: 03.7-authentication-user-context-migration-strategy*
*Completed: 2026-02-17*
