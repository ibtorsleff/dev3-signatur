---
phase: 03.7-authentication-user-context-migration-strategy
verified: 2026-02-17T19:00:00Z
status: human_needed
score: 3/3 must-haves verified
re_verification: true
gaps:
  - truth: "Unauthenticated users navigating to a Blazor page are redirected to the legacy login page"
    status: failed
    reason: "Routes.razor references <RedirectToLogin /> but the component's namespace (SignaturPortal.Web.Components.Auth) is not imported in _Imports.razor or in Routes.razor itself. The Razor compiler emits RZ10012 warning and treats the tag as an unknown HTML element — so at runtime the <NotAuthorized> template renders nothing instead of navigating to /Login.aspx."
    artifacts:
      - path: "src/SignaturPortal.Web/Components/Routes.razor"
        issue: "Missing @using SignaturPortal.Web.Components.Auth — RedirectToLogin component is unresolved (RZ10012)"
      - path: "src/SignaturPortal.Web/Components/_Imports.razor"
        issue: "Imports SignaturPortal.Web.Components and SignaturPortal.Web.Components.Layout but not SignaturPortal.Web.Components.Auth"
    missing:
      - "Add @using SignaturPortal.Web.Components.Auth to src/SignaturPortal.Web/Components/_Imports.razor (preferred, makes it globally available) OR add @using SignaturPortal.Web.Components.Auth to the top of Routes.razor"
human_verification:
  - test: "Confirm unauthenticated login redirect works end-to-end after gap fix"
    expected: "Visiting a Blazor page without an active session should result in a full-page redirect to /Login.aspx?ReturnUrl=..."
    why_human: "Requires running both apps (Blazor + legacy) simultaneously with Forms Auth active; cannot verify via grep"
---

# Phase 03.7: Authentication & Authorization Enforcement — Verification Report

**Phase Goal:** Fix authentication and authorization gaps: correct UserId session key type mismatch, wire up AuthorizeRouteView with CascadingAuthenticationState, and redirect unauthenticated users to legacy login page
**Verified:** 2026-02-17T19:00:00Z
**Status:** gaps_found
**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Unauthenticated users navigating to a Blazor page are redirected to the legacy login page | FAILED | Routes.razor references `<RedirectToLogin />` but the namespace `SignaturPortal.Web.Components.Auth` is not imported. Build emits RZ10012: "Found markup element with unexpected name 'RedirectToLogin'". At runtime the component is treated as an unknown HTML element — no redirect occurs. |
| 2 | [Authorize] attributes on Blazor pages are enforced during both SSR and SPA navigation within the circuit | VERIFIED | Routes.razor uses `<AuthorizeRouteView>` with `<NotAuthorized>` template. `Program.cs` calls `AddCascadingAuthenticationState()`. The infrastructure correctly enforces [Authorize] — the redirect component it invokes is broken, but the enforcement mechanism itself is wired. |
| 3 | UserId session value deserializes correctly as Guid on the Blazor side | VERIFIED | Legacy `Global.asax.cs` now has `options.RegisterKey<Guid>("UserId")` (was `int`). This matches the actual `aUser.UserId` type (Guid) and the Blazor-side consumption via `System.Web.HttpContext.Current.Session["UserId"]` cast to Guid. |

**Score:** 2/3 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/SignaturPortal.Web/Components/Routes.razor` | AuthorizeRouteView with NotAuthorized redirect | PARTIAL | Contains `<AuthorizeRouteView>` and `<NotAuthorized><RedirectToLogin /></NotAuthorized>`. AuthorizeRouteView is correctly wired. RedirectToLogin is present but unresolved by the Razor compiler (RZ10012). |
| `src/SignaturPortal.Web/Components/Auth/RedirectToLogin.razor` | Login redirect component | VERIFIED | File exists, contains `NavigationManager.NavigateTo($"/Login.aspx?ReturnUrl={returnUrl}", forceLoad: true)`. Implementation is correct. |
| `src/SignaturPortal.Web/Program.cs` | CascadingAuthenticationState registration | VERIFIED | Contains `builder.Services.AddCascadingAuthenticationState()` after AddRazorComponents block. |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `Routes.razor` | `Auth/RedirectToLogin.razor` | `<NotAuthorized>` template references `<RedirectToLogin>` component | BROKEN | Pattern `<RedirectToLogin` exists in Routes.razor line 7. However, Razor compiler cannot resolve the component — namespace `SignaturPortal.Web.Components.Auth` is not imported in `_Imports.razor` or in Routes.razor. Build warning RZ10012 confirms this. |
| `Auth/RedirectToLogin.razor` | `/Login.aspx` | `NavigationManager.NavigateTo` with `forceLoad: true` | VERIFIED | Line 7: `Navigation.NavigateTo($"/Login.aspx?ReturnUrl={returnUrl}", forceLoad: true)` — correct pattern present. |

---

### Requirements Coverage

| Requirement | Status | Blocking Issue |
|-------------|--------|----------------|
| Unauthenticated redirect to legacy login | BLOCKED | RedirectToLogin component not resolvable in Routes.razor due to missing namespace import |
| [Authorize] enforcement during SPA navigation | SATISFIED | AuthorizeRouteView + CascadingAuthenticationState correctly wired |
| UserId Guid type alignment | SATISFIED | Legacy Global.asax.cs updated, commit d30140a confirmed |

---

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `Routes.razor` | 7 | Build warning RZ10012 — unresolved component name | Blocker | `<RedirectToLogin />` is treated as unknown HTML at runtime; unauthenticated users see a blank page instead of login redirect |

---

### Human Verification Required

#### 1. End-to-End Unauthenticated Redirect (after gap fix)

**Test:** With both apps running (Blazor on localhost:5219, legacy on localhost:1500), clear all session cookies and navigate directly to a [Authorize]-decorated Blazor page (e.g., `/activities`).
**Expected:** Full page redirect to `/Login.aspx?ReturnUrl=%2Factivities` (or similar encoded URL).
**Why human:** Requires both apps running simultaneously with Forms Auth active and an actual unauthenticated browser session.

---

### Gaps Summary

One gap blocks the phase goal. The `RedirectToLogin` component was created correctly and its internal logic is sound, but it was never made resolvable from `Routes.razor`. The `_Imports.razor` in the Components folder lists `SignaturPortal.Web.Components` and `SignaturPortal.Web.Components.Layout` but not `SignaturPortal.Web.Components.Auth`. Routes.razor only adds `@using Microsoft.AspNetCore.Components.Authorization` — not the Auth sub-namespace.

The Razor compiler's RZ10012 warning on `Routes.razor` line 7 is the build-time evidence. At runtime, the `<NotAuthorized>` template renders an unknown HTML tag and nothing else — the redirect does not execute. Authenticated users are unaffected. The UserId type fix and CascadingAuthenticationState registration are both correct and complete.

**Fix required:** Add `@using SignaturPortal.Web.Components.Auth` to `src/SignaturPortal.Web/Components/_Imports.razor`. This is a one-line change.

---

_Verified: 2026-02-17T19:00:00Z_
_Verifier: Claude (gsd-verifier)_
