---
phase: 04-core-write-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Application/SignaturPortal.Application.csproj
  - src/SignaturPortal.Application/DTOs/CreateActivityDto.cs
  - src/SignaturPortal.Application/DTOs/EditActivityDto.cs
  - src/SignaturPortal.Application/Validators/CreateActivityValidator.cs
  - src/SignaturPortal.Application/Validators/EditActivityValidator.cs
  - src/SignaturPortal.Application/DTOs/ActivityResult.cs
  - src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
autonomous: true

must_haves:
  truths:
    - "CreateActivityDto captures all user-editable fields for new activity creation"
    - "EditActivityDto includes EditedId concurrency token for conflict detection"
    - "FluentValidation validators enforce required fields, max lengths, and business rules"
    - "ActivityResult provides Success/Failure/Conflict/NotFound discriminated result"
  artifacts:
    - path: "src/SignaturPortal.Application/DTOs/CreateActivityDto.cs"
      provides: "Create activity form model"
      contains: "class CreateActivityDto"
    - path: "src/SignaturPortal.Application/DTOs/EditActivityDto.cs"
      provides: "Edit activity form model with concurrency token"
      contains: "EditedId"
    - path: "src/SignaturPortal.Application/Validators/CreateActivityValidator.cs"
      provides: "Create validation rules"
      contains: "AbstractValidator<CreateActivityDto>"
    - path: "src/SignaturPortal.Application/Validators/EditActivityValidator.cs"
      provides: "Edit validation rules"
      contains: "AbstractValidator<EditActivityDto>"
    - path: "src/SignaturPortal.Application/DTOs/ActivityResult.cs"
      provides: "Operation result type for service methods"
      contains: "ActivityResult"
  key_links:
    - from: "src/SignaturPortal.Application/Validators/CreateActivityValidator.cs"
      to: "src/SignaturPortal.Application/DTOs/CreateActivityDto.cs"
      via: "AbstractValidator generic parameter"
      pattern: "AbstractValidator<CreateActivityDto>"
---

<objective>
Create write operation DTOs, FluentValidation validators, and result types for activity CRUD operations.

Purpose: Establish the Application layer contracts (DTOs, validators, result types) that both the service layer (Plan 03) and UI layer (Plan 04) depend on. This plan has no runtime dependencies and can be built first.

Output: CreateActivityDto, EditActivityDto, validators, ActivityResult, updated ERecruitmentPermission enum
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-write-operations/04-RESEARCH.md
@src/SignaturPortal.Application/DTOs/ActivityListDto.cs
@src/SignaturPortal.Application/DTOs/ActivityDetailDto.cs
@src/SignaturPortal.Application/Interfaces/IActivityService.cs
@src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
@src/SignaturPortal.Application/SignaturPortal.Application.csproj
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
@src/SignaturPortal.Infrastructure/Data/Entities/UserActivityLog.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install FluentValidation and create write DTOs with result type</name>
  <files>
    src/SignaturPortal.Application/SignaturPortal.Application.csproj
    src/SignaturPortal.Application/DTOs/CreateActivityDto.cs
    src/SignaturPortal.Application/DTOs/EditActivityDto.cs
    src/SignaturPortal.Application/DTOs/ActivityResult.cs
    src/SignaturPortal.Application/Authorization/ERecruitmentPermission.cs
  </files>
  <action>
    1. Add FluentValidation NuGet package to Application.csproj:
       `dotnet add src/SignaturPortal.Application/SignaturPortal.Application.csproj package FluentValidation`

    2. Create `CreateActivityDto.cs` in DTOs folder. This is the form model for creating a new activity. Include these user-editable fields (derived from Eractivity entity, focusing on fields a user actually fills in on the create form):
       - Headline (string, required) -- max 255
       - Jobtitle (string, required) -- max 255
       - JournalNo (string, required) -- max 50
       - ApplicationDeadline (DateTime, required)
       - HireDate (DateTime?, optional)
       - HireDateFreeText (string?, optional) -- max 100
       - ContinuousPosting (bool, default false)
       - EmailOnNewCandidate (bool, default true)
       - CandidateEvaluationEnabled (bool, default false)
       - InterviewRounds (int, default 1)
       Use a class (not record) so MudBlazor two-way binding works with @bind-Value.

    3. Create `EditActivityDto.cs` in DTOs folder. Same fields as CreateActivityDto plus:
       - EractivityId (int, required) -- the entity PK
       - EditedId (Guid, required) -- concurrency token. The legacy schema uses this Guid column (default newid()) as an application-managed concurrency marker. When loading an activity for edit, capture the current EditedId. On save, check if EditedId still matches the DB value before committing.
       Use a class (not record).

    4. Create `ActivityResult.cs` in DTOs folder. A discriminated result type:
       ```csharp
       public class ActivityResult
       {
           public bool IsSuccess { get; init; }
           public int? ActivityId { get; init; }
           public string? ErrorMessage { get; init; }
           public ActivityResultType Type { get; init; }
           // Factory methods:
           public static ActivityResult Success(int activityId) => ...
           public static ActivityResult Failure(string message) => ...
           public static ActivityResult NotFound() => ...
           public static ActivityResult ConcurrencyConflict(string message) => ...
           public static ActivityResult PermissionDenied() => ...
       }

       public enum ActivityResultType { Success, Failure, NotFound, ConcurrencyConflict, PermissionDenied }
       ```

    5. Update `ERecruitmentPermission.cs` to add activity write permissions. Check the legacy Permission table for these IDs. If unsure, use reasonable IDs in the 2000-range (E-recruitment block). Add:
       - CreateActivity (find correct ID or use 2010)
       - EditActivity (find correct ID or use 2020)
       - DeleteActivity (find correct ID or use 2030)
       Keep existing permissions intact.
  </action>
  <verify>
    `dotnet build src/SignaturPortal.Application/SignaturPortal.Application.csproj` compiles with no errors.
  </verify>
  <done>
    CreateActivityDto and EditActivityDto exist with all user-editable fields. EditActivityDto includes EractivityId and EditedId for concurrency. ActivityResult provides typed result factories. FluentValidation package is referenced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FluentValidation validators for Create and Edit DTOs</name>
  <files>
    src/SignaturPortal.Application/Validators/CreateActivityValidator.cs
    src/SignaturPortal.Application/Validators/EditActivityValidator.cs
  </files>
  <action>
    1. Create `Validators/` folder under Application project.

    2. Create `CreateActivityValidator.cs`:
       ```csharp
       public class CreateActivityValidator : AbstractValidator<CreateActivityDto>
       ```
       Rules:
       - Headline: NotEmpty, MaximumLength(255)
       - Jobtitle: NotEmpty, MaximumLength(255)
       - JournalNo: NotEmpty, MaximumLength(50)
       - ApplicationDeadline: Must be in the future (GreaterThan DateTime.Today) UNLESS ContinuousPosting is true (use When/Unless)
       - HireDateFreeText: MaximumLength(100) when provided
       - InterviewRounds: InclusiveBetween(1, 10)
       Use descriptive WithMessage() for each rule.

    3. Create `EditActivityValidator.cs`:
       ```csharp
       public class EditActivityValidator : AbstractValidator<EditActivityDto>
       ```
       Rules: Same as CreateActivityValidator plus:
       - EractivityId: GreaterThan(0).WithMessage("Activity ID is required")
       - EditedId: NotEqual(Guid.Empty).WithMessage("Concurrency token is required")

       To avoid duplicating rules, use Include(new CreateActivityValidator()) if Create and Edit DTOs share a base class, OR define a shared private method/separate rule set. Since the DTOs are separate classes (not inheriting), the simplest approach is to duplicate the field rules. This is acceptable for ~8 rules.

    4. Do NOT add any async validation rules (MustAsync) in this plan. Async rules like "journal number must be unique" will be handled in the service layer (Plan 03) rather than in the validator, to keep validators synchronous and avoid the Blazor async validation pitfall documented in research.
  </action>
  <verify>
    `dotnet build src/SignaturPortal.Application/SignaturPortal.Application.csproj` compiles with no errors. Manually verify both validator files exist and contain RuleFor statements.
  </verify>
  <done>
    CreateActivityValidator and EditActivityValidator exist with field-level validation rules. All rules are synchronous. Validators are ready for DI registration and Blazilla integration in Plan 04.
  </done>
</task>

</tasks>

<verification>
- `dotnet build src/SignaturPortal.Application/SignaturPortal.Application.csproj` succeeds
- FluentValidation package is in csproj
- CreateActivityDto has all user-editable fields from Eractivity
- EditActivityDto has EractivityId + EditedId concurrency token
- Both validators exist with appropriate rules
- ActivityResult has typed factory methods
- ERecruitmentPermission has create/edit/delete entries
</verification>

<success_criteria>
Application layer has all contracts needed for write operations: DTOs for create/edit, validators, result type, and permission constants. No runtime dependencies -- this is pure compilation.
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-write-operations/04-01-SUMMARY.md`
</output>
