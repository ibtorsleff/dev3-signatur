---
phase: 04-core-write-operations
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/SignaturPortal.Web/SignaturPortal.Web.csproj
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityCreate.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityEdit.razor
  - src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
  - src/SignaturPortal.Web/Components/Shared/ConfirmationDialog.razor
autonomous: false

must_haves:
  truths:
    - "User can navigate to create form, fill fields, and submit to create a new activity"
    - "User can navigate to edit form, modify fields, and save with concurrency conflict handling"
    - "User can delete an activity via confirmation dialog from the activity list"
    - "Validation errors display inline under form fields"
    - "Form state persists across circuit disconnection via PersistentComponentState"
    - "Concurrency conflict shows user-friendly message with option to reload"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityCreate.razor"
      provides: "Create activity page with validated form"
      contains: "EditForm"
    - path: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityEdit.razor"
      provides: "Edit activity page with concurrency handling"
      contains: "EditForm"
    - path: "src/SignaturPortal.Web/Components/Shared/ConfirmationDialog.razor"
      provides: "Reusable MudDialog confirmation component"
      contains: "MudDialog"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityCreate.razor"
      to: "src/SignaturPortal.Application/Interfaces/IActivityService.cs"
      via: "inject IActivityService, call CreateAsync"
      pattern: "ActivityService\\.CreateAsync"
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityEdit.razor"
      to: "src/SignaturPortal.Application/Interfaces/IActivityService.cs"
      via: "inject IActivityService, call UpdateAsync"
      pattern: "ActivityService\\.UpdateAsync"
    - from: "src/SignaturPortal.Web/Components/Pages/Activities/ActivityCreate.razor"
      to: "src/SignaturPortal.Application/Validators/CreateActivityValidator.cs"
      via: "Blazilla FluentValidator component"
      pattern: "FluentValidator"
---

<objective>
Build Blazor UI for activity create, edit, and delete with FluentValidation integration, concurrency conflict UX, and circuit resilience.

Purpose: This is the user-facing layer that completes the CRUD workflow. Users interact with MudBlazor forms validated by Blazilla, see inline errors, handle conflicts gracefully, and don't lose data on circuit drops.

Output: ActivityCreate.razor, ActivityEdit.razor, ConfirmationDialog.razor, updated ActivityList.razor with delete button
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-write-operations/04-RESEARCH.md
@.planning/phases/04-core-write-operations/04-01-SUMMARY.md
@.planning/phases/04-core-write-operations/04-02-SUMMARY.md
@.planning/phases/04-core-write-operations/04-03-SUMMARY.md
@src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
@src/SignaturPortal.Web/SignaturPortal.Web.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Blazilla, create ActivityCreate and ActivityEdit pages with PersistentComponentState</name>
  <files>
    src/SignaturPortal.Web/SignaturPortal.Web.csproj
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityCreate.razor
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityEdit.razor
  </files>
  <action>
    1. Install Blazilla NuGet package:
       `dotnet add src/SignaturPortal.Web/SignaturPortal.Web.csproj package Blazilla`

    2. Register FluentValidation validators in DI (Program.cs or wherever services are registered):
       ```csharp
       builder.Services.AddValidatorsFromAssemblyContaining<CreateActivityValidator>();
       ```
       This requires `using FluentValidation;` and the FluentValidation.DependencyInjectionExtensions package (comes with FluentValidation).

    3. Create `ActivityCreate.razor` at route `/activities/create`:
       ```razor
       @page "/activities/create"
       @inject IActivityService ActivityService
       @inject NavigationManager Navigation
       @inject ISnackbar Snackbar
       @inject PersistentComponentState ApplicationState
       @implements IDisposable

       <PageTitle>Create Activity</PageTitle>

       <MudContainer MaxWidth="MaxWidth.Medium">
           <MudText Typo="Typo.h4" Class="mb-4">Create Recruitment Activity</MudText>

           <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
               <FluentValidator TValidator="CreateActivityValidator" />

               <MudGrid>
                   <MudItem xs="12">
                       <MudTextField @bind-Value="Model.Headline"
                                     Label="Headline" Required="true"
                                     For="@(() => Model.Headline)"
                                     MaxLength="255" />
                   </MudItem>
                   <MudItem xs="12" md="6">
                       <MudTextField @bind-Value="Model.Jobtitle"
                                     Label="Job Title" Required="true"
                                     For="@(() => Model.Jobtitle)"
                                     MaxLength="255" />
                   </MudItem>
                   <MudItem xs="12" md="6">
                       <MudTextField @bind-Value="Model.JournalNo"
                                     Label="Journal No." Required="true"
                                     For="@(() => Model.JournalNo)"
                                     MaxLength="50" />
                   </MudItem>
                   <MudItem xs="12" md="6">
                       <MudDatePicker @bind-Date="ApplicationDeadlineNullable"
                                      Label="Application Deadline"
                                      For="@(() => Model.ApplicationDeadline)" />
                   </MudItem>
                   <MudItem xs="12" md="6">
                       <MudDatePicker @bind-Date="Model.HireDate"
                                      Label="Hire Date" />
                   </MudItem>
                   <MudItem xs="12" md="6">
                       <MudTextField @bind-Value="Model.HireDateFreeText"
                                     Label="Hire Date (Free Text)"
                                     MaxLength="100" />
                   </MudItem>
                   <MudItem xs="12" md="6">
                       <MudNumericField @bind-Value="Model.InterviewRounds"
                                        Label="Interview Rounds" Min="1" Max="10"
                                        For="@(() => Model.InterviewRounds)" />
                   </MudItem>
                   <MudItem xs="12" md="4">
                       <MudCheckBox @bind-Value="Model.ContinuousPosting"
                                    Label="Continuous Posting" />
                   </MudItem>
                   <MudItem xs="12" md="4">
                       <MudCheckBox @bind-Value="Model.EmailOnNewCandidate"
                                    Label="Email on New Candidate" />
                   </MudItem>
                   <MudItem xs="12" md="4">
                       <MudCheckBox @bind-Value="Model.CandidateEvaluationEnabled"
                                    Label="Candidate Evaluation" />
                   </MudItem>
               </MudGrid>

               <MudStack Row="true" Class="mt-4">
                   <MudButton ButtonType="ButtonType.Submit"
                              Variant="Variant.Filled" Color="Color.Primary"
                              Disabled="@_saving">
                       @(_saving ? "Saving..." : "Create Activity")
                   </MudButton>
                   <MudButton Variant="Variant.Text"
                              OnClick="@(() => Navigation.NavigateTo("/activities"))">
                       Cancel
                   </MudButton>
               </MudStack>
           </EditForm>
       </MudContainer>
       ```

       Code-behind (@code block):
       - Model = new CreateActivityDto() with EmailOnNewCandidate = true, InterviewRounds = 1
       - ApplicationDeadlineNullable wrapper property (MudDatePicker binds DateTime? but DTO has DateTime)
       - PersistentComponentState: register persist handler in OnInitialized, restore model if available
       - HandleValidSubmit: call ActivityService.CreateAsync, on success navigate to /activities with success snackbar, on failure show error snackbar
       - _saving bool to prevent double-submit
       - NavigationLock with ConfirmExternalNavigation="true" to warn about unsaved changes
       - Dispose: unsubscribe PersistentComponentState

    4. Create `ActivityEdit.razor` at route `/activities/edit/{ActivityId:int}`:
       - Similar form layout to Create but:
         - OnInitializedAsync: call ActivityService.GetForEditAsync(ActivityId) to load data
         - EditedId captured from loaded DTO (concurrency token)
         - HandleValidSubmit: call ActivityService.UpdateAsync, handle ConcurrencyConflict result by showing MudAlert with "This activity was modified by another user" and a "Reload" button
         - PersistentComponentState for circuit resilience (same pattern as Create)
         - Show loading state while fetching entity

       Handle the concurrency conflict UX:
       ```razor
       @if (_concurrencyConflict)
       {
           <MudAlert Severity="Severity.Warning" Class="mb-4">
               This activity was modified by another user since you started editing.
               <MudButton Variant="Variant.Text" Color="Color.Warning"
                          OnClick="ReloadActivity">Reload Latest Version</MudButton>
           </MudAlert>
       }
       ```
       ReloadActivity: re-fetch via GetForEditAsync, clear _concurrencyConflict flag.

    5. IMPORTANT Blazilla usage: Check Blazilla's actual API. The research shows `<FluentValidator TValidator="..." />` but Blazilla may have a different component name. The Blazilla GitHub README should clarify. If Blazilla uses a different component name (e.g., `<FluentValidationValidator />` or similar), use the correct one. If in doubt, fall back to manual validation pattern:
       ```razor
       @inject IValidator<CreateActivityDto> Validator

       <EditForm Model="@Model" OnSubmit="HandleSubmit">
           <DataAnnotationsValidator /> @* or nothing *@
           <ValidationSummary />
       ```
       And in HandleSubmit:
       ```csharp
       var result = await Validator.ValidateAsync(Model);
       if (!result.IsValid) { /* show errors */ return; }
       ```
       If Blazilla works, prefer it for automatic inline validation display with MudBlazor's `For` parameter.

    6. Date handling: MudDatePicker uses DateTime? but CreateActivityDto.ApplicationDeadline is DateTime. Create a wrapper:
       ```csharp
       private DateTime? ApplicationDeadlineNullable
       {
           get => Model.ApplicationDeadline == default ? null : Model.ApplicationDeadline;
           set => Model.ApplicationDeadline = value ?? default;
       }
       ```
  </action>
  <verify>
    `dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj` compiles.
    Both .razor files exist at correct routes.
    Blazilla or manual validation pattern is used (not both).
  </verify>
  <done>
    ActivityCreate.razor and ActivityEdit.razor exist with MudBlazor forms, FluentValidation (via Blazilla or manual), PersistentComponentState for circuit resilience, and concurrency conflict UX on edit page. Both pages navigate correctly and show validation errors inline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConfirmationDialog and add delete functionality to ActivityList</name>
  <files>
    src/SignaturPortal.Web/Components/Shared/ConfirmationDialog.razor
    src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor
  </files>
  <action>
    1. Create `Components/Shared/ConfirmationDialog.razor`:
       ```razor
       <MudDialog>
           <DialogContent>
               <MudText>@Message</MudText>
           </DialogContent>
           <DialogActions>
               <MudButton OnClick="Cancel">Cancel</MudButton>
               <MudButton Color="@Color" Variant="Variant.Filled" OnClick="Submit">
                   @ButtonText
               </MudButton>
           </DialogActions>
       </MudDialog>

       @code {
           [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
           [Parameter] public string Message { get; set; } = "";
           [Parameter] public string ButtonText { get; set; } = "Confirm";
           [Parameter] public Color Color { get; set; } = Color.Primary;

           void Submit() => MudDialog.Close(DialogResult.Ok(true));
           void Cancel() => MudDialog.Cancel();
       }
       ```
       NOTE: MudBlazor 8.x may use `IMudDialogInstance` instead of `MudDialogInstance`. Check the MudBlazor 8 docs. The research example uses `MudDialogInstance` but that may be v7 API.

    2. Update `ActivityList.razor` to add Create and Delete buttons:

       **Add "Create Activity" button** at the top of the list:
       ```razor
       <MudButton Variant="Variant.Filled" Color="Color.Primary"
                  StartIcon="@Icons.Material.Filled.Add"
                  Href="/activities/create"
                  Class="mb-4">
           Create Activity
       </MudButton>
       ```

       **Add delete button to each row** (if user has delete permission):
       - In OnInitializedAsync, check delete permission:
         ```csharp
         _canDelete = await PermissionService.HasPermissionAsync(
             SessionContext.UserName, (int)ERecruitmentPermission.DeleteActivity);
         ```
       - In the grid/table row template, add action buttons column:
         ```razor
         <MudIconButton Icon="@Icons.Material.Filled.Edit"
                        Href="@($"/activities/edit/{context.EractivityId}")"
                        Size="Size.Small" />
         @if (_canDelete)
         {
             <MudIconButton Icon="@Icons.Material.Filled.Delete"
                            Color="Color.Error" Size="Size.Small"
                            OnClick="@(() => DeleteActivityAsync(context))" />
         }
         ```

       **DeleteActivityAsync implementation:**
       ```csharp
       private async Task DeleteActivityAsync(ActivityListDto activity)
       {
           var parameters = new DialogParameters<ConfirmationDialog>
           {
               { x => x.Message, $"Are you sure you want to delete '{activity.Headline}'? This will mark the activity as deleted." },
               { x => x.ButtonText, "Delete" },
               { x => x.Color, Color.Error }
           };

           var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete Activity", parameters);
           var result = await dialog.Result;

           if (!result.Canceled)
           {
               var deleteResult = await ActivityService.DeleteAsync(activity.EractivityId);
               if (deleteResult.IsSuccess)
               {
                   Snackbar.Add("Activity deleted", Severity.Success);
                   await ReloadData(); // Refresh the grid
               }
               else if (deleteResult.Type == ActivityResultType.PermissionDenied)
               {
                   Snackbar.Add("You don't have permission to delete activities", Severity.Error);
               }
               else
               {
                   Snackbar.Add(deleteResult.ErrorMessage ?? "Delete failed", Severity.Error);
               }
           }
       }
       ```

    3. Inject required services into ActivityList.razor:
       - @inject IDialogService DialogService
       - @inject ISnackbar Snackbar
       - @inject IPermissionService PermissionService
       - @inject IUserSessionContext SessionContext
       (IActivityService should already be injected)

    4. Keep existing ActivityList functionality (grid, sorting, filtering) intact. Only ADD the create button, action column, and delete dialog.
  </action>
  <verify>
    `dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj` compiles.
    ConfirmationDialog.razor exists in Shared folder.
    ActivityList.razor has Create button, Edit link, and Delete button with confirmation dialog.
  </verify>
  <done>
    ConfirmationDialog is a reusable MudDialog component. ActivityList has Create button (navigates to /activities/create), Edit button per row (navigates to /activities/edit/{id}), and Delete button per row (shows confirmation dialog, calls soft-delete, refreshes grid). Delete is permission-gated.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete CRUD workflow for recruitment activities: Create form with validation, Edit form with concurrency handling, Delete with confirmation dialog, audit logging, and circuit resilience.</what-built>
  <how-to-verify>
    1. Navigate to https://localhost:5219/activities (or the configured URL)
    2. Click "Create Activity" button -- verify form loads with all fields
    3. Submit empty form -- verify inline validation errors appear (Headline, Jobtitle, JournalNo required)
    4. Fill valid data and submit -- verify redirect to activity list, new activity appears
    5. Click Edit on the new activity -- verify form loads with saved data
    6. Change Headline and save -- verify update succeeds
    7. Click Delete on an activity -- verify confirmation dialog appears
    8. Confirm delete -- verify activity disappears from list (soft-deleted)
    9. Check UserActivityLog table in database -- verify audit entries for create, update, and delete operations
    10. (Optional) Open two browser tabs, edit same activity in both, save first tab, then save second tab -- verify concurrency conflict message
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All pages compile and render
- Create form validates and saves new activity
- Edit form loads existing data and handles concurrency conflicts
- Delete shows confirmation dialog and soft-deletes
- UserActivityLog entries created for all operations
- PersistentComponentState preserves form data on circuit reconnection
- Validation errors display inline next to fields
</verification>

<success_criteria>
Users can create, edit, and delete recruitment activities through the Blazor UI. Forms validate input with FluentValidation, edits handle concurrency conflicts gracefully, deletes check permissions, and all operations are audit-logged. Form data survives brief circuit disconnections.
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-write-operations/04-04-SUMMARY.md`
</output>
