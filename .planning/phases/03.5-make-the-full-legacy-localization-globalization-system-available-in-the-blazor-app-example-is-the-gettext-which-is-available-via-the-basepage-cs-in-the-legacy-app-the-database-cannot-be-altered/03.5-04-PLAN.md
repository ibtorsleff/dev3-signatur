---
phase: 03.5-localization
plan: 04
type: execute
wave: 2
depends_on: ["03.5-01"]
files_modified:
  - src/SignaturPortal.Web/Components/Pages/Admin/CacheStatus.razor
  - src/SignaturPortal.Web/Components/Pages/Admin/CacheStatus.razor.cs
  - src/SignaturPortal.Infrastructure/Localization/LocalizationCacheWarmupService.cs
autonomous: true

must_haves:
  truths:
    - "Admin user can view cache status page showing entry count"
    - "Admin user can click a button to clear and reload the localization cache"
    - "Cache reload calls LocalizationCacheWarmupService.ReloadAsync() and reports the new entry count"
    - "Non-admin users cannot access the cache status page"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Admin/CacheStatus.razor"
      provides: "Blazor admin page for cache status and management"
      contains: "CacheStatus"
    - path: "src/SignaturPortal.Web/Components/Pages/Admin/CacheStatus.razor.cs"
      provides: "Code-behind with cache reload logic"
      contains: "LocalizationCacheWarmupService"
  key_links:
    - from: "src/SignaturPortal.Web/Components/Pages/Admin/CacheStatus.razor.cs"
      to: "LocalizationCacheWarmupService"
      via: "DI injection for cache reload"
      pattern: "ReloadAsync"
---

<objective>
Create an admin page for localization cache management, equivalent to the legacy /Admin/cachestatus.aspx. The page shows cache entry count and provides a button to clear and reload the localization cache.

Purpose: Allow administrators to manage the localization cache without restarting the application -- essential during full migration when new keys are added to the Localization table.
Output: Blazor admin page at /admin/cache-status with cache status display and reload functionality.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03.5-make-the-full-legacy-localization-globalization-system-available-in-the-blazor-app-example-is-the-gettext-which-is-available-via-the-basepage-cs-in-the-legacy-app-the-database-cannot-be-altered/03.5-RESEARCH.md
@.planning/phases/03.5-make-the-full-legacy-localization-globalization-system-available-in-the-blazor-app-example-is-the-gettext-which-is-available-via-the-basepage-cs-in-the-legacy-app-the-database-cannot-be-altered/03.5-01-SUMMARY.md
@src/SignaturPortal.Infrastructure/Localization/LocalizationCacheWarmupService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance LocalizationCacheWarmupService with ReloadAsync and entry tracking</name>
  <files>
    src/SignaturPortal.Infrastructure/Localization/LocalizationCacheWarmupService.cs
  </files>
  <action>
    1. **Ensure LocalizationCacheWarmupService has a public `ReloadAsync()` method** (Plan 01 Task 2 already adds this). If not already present, add it now. The method should:
       - Re-run the same bulk-load logic as StartAsync
       - Return the count of entries loaded (change return type to `Task<int>`)
       - Log the reload event

    2. **Add an `EntryCount` property** (public int, getter only) that tracks the number of entries loaded in the last warmup/reload. Set it in both StartAsync and ReloadAsync after the bulk load completes.

    3. **Add a `LastLoadedAt` property** (public DateTime?, getter only) that records when the cache was last loaded/reloaded. Set it in both StartAsync and ReloadAsync.

    4. **Register LocalizationCacheWarmupService as a named singleton** so it can be injected directly (not just as IHostedService). In DependencyInjection.cs, add:
       ```csharp
       services.AddSingleton<LocalizationCacheWarmupService>();
       services.AddHostedService(sp => sp.GetRequiredService<LocalizationCacheWarmupService>());
       ```
       This replaces the simple `AddHostedService<LocalizationCacheWarmupService>()` call from Plan 01, allowing the same singleton instance to be injected into the admin page.
  </action>
  <verify>
    Run `dotnet build src/SignaturPortal.Infrastructure` -- must compile.
  </verify>
  <done>
    LocalizationCacheWarmupService exposes ReloadAsync(), EntryCount, and LastLoadedAt. Registered as injectable singleton.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Blazor admin CacheStatus page</name>
  <files>
    src/SignaturPortal.Web/Components/Pages/Admin/CacheStatus.razor
    src/SignaturPortal.Web/Components/Pages/Admin/CacheStatus.razor.cs
  </files>
  <action>
    1. **Create CacheStatus.razor** at `Components/Pages/Admin/CacheStatus.razor`:
       - Route: `@page "/admin/cache-status"`
       - Use MudBlazor components for layout (MudContainer, MudPaper, MudText, MudButton, MudAlert)
       - Display:
         - Page title: "Cache Management" (use L.GetText("CacheManagement") with fallback)
         - Localization cache section:
           - Entry count (from LocalizationCacheWarmupService.EntryCount)
           - Last loaded timestamp (from LocalizationCacheWarmupService.LastLoadedAt)
           - "Reload Cache" button (MudButton Color.Primary) that calls ReloadAsync
         - After reload: show MudAlert with success message and new entry count
       - Show loading spinner during reload operation

    2. **Create CacheStatus.razor.cs** code-behind:
       - Inject `LocalizationCacheWarmupService` (the singleton)
       - Inject `ILocalizationService L` for localized labels
       - Add `_isReloading` bool state
       - `OnReloadCache` async method:
         - Set `_isReloading = true`, StateHasChanged
         - Call `await _warmupService.ReloadAsync()`
         - Set `_isReloading = false`, set success message, StateHasChanged
       - Display EntryCount and LastLoadedAt from the warmup service

    3. **Authorization:** Add `[Authorize]` attribute. For now, any authenticated user can access (admin role check will be added when role infrastructure is complete in a later phase). Add a TODO comment: `// TODO: Restrict to admin role when PermissionService supports page-level auth`.
  </action>
  <verify>
    1. Run `dotnet build src/SignaturPortal.Web` -- must compile.
    2. Navigate to `/admin/cache-status` while logged in -- page renders with entry count and reload button.
    3. Click "Reload Cache" -- button shows loading, then displays success with updated count.
  </verify>
  <done>
    Admin cache status page at /admin/cache-status displays localization cache entry count and last loaded time. Reload button clears and re-warms the cache. Page is accessible to authenticated users.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/SignaturPortal.Web` compiles
2. `/admin/cache-status` page renders with cache statistics
3. Reload button triggers ReloadAsync and updates the display
4. Page requires authentication (redirects to login if not authenticated)
</verification>

<success_criteria>
- Admin page shows localization cache entry count and last loaded timestamp
- Reload button calls LocalizationCacheWarmupService.ReloadAsync() and refreshes display
- LocalizationCacheWarmupService is injectable as a singleton (same instance as IHostedService)
- Page is protected by authentication
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-make-the-full-legacy-localization-globalization-system-available-in-the-blazor-app-example-is-the-gettext-which-is-available-via-the-basepage-cs-in-the-legacy-app-the-database-cannot-be-altered/03.5-04-SUMMARY.md`
</output>
