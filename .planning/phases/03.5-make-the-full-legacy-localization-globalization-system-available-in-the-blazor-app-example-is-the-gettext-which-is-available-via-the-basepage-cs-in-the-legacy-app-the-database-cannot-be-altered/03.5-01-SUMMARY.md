---
phase: 03.5-localization
plan: 01
subsystem: localization
tags: [localization, i18n, memory-cache, ef-core, tunit, blazor-server]

# Dependency graph
requires:
  - phase: 01-infrastructure-shell
    provides: EF Core DbContextFactory, IUserSessionContext, DI infrastructure
provides:
  - ILocalizationService interface with GetText overloads
  - LocalizationService implementation with IMemoryCache + DB fallback
  - LocalizationCacheWarmupService hosted service for startup bulk-load
  - AppLanguage enum matching legacy GenericObjects.Language values
  - Localization EF Core entity mapped to database table
affects: [03.5-02, 03.5-03, 03.5-04, blazor-components]

# Tech tracking
tech-stack:
  added: [Microsoft.Extensions.Caching.Memory]
  patterns: [cache-key-pattern loc_{languageId}_{key}, language-fallback-chain, hosted-service-warmup]

key-files:
  created:
    - src/SignaturPortal.Domain/Enums/AppLanguage.cs
    - src/SignaturPortal.Application/Interfaces/ILocalizationService.cs
    - src/SignaturPortal.Infrastructure/Data/Entities/Localization.cs
    - src/SignaturPortal.Infrastructure/Localization/LocalizationService.cs
    - src/SignaturPortal.Infrastructure/Localization/LocalizationCacheWarmupService.cs
    - tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs
  modified:
    - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
    - src/SignaturPortal.Infrastructure/DependencyInjection.cs

key-decisions:
  - "Cache key pattern loc_{languageId}_{key} shared between service and warmup -- prevents cache mismatch bug"
  - "IMemoryCache (not IDistributedCache) for localization -- translations are read-only reference data"
  - "Localization entity has composite PK (Key, LanguageId, SiteId) -- Id is identity but not PK"
  - "Raw SQL table creation in tests to avoid SQLite incompatibilities with full SignaturDbContext model"

patterns-established:
  - "Language fallback chain: requested -> English (1) -> [key] bracket notation"
  - "UserLanguageId=0 defaults to Danish (3) matching legacy deployment"
  - "IHostedService for cache warmup at startup with public ReloadAsync for refresh"

# Metrics
duration: 8min
completed: 2026-02-17
---

# Phase 3.5 Plan 01: Localization Infrastructure Summary

**ILocalizationService with IMemoryCache-backed GetText, startup cache warmup, language fallback chain, and 10 TUnit tests**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-16T23:39:34Z
- **Completed:** 2026-02-16T23:47:27Z
- **Tasks:** 3
- **Files modified:** 8

## Accomplishments
- Localization entity mapped to database with composite PK (Key, LanguageId, SiteId)
- LocalizationService returns cached translations with language fallback (requested -> English -> [key])
- Cache warmup hosted service bulk-loads all enabled Localization rows at startup
- 10 TUnit tests verify all GetText behaviors: cache hit/miss, fallback, format args, TextExists

## Task Commits

Each task was committed atomically:

1. **Task 1: Localization entity, AppLanguage enum, ILocalizationService interface** - `36b1bf1` (feat)
2. **Task 2: LocalizationService, cache warmup, and DI registration** - `fe665ab` (feat)
3. **Task 3: TUnit tests for LocalizationService** - `7d8cb72` (test)

## Files Created/Modified
- `src/SignaturPortal.Domain/Enums/AppLanguage.cs` - Language enum (Default=0, EN=1, DK=3, DE=4, ES=5)
- `src/SignaturPortal.Application/Interfaces/ILocalizationService.cs` - GetText overloads + TextExists
- `src/SignaturPortal.Infrastructure/Data/Entities/Localization.cs` - EF Core entity with composite PK
- `src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs` - Added Localizations DbSet + OnModelCreating mapping
- `src/SignaturPortal.Infrastructure/Localization/LocalizationService.cs` - IMemoryCache + IDbContextFactory implementation
- `src/SignaturPortal.Infrastructure/Localization/LocalizationCacheWarmupService.cs` - IHostedService bulk-loader
- `src/SignaturPortal.Infrastructure/DependencyInjection.cs` - AddMemoryCache, scoped service, hosted warmup
- `tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs` - 10 TUnit tests

## Decisions Made
- Cache key pattern `loc_{languageId}_{key}` shared between LocalizationService and LocalizationCacheWarmupService to prevent cache mismatch
- IMemoryCache used (not IDistributedCache) since translations are read-only reference data
- Localization entity composite PK (Key, LanguageId, SiteId) matches actual database schema -- Id column is identity but not the PK
- Test infrastructure uses raw SQL table creation on SQLite to avoid incompatibilities with SQL Server-specific types in the full SignaturDbContext model

## Deviations from Plan

None - plan executed exactly as written. Task 1 entity and Task 2 service code were already created in a prior partial execution; this run verified them, committed Task 2 changes, and created the full test suite.

## Issues Encountered
- SQLite incompatibility with SQL Server types (varbinary(max), ntext) prevented using EnsureCreated() with the full SignaturDbContext in tests. Resolved by creating the Localization table via raw SQL and using a stub IDbContextFactory that provides SignaturDbContext instances on the shared SQLite connection.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- ILocalizationService is injectable in any Blazor component via `@inject ILocalizationService L`
- Ready for Plan 02 (Blazor component integration) and Plans 03-04 (GetText usage in views)
- Cache warmup runs at startup; on-demand DB fallback handles any keys missed during warmup

---
*Phase: 03.5-localization*
*Completed: 2026-02-17*
