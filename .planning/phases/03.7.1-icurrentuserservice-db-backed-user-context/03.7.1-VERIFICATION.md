---
phase: 03.7.1-icurrentuserservice-db-backed-user-context
verified: 2026-02-17T23:21:15Z
status: gaps_found
score: 8/9 must-haves verified
re_verification: false
gaps:
  - truth: Full solution builds without errors
    status: failed
    reason: >-
      Test project fails to compile with 2 CS0738 errors.
      IUserSessionContext.UserId was changed from int? to Guid? in phase 03.7
      commit 18c3cac, but two test stub implementations were not updated.
    artifacts:
      - path: tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs
        issue: StubUserSessionContext.UserId returns int? (1) but IUserSessionContext.UserId requires Guid?
      - path: tests/SignaturPortal.Tests/Authorization/PermissionServiceTests.cs
        issue: TestSessionContext.UserId returns int? (0) but IUserSessionContext.UserId requires Guid?
    missing:
      - Change public int? UserId => 1 to public Guid? UserId => Guid.Empty in LocalizationServiceTests.StubUserSessionContext (line 220)
      - Change public int? UserId => 0 to public Guid? UserId => Guid.Empty in PermissionServiceTests.TestSessionContext (line 174)
---

# Phase 03.7.1: ICurrentUserService DB-Backed User Context Verification Report

**Phase Goal:** Create ICurrentUserService that provides DB-backed current user data, fix the ActivityService.GetUserGuidAsync bug that queries the wrong table (aspnet_Users instead of [User]), and eliminate the redundant session-to-DB round-trip for the user Guid.
**Verified:** 2026-02-17T23:21:15Z
**Status:** gaps_found
**Re-verification:** No - initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | ICurrentUserService interface exists in Application layer with GetCurrentUserAsync only - no Guid? UserId shortcut property | VERIFIED | File exists. Single method Task<CurrentUserDto?> GetCurrentUserAsync(CancellationToken ct = default). No UserId property. |
| 2 | CurrentUserService lazy-loads from DB using AuthenticationStateProvider (auth cookie identity name) | VERIFIED | GetAuthenticationStateAsync at line 38, userName from authState.User.Identity?.Name, db.Users queried by UserName at line 46 |
| 3 | CurrentUserService caches the User record per circuit using _loaded bool + _cachedUser field | VERIFIED | private bool _loaded at line 21, if (_loaded) return _cachedUser at lines 33-34, _loaded = true at line 36 |
| 4 | Build compiles without errors - Plan 01 scope (Application + Infrastructure) | VERIFIED | Application: 0 errors 0 warnings. Infrastructure: 0 errors 0 warnings. |
| 5 | CurrentUserService is registered as Scoped in DependencyInjection.cs | VERIFIED | services.AddScoped<ICurrentUserService, CurrentUserService>() at line 48 |
| 6 | ActivityService constructor accepts ICurrentUserService as the 4th parameter | VERIFIED | Constructor at lines 23-33: ICurrentUserService currentUserService is 4th param, _currentUserService field assigned |
| 7 | GetUserGuidAsync private method no longer exists in ActivityService | VERIFIED | Grep for GetUserGuidAsync in ActivityService.cs: 0 matches |
| 8 | Activity permission filtering uses currentUser?.UserId from await _currentUserService.GetCurrentUserAsync(ct) | VERIFIED | Lines 54-55: var currentUser = await GetCurrentUserAsync(ct); var currentUserGuid = currentUser?.UserId - used in filter at line 70 |
| 9 | Full solution builds without errors | FAILED | Test project (SignaturPortal.Tests) fails with 2 CS0738 errors: test stub UserId returns int? but IUserSessionContext.UserId requires Guid? (type changed phase 03.7 commit 18c3cac, stubs not updated in 03.7.1) |

**Score:** 8/9 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| src/SignaturPortal.Application/DTOs/CurrentUserDto.cs | Record DTO bridging Application/Infrastructure boundary | VERIFIED | 14-line record with 8 positional params: UserId (Guid), FullName, UserName, Email, IsInternal, Enabled, SiteId, ClientId |
| src/SignaturPortal.Application/Interfaces/ICurrentUserService.cs | Contract with GetCurrentUserAsync returning CurrentUserDto? | VERIFIED | 18 lines, XML doc, single method signature, no shortcut properties |
| src/SignaturPortal.Infrastructure/Services/CurrentUserService.cs | Scoped lazy-loading implementation | VERIFIED | 65 lines, implements ICurrentUserService, _loaded bool, AuthenticationStateProvider injection, db.Users by UserName |
| src/SignaturPortal.Infrastructure/DependencyInjection.cs | Scoped registration of CurrentUserService | VERIFIED | Line 48: services.AddScoped<ICurrentUserService, CurrentUserService>() |
| src/SignaturPortal.Infrastructure/Services/ActivityService.cs | Refactored - ICurrentUserService injected, GetUserGuidAsync deleted | VERIFIED | _currentUserService field, 4-param constructor, GetCurrentUserAsync at line 54, GetUserGuidAsync absent |
| tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs | StubUserSessionContext.UserId returns Guid? | STUB | Returns int? value 1 - CS0738 compile error (pre-existing from phase 03.7, not fixed in 03.7.1) |
| tests/SignaturPortal.Tests/Authorization/PermissionServiceTests.cs | TestSessionContext.UserId returns Guid? | STUB | Returns int? value 0 - CS0738 compile error (pre-existing from phase 03.7, not fixed in 03.7.1) |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| CurrentUserService.cs | ICurrentUserService.cs | class CurrentUserService : ICurrentUserService | WIRED | Line 16 |
| CurrentUserService.cs | AuthenticationStateProvider | Constructor injection + GetAuthenticationStateAsync() | WIRED | _authStateProvider field, call at line 38 |
| ActivityService.cs | ICurrentUserService.cs | Constructor injection, 4th parameter | WIRED | _currentUserService field, constructor at lines 23-33 |
| ActivityService.cs | GetCurrentUserAsync | Replaces deleted GetUserGuidAsync call | WIRED | Line 54: await _currentUserService.GetCurrentUserAsync(ct) |
| DependencyInjection.cs | ICurrentUserService / CurrentUserService | AddScoped registration | WIRED | Line 48 |

### Requirements Coverage

| Requirement | Status | Notes |
|-------------|--------|-------|
| Create ICurrentUserService with DB-backed current user data | SATISFIED | Interface + DTO + implementation all exist and are substantive |
| Fix GetUserGuidAsync bug (aspnet_Users instead of [User] table) | SATISFIED | GetUserGuidAsync deleted; GetCurrentUserAsync queries db.Users by UserName from auth identity |
| Eliminate redundant session-to-DB round-trip for user Guid | SATISFIED | Session UserId no longer used for Guid lookup; single DB fetch per circuit via ICurrentUserService caching |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| ActivityService.cs | 99 | aspnet_Users in code comment only | Info | None - explains future sortability limitation, not functional code |
| tests/.../LocalizationServiceTests.cs | 220 | public int? UserId => 1 | Blocker | CS0738 compile error, test project does not build |
| tests/.../PermissionServiceTests.cs | 174 | public int? UserId => 0 | Blocker | CS0738 compile error, test project does not build |

### Human Verification Required

None. The gap is a type mismatch, mechanically verifiable and mechanically fixable.

### Gaps Summary

One gap blocks the Plan 02 success criterion: Full solution (SignaturPortal.slnx) builds with zero errors.

The IUserSessionContext.UserId property was changed from int? to Guid? in phase 03.7 (commit 18c3cac). Two test stub classes in SignaturPortal.Tests were not updated at that time, and phase 03.7.1 did not remediate them. The test project is the only project that fails to compile.

The fix is two one-line changes in test files:

File: tests/SignaturPortal.Tests/Localization/LocalizationServiceTests.cs, line 220
  BEFORE: public int? UserId => 1;
  AFTER:  public Guid? UserId => Guid.Empty;

File: tests/SignaturPortal.Tests/Authorization/PermissionServiceTests.cs, line 174
  BEFORE: public int? UserId => 0;
  AFTER:  public Guid? UserId => Guid.Empty;

Everything else in the phase goal is fully achieved:
- ICurrentUserService interface + CurrentUserDto record: Application layer, clean architecture boundary maintained
- CurrentUserService: substantive implementation - AuthenticationStateProvider identity lookup, [User] table query, _loaded bool caching
- GetUserGuidAsync: completely deleted from ActivityService; no aspnet_Users reference in functional code
- ActivityService: ICurrentUserService wired via constructor injection, GetCurrentUserAsync called at permission-filter site
- DI registration: Scoped, correctly placed in DependencyInjection.cs
- Application and Infrastructure projects: compile cleanly, zero errors

---

_Verified: 2026-02-17T23:21:15Z_
_Verifier: Claude (gsd-verifier)_
