---
phase: 03.7.1-icurrentuserservice-db-backed-user-context
plan: 02
type: execute
wave: 2
depends_on:
  - 03.7.1-01
files_modified:
  - src/SignaturPortal.Infrastructure/DependencyInjection.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
autonomous: true
must_haves:
  truths:
    - "CurrentUserService is registered as Scoped in DependencyInjection.cs"
    - "ActivityService constructor accepts ICurrentUserService as the 4th parameter"
    - "GetUserGuidAsync private method no longer exists in ActivityService"
    - "Activity permission filtering uses _currentUserService.UserId (the [User] table Guid from session)"
    - "Full solution builds without errors"
  artifacts:
    - path: "src/SignaturPortal.Infrastructure/DependencyInjection.cs"
      provides: "Scoped registration of CurrentUserService"
      contains: "AddScoped<ICurrentUserService, CurrentUserService>"
    - path: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      provides: "Refactored activity list with correct Guid source for permission filtering"
      contains: "_currentUserService"
  key_links:
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "src/SignaturPortal.Application/Interfaces/ICurrentUserService.cs"
      via: "constructor injection"
      pattern: "ICurrentUserService"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "_currentUserService.UserId"
      via: "replaces GetUserGuidAsync call"
      pattern: "_currentUserService\\.UserId"
---

<objective>
Register ICurrentUserService in DI and refactor ActivityService to use it — eliminating the GetUserGuidAsync private method and fixing the critical Guid table confusion.

Purpose: The ActivityService.GetUserGuidAsync method queries aspnet_Users.UserId (ASP.NET Membership Guid) to filter Eractivity.Responsible and Eractivity.CreatedBy — but those columns store the [User] table's UserId, which is a DIFFERENT Guid. This means non-admin users may see zero activities because the wrong Guid never matches. The fix: use ICurrentUserService.UserId which delegates to IUserSessionContext.UserId (the [User] table Guid stored in session at login). This also eliminates a redundant DB round-trip.

Output: DependencyInjection.cs with new Scoped registration. ActivityService.cs without GetUserGuidAsync, using _currentUserService.UserId for permission filtering.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.7.1-icurrentuserservice-db-backed-user-context/03.7.1-RESEARCH.md
@.planning/phases/03.7.1-icurrentuserservice-db-backed-user-context/03.7.1-01-SUMMARY.md

<!-- Files being modified -->
@src/SignaturPortal.Infrastructure/DependencyInjection.cs
@src/SignaturPortal.Infrastructure/Services/ActivityService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register ICurrentUserService as Scoped in DependencyInjection.cs</name>
  <files>src/SignaturPortal.Infrastructure/DependencyInjection.cs</files>
  <action>
In `src/SignaturPortal.Infrastructure/DependencyInjection.cs`, add one line: Scoped registration for ICurrentUserService / CurrentUserService.

Current registration block in DependencyInjection.cs:
```csharp
services.AddScoped<IPermissionService, PermissionService>();
services.AddScoped<IPermissionHelper, PermissionHelperService>();
services.AddScoped<IAuthorizationHandler, PermissionHandler>();
services.AddScoped<IActivityService, ActivityService>();
```

Insert after the IPermissionHelper line (before IAuthorizationHandler), keeping the user-context services grouped:
```csharp
services.AddScoped<ICurrentUserService, CurrentUserService>();
```

Result after change:
```csharp
services.AddScoped<IPermissionService, PermissionService>();
services.AddScoped<IPermissionHelper, PermissionHelperService>();
services.AddScoped<ICurrentUserService, CurrentUserService>();
services.AddScoped<IAuthorizationHandler, PermissionHandler>();
services.AddScoped<IActivityService, ActivityService>();
```

Check the using directives at the top of DependencyInjection.cs. It already has:
- `using SignaturPortal.Application.Interfaces;` — covers ICurrentUserService
- `using SignaturPortal.Infrastructure.Services;` — covers CurrentUserService

If either using is missing, add it. No other changes to DependencyInjection.cs.
  </action>
  <verify>
    `dotnet build C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3/src/SignaturPortal.Infrastructure/SignaturPortal.Infrastructure.csproj` — zero errors.
    Grep `AddScoped.*ICurrentUserService` in DependencyInjection.cs returns a match.
  </verify>
  <done>
    DependencyInjection.cs contains `services.AddScoped&lt;ICurrentUserService, CurrentUserService&gt;()` and builds without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ActivityService — remove GetUserGuidAsync, inject ICurrentUserService</name>
  <files>src/SignaturPortal.Infrastructure/Services/ActivityService.cs</files>
  <action>
Refactor `src/SignaturPortal.Infrastructure/Services/ActivityService.cs`. Three changes: add field + constructor parameter, replace async call with synchronous property access, delete private method.

**Change 1 — Add field and constructor parameter:**

Add private field:
```csharp
private readonly ICurrentUserService _currentUserService;
```

Add constructor parameter (4th, after IPermissionService):
```csharp
public ActivityService(
    IDbContextFactory<SignaturDbContext> contextFactory,
    IUserSessionContext sessionContext,
    IPermissionService permissionService,
    ICurrentUserService currentUserService)
{
    _contextFactory = contextFactory;
    _sessionContext = sessionContext;
    _permissionService = permissionService;
    _currentUserService = currentUserService;
}
```

**Change 2 — Replace async user Guid lookup with synchronous property in GetActivitiesAsync:**

Remove this line:
```csharp
var currentUserGuid = await GetUserGuidAsync(context, _sessionContext.UserName, ct);
```

Replace with:
```csharp
// UserId comes from session (IUserSessionContext.UserId = [User] table Guid, not aspnet_Users.UserId)
var currentUserGuid = _currentUserService.UserId;
```

The permission-filtering block immediately below remains UNCHANGED:
```csharp
if (!hasAdminAccess && currentUserGuid.HasValue)
{
    query = query.Where(a =>
        a.Responsible == currentUserGuid.Value ||
        a.CreatedBy == currentUserGuid.Value);
}
```

The Debug.WriteLine lines are harmless — leave them in place.

**Change 3 — Delete GetUserGuidAsync private method entirely:**

Remove the complete method at the bottom of ActivityService.cs:
```csharp
/// <summary>
/// Gets the UserId (GUID) for a given username.
/// Returns null if user not found.
/// </summary>
private async Task<Guid?> GetUserGuidAsync(
    SignaturDbContext context,
    string userName,
    CancellationToken ct)
{
    var user = await context.AspnetUsers
        .Where(u => u.UserName == userName)
        .Select(u => u.UserId)
        .FirstOrDefaultAsync(ct);

    return user == default ? null : user;
}
```

After deletion, verify `aspnet_Users` no longer appears anywhere in ActivityService.cs (it was used only in GetUserGuidAsync).

No other methods (GetActivityDetailAsync, GetCandidatesAsync, GetCandidateDetailAsync, GetCandidateFileDataAsync) are changed — they do not use GetUserGuidAsync.

Note: `GetActivitiesAsync` remains `async` because it still awaits `_permissionService.HasPermissionAsync`. No method signature change needed.
  </action>
  <verify>
    `dotnet build C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3/SignaturPortal.sln` — zero errors across full solution.
    Grep `GetUserGuidAsync` in ActivityService.cs — NO matches (method deleted, call removed).
    Grep `_currentUserService\.UserId` in ActivityService.cs — match present.
    Grep `aspnet_Users` in ActivityService.cs — NO matches (was only in deleted method).
  </verify>
  <done>
    ActivityService.cs: GetUserGuidAsync deleted, ICurrentUserService injected in constructor, permission filtering uses _currentUserService.UserId, full solution builds with zero errors.
  </done>
</task>

</tasks>

<verification>
Full solution build check:

```bash
dotnet build C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3/SignaturPortal.sln
```

Expected: zero errors.

Grep assertions (all must pass):
1. `GetUserGuidAsync` — NOT in ActivityService.cs
2. `_currentUserService\.UserId` — IS in ActivityService.cs
3. `AddScoped.*ICurrentUserService` — IS in DependencyInjection.cs
4. `aspnet_Users` — NOT in ActivityService.cs
</verification>

<success_criteria>
- Full solution (SignaturPortal.sln) builds with zero errors
- GetUserGuidAsync does not exist in ActivityService.cs
- ActivityService filters activities using _currentUserService.UserId (the correct [User] table Guid)
- ICurrentUserService registered as Scoped in DependencyInjection.cs
- The bug where non-admin users may see no activities (wrong Guid table) is corrected
</success_criteria>

<output>
After completion, create `.planning/phases/03.7.1-icurrentuserservice-db-backed-user-context/03.7.1-02-SUMMARY.md`
</output>
