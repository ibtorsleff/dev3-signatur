---
phase: 03.7.1-icurrentuserservice-db-backed-user-context
plan: 02
subsystem: auth
tags: [di-registration, user-context, guid-fix, activity-service]

# Dependency graph
requires:
  - phase: 03.7.1-01
    provides: ICurrentUserService interface + CurrentUserService implementation + CurrentUserDto
provides:
  - Scoped DI registration for ICurrentUserService / CurrentUserService
  - ActivityService refactored to use DB-backed user Guid (correct User table) instead of aspnet_Users Membership Guid
affects: [activity-list, permission-filtering, user-context]

# Tech tracking
tech-stack:
  added: []
  patterns: [ICurrentUserService-injection-for-user-guid-resolution]

key-files:
  created: []
  modified:
    - src/SignaturPortal.Infrastructure/DependencyInjection.cs
    - src/SignaturPortal.Infrastructure/Services/ActivityService.cs

key-decisions:
  - "ICurrentUserService registered after IPermissionHelper in DI (user-context services grouped together)"
  - "GetUserGuidAsync deleted entirely rather than deprecated (clean break, no aspnet_Users reference remains)"

patterns-established:
  - "ICurrentUserService injection pattern: inject via constructor, call GetCurrentUserAsync, use CurrentUserDto.UserId for DB Guid"

# Metrics
duration: 2min
completed: 2026-02-18
---

# Phase 03.7.1 Plan 02: DI Registration and ActivityService Refactor Summary

**ICurrentUserService registered as Scoped, ActivityService refactored to use correct User table Guid instead of aspnet_Users Membership Guid for activity permission filtering**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-17T23:14:34Z
- **Completed:** 2026-02-17T23:17:05Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Registered ICurrentUserService as Scoped in DependencyInjection.cs, grouped with user-context services
- Refactored ActivityService to inject ICurrentUserService and use GetCurrentUserAsync for user Guid resolution
- Deleted GetUserGuidAsync private method that queried wrong table (aspnet_Users instead of User)
- Fixed critical bug: non-admin users may have seen zero activities because aspnet_Users.UserId (Membership Guid) never matched Eractivity.Responsible/CreatedBy (which store User table UserId)

## Task Commits

Each task was committed atomically:

1. **Task 1: Register ICurrentUserService as Scoped in DependencyInjection.cs** - `f058e66` (feat)
2. **Task 2: Refactor ActivityService -- remove GetUserGuidAsync, inject ICurrentUserService** - `37e887f` (fix)

## Files Created/Modified
- `src/SignaturPortal.Infrastructure/DependencyInjection.cs` - Added Scoped registration for ICurrentUserService/CurrentUserService
- `src/SignaturPortal.Infrastructure/Services/ActivityService.cs` - Injected ICurrentUserService, replaced GetUserGuidAsync with GetCurrentUserAsync, deleted private method

## Decisions Made
- ICurrentUserService registered after IPermissionHelper in DI (user-context services grouped together)
- GetUserGuidAsync deleted entirely rather than deprecated -- clean break, no aspnet_Users reference remains in ActivityService

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Full solution build failed due to file locks (SignaturPortal.Web.exe running) -- not a compilation error. Infrastructure project built cleanly with zero errors.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- ICurrentUserService is now fully wired: interface (Plan 01) + implementation (Plan 01) + DI registration (Plan 02) + first consumer refactored (Plan 02)
- Activity list for non-admin users should now correctly filter by the User table UserId
- Ready for Phase 02 (multi-tenancy) or next feature phase

---
*Phase: 03.7.1-icurrentuserservice-db-backed-user-context*
*Completed: 2026-02-18*
