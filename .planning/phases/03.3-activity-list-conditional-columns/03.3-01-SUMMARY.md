---
phase: 03.3-activity-list-conditional-columns
plan: 01
subsystem: database, api
tags: [ef-core, linq, left-join, dto, sql-subquery]

# Dependency graph
requires:
  - phase: 03-core-read-views
    provides: "ActivityService, ActivityListDto, Eractivity entity, User entity, SignaturDbContext"
provides:
  - "ClientSection entity (Id, Name) mapped to ClientSection table"
  - "ErTemplateGroup entity (Id, Name) mapped to ERTemplateGroup table"
  - "Eractivity navigation properties to ClientSection and ErTemplateGroup"
  - "ActivityListDto with 5 resolved name fields (RecruitingResponsibleName, CreatedByName, DraftResponsibleName, ClientSectionName, TemplateGroupName)"
  - "ActivityListDto with ContinuousPosting boolean"
  - "Single-query SQL projection resolving all names via subqueries and LEFT JOINs"
affects: [03.3-02-activity-list-conditional-columns-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Correlated SQL subqueries for Guid FK to User.FullName resolution in LINQ projections"
    - "Navigation property LEFT JOIN for lookup table name resolution (ClientSection, ErTemplateGroup)"

key-files:
  created:
    - "src/SignaturPortal.Infrastructure/Data/Entities/ClientSection.cs"
    - "src/SignaturPortal.Infrastructure/Data/Entities/ErTemplateGroup.cs"
  modified:
    - "src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs"
    - "src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs"
    - "src/SignaturPortal.Application/DTOs/ActivityListDto.cs"
    - "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"

key-decisions:
  - "User name resolution via correlated SQL subqueries (not navigation properties) because Responsible/CreatedBy/DraftResponsible are Guid FKs to User table without configured nav properties"
  - "ClientSection and ErTemplateGroup as minimal entities (Id+Name only) since only display names needed"
  - "No global query filters on lookup tables (shared reference data, not tenant-scoped)"
  - "Removed JournalNo and StatusName from ActivityListDto (legacy list does not display these)"

patterns-established:
  - "Lookup entity pattern: minimal Id+Name entity for display name resolution via LEFT JOIN"
  - "SQL subquery pattern: context.Users.Where(u => u.UserId == fkValue).Select(u => u.FullName).FirstOrDefault() for Guid FK resolution"

# Metrics
duration: 3min
completed: 2026-02-16
---

# Phase 03.3 Plan 01: Backend Data Layer Expansion Summary

**ClientSection and ErTemplateGroup entities scaffolded with EF Core, ActivityListDto expanded with 5 resolved name fields and ContinuousPosting via single-query SQL projection**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-16T14:52:58Z
- **Completed:** 2026-02-16T14:55:44Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Scaffolded ClientSection and ErTemplateGroup as minimal EF Core entities with correct table/column mappings
- Added navigation properties on Eractivity to both lookup tables with FK relationships
- Expanded ActivityListDto with RecruitingResponsibleName, CreatedByName, DraftResponsibleName, ClientSectionName, TemplateGroupName, and ContinuousPosting
- Removed JournalNo and StatusName from DTO (not displayed in legacy activity list)
- Updated GetActivitiesAsync query projection to resolve all names via SQL subqueries and LEFT JOINs in a single round-trip

## Task Commits

Each task was committed atomically:

1. **Task 1: Scaffold ClientSection and ErTemplateGroup entities and register in DbContext** - `c42f0ab` (feat)
2. **Task 2: Expand ActivityListDto and service query projection with JOINs** - `09fe842` (feat)

## Files Created/Modified
- `src/SignaturPortal.Infrastructure/Data/Entities/ClientSection.cs` - Lookup entity for client organizational sections (Id, Name)
- `src/SignaturPortal.Infrastructure/Data/Entities/ErTemplateGroup.cs` - Lookup entity for recruitment template groups (Id, Name)
- `src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs` - Added ClientSection and ErTemplateGroup navigation properties
- `src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs` - Registered DbSets, entity configurations, and FK relationships
- `src/SignaturPortal.Application/DTOs/ActivityListDto.cs` - Expanded with 5 name fields + ContinuousPosting, removed JournalNo/StatusName
- `src/SignaturPortal.Infrastructure/Services/ActivityService.cs` - Updated query projection with SQL subqueries and LEFT JOINs

## Decisions Made
- Used correlated SQL subqueries for User name resolution (Responsible, CreatedBy, DraftResponsible are Guid FKs without navigation properties on Eractivity)
- Used navigation property approach for ClientSection and ErTemplateGroup (cleaner LEFT JOIN, entities configured with FK relationships)
- Minimal entities with only Id+Name (lookup tables have more columns but only names are needed for display)
- No global query filters on ClientSection/ErTemplateGroup (shared reference data, not tenant-scoped)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - Infrastructure and Application projects compile cleanly. Web project shows expected compilation errors in ActivityList.razor for removed JournalNo and StatusName fields (fixed in Plan 02).

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Backend data layer complete with all fields needed for mode-aware activity list columns
- Plan 02 can now implement the UI with conditional column visibility using the expanded DTO
- Web project compilation errors (JournalNo, StatusName in ActivityList.razor) are expected and will be resolved in Plan 02

---
*Phase: 03.3-activity-list-conditional-columns*
*Completed: 2026-02-16*
