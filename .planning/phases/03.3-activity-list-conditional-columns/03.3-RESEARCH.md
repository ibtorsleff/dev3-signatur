# Phase 03.3: Activity List Conditional Columns - Research

**Researched:** 2026-02-16
**Domain:** Legacy-to-Blazor column parity for recruitment activity list
**Confidence:** HIGH

## Summary

The legacy recruitment activity list (`Responsive/Recruiting/Controls/ActivityList.ascx`) uses a significantly different column set from what the current Blazor `ActivityList.razor` displays. The legacy list has 14 possible columns (header `<th>` elements) with complex conditional visibility controlled by mode (Draft/Ongoing/Closed), user role (client vs. internal), client configuration, and permissions. The current Blazor grid shows 7 columns, two of which ("Journal No" and "Candidates") do not exist in the legacy list at all.

The legacy activity list is the "Responsive Recruiting" version found at `Responsive/Recruiting/Controls/ActivityList.ascx` and its code-behind. This is the authoritative source -- NOT the older non-responsive `Activity/Controls/ActivityListControl.ascx` (which is a proofing/advertising list, not a recruitment list).

**Primary recommendation:** Remove JournalNo and CandidateCount columns from the Blazor grid entirely. Add the missing columns (Visitors, Client, DraftArea, ClientSection, RecruitingResponsible, CreateDate, CreatedBy, DraftResponsible, TemplateGroup, Actions) with conditional visibility matching the mode-based logic from lines 1299-1307 of the legacy `ActivityList.aspx.cs`. The DTO must be expanded with new fields for ClientSection name, Responsible name, CreatedBy name, TemplateGroup name, and ContinuousPosting flag.

## Legacy Column Analysis (CRITICAL)

### All Columns in Legacy `ActivityList.ascx` (Desktop View)

The legacy ASCX defines these header columns in order:

| # | Column ID | Header Text Key | Legacy Data Source | Always Visible? |
|---|-----------|----------------|-------------------|-----------------|
| 1 | `dskSelectTh` | (checkbox) | N/A | **Conditional** - `ShowSelectColumn` (default `false` in ActivityList.aspx) |
| 2 | `dskIdTh` | "Id" | `data.Id` (ERActivity PK) | **Always** |
| 3 | `dskHeadlineTh` | "Headline" | `data.Headline` (with candidate count appended in text) | **Always** |
| 4 | `dskVisitorsTh` | "MSFNumberOfClicks" | `data.WebAdVisitors` | **Conditional** - `_tmpWebAdVisitorStatisticsEnabled` (client config) |
| 5 | `dskApplicationDeadlineTh` | "ApplicationDeadline" | `data.ApplicationDeadline` / "Continuous Posting" | **Always** |
| 6 | `dskStatusTh` | "Status" | `ERStatusGet(data.ERActivityStatusId).TextId` | **Conditional** - `ShowActivityStatusColumn` (set `false` in ActivityList.aspx markup!) |
| 7 | `dskClientTh` | "Client" | `data.ClientName` | **Conditional** - visible when `!isClientLoggedOn && !MustHaveClientId && no specific clientId` |
| 8 | `dskDraftAreaTh` | Dynamic (from settings) | `data.ClientSectionTopLevelName` or `data.ErTemplateGroupName` | **Conditional** - Draft mode only + client config |
| 9 | `dskClientSectionTh` | "ClientSection" | `data.ClientSectionName` | **Always** (CSS hides below 1300px) |
| 10 | `dskRecruitingResponsibleTh` | "RecruitingResponsable" or "RecruitingResponsableFund" | `data.RecruitmentResponsibleFullName` | **Always** |
| 11 | `dskCreateDateTh` | "CreateDate" | `data.CreateDate` | **Always** (CSS hides below 1550px) |
| 12 | `dskCreatedByTh` | "CreatedBy" | `data.CreatedByFullName` | **Conditional** - Ongoing and Closed only |
| 13 | `dskDraftResponsibleTh` | Dynamic (from settings) | `data.DraftResponsibleFullName` | **Conditional** - Draft mode only |
| 14 | `dskTemplateGroupTh` | "TemplateGroup" | `data.ErTemplateGroupName` | **Conditional** - Ongoing and Closed only (+ client config check) |
| 15 | `dskActionsTh` | (copy icon) | N/A (action buttons) | **Conditional** - Ongoing only + permission |

### Mode-Based Column Visibility Rules (from `ActivityList.aspx.cs` lines 1299-1307)

```
ShowActivityActionColumn   = (mode == OnGoing)
ShowDraftAreaColumn        = (mode == Draft && draftAreaType matches specific config)
ShowCreatedByColumn        = (mode == OnGoing || mode == Closed)
ShowTemplateGroupColumn    = (mode == OnGoing || mode == Closed)
ShowDraftResponsibleColumn = (mode == Draft)
ShowActivityCopyColumn     = (mode != Draft)
ShowSelectColumn           = false (default, not set in ActivityList.aspx)
ShowActivityStatusColumn   = false (set in ASPX markup)
```

### Columns Per Mode Summary

**Ongoing mode columns (in order):**
1. Id
2. Headline (with candidate count in text, e.g., "My Activity (5)")
3. Visitors (if client has WebAdVisitorStatistics enabled)
4. Application Deadline
5. Client (only if no specific client context -- typically not shown since MustHaveClientId=true)
6. Client Section
7. Recruiting Responsible
8. Create Date
9. Created By
10. Template Group (if client uses template groups)
11. Actions (copy button, if user has create permission)

**Draft mode columns (in order):**
1. Id
2. Headline (plain text, no candidate count)
3. Application Deadline
4. Draft Area (if client config enables it)
5. Client Section
6. Recruiting Responsible
7. Create Date
8. Draft Responsible

**Closed mode columns (in order):**
1. Id
2. Headline (with candidate count)
3. Visitors (if client has WebAdVisitorStatistics enabled)
4. Application Deadline
5. Client (only if no specific client context)
6. Client Section
7. Recruiting Responsible
8. Create Date
9. Created By
10. Template Group (if client uses template groups)

### Current Blazor Columns (WRONG)

| # | Column | Legacy Equivalent | Issue |
|---|--------|-------------------|-------|
| 1 | Activity (Headline) | Headline | **Name differs** but same data. Missing candidate count in text |
| 2 | Journal No | **DOES NOT EXIST** in legacy list | **REMOVE** |
| 3 | Deadline | ApplicationDeadline | OK but missing ContinuousPosting handling |
| 4 | Status | Status | Should be hidden (legacy sets `ShowActivityStatusColumn=false`) |
| 5 | Candidates | **DOES NOT EXIST** in legacy list | **REMOVE** |
| 6 | Created | CreateDate | OK |
| 7 | (View icon) | N/A | Not in legacy -- legacy uses row click navigation |

### Gap Analysis: What Must Change

**Columns to REMOVE from Blazor:**
- `JournalNo` -- does not exist in legacy activity list
- `CandidateCount` -- does not exist as a separate column (count is embedded in Headline text)
- `StatusName` -- hidden in the standard activity list page (`ShowActivityStatusColumn=false` in markup)
- View icon button -- legacy uses row click for navigation (Blazor already has `OnRowClick`)

**Columns to ADD to Blazor (always visible):**
- `Id` (EractivityId) -- first column in legacy
- `ClientSection` -- always visible, CSS responsive hide below 1300px
- `RecruitingResponsible` -- always visible

**Columns to ADD conditionally:**
- `CreatedBy` -- visible in Ongoing and Closed modes
- `TemplateGroup` -- visible in Ongoing and Closed modes (+ client config check)
- `DraftResponsible` -- visible in Draft mode only
- `DraftArea` -- visible in Draft mode only (+ client config)
- `Visitors` -- visible when client has WebAdVisitorStatistics enabled
- `Client` -- visible when no specific client context (unlikely in portal, since MustHaveClientId=true)
- `Actions` (copy) -- visible in Ongoing mode only (+ permission)

**Columns to MODIFY:**
- `Headline` -- should include candidate count in parentheses for Ongoing/Closed modes (e.g., "Title (5)")
- `ApplicationDeadline` -- should handle `ContinuousPosting` flag (show "-" with tooltip "Continuous Posting")

## Architecture Patterns

### Recommended Approach: Mode-Aware Column Visibility

The Blazor `MudDataGrid` supports conditional column visibility via the `Hidden` property on `PropertyColumn`/`TemplateColumn`. The recommended approach:

1. **Compute column visibility in code-behind** based on `_currentStatus` (already available)
2. **Bind `Hidden` property** to computed booleans
3. **DTO expansion** to include new fields
4. **Service layer** -- expand the SQL query projection to include joined data (user names, client section, template group)

### Recommended Project Structure Changes

```
src/SignaturPortal.Application/DTOs/
    ActivityListDto.cs           # Expand with new fields

src/SignaturPortal.Infrastructure/Services/
    ActivityService.cs           # Expand GetActivitiesAsync projection

src/SignaturPortal.Web/Components/Pages/Activities/
    ActivityList.razor           # Mode-aware columns
    ActivityList.razor.cs        # Column visibility logic
```

### Pattern: Column Visibility via Hidden Property

```razor
<PropertyColumn Property="x => x.CreatedByName"
                Title="Created By"
                Hidden="@_hideCreatedByColumn" />
```

```csharp
// In code-behind
private bool _hideCreatedByColumn => _currentStatus == ERActivityStatus.Draft;
private bool _hideDraftResponsibleColumn => _currentStatus != ERActivityStatus.Draft;
private bool _hideTemplateGroupColumn => _currentStatus == ERActivityStatus.Draft;
```

### Pattern: Headline with Candidate Count (Legacy Behavior)

The legacy does NOT have a separate "Candidates" column. Instead, the candidate count is appended to the Headline text inside parentheses:

```
// Legacy: "My Activity (3/5)" for ongoing where user is a member
// Legacy: "My Activity (5)" for ongoing/closed general view
// Legacy: "My Activity" for draft mode (no candidate count)
```

For the Blazor version, the simplest approach is to have the DTO include the count and format in the CellTemplate:

```razor
<PropertyColumn Property="x => x.Headline" Title="@GetText("Headline")">
    <CellTemplate>
        @if (_currentStatus != ERActivityStatus.Draft && context.Item.CandidateCount > 0)
        {
            <MudText>@($"{context.Item.Headline} ({context.Item.CandidateCount})")</MudText>
        }
        else
        {
            <MudText>@context.Item.Headline</MudText>
        }
    </CellTemplate>
</PropertyColumn>
```

### Anti-Patterns to Avoid

- **Separate Candidates column:** The legacy never shows candidates as a standalone column. Don't diverge from this.
- **Always-visible Status column:** The legacy explicitly sets `ShowActivityStatusColumn=false` in the ASPX markup for the standard activity list page. Don't show it.
- **JournalNo column:** This field exists on the DB entity but was never shown in the legacy list view. Don't show it.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Column visibility toggling | Custom show/hide JS | MudDataGrid `Hidden` property | Built-in, works with virtualization |
| Responsive column hiding | Media queries | MudBlazor `HideSmall` / CSS class approach | Consistent with MudBlazor |
| User name resolution | Inline per-row lookups | SQL JOIN in projection | N+1 query prevention |

## Common Pitfalls

### Pitfall 1: N+1 Queries for User Names

**What goes wrong:** Adding RecruitingResponsible, CreatedBy, DraftResponsible columns requires resolving Guid UserIds to display names. Doing this per-row is an N+1 disaster.
**Why it happens:** The DTO currently stores `Guid? Responsible` and `Guid? CreatedBy` without names.
**How to avoid:** JOIN to the User table in the EF Core query projection. Add `ResponsibleName` and `CreatedByName` as `string` properties on the DTO, populated via navigation property or subquery in the LINQ projection.
**Warning signs:** Multiple SQL queries per grid page load.

### Pitfall 2: ContinuousPosting Not Handled

**What goes wrong:** Activities with `ContinuousPosting = true` show a nonsensical max-date deadline instead of "-".
**Why it happens:** The current Blazor code checks `Year >= 9999` but legacy uses `ContinuousPosting` boolean flag.
**How to avoid:** Add `ContinuousPosting` to the DTO and check it in the CellTemplate. Show "-" with a tooltip "Continuous Posting" when true.

### Pitfall 3: ShowActivityStatusColumn = false

**What goes wrong:** The Blazor grid shows a Status column that the legacy deliberately hides.
**Why it happens:** The legacy ASPX page explicitly sets `ShowActivityStatusColumn="false"` in markup (line 129 of ActivityList.aspx). The Blazor developer didn't know this.
**How to avoid:** Remove the Status column. The mode (Draft/Ongoing/Closed) is already indicated by the page headline and tab navigation.

### Pitfall 4: TemplateGroup Conditional on Client Config

**What goes wrong:** TemplateGroup column visibility depends not just on mode but also on `ClientRecruitmentUseTemplateGroups(siteId, clientId)`.
**Why it happens:** The legacy `ShowTemplateGroupColumn` getter includes this check (line 392 of ActivityList.ascx.cs).
**How to avoid:** For Phase 03.3, default TemplateGroup to visible for Ongoing/Closed modes. Note that full client-config-aware visibility is a future refinement.

### Pitfall 5: DraftArea is Not a Simple Column

**What goes wrong:** DraftArea column header text and data depend on `RecruitmentDraftSettings.UserResponsabilityAreaTypeEn` which determines whether to show ClientSection or TemplateGroup data.
**Why it happens:** Legacy has complex per-client draft configuration.
**How to avoid:** For Phase 03.3, implement DraftArea column for Draft mode with a simplified approach (show the value from `ClientSectionTopLevelName` or `ErTemplateGroupName` depending on config). Mark full draft-settings integration as a refinement task.

## Data Requirements

### Fields Already on Entity (Eractivity.cs) But Not in DTO

| Field | Entity Property | Needed For |
|-------|----------------|------------|
| ContinuousPosting | `Eractivity.ContinuousPosting` | Deadline display |
| DraftResponsible | `Eractivity.DraftResponsible` (Guid?) | Draft mode column |
| ClientSectionId | `Eractivity.ClientSectionId` (int?) | Client section lookup |
| ErtemplateGroupId | `Eractivity.ErtemplateGroupId` (int?) | Template group lookup |

### Fields Requiring JOINs

| Display Field | Source | Join Path |
|---------------|--------|-----------|
| RecruitingResponsibleName | User.FullName | Eractivity.Responsible -> User.UserId |
| CreatedByName | User.FullName | Eractivity.CreatedBy -> User.UserId |
| DraftResponsibleName | User.FullName | Eractivity.DraftResponsible -> User.UserId |
| ClientSectionName | ClientSection.Name | Eractivity.ClientSectionId -> ClientSection table |
| TemplateGroupName | ErTemplateGroup.Name | Eractivity.ErtemplateGroupId -> ErTemplateGroup table |
| ClientName | Client.ClientName (from ObjectData) | Eractivity.ClientId -> Client table |

### Missing DB Entities (Not Yet Scaffolded)

The following tables exist in the legacy DB but are not yet scaffolded in the Blazor project:

- `ClientSection` -- needed for ClientSection name
- `ErTemplateGroup` (or `ERTemplateGroup`) -- needed for TemplateGroup name

These will need to be added as EF Core entities or accessed via raw SQL subqueries.

### Expanded ActivityListDto (Proposed)

```csharp
public record ActivityListDto
{
    public int EractivityId { get; init; }
    public string Headline { get; init; } = "";
    public string Jobtitle { get; init; } = "";
    public DateTime ApplicationDeadline { get; init; }
    public bool ContinuousPosting { get; init; }
    public int EractivityStatusId { get; init; }
    public DateTime CreateDate { get; init; }
    public int CandidateCount { get; init; }

    // Resolved names (from JOINs)
    public string RecruitingResponsibleName { get; init; } = "";
    public string CreatedByName { get; init; } = "";
    public string DraftResponsibleName { get; init; } = "";
    public string ClientSectionName { get; init; } = "";
    public string TemplateGroupName { get; init; } = "";
    public string ClientName { get; init; } = "";

    // Raw IDs (kept for potential future use)
    public Guid? Responsible { get; init; }
    public Guid? CreatedBy { get; init; }
}
```

**Removed fields:** `JournalNo`, `StatusName` (not displayed in legacy list)

## Column Visibility Matrix (Implementation Reference)

| Column | Ongoing | Closed | Draft | Additional Condition |
|--------|---------|--------|-------|---------------------|
| Id | YES | YES | YES | -- |
| Headline (+count) | YES (+count) | YES (+count) | YES (no count) | -- |
| Visitors | CONDITIONAL | CONDITIONAL | NO | Client WebAdVisitorStatistics |
| Application Deadline | YES | YES | YES | Show "-" if ContinuousPosting |
| Status | **NO** | **NO** | **NO** | Explicitly disabled in legacy |
| Client | CONDITIONAL | CONDITIONAL | CONDITIONAL | Only when no specific client |
| Draft Area | NO | NO | CONDITIONAL | Draft mode + client config |
| Client Section | YES | YES | YES | CSS responsive |
| Recruiting Responsible | YES | YES | YES | -- |
| Create Date | YES | YES | YES | CSS responsive |
| Created By | YES | YES | NO | -- |
| Draft Responsible | NO | NO | YES | -- |
| Template Group | YES | YES | NO | + client config check |
| Actions (copy) | YES | NO | NO | + create permission |

## State of the Art

| Old Approach (Current Blazor) | Correct Approach (Legacy Parity) | Impact |
|-------------------------------|----------------------------------|--------|
| Fixed 7 columns for all modes | Mode-dependent column set | Major UI change |
| JournalNo column | Not shown in list | Remove |
| Separate Candidates column | Count embedded in Headline text | Remove column, modify Headline |
| Status column visible | Status column hidden | Remove |
| No Id column | Id is first column | Add |
| Year >= 9999 check for deadline | ContinuousPosting boolean | More correct |
| Static column headers | Some headers from client config | Minor |

## Open Questions

1. **ClientSection and ErTemplateGroup DB entities**
   - What we know: These tables exist in the legacy DB. The Blazor project has not scaffolded them.
   - What's unclear: Exact table/column names for EF Core scaffolding.
   - Recommendation: Add minimal entities (Id, Name) or use raw SQL subqueries in the projection. Can be validated at implementation time by checking the DB schema.

2. **WebAdVisitorStatistics client config**
   - What we know: In legacy, `ClientHlp.ClientWebAdVisitorStatisticsEnabled(siteId, clientId)` controls the Visitors column.
   - What's unclear: How to access this client configuration in the Blazor app (it's stored in the Client's ObjectData XML).
   - Recommendation: For Phase 03.3, skip the Visitors column entirely. It's a client-specific optional feature. Add it as a future enhancement.

3. **Headline candidate count format**
   - What we know: Legacy shows different formats: "Title (unread/total)" for member users, "Title (total)" for others, "Title" for draft.
   - What's unclear: Whether to replicate the member-specific format or use a simpler "(total)" format.
   - Recommendation: Use simple "(total)" format for Ongoing/Closed, no count for Draft. The member-specific counts require additional DB queries and session state.

4. **Actions column (Copy Activity)**
   - What we know: Legacy shows a copy icon on Ongoing activities if user has `RecruitmentPortalCreateActivity` permission.
   - What's unclear: Whether copy activity functionality is in scope for Phase 03.3.
   - Recommendation: Skip the Actions column for Phase 03.3. Focus on data columns only. Copy functionality is a separate feature.

## Sources

### Primary (HIGH confidence)
- `C:/Dev/Dev3Org/AtlantaSignatur/Web/MainSite/Responsive/Recruiting/Controls/ActivityList.ascx` -- Legacy ASCX markup with all 15 header columns
- `C:/Dev/Dev3Org/AtlantaSignatur/Web/MainSite/Responsive/Recruiting/Controls/ActivityList.ascx.cs` -- Column visibility logic, data binding, sort fields (1964 lines)
- `C:/Dev/Dev3Org/AtlantaSignatur/Web/MainSite/Responsive/Recruiting/ActivityList.aspx` -- Page markup: `ShowActivityStatusColumn="false"`, `MustHaveClientId="true"`
- `C:/Dev/Dev3Org/AtlantaSignatur/Web/MainSite/Responsive/Recruiting/ActivityList.aspx.cs` -- Mode-specific column configuration (lines 1299-1307)
- `C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3/src/SignaturPortal.Web/Components/Pages/Activities/ActivityList.razor` -- Current Blazor grid (7 columns)
- `C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3/src/SignaturPortal.Application/DTOs/ActivityListDto.cs` -- Current DTO
- `C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3/src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs` -- DB entity with all available columns
- `C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3/src/SignaturPortal.Infrastructure/Services/ActivityService.cs` -- Current service with SQL projection

### Secondary (MEDIUM confidence)
- `C:/Dev/Dev3Org/AtlantaSignatur/Library/GenericObjects/GenericObjects.cs` (line 7588+) -- `ERForList` class with all data fields used in legacy list

## Metadata

**Confidence breakdown:**
- Column inventory: HIGH -- directly read from legacy ASCX markup and code-behind
- Mode visibility rules: HIGH -- directly read from `ActivityList.aspx.cs` lines 1299-1307
- Data requirements: HIGH -- cross-referenced entity, DTO, and legacy data sources
- Client config dependencies: MEDIUM -- understood the pattern but not all config values are accessible in Blazor yet
- Candidate count format: MEDIUM -- multiple formats exist in legacy, simplified recommendation provided

**Research date:** 2026-02-16
**Valid until:** Stable -- legacy code is frozen, Blazor code changes are under our control
