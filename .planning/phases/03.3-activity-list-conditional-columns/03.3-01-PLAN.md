---
phase: 03.3-activity-list-conditional-columns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Infrastructure/Data/Entities/ClientSection.cs
  - src/SignaturPortal.Infrastructure/Data/Entities/ErTemplateGroup.cs
  - src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
  - src/SignaturPortal.Application/DTOs/ActivityListDto.cs
  - src/SignaturPortal.Infrastructure/Services/ActivityService.cs
autonomous: true

must_haves:
  truths:
    - "GetActivitiesAsync returns DTO with RecruitingResponsibleName, CreatedByName, DraftResponsibleName populated from User table JOINs"
    - "GetActivitiesAsync returns DTO with ClientSectionName populated from ClientSection table JOIN"
    - "GetActivitiesAsync returns DTO with TemplateGroupName populated from ErTemplateGroup table JOIN"
    - "GetActivitiesAsync returns DTO with ContinuousPosting boolean from the entity"
    - "JournalNo and StatusName fields are removed from ActivityListDto"
    - "CandidateCount is still available on DTO for Headline formatting in the UI"
  artifacts:
    - path: "src/SignaturPortal.Infrastructure/Data/Entities/ClientSection.cs"
      provides: "ClientSection entity for name lookup"
      contains: "class ClientSection"
    - path: "src/SignaturPortal.Infrastructure/Data/Entities/ErTemplateGroup.cs"
      provides: "ErTemplateGroup entity for name lookup"
      contains: "class ErTemplateGroup"
    - path: "src/SignaturPortal.Application/DTOs/ActivityListDto.cs"
      provides: "Expanded DTO with resolved names and ContinuousPosting"
      exports: ["ActivityListDto"]
    - path: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      provides: "Expanded SQL projection with LEFT JOINs to User, ClientSection, ErTemplateGroup"
  key_links:
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "src/SignaturPortal.Infrastructure/Data/Entities/ClientSection.cs"
      via: "LEFT JOIN in LINQ projection"
      pattern: "ClientSection"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "src/SignaturPortal.Infrastructure/Data/Entities/ErTemplateGroup.cs"
      via: "LEFT JOIN in LINQ projection"
      pattern: "ErTemplateGroup"
    - from: "src/SignaturPortal.Infrastructure/Services/ActivityService.cs"
      to: "User entity"
      via: "LEFT JOIN subqueries for Responsible, CreatedBy, DraftResponsible"
      pattern: "Users.*FullName"
---

<objective>
Expand the backend data layer to provide all fields needed for mode-aware activity list columns.

Purpose: The UI plan (03.3-02) needs resolved display names (RecruitingResponsible, CreatedBy, DraftResponsible, ClientSection, TemplateGroup) and ContinuousPosting. These must come from SQL JOINs in a single query to avoid N+1 issues. Two new entities (ClientSection, ErTemplateGroup) must be scaffolded since they are not yet in the EF Core model.

Output: Expanded ActivityListDto with resolved names, new EF Core entities, updated service query projection.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-activity-list-conditional-columns/03.3-RESEARCH.md
@src/SignaturPortal.Application/DTOs/ActivityListDto.cs
@src/SignaturPortal.Infrastructure/Services/ActivityService.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
@src/SignaturPortal.Infrastructure/Data/SignaturDbContext.Custom.cs
@src/SignaturPortal.Infrastructure/Data/Entities/Eractivity.cs
@src/SignaturPortal.Infrastructure/Data/Entities/User.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold ClientSection and ErTemplateGroup entities and register in DbContext</name>
  <files>
    src/SignaturPortal.Infrastructure/Data/Entities/ClientSection.cs
    src/SignaturPortal.Infrastructure/Data/Entities/ErTemplateGroup.cs
    src/SignaturPortal.Infrastructure/Data/SignaturDbContext.cs
  </files>
  <action>
Create two minimal EF Core entities for lookup tables:

**ClientSection.cs:**
```csharp
public partial class ClientSection
{
    public int ClientSectionId { get; set; }
    public string Name { get; set; } = "";
    // Only fields needed for display. Table has more columns but we only need Id+Name.
}
```

**ErTemplateGroup.cs:**
```csharp
public partial class ErTemplateGroup
{
    public int ErtemplateGroupId { get; set; }
    public string Name { get; set; } = "";
}
```

Register in `SignaturDbContext.cs`:
- Add `public virtual DbSet<ClientSection> ClientSections { get; set; }`
- Add `public virtual DbSet<ErTemplateGroup> ErTemplateGroups { get; set; }`

Configure in `OnModelCreating` in `SignaturDbContext.cs` (add before the `OnModelCreatingPartial` call):
- `ClientSection`: `entity.ToTable("ClientSection")`, `entity.HasKey(e => e.ClientSectionId)`, `entity.Property(e => e.Name).HasMaxLength(255)`
- `ErTemplateGroup`: `entity.ToTable("ERTemplateGroup")`, `entity.HasKey(e => e.ErtemplateGroupId)`, `entity.Property(e => e.ErtemplateGroupId).HasColumnName("ERTemplateGroupId")`, `entity.Property(e => e.Name).HasMaxLength(255)`

Also add navigation properties to `Eractivity.cs`:
- `public virtual ClientSection? ClientSection { get; set; }`
- `public virtual ErTemplateGroup? ErTemplateGroup { get; set; }`

And configure the FK relationships in the `Eractivity` entity configuration in `OnModelCreating`:
- `entity.HasOne(d => d.ClientSection).WithMany().HasForeignKey(d => d.ClientSectionId).OnDelete(DeleteBehavior.ClientSetNull);`
- `entity.HasOne(d => d.ErTemplateGroup).WithMany().HasForeignKey(d => d.ErtemplateGroupId).OnDelete(DeleteBehavior.ClientSetNull);`

Do NOT add global query filters for these lookup tables -- they are shared reference data, not tenant-scoped.
  </action>
  <verify>
`dotnet build src/SignaturPortal.Web` compiles without errors. Verify the new DbSets are accessible and navigation properties are configured.
  </verify>
  <done>ClientSection and ErTemplateGroup entities exist, are registered in DbContext with correct table/column mappings, and Eractivity has navigation properties to both.</done>
</task>

<task type="auto">
  <name>Task 2: Expand ActivityListDto and service query projection with JOINs</name>
  <files>
    src/SignaturPortal.Application/DTOs/ActivityListDto.cs
    src/SignaturPortal.Infrastructure/Services/ActivityService.cs
  </files>
  <action>
**ActivityListDto.cs** -- Replace the existing DTO. Remove `JournalNo` and `StatusName` fields. Add resolved name fields and `ContinuousPosting`:

```csharp
public record ActivityListDto
{
    public int EractivityId { get; init; }
    public string Headline { get; init; } = "";
    public string Jobtitle { get; init; } = "";
    public DateTime ApplicationDeadline { get; init; }
    public bool ContinuousPosting { get; init; }
    public int EractivityStatusId { get; init; }
    public DateTime CreateDate { get; init; }
    public int CandidateCount { get; init; }

    // Resolved display names (populated via SQL JOINs, no N+1)
    public string RecruitingResponsibleName { get; init; } = "";
    public string CreatedByName { get; init; } = "";
    public string DraftResponsibleName { get; init; } = "";
    public string ClientSectionName { get; init; } = "";
    public string TemplateGroupName { get; init; } = "";
}
```

**ActivityService.cs** -- Update the `GetActivitiesAsync` method projection (the `.Select(a => new ActivityListDto { ... })` block). Replace the current projection with one that uses LEFT JOINs via LINQ subqueries for the name lookups:

```csharp
var items = await query
    .Select(a => new ActivityListDto
    {
        EractivityId = a.EractivityId,
        Headline = a.Headline,
        Jobtitle = a.Jobtitle,
        ApplicationDeadline = a.ApplicationDeadline,
        ContinuousPosting = a.ContinuousPosting,
        EractivityStatusId = a.EractivityStatusId,
        CreateDate = a.CreateDate,
        CandidateCount = a.Ercandidates.Count(c => !c.IsDeleted),
        // Resolve names via navigation properties / subqueries
        RecruitingResponsibleName = a.Responsible.HasValue
            ? context.Users.Where(u => u.UserId == a.Responsible.Value).Select(u => u.FullName ?? u.UserName ?? "").FirstOrDefault() ?? ""
            : "",
        CreatedByName = a.CreatedBy.HasValue
            ? context.Users.Where(u => u.UserId == a.CreatedBy.Value).Select(u => u.FullName ?? u.UserName ?? "").FirstOrDefault() ?? ""
            : "",
        DraftResponsibleName = a.DraftResponsible.HasValue
            ? context.Users.Where(u => u.UserId == a.DraftResponsible.Value).Select(u => u.FullName ?? u.UserName ?? "").FirstOrDefault() ?? ""
            : "",
        ClientSectionName = a.ClientSection != null ? a.ClientSection.Name : "",
        TemplateGroupName = a.ErTemplateGroup != null ? a.ErTemplateGroup.Name : ""
    })
    .ToListAsync(ct);
```

Remove the post-materialization loop that computed `StatusName` (the `for` loop with `StatusMappings.GetActivityStatusName`) since `StatusName` is no longer on the DTO.

Important: The `context.Users.Where(...)` subqueries translate to SQL scalar subqueries (correlated subselects), which is the correct EF Core pattern for resolving FKs to display names without materializing the entire User table. This is equivalent to a LEFT JOIN in SQL. The navigation property approach (`a.ClientSection.Name`) is even cleaner and translates to a proper LEFT JOIN.
  </action>
  <verify>
`dotnet build src/SignaturPortal.Web` compiles without errors. The build will show any compilation errors from the removed `JournalNo`/`StatusName` references in the UI (expected -- Plan 02 will fix those).
  </verify>
  <done>ActivityListDto has 5 new resolved name fields plus ContinuousPosting. JournalNo and StatusName removed. Service query projection resolves all names via SQL subqueries/JOINs in a single round-trip.</done>
</task>

</tasks>

<verification>
- `dotnet build src/SignaturPortal.Infrastructure` passes (entities + service compile)
- `dotnet build src/SignaturPortal.Application` passes (DTO compiles)
- Note: `dotnet build src/SignaturPortal.Web` may show errors in ActivityList.razor referencing removed fields (JournalNo, StatusName) -- this is expected and fixed in Plan 02
</verification>

<success_criteria>
- ClientSection and ErTemplateGroup entities scaffolded with correct table/column mappings
- Eractivity has navigation properties to both lookup tables
- ActivityListDto has RecruitingResponsibleName, CreatedByName, DraftResponsibleName, ClientSectionName, TemplateGroupName, ContinuousPosting
- ActivityListDto no longer has JournalNo or StatusName
- GetActivitiesAsync query projection resolves all names via SQL (no N+1)
- Infrastructure and Application projects compile
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-activity-list-conditional-columns/03.3-01-SUMMARY.md`
</output>
