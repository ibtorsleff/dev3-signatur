---
phase: 01-infrastructure-shell
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/SignaturPortal.Web/SignaturPortal.Web.csproj
  - src/SignaturPortal.Web/Program.cs
  - src/SignaturPortal.Web/appsettings.json
  - src/SignaturPortal.Web/Components/Layout/MainLayout.razor
  - src/SignaturPortal.Web/Components/Layout/MainLayout.razor.css
  - src/SignaturPortal.Web/Components/Layout/NavMenu.razor
  - src/SignaturPortal.Web/Components/Layout/NavMenu.razor.css
  - src/SignaturPortal.Web/Components/App.razor
  - src/SignaturPortal.Web/Components/Pages/Home.razor
autonomous: true

must_haves:
  truths:
    - "Blazor pages are served at their defined routes while unmigrated routes proxy to the legacy WebForms app"
    - "YARP fallback catches all unmatched routes and forwards them to the legacy app URL"
    - "System.Web Adapters session sharing is configured with registered session keys"
    - "System.Web Adapters authentication sharing is configured as default scheme"
    - "Navigation shell displays a top nav bar with links that work across both apps"
  artifacts:
    - path: "src/SignaturPortal.Web/Program.cs"
      provides: "YARP + System.Web Adapters + Blazor pipeline"
      contains: "AddReverseProxy"
    - path: "src/SignaturPortal.Web/appsettings.json"
      provides: "YARP route configuration and remote app settings"
      contains: "ReverseProxy"
    - path: "src/SignaturPortal.Web/Components/Layout/MainLayout.razor"
      provides: "Blazor layout with navigation shell"
      contains: "NavMenu"
    - path: "src/SignaturPortal.Web/Components/Layout/NavMenu.razor"
      provides: "Top navigation bar matching legacy UI structure"
      contains: "nav"
  key_links:
    - from: "src/SignaturPortal.Web/Program.cs"
      to: "YARP reverse proxy"
      via: "MapForwarder with int.MaxValue order"
      pattern: "MapForwarder.*catch-all"
    - from: "src/SignaturPortal.Web/Program.cs"
      to: "System.Web Adapters remote session"
      via: "AddSystemWebAdapters + AddRemoteAppClient"
      pattern: "AddSystemWebAdapters"
    - from: "src/SignaturPortal.Web/Components/Layout/MainLayout.razor"
      to: "src/SignaturPortal.Web/Components/Layout/NavMenu.razor"
      via: "Blazor component reference"
      pattern: "NavMenu"
---

<objective>
Configure YARP reverse proxy to route between Blazor and legacy WebForms, set up System.Web Adapters for session and authentication sharing, and create the navigation shell layout matching the original UI structure.

Purpose: This is the core migration enabler. YARP allows incremental page-by-page migration while keeping the legacy app functional for unmigrated routes. Session/auth sharing ensures users don't need to re-login when navigating between old and new pages. The navigation shell provides the UI frame for all future Blazor pages.
Output: A Blazor app that proxies unmigrated routes to legacy WebForms, shares session/auth, and displays a navigation shell.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-shell/01-RESEARCH.md
@.planning/phases/01-infrastructure-shell/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure YARP reverse proxy and System.Web Adapters</name>
  <files>
    src/SignaturPortal.Web/SignaturPortal.Web.csproj
    src/SignaturPortal.Web/Program.cs
    src/SignaturPortal.Web/appsettings.json
  </files>
  <action>
    Install NuGet packages and configure YARP + System.Web Adapters in the Blazor Web project:

    1. Add NuGet packages to SignaturPortal.Web:
       ```
       dotnet add src/SignaturPortal.Web package Yarp.ReverseProxy --version 2.3.0
       dotnet add src/SignaturPortal.Web package Microsoft.AspNetCore.SystemWebAdapters --version 2.3.0
       ```
       If exact version 2.3.0 is not available, use the latest stable version of each package and note the actual version in the summary.

    2. Update appsettings.json to add YARP configuration:
       ```json
       {
         "ConnectionStrings": {
           "SignaturAnnoncePortal": "Server=.;Database=SignaturAnnoncePortal;Trusted_Connection=True;TrustServerCertificate=True;"
         },
         "RemoteAppUri": "https://localhost:44300",
         "RemoteAppApiKey": "CHANGE-ME-GENERATE-GUID",
         "ReverseProxy": {
           "Routes": {
             "fallback-to-webforms": {
               "ClusterId": "legacy-webforms",
               "Order": 2147483647,
               "Match": {
                 "Path": "/{**catch-all}"
               }
             }
           },
           "Clusters": {
             "legacy-webforms": {
               "Destinations": {
                 "webforms-app": {
                   "Address": "https://localhost:44300"
                 }
               }
             }
           }
         },
         "Logging": {
           "LogLevel": {
             "Default": "Information",
             "Microsoft.AspNetCore": "Warning",
             "Yarp": "Information"
           }
         },
         "AllowedHosts": "*"
       }
       ```

    3. Rewrite Program.cs to integrate YARP + System.Web Adapters with Blazor Server:
       ```csharp
       using Microsoft.AspNetCore.SystemWebAdapters;
       using Microsoft.Extensions.Options;

       var builder = WebApplication.CreateBuilder(args);

       // Blazor Server
       builder.Services.AddRazorComponents()
           .AddInteractiveServerComponents();

       // YARP Reverse Proxy
       builder.Services.AddReverseProxy()
           .LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"));

       // System.Web Adapters - Session + Auth sharing with legacy WebForms
       builder.Services.AddSystemWebAdapters()
           .AddJsonSessionSerializer(options =>
           {
               // Register session keys used by legacy WebForms app.
               // IMPORTANT: These must match exactly what the WebForms app registers.
               // TODO: Audit legacy app for complete session key list during implementation.
               options.RegisterKey<int>("UserId");
               options.RegisterKey<string>("SiteId");
               options.RegisterKey<string>("ClientId");
               options.RegisterKey<string>("UserName");
               options.RegisterKey<int>("UserLanguageId");
           })
           .AddRemoteAppClient(options =>
           {
               options.RemoteAppUrl = new Uri(builder.Configuration["RemoteAppUri"]!);
               options.ApiKey = builder.Configuration["RemoteAppApiKey"]!;
           })
           .AddSessionClient()
           .AddAuthenticationClient(true); // true = set as default auth scheme

       // HttpContext accessor for session access in services
       builder.Services.AddHttpContextAccessor();

       var app = builder.Build();

       // Middleware pipeline - ORDER IS CRITICAL
       if (!app.Environment.IsDevelopment())
       {
           app.UseExceptionHandler("/Error");
           app.UseHsts();
       }

       app.UseHttpsRedirection();
       app.UseStaticFiles();
       app.UseRouting();
       app.UseAuthentication();
       app.UseAuthorization();
       app.UseSystemWebAdapters();
       app.UseAntiforgery();

       // Blazor components (higher precedence - matched first)
       app.MapRazorComponents<App>()
           .AddInteractiveServerRenderMode();

       // YARP fallback to WebForms (MUST be last - lowest precedence)
       // int.MaxValue ensures this only matches when no Blazor route handles the request
       var remoteAppUrl = builder.Configuration["RemoteAppUri"]!;
       app.MapForwarder("/{**catch-all}", remoteAppUrl)
           .WithOrder(int.MaxValue)
           .ShortCircuit();

       app.Run();
       ```

    NOTES:
    - The `App` type in `MapRazorComponents<App>()` must match the actual root component class. If the Blazor template uses a different namespace, adjust the import.
    - Session keys (UserId, SiteId, ClientId, UserName, UserLanguageId) are initial guesses based on research. The executor should grep the legacy codebase at `C:\Users\it\Documents\Dev\CustomersAndProjects\Signatur\Dev3Org\AtlantaSignatur` for `Session\[` patterns to discover additional keys. Add any discovered keys to the registration. Log the complete list found in the summary.
    - Do NOT modify the legacy WebForms app in this task. That is a separate concern that requires careful coordination and is noted as a blocker/concern in STATE.md. The Blazor side can be configured now and will work once the legacy side is also configured.
  </action>
  <verify>
    Run `dotnet build SignaturPortal.sln` -- must compile cleanly with YARP and System.Web Adapters packages.
    Run `dotnet run --project src/SignaturPortal.Web` and confirm:
    - App starts without errors (System.Web Adapters will log warnings about unreachable remote app, which is expected since legacy app is not running)
    - Navigating to https://localhost:{port}/ still shows the Blazor home page
    Stop the app after verification.
  </verify>
  <done>YARP reverse proxy configured with fallback-to-webforms route. System.Web Adapters configured with session key registration and remote auth client. Program.cs has correct middleware ordering. Solution builds cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create navigation shell layout with top nav bar</name>
  <files>
    src/SignaturPortal.Web/Components/Layout/MainLayout.razor
    src/SignaturPortal.Web/Components/Layout/MainLayout.razor.css
    src/SignaturPortal.Web/Components/Layout/NavMenu.razor
    src/SignaturPortal.Web/Components/Layout/NavMenu.razor.css
    src/SignaturPortal.Web/Components/App.razor
    src/SignaturPortal.Web/Components/Pages/Home.razor
  </files>
  <action>
    Create the Blazor layout with a top navigation bar matching the original UI structure. The legacy app uses a horizontal top nav with links to different portal modules.

    1. Create MainLayout.razor:
       ```razor
       @inherits LayoutComponentBase

       <div class="page">
           <NavMenu />
           <main class="main-content">
               @Body
           </main>
       </div>
       ```

    2. Create MainLayout.razor.css with scoped styles:
       ```css
       .page {
           display: flex;
           flex-direction: column;
           min-height: 100vh;
       }

       .main-content {
           flex: 1;
           padding: 1.5rem;
       }
       ```

    3. Create NavMenu.razor with a top navigation bar:
       The navigation should reflect the original portal structure with these key sections:
       - Home / Dashboard
       - E-Recruitment (activities, candidates)
       - Links to legacy pages (these will route through YARP to WebForms)

       ```razor
       <nav class="top-nav">
           <div class="nav-brand">
               <a href="/">SignaturPortal</a>
           </div>
           <div class="nav-links">
               <a href="/" class="nav-link">Home</a>
               <a href="/e-recruitment" class="nav-link">E-Recruitment</a>
               @* Legacy links - these route through YARP to WebForms *@
               <a href="/Responsive/AdPortal/Default.aspx" class="nav-link">Job Ads</a>
               <a href="/Responsive/OnBoarding/Default.aspx" class="nav-link">Onboarding</a>
           </div>
           <div class="nav-user">
               @* User info will be populated from session in Phase 2 *@
               <span class="user-name">User</span>
           </div>
       </nav>
       ```

    4. Create NavMenu.razor.css with scoped styles matching a professional top nav:
       ```css
       .top-nav {
           display: flex;
           align-items: center;
           background-color: #1a237e;
           color: white;
           padding: 0 1.5rem;
           height: 56px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.2);
       }

       .nav-brand a {
           color: white;
           font-size: 1.25rem;
           font-weight: 600;
           text-decoration: none;
           margin-right: 2rem;
       }

       .nav-links {
           display: flex;
           gap: 0.25rem;
           flex: 1;
       }

       .nav-link {
           color: rgba(255,255,255,0.85);
           text-decoration: none;
           padding: 0.5rem 1rem;
           border-radius: 4px;
           transition: background-color 0.2s;
       }

       .nav-link:hover {
           background-color: rgba(255,255,255,0.15);
           color: white;
       }

       .nav-user {
           margin-left: auto;
       }

       .user-name {
           color: rgba(255,255,255,0.85);
           font-size: 0.875rem;
       }
       ```

    5. Update App.razor to use the MainLayout as the default layout. Ensure the Router component uses `DefaultLayout="typeof(MainLayout)"` or that the layout is applied via `@layout MainLayout` in _Imports.razor or at the router level.

    6. Update Home.razor to use the layout and show a simple infrastructure shell status page:
       ```razor
       @page "/"

       <PageTitle>SignaturPortal</PageTitle>

       <h1>SignaturPortal - Infrastructure Shell</h1>
       <p>Phase 1: Infrastructure foundation is operational.</p>

       <div class="status-grid">
           <div class="status-card">
               <h3>YARP Proxy</h3>
               <p>Configured - unmigrated routes forward to legacy WebForms</p>
           </div>
           <div class="status-card">
               <h3>Session Sharing</h3>
               <p>Configured - System.Web Adapters remote session</p>
           </div>
           <div class="status-card">
               <h3>Auth Sharing</h3>
               <p>Configured - System.Web Adapters remote authentication</p>
           </div>
       </div>
       ```

    NOTES:
    - The nav bar colors (#1a237e dark blue) are a starting point. The exact colors will be refined when MudBlazor is added in later phases. For now, use a professional dark blue that is close to the original app's nav color.
    - Legacy links (Job Ads, Onboarding) use .aspx paths intentionally -- YARP will catch these and proxy them to the WebForms app.
    - Do NOT add MudBlazor yet. Use plain HTML + CSS scoped styles. MudBlazor integration will happen when UI components are needed (Phase 3).
  </action>
  <verify>
    Run `dotnet build SignaturPortal.sln` -- must compile cleanly.
    Run `dotnet run --project src/SignaturPortal.Web` and confirm:
    - App starts and shows the top navigation bar at https://localhost:{port}/
    - The nav bar displays: SignaturPortal brand, Home link, E-Recruitment link, Job Ads link, Onboarding link
    - Clicking Home navigates to / and shows the status page
    - The layout renders with nav at top and content below
    Stop the app after verification.
  </verify>
  <done>Navigation shell renders with top nav bar. Layout wraps all pages. Links to legacy .aspx routes are present (will proxy via YARP when legacy app runs). Status page confirms infrastructure components are configured.</done>
</task>

</tasks>

<verification>
1. `dotnet build SignaturPortal.sln` compiles with YARP and System.Web Adapters packages
2. `dotnet run --project src/SignaturPortal.Web` starts and shows nav bar + home page
3. Program.cs contains YARP MapForwarder with int.MaxValue order
4. Program.cs contains AddSystemWebAdapters with session key registration
5. appsettings.json contains ReverseProxy routes and clusters configuration
6. NavMenu.razor contains links to both Blazor routes and legacy .aspx pages
</verification>

<success_criteria>
- YARP reverse proxy routes configured with correct fallback ordering
- System.Web Adapters configured for remote session and auth sharing
- Navigation shell displays top nav with links across both apps
- All legacy route links use .aspx paths that YARP will proxy
- Solution builds and runs cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-shell/01-02-SUMMARY.md`
</output>
