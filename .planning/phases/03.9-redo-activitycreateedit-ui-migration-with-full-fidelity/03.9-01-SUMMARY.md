---
phase: 03.9-redo-activitycreateedit-ui-migration-with-full-fidelity
plan: 01
subsystem: ui
tags: [blazor, form, validation, localization, cascading, navigation]

# Dependency graph
requires:
  - phase: 03.5-localization
    provides: ILocalizationService and GetText pattern for localized strings
  - phase: 03.8-client-selector-dropdown
    provides: ActivityCreateEdit.razor.cs baseline with client cascade pattern

provides:
  - Corrected ActivityCreateEdit.razor.cs with all 6 logic defects fixed
  - ActivityFormModel.Validate() using ILocalizationService from ValidationContext with English fallback
  - RecruitmentTypeId bidirectional translation (LeadershipPositionId/BlindRecruitmentId)
  - CalendarTypeId/checkbox state bidirectional derivation
  - _cascadeLoading state field toggled during client-dependent data reload

affects:
  - 03.9-02 (razor markup that reads _cascadeLoading to disable inputs)
  - Any future plan that extends ActivityCreateEdit save/edit logic

# Tech tracking
tech-stack:
  added: []
  patterns:
    - ValidationContext.GetService(typeof(T)) as T pattern for resolving DI services in IValidatableObject.Validate()
    - Switch expression for bidirectional lookup table translation (RecruitmentTypeId ↔ LeadershipPositionId/BlindRecruitmentId)
    - _cascadeLoading + StateHasChanged() pattern for showing loading state during async cascade reload

key-files:
  created: []
  modified:
    - src/SignaturPortal.Application/DTOs/ActivityFormModel.cs
    - src/SignaturPortal.Web/Components/Pages/Recruiting/ActivityCreateEdit.razor.cs

key-decisions:
  - "ValidationContext.GetService is non-generic in .NET ComponentModel — use GetService(typeof(T)) as T, not GetService<T>()"
  - "Edit save navigation goes to /recruiting/activities not Snackbar + stay on page (matches legacy behavior)"
  - "_saving = false only in catch block for OnSaveAsync (navigation destroys component, no need to reset in finally)"
  - "RecruitmentTypeId ternary in MapEditDataToForm: LeadershipPositionId==1 -> 2, BlindRecruitmentId==1 -> 3, else 1 or null"
  - "CalendarTypeId derived from checkbox state in BuildSaveCommand: ClosedCalendar=2, OpenCalendar=1, both=use dropdown, neither=0"
  - "Occupation autocomplete state (_selectedOccupation + _form.JobnetOccupationId) cleared on client change"

patterns-established:
  - "IValidatableObject localization pattern: resolve ILocalizationService via ValidationContext.GetService(typeof(ILocalizationService)) as ILocalizationService with ?. null-safe fallback"
  - "Cascade loading pattern: _cascadeLoading = true; StateHasChanged(); try { await Load...(); } finally { _cascadeLoading = false; }"

requirements-completed: [CRUD-01, CRUD-03, CRUD-04, CRUD-05, CRUD-06]

# Metrics
duration: 8min
completed: 2026-02-23
---

# Phase 03.9 Plan 01: ActivityCreateEdit Code-Behind Logic Fixes Summary

**Fixed 6 code-behind defects and added localized validation messages: correct post-edit navigation, bidirectional RecruitmentTypeId/LeadershipPosition/BlindRecruitment translation, CalendarTypeId/checkbox derivation, cascade loading state, and ILocalizationService in IValidatableObject.Validate().**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-23T16:45:23Z
- **Completed:** 2026-02-23T16:53:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- ActivityFormModel.Validate() now resolves ILocalizationService from ValidationContext and uses localized error messages with English fallbacks for all 4 cross-field validation rules
- ActivityCreateEdit.razor.cs edit-mode save path now navigates to /recruiting/activities (was incorrectly showing Snackbar and staying on page)
- MapEditDataToForm correctly derives single RecruitmentTypeId from the two binary flags (LeadershipPositionId/BlindRecruitmentId) stored in the DB
- BuildSaveCommand correctly translates RecruitmentTypeId back to LeadershipPositionId and BlindRecruitmentId via switch expressions, and derives CalendarTypeId from checkbox state
- _cascadeLoading field added and toggled in OnClientChangedAsync to enable Plan 02 markup to disable inputs during reload
- Occupation autocomplete cleared on client change (was a missed state reset that would show stale occupation from previous client)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix ActivityFormModel.Validate() to use localized messages via ValidationContext** - `5cd61d2` (fix)
2. **Task 2: Fix ActivityCreateEdit.razor.cs — navigation, translations, cascade loading** - `5eaf7c3` (fix)

## Files Created/Modified

- `src/SignaturPortal.Application/DTOs/ActivityFormModel.cs` - Added using for ILocalizationService; Validate() now uses ValidationContext.GetService(typeof(ILocalizationService)) as ILocalizationService with null-safe GetText calls and English fallbacks
- `src/SignaturPortal.Web/Components/Pages/Recruiting/ActivityCreateEdit.razor.cs` - 6 logic defects fixed: navigation, RecruitmentTypeId bidirectional translation, CalendarTypeId derivation, cascade loading state, occupation state reset on client change

## Decisions Made

- Used `ValidationContext.GetService(typeof(ILocalizationService)) as ILocalizationService` because `ValidationContext.GetService()` is non-generic in .NET's `System.ComponentModel.DataAnnotations` (the generic overload only exists as an extension method that was not available in this context)
- `_saving = false` removed from `finally` block in `OnSaveAsync` — when NavigateTo is called, the component is destroyed, so resetting the flag would be a write to a disposed component. The flag is only reset in the `catch` block now
- Occupation autocomplete state cleared on client change as part of Fix 6 — this was an additional pitfall from the research audit (Pitfall #6) that was included in the plan spec

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] ValidationContext.GetService generic form not available**
- **Found during:** Task 1 (Fix ActivityFormModel.Validate())
- **Issue:** The plan specified `validationContext.GetService<ILocalizationService>()` but `ValidationContext.GetService(Type)` is non-generic in `System.ComponentModel.DataAnnotations`. CS0308 error: "The non-generic method cannot be used with type arguments"
- **Fix:** Used `validationContext.GetService(typeof(ILocalizationService)) as ILocalizationService` instead — achieves same result with correct API
- **Files modified:** src/SignaturPortal.Application/DTOs/ActivityFormModel.cs
- **Verification:** Application project builds with 0 errors; `as ILocalizationService` preserves null-safety pattern
- **Committed in:** 5cd61d2 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug — API mismatch in plan specification)
**Impact on plan:** Auto-fix necessary for compilation. Semantically equivalent to the plan's intent. No scope creep.

## Issues Encountered

- Web project build showed file-locking errors (MSB3027/MSB3021) because Visual Studio and SignaturPortal.Web.exe had Debug DLLs locked. These are runtime environment constraints, not code errors. Zero `error CS` compiler errors confirmed separately. Build will succeed when the dev server is not running.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Plan 01 delivers corrected code-behind logic. Plan 02 can now proceed with razor markup changes.
- `_cascadeLoading` field is in place and toggled correctly — Plan 02 markup can use `disabled="@_cascadeLoading"` on client-dependent inputs.
- All 6 defects from the research audit are fixed. No known remaining defects in the code-behind.

---
*Phase: 03.9-redo-activitycreateedit-ui-migration-with-full-fidelity*
*Completed: 2026-02-23*
