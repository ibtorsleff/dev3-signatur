---
phase: 03.9-redo-activitycreateedit-ui-migration-with-full-fidelity
task: human-verify (03.9-03 Task 2 - continued)
status: in_progress
last_updated: 2026-02-23T19:36:19.312Z
---

<current_state>
Resumed from previous .continue-here checkpoint. Fixed the 3 original UI issues. Now investigating RecruitmentType dropdown visibility business rules — investigated, NOT yet implemented. All changes this session are uncommitted.
</current_state>

<completed_work>

**Fixes applied this session (all uncommitted):**

1. **JobnetOccupation Level filter** — `Level >= 3` (not `Level == 3`). Legacy includes level-4 alias items (e.g. "Adjunktvikar i sygepleje" is level 4). `Level` property added to entity.
2. **Jobtitle label** — replaced `GetText("Jobtitle")` with IsFundClient conditional: `ERecruitmentJobtitleOnlyForCandidateEmails` / `ERecruitmentJobtitleOnlyForCandidateEmailsFund`
3. **"Created by" in create mode** — added `_currentUserDisplayName` field, row shown unconditionally (edit: `_editData.CreatedByName`, create: `_currentUserDisplayName`)
4. **Parallel DB queries + occupation cache** — `GetActivityFormOptionsAsync` refactored: all 7 DB queries run in parallel (each with own DbContext). Occupation list cached 1h in `IMemoryCache`.
5. **Occupation autocomplete UX** — `MaxItems="50"`, `MinCharacters="0"`, returns empty on blank input, `NoItemsTemplate` shows "Skriv for at søge..."
6. **Todo captured** — ClientSection (Afdeling) hierarchical display: `.planning/todos/pending/2026-02-23-clientsection-afdeling-autocomplete-hierarchical-display.md`

</completed_work>

<remaining_work>

**RecruitmentType dropdown — business rules investigated, NOT yet implemented:**

Legacy visibility logic (ActivityCreateEdit.aspx.cs lines 2069-2071):
```
leadershipPositionOuterDiv.Visible   = leadershipPositionEnabled && (!blindRecruitmentEnabled || !limitedCandidateAccess);
blindRecruitmentOuterDiv.Visible     = blindRecruitmentEnabled && (!leadershipPositionEnabled || !limitedCandidateAccess);
recruitmentTypeOuterDiv.Visible      = blindRecruitmentEnabled && leadershipPositionEnabled && limitedCandidateAccess;
```

Three flags from `Sig_Client.CustomData` XML:
- `LeadershipPositionMarkOnActivityEnabled` → XPath: `/ClientCustomData/Recruitment/@LeadershipPositionMarkOnActivityEnabled`
- `LeadershipPositionLimitedCandidateAccessEnabled` → XPath: `/ClientCustomData/Recruitment/@LeadershipPositionLimitedCandidateAccessEnabled`
- `BlindRecruitmentEnabled` → XPath: `/ClientCustomData/Recruitment/@BlindRecruitmentEnabled`

Truth table:
- LP=false, Blind=false → hide everything
- LP=true, Blind=false → show LP Yes/No dropdown only
- LP=false, Blind=true → show BlindRecruitment Yes/No dropdown only
- LP=true, Blind=true, LimitedAccess=false → show both LP + BlindRecruitment as separate Yes/No dropdowns
- LP=true, Blind=true, LimitedAccess=true → show combined RecruitmentType dropdown (current Blazor behavior)

**What needs implementing:**
1. Add 3 flags to `ActivityClientConfigDto`: `LeadershipPositionEnabled`, `BlindRecruitmentEnabled`, `LeadershipPositionLimitedCandidateAccessEnabled`
2. Read them in `ClientService.GetActivityClientConfigAsync` via XPath on `Sig_Client.CustomData` (same pattern as `IsFundClient`)
3. Replace always-visible RecruitmentType MudSelect in razor with conditional logic per truth table above
4. Add `_form.LeadershipPositionId` and `_form.BlindRecruitmentId` int? fields to `ActivityFormModel` for the separate Yes/No cases
5. Re-run all 6 human verification tests

**Also: commit all uncommitted changes before starting**

</remaining_work>

<decisions_made>

- `Level >= 3` not `Level == 3` — legacy traverses 3 levels + children (level 4 = aliases)
- Cache occupation list 1h in IMemoryCache (global, same for all clients)
- Parallel DB queries via separate DbContext per helper method
- `MaxItems="50"` + empty-on-blank-input for occupation autocomplete
- RecruitmentType: 3 client flags from XML CustomData on Sig_Client

</decisions_made>

<blockers>

- All changes from this session are uncommitted — commit first when resuming

</blockers>

<context>
Phase 03.9 nearly done. Main remaining item: RecruitmentType conditional visibility. The `Sig_Client.CustomData` XML holds the flags — same pattern already used by `IsFundClient` which reads `(/ClientCustomData/@IsFundClient)`. Just extend `GetActivityClientConfigAsync` to also read the 3 recruitment type flags, then implement conditional razor UI.
</context>

<next_action>
1. Commit all uncommitted changes from this session
2. Add 3 flags to ActivityClientConfigDto + read in ClientService + implement conditional razor UI
3. Re-run all 6 human verification tests
</next_action>
