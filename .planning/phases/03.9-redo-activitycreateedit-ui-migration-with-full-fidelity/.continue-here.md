---
phase: 03.9-redo-activitycreateedit-ui-migration-with-full-fidelity
task: human-verify (03.9-03 Task 2)
status: in_progress
last_updated: 2026-02-23T18:51:03.565Z
---

<current_state>
Mid human-verification of Plan 03.9-03 Task 2. The app restarts and the user is testing the create form. Three UI issues have been found and are partially investigated but NOT yet fixed:

1. **"Created by" field missing in create mode** — currently only shown in edit mode
2. **Jobtitle label wrong** — Blazor uses `GetText("Jobtitle")`, legacy uses `GetText("ERecruitmentJobtitleOnlyForCandidateEmails")` (or Fund variant `ERecruitmentJobtitleOnlyForCandidateEmailsFund`)
3. **Stillingsbetegnelse (JobnetOccupation) shows only 1 item** — legacy shows level-3 occupations only (3-level hierarchy traversal); Blazor queries all non-deleted from root table

The EF entity migration (raw SQL → LINQ) was completed and committed. The cascade now fires. Column name fixes were: `TypeId` → `ErLetterTemplateTypeId`, `TemplateTypeId` → `ErApplicationTemplateTypeId` (with HasColumnName mapping). The 488px max-width CSS fix is also committed.
</current_state>

<completed_work>

- Plans 03.9-01, 03.9-02: Fully executed (multiple commits)
- Plan 03.9-03 Task 1: CSS polish committed
- All SQL exceptions in GetActivityFormOptionsAsync fixed:
  - `ERJobnetOccupation` → `JobnetOccupation`
  - `ERRecruitmentType`/`ERCalendarType` → hardcoded enums with ILocalizationService
  - `Language` → `Languages`
  - `IsEnabled` → `Active`
  - `Name` → `TemplateName` on ERLetterTemplate/ERSmsTemplate
  - `ERLetterTemplateTypeId` → `ErLetterTemplateTypeId` (EF entity property)
  - `ERApplicationTemplateTypeId` column via HasColumnName mapping
- EF entity migration: JobnetOccupation, ErApplicationTemplate, ErLetterTemplate, ErSmsTemplate, ErTemplateGroupApplicationTemplate — all raw SQL in GetActivityFormOptionsAsync replaced with LINQ
- Layout rewrite: form-row CSS pattern (185px right-aligned label + flex input), responsive stacking at 767px
- CSS: max-width 488px on .form-input
- Cascade now fires on client selection (was silently failing due to wrong column names)

</completed_work>

<remaining_work>

**Fix the 3 UI issues found during verification:**

### Issue 1: "Created by" field in create mode
- `CurrentUserDto` has `FullName` (nullable string)
- In `ActivityCreateEdit.razor.cs`: `_currentUserId` is stored but NOT `_currentUserDisplayName`
- Fix: Store `currentUser?.FullName ?? currentUser?.UserName` in a `_currentUserDisplayName` field
- In razor: Show CreatedBy row in BOTH create and edit modes:
  - Edit: use `_editData.CreatedByName`
  - Create: use `_currentUserDisplayName`

### Issue 2: Jobtitle label
- Replace `Localization.GetText("Jobtitle")` with conditional:
  - `_clientConfig.IsFundClient ? Localization.GetText("ERecruitmentJobtitleOnlyForCandidateEmailsFund") : Localization.GetText("ERecruitmentJobtitleOnlyForCandidateEmails")`
- Before client is selected, `_clientConfig` is default, so defaults to non-fund label (acceptable)

### Issue 3: JobnetOccupation level filter
- Legacy `JobnetOccupationsFlatListGet` traverses 3 levels deep (occupation1 → occupation2 → occupation3.Children)
- Only level-3 occupations are shown
- `JobnetOccupationClient` IS a real persistent table (confirmed), but the legacy only uses it when `clientJobAgentUseJobnetCategories = true` (job agent feature)
- For standard clients: show all level-3 non-deleted occupations from `JobnetOccupation WHERE Level = 3 AND Deleted = 0`
- Need to add `Level` property to `JobnetOccupation` entity and add `Level = 3` filter to the LINQ query

**After fixing those 3 issues, re-run all 6 human verification tests.**

</remaining_work>

<decisions_made>

- Replaced raw SQL with EF entities for JobnetOccupation, ErApplicationTemplate, ErLetterTemplate, ErSmsTemplate — compile-time safety, eliminates silent column-name runtime failures
- `ErTemplateGroupApplicationTemplate` join entity used instead of many-to-many nav property to avoid modifying existing ErTemplateGroup entity
- Email templates: load all for client in one query, partition by ErLetterTemplateTypeId in memory (1 DB round trip vs 5)
- JobnetOccupation: should filter by Level=3 (leaf nodes), NOT by JobnetOccupationClient (that's only for job-agent clients)
- Jobtitle label: conditional on IsFundClient, two different localization keys

</decisions_made>

<blockers>

- None blocking; 3 UI issues need fixes before verification can complete

</blockers>

<context>
Phase 03.9 is nearly done. The core backend and form layout are working. The cascade works. What's left is 3 cosmetic/data issues found during the first pass of human verification, then a clean run of all 6 tests (create, edit, delete, cancel, validation, mobile).

The JobnetOccupation Level=3 filter is the most important fix — without it the occupation autocomplete only shows global root/intermediate nodes instead of the actual selectable occupation titles.
</context>

<next_action>
Start with: Fix the 3 UI issues in order:
1. Add `Level` to `JobnetOccupation` entity + filter `Level = 3` in service LINQ query
2. Fix jobtitle label in razor to use `ERecruitmentJobtitleOnlyForCandidateEmails`/Fund variant
3. Add "Created by" display in create mode (store `_currentUserDisplayName` in code-behind, show row unconditionally in razor)
Then rebuild, restart app, re-run all 6 verification tests.
</next_action>
