---
phase: 03.9-redo-activitycreateedit-ui-migration-with-full-fidelity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SignaturPortal.Web/Components/Pages/Recruiting/ActivityCreateEdit.razor.cs
  - src/SignaturPortal.Application/DTOs/ActivityFormModel.cs
autonomous: true
requirements: [CRUD-01, CRUD-03, CRUD-04, CRUD-05, CRUD-06]
must_haves:
  truths:
    - "After editing and saving an activity, the user is navigated to /recruiting/activities (not kept on edit page)"
    - "MapEditDataToForm derives a single RecruitmentTypeId from LeadershipPositionId/BlindRecruitmentId in the edit data"
    - "MapEditDataToForm derives ClosedCalendarEnabled and OpenCalendarEnabled from CalendarTypeId"
    - "BuildSaveCommand translates RecruitmentTypeId back to LeadershipPositionId and BlindRecruitmentId on the command"
    - "BuildSaveCommand derives CalendarTypeId from the ClosedCalendarEnabled/OpenCalendarEnabled checkbox state"
    - "Client change cascade shows a _cascadeLoading state that disables affected inputs during the async reload"
    - "ActivityFormModel.Validate() uses ILocalizationService from ValidationContext to produce localized error messages"
  artifacts:
    - path: "src/SignaturPortal.Web/Components/Pages/Recruiting/ActivityCreateEdit.razor.cs"
      provides: "Corrected code-behind with all 7 logic defects fixed"
      min_lines: 400
    - path: "src/SignaturPortal.Application/DTOs/ActivityFormModel.cs"
      provides: "ActivityFormModel.Validate() using ValidationContext.GetService<ILocalizationService>()"
      contains: "validationContext.GetService"
  key_links:
    - from: "ActivityCreateEdit.razor.cs OnSaveAsync"
      to: "Navigation.NavigateTo('/recruiting/activities')"
      via: "direct call after UpdateActivityAsync"
      pattern: "NavigateTo.*recruiting/activities"
    - from: "ActivityCreateEdit.razor.cs MapEditDataToForm"
      to: "_form.RecruitmentTypeId"
      via: "conditional expression: LeadershipPositionId==1 ? 2 : BlindRecruitmentId==1 ? 3 : 1"
      pattern: "RecruitmentTypeId.*LeadershipPositionId|BlindRecruitmentId"
    - from: "ActivityCreateEdit.razor.cs BuildSaveCommand"
      to: "ActivitySaveCommand.LeadershipPositionId/BlindRecruitmentId"
      via: "switch expression on _form.RecruitmentTypeId"
      pattern: "RecruitmentTypeId switch"
    - from: "ActivityFormModel.Validate"
      to: "ILocalizationService.GetText"
      via: "validationContext.GetService<ILocalizationService>()"
      pattern: "GetService.*ILocalizationService"
---

<objective>
Fix all code-behind logic defects in ActivityCreateEdit.razor.cs and update ActivityFormModel.Validate() to use localized error messages via ValidationContext.

Purpose: The existing code-behind has 7 defects identified by the research audit: wrong post-edit-save navigation, missing RecruitmentTypeId/LeadershipPosition/BlindRecruitment bidirectional translation, missing CalendarTypeId/checkbox state derivation, missing cascade loading state, and hardcoded English validation error messages. These defects cause functional regressions vs the legacy system.

Output: A corrected ActivityCreateEdit.razor.cs and an updated ActivityFormModel.Validate() that together pass all logic requirements before any UI markup changes.
</objective>

<execution_context>
@C:/Users/it/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/it/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ActivityCreateEditMigration.md
@.planning/phases/03.9-redo-activitycreateedit-ui-migration-with-full-fidelity/03.9-CONTEXT.md
@.planning/phases/03.9-redo-activitycreateedit-ui-migration-with-full-fidelity/03.9-RESEARCH.md
@src/SignaturPortal.Application/DTOs/ActivityFormModel.cs
@src/SignaturPortal.Application/DTOs/ActivitySaveCommand.cs
@src/SignaturPortal.Application/DTOs/ActivityEditDto.cs
@src/SignaturPortal.Web/Components/Pages/Recruiting/ActivityCreateEdit.razor.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ActivityFormModel.Validate() to use localized messages via ValidationContext</name>
  <files>src/SignaturPortal.Application/DTOs/ActivityFormModel.cs</files>
  <action>
Rewrite the `Validate(ValidationContext validationContext)` method body to resolve ILocalizationService from the validation context and use it for all error message strings. Keep all existing validation logic (rules, field member names) unchanged — only replace hardcoded English strings with localized lookups.

The Application layer already references ILocalizationService via its Interfaces project. Use `validationContext.GetService<ILocalizationService>()` (returns null if not available). Add `using SignaturPortal.Application.Interfaces;` if not present.

Replace each hardcoded string with a GetText call + English fallback:
- `"Application deadline is required when continuous posting is not enabled."` → `loc?.GetText("ApplicationDeadlineMandatory") ?? "Application deadline is required when continuous posting is not enabled."`
- `"Hire date is required."` → `loc?.GetText("HireDateMandatory") ?? "Hire date is required."`
- `"Hire date must be on or after the application deadline."` → `loc?.GetText("HireDateMustBeAfterDeadline") ?? "Hire date must be on or after the application deadline."`
- `"Hire date text is required."` → `loc?.GetText("HireDateFreeTextMandatory") ?? "Hire date text is required."`

Pattern:
```csharp
public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
{
    var loc = validationContext.GetService<ILocalizationService>();

    if (!ContinuousPosting && !ApplicationDeadline.HasValue)
        yield return new ValidationResult(
            loc?.GetText("ApplicationDeadlineMandatory") ?? "Application deadline is required when continuous posting is not enabled.",
            new[] { nameof(ApplicationDeadline) });
    // ... remaining rules unchanged, same pattern
}
```

Do NOT change any rule logic, field names, or the IValidatableObject signature.
  </action>
  <verify>
    <automated>cd "C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3" && dotnet build src/SignaturPortal.Application/SignaturPortal.Application.csproj --no-restore -q 2>&1 | tail -5</automated>
    <manual>Confirm ActivityFormModel.Validate() calls validationContext.GetService with ILocalizationService and uses ?. null-conditional GetText with English fallback string</manual>
  </verify>
  <done>ActivityFormModel compiles; Validate() calls `validationContext.GetService&lt;ILocalizationService&gt;()` with null-safe fallback for all 4 validation rules</done>
</task>

<task type="auto">
  <name>Task 2: Fix ActivityCreateEdit.razor.cs — navigation, translations, cascade loading</name>
  <files>src/SignaturPortal.Web/Components/Pages/Recruiting/ActivityCreateEdit.razor.cs</files>
  <action>
Apply all 7 code-behind defect fixes. The file already exists and is mostly correct. Make targeted changes:

**Fix 1 — Edit save navigation (Defect #1, #5 from research):**
In `OnSaveAsync`, replace the edit-mode branch that does `Snackbar.Add(...) + stays on page` with `Navigation.NavigateTo("/recruiting/activities")`. Also remove `_saving = false` from the finally block (navigation destroys the component). Only reset `_saving = false` in the catch block:
```csharp
if (IsEditMode && ActivityId.HasValue)
{
    await ErActivityService.UpdateActivityAsync(ActivityId.Value, command);
    Navigation.NavigateTo("/recruiting/activities");
}
else
{
    var newId = await ErActivityService.CreateActivityAsync(command);
    Navigation.NavigateTo($"/recruiting/activities/{newId}/edit");
}
```
Remove `finally { _saving = false; }` from `OnSaveAsync` (navigation destroys component — no need to reset). Keep `_saving = false` only in the catch block.

**Fix 2 — MapEditDataToForm: RecruitmentTypeId translation (Defect #6):**
In `MapEditDataToForm`, after the existing field assignments, add:
```csharp
// Translate LeadershipPositionId/BlindRecruitmentId → single RecruitmentTypeId
// 1=Yes, 2=No for each. LeadershipPosition=Yes → type 2; BlindRecruitment=Yes → type 3; otherwise → type 1 (Normal)
_form.RecruitmentTypeId = data.LeadershipPositionId == 1 ? 2 :
                          data.BlindRecruitmentId == 1 ? 3 :
                          (data.LeadershipPositionId.HasValue || data.BlindRecruitmentId.HasValue) ? 1 : null;
```
Remove the existing raw assignments of `_form.LeadershipPositionId = data.LeadershipPositionId;` and `_form.BlindRecruitmentId = data.BlindRecruitmentId;` — these are no longer set directly from edit data (they are derived from RecruitmentTypeId on save).

**Fix 3 — MapEditDataToForm: CalendarType checkbox derivation (Defect #5):**
In `MapEditDataToForm`, add after CalendarTypeId assignment:
```csharp
_form.ClosedCalendarEnabled = data.CalendarTypeId == 2;
_form.OpenCalendarEnabled = data.CalendarTypeId == 1;
```

**Fix 4 — BuildSaveCommand: RecruitmentTypeId → Leadership/BlindRecruitment translation (Defect #7):**
In `BuildSaveCommand`, replace the existing `LeadershipPositionId = _form.LeadershipPositionId` and `BlindRecruitmentId = _form.BlindRecruitmentId` assignments with translated values from `_form.RecruitmentTypeId`:
```csharp
// ERRecruitmentType: 1=Normal, 2=LeadershipPosition, 3=BlindRecruitment
// LeadershipPositionId/BlindRecruitmentId: 1=Yes, 2=No
LeadershipPositionId = _form.RecruitmentTypeId switch
{
    2 => 1,           // LeadershipPosition → Yes
    1 or 3 => 2,      // Normal or BlindRecruitment → No
    _ => null
},
BlindRecruitmentId = _form.RecruitmentTypeId switch
{
    3 => 1,           // BlindRecruitment → Yes
    1 or 2 => 2,      // Normal or LeadershipPosition → No
    _ => null
},
```
Also set `RecruitmentTypeId = _form.RecruitmentTypeId` on the command (the service may use it for audit/logging).

**Fix 5 — BuildSaveCommand: CalendarTypeId from checkbox state (Defect #4):**
Replace `CalendarTypeId = _form.CalendarTypeId` with the derived value:
```csharp
CalendarTypeId = _form.ClosedCalendarEnabled && _form.OpenCalendarEnabled
    ? _form.CalendarTypeId  // Both checked: use dropdown selection
    : _form.ClosedCalendarEnabled ? 2
    : _form.OpenCalendarEnabled ? 1
    : 0,
```

**Fix 6 — Cascade loading state (Defect #8):**
Add `private bool _cascadeLoading;` to the component state fields (after `_isClientUser`).

In `OnClientChangedAsync`, wrap the `LoadClientDependentDataAsync` call with `_cascadeLoading = true/false`:
```csharp
if (client != null)
{
    _cascadeLoading = true;
    StateHasChanged();
    try
    {
        await LoadClientDependentDataAsync(client.ClientId);
    }
    finally
    {
        _cascadeLoading = false;
    }
}
```

Also clear `_selectedOccupation = null; _form.JobnetOccupationId = null;` in the client change clear section (Pitfall #6 from research — occupation autocomplete state not cleared on client change).

The `_cascadeLoading` field is referenced from the razor markup in Plan 02 to disable inputs.
  </action>
  <verify>
    <automated>cd "C:/Users/it/Documents/Dev/CustomersAndProjects/Signatur/Dev3" && dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj --no-restore -q 2>&1 | tail -10</automated>
    <manual>Verify: (1) OnSaveAsync edit path calls NavigateTo not Snackbar.Add; (2) MapEditDataToForm sets _form.RecruitmentTypeId from ternary expression; (3) BuildSaveCommand has RecruitmentTypeId switch expressions for LeadershipPositionId/BlindRecruitmentId; (4) _cascadeLoading field exists; (5) OnClientChangedAsync sets _cascadeLoading = true/false around the reload</manual>
  </verify>
  <done>Web project compiles; all 6 specific code fixes applied as described; _cascadeLoading field exists and is set in OnClientChangedAsync</done>
</task>

</tasks>

<verification>
Run `dotnet build src/SignaturPortal.Web/SignaturPortal.Web.csproj --no-restore -q` — zero errors, zero warnings about new code.

Confirm in ActivityCreateEdit.razor.cs:
- `Navigation.NavigateTo("/recruiting/activities")` appears in edit-mode save path
- `_form.RecruitmentTypeId = data.LeadershipPositionId == 1 ? 2 :` appears in MapEditDataToForm
- `RecruitmentTypeId switch` appears in BuildSaveCommand
- `_cascadeLoading = true;` appears in OnClientChangedAsync
- `_form.ClosedCalendarEnabled = data.CalendarTypeId == 2;` appears in MapEditDataToForm

Confirm in ActivityFormModel.cs:
- `validationContext.GetService` appears
</verification>

<success_criteria>
- Web project builds with zero errors
- ActivityFormModel.Validate() uses ILocalizationService from ValidationContext with English fallback
- OnSaveAsync navigates to /recruiting/activities after edit save (no Snackbar call)
- MapEditDataToForm derives RecruitmentTypeId from LeadershipPositionId/BlindRecruitmentId
- MapEditDataToForm derives ClosedCalendarEnabled/OpenCalendarEnabled from CalendarTypeId
- BuildSaveCommand translates RecruitmentTypeId to LeadershipPositionId/BlindRecruitmentId via switch expression
- BuildSaveCommand derives CalendarTypeId from checkbox state
- _cascadeLoading bool exists and is toggled in OnClientChangedAsync
</success_criteria>

<output>
After completion, create `.planning/phases/03.9-redo-activitycreateedit-ui-migration-with-full-fidelity/03.9-01-SUMMARY.md`
</output>
